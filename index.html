<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #fff;
            color: #000;
        }
        body {
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }
        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover {
            background-color: #f0f0f0;
        }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        /* --- Home Page Buttons --- */
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3);}
        .main-button:active { transform: translateY(0);}
        .btn-talking { background-color: #0099cc;}
        .btn-texting { background-color: #9933cc;}
        .btn-phone { background-color: #669900;}
        .btn-commands { background-color: #ff8800;}
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        /* --- Speech Recognition Page --- */
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 8px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 130px;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            overflow-y: auto;
            min-height: 80px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .current-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding: 12px 0 12px 0;
        }
        .control-btn {
            height: 56px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 230px;
            max-width: 90%;
        }
        .icon-btn {
            width: 56px;
            height: 56px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc;}
        .btn-stop { background-color: #cc0000;}
        .btn-enhanced { background-color: #6f42c1;}
        .btn-send { background-color: #669900;}
        .btn-clear { background-color: #ffaa00;}
        .btn-home {
            background-color: #0099cc;
            height: 56px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 230px;
            max-width: 90%;
            margin: 0 auto;
            display: block;
        }
        /* --- Text Input Page --- */
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        .header-speech { background-color: #0099cc;}
        .header-phone { background-color: #669900;}
        .header-commands { background-color: #ff8800;}
        .header-text { background-color: #9933cc;}
        .header-settings { background-color: #0099cc;}
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2);}
        .text-input-content {
            flex-grow: 1;
            padding: 12px;
            padding-bottom: 88px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .speak-row {
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 6px;
            margin-bottom: 0;
            margin-top: 0;
            float: right;
            z-index: 10;
            position: relative;
        }
        .speak-phrase-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .text-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 220px;
            flex-grow: 1;
            box-sizing: border-box;
        }
        /* --- Contacts/Phone Page --- */
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
        }
        .contact-search-input {
            width: 100%;
            height: 44px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 320px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.2s;
        }
        .contact-item:hover {
            background-color: #f0f0f0;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        /* --- Swipe Edges --- */
        .swipe-edge { position: fixed; z-index: 998; pointer-events: auto;}
        .swipe-bottom { bottom: 0; left: 25%; right: 25%; height: 12px;}
        .swipe-left { left: 0; top: 25%; bottom: 25%; width: 12px;}
        .swipe-right { right: 0; top: 25%; bottom: 25%; width: 12px;}
        .hidden { display: none;}
        @media (max-width: 768px) {
            .main-button, .btn-home, .control-btn { width: 98vw; }
            .text-input-content { padding: 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Swipe Edge Detection Areas -->
    <div class="swipe-edge swipe-bottom" id="swipeBottom"></div>
    <div class="swipe-edge swipe-left" id="swipeLeft"></div>
    <div class="swipe-edge swipe-right" id="swipeRight"></div>

    <!-- Weather Modal -->
    <div class="weather-display hidden" id="weatherDisplay">
        <div class="weather-title" id="weatherTitle">Current Weather</div>
        <div class="weather-content" id="weatherContent">Loading weather data...</div>
        <div class="weather-controls">
            <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
            <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
            <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
            <button class="weather-btn" onclick="hideWeather()">Close</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div style="width: 48px;"></div>
        <h1>Leslie Speech Assistant</h1>
        <button class="settings-btn" id="btnSettings">⚙️</button>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="page active">
        <div class="home-page">
            <div class="welcome-text">
                👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
            </div>
            <button class="main-button btn-talking" id="btnStartTalking">
                🎤 START TALKING
            </button>
            <button class="main-button btn-texting" id="btnStartTexting">
                📝 START TEXTING
            </button>
            <button class="main-button btn-phone" id="btnPhoneCall">
                📞 PHONE CALL
            </button>
            <button class="main-button btn-commands" id="btnCommands">
                🗣️ LESLIE COMMANDS
            </button>
            <div class="tips-box">
                💡 Tips:<br>
                • Voice commands work best with microphone permission granted<br>
                • Say "Hey Leslie" followed by commands for voice control<br>
                • Click START TALKING for continuous speech recognition<br>
                • Use Enhanced Recognition for better accuracy with unclear speech<br>
                • Very small swipe areas: bottom center, left/right sides for weather<br>
                • Works best with clear speech or whispers
            </div>
        </div>
    </div>

    <!-- Speech Recognition Page -->
    <div id="speechPage" class="page">
        <div class="speech-page">
            <div class="page-header header-speech">
                <h2>🎤 Speech Recognition</h2>
                <button class="close-btn" id="btnCloseSpeech">&times;</button>
            </div>
            <div class="status-text" id="statusText">
                Ready to listen - Click "START TALKING" below
            </div>
            <div class="speech-display">
                <div class="speech-header">
                    Speech Recognition - Current Phrase
                </div>
                <div class="speech-content">
                    <div class="speech-text" id="recognizedText">
                        <div class="current-phrase" id="currentPhrase">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-row">
                <button class="control-btn btn-listen" id="listenButton">
                    START TALKING
                </button>
                <button class="icon-btn btn-clear" id="btnClearSpeech" title="Clear Text">
                    🗑️
                </button>
            </div>
        </div>
    </div>

    <!-- Text Input Page -->
    <div id="textInputPage" class="page">
        <div class="text-input-page">
            <div class="page-header header-text">
                <h2>📝 Text Input</h2>
                <button class="close-btn" id="btnCloseText">&times;</button>
            </div>
            <div class="text-input-content">
                <div class="speak-row">
                    <button class="speak-phrase-btn" id="speakTextBtn">
                        🔊 SPEAK TEXT
                    </button>
                </div>
                <textarea class="text-input large-text-input" id="largeTextInputField"
                          placeholder="Type your message here..."></textarea>
                <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                    <button class="btn-home" id="btnTextHome">
                        🏠 HOME
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Call Page -->
    <div id="phonePage" class="page">
        <div class="phone-header header-phone">
            <h2>📞 Your Contacts</h2>
            <button class="close-btn" id="btnClosePhone">&times;</button>
        </div>
        <div class="contact-search-section">
            <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                🔍 Search Your Contacts:
            </div>
            <input type="text" id="contactSearch" class="contact-search-input"
                   placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                Click "Load Your Contacts" to access your real device contacts.
            </div>
        </div>
        <div class="contact-list-container">
            <div style="font-size: 12px; color: #669900; margin-bottom: 8px;">
                📱 Tap contact to call directly:
            </div>
            <div class="contacts-list" id="contactsList">
                <div style="padding: 16px; text-align: center; color: #666;">
                    <p><strong>📱 Access Your Real Contacts</strong></p>
                    <p>Your contacts are accessed locally on your device only.</p>
                    <p>No contact data is sent to servers or made public.</p>
                    <br>
                    <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📞 Load Your Contacts
                    </button>
                </div>
            </div>
        </div>
        <div class="phone-home-section">
            <button class="btn-home" id="btnPhoneHome">
                🏠 HOME
            </button>
        </div>
    </div>

    <!-- Leslie Commands Page -->
    <div id="commandsPage" class="page">
        <div class="page-header header-commands">
            <h2>🗣️ Leslie Commands</h2>
            <button class="close-btn" id="btnCloseCommands">&times;</button>
        </div>
        <div class="commands-content">
            <div class="commands-text" id="leslieCommandsText">
                <!-- Will be filled by JS with your latest voice command set -->
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="page">
        <div class="page-header header-settings">
            <h2>Leslie Settings</h2>
            <button class="close-btn" id="btnCloseSettings">&times;</button>
        </div>
        <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
            <div class="settings-section">
                <div class="settings-title">Pause Between Words (seconds)</div>
                <div class="settings-description">Pause time between words (affects how Leslie speaks on talking/texting pages and for commands)</div>
                <input type="range" class="slider" id="pauseSlider" min="0" max="3" step="0.5" value="1">
                <div class="setting-value" id="pauseValue">1.0s</div>
            </div>
            <div class="settings-section">
                <div class="settings-title">Speech Playback Speed</div>
                <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0">
                <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
            </div>
            <div class="settings-section">
                <div class="settings-title">Voice Command Speech</div>
                <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                <div class="switch">
                    <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                    <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                </div>
                <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
            </div>
        </div>
        <button class="back-btn" id="btnSettingsHome">
            ← Back
        </button>
    </div>
</div>
<script>
let recognition = null;
let isListening = false;
let speechSynth = window.speechSynthesis;
let currentPage = 'home';
let pageHistory = ['home'];
let contacts = [];
let filteredContacts = [];
let currentPhrase = '';
let isSpeaking = false;
let microphonePermissionGranted = false;
let phraseHistory = [];
let demoContacts = [
    {name: "John Smith", phone: "555-1212"},
    {name: "Mary Jones", phone: "555-1234"},
    {name: "Derek Lee", phone: "555-0001"},
    {name: "Rebecca Miller", phone: "555-1111"}
];
let settings = {
    speechSpeed: 1.0,
    speakVoiceCommands: true,
    pauseBetweenWords: 1.0
};

document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    updateSettingsUI();
    setupButtonHandlers();
    setupSpeechRecognition();
    initializeContacts();
    setupSwipeDetection();
    requestMicrophonePermission();
    updateCommandPage();
    updateTextSpeakButton();
});

// --- BUTTON HANDLERS ---
function setupButtonHandlers() {
    document.getElementById('btnStartTalking').onclick = startTalkingFromHome;
    document.getElementById('btnStartTexting').onclick = () => showPage('textInput');
    document.getElementById('btnPhoneCall').onclick = () => showPage('phone');
    document.getElementById('btnCommands').onclick = () => showPage('commands');
    document.getElementById('btnSettings').onclick = () => showPage('settings');
    document.getElementById('btnCloseSpeech').onclick = navigateBack;
    document.getElementById('listenButton').onclick = toggleListening;
    document.getElementById('btnClearSpeech').onclick = clearSpeechText;
    document.getElementById('btnClosePhone').onclick = () => showPage('home');
    document.getElementById('btnPhoneHome').onclick = () => showPage('home');
    document.getElementById('btnCloseCommands').onclick = navigateBack;
    document.getElementById('btnCloseText').onclick = navigateBack;
    document.getElementById('speakTextBtn').onclick = speakTextInput;
    document.getElementById('btnTextHome').onclick = () => showPage('home');
    document.getElementById('largeTextInputField').oninput = updateTextSpeakButton;
    document.getElementById('btnCloseSettings').onclick = navigateBack;
    document.getElementById('btnSettingsHome').onclick = () => showPage('home');
    document.getElementById('speechSpeedSlider').oninput = e => updateSpeechSpeed(e.target.value);
    document.getElementById('speakVoiceCommandsSwitch').onchange = e => updateVoiceCommandSetting(e.target.checked);
    document.getElementById('pauseSlider').oninput = e => updatePauseBetweenWords(e.target.value);
}

// --- MICROPHONE PERMISSION ---
function requestMicrophonePermission() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                microphonePermissionGranted = true;
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(function() {
                microphonePermissionGranted = false;
                alert('Microphone permission is required.');
            });
    }
}

// --- SPEECH RECOGNITION ---
function setupSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert('Speech recognition not supported in this browser.');
        return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onstart = function() {
        isListening = true;
        updateListenButton();
        updateStatus('🎤 Listening... Say something!');
    };
    recognition.onend = function() {
        isListening = false;
        updateListenButton();
        updateStatus('Ready to listen - Click "START TALKING" below');
    };
    recognition.onerror = function(event) {
        isListening = false;
        updateListenButton();
        updateStatus('Speech recognition error: ' + (event.error || 'Unknown error'));
    };
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalText = '';
        for (let i = 0; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalText += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        if (finalText.trim()) {
            if (!finalText.toLowerCase().startsWith('hey leslie')) {
                // Only show and speak last phrase
                phraseHistory = [finalText.trim()];
                updateCurrentPhraseDisplay();
                updateStatus('✅ Heard: ' + finalText.trim());
                if (!isSpeaking) {
                    isSpeaking = true;
                    leslieSpeak(finalText.trim(), () => {
                        isSpeaking = false;
                        clearSpeechText();
                    });
                }
            } else {
                processVoiceCommand(finalText.toLowerCase().trim());
            }
        } else if (interimTranscript.trim()) {
            if (!interimTranscript.toLowerCase().startsWith('hey leslie')) {
                currentPhrase = interimTranscript.trim();
                updateCurrentPhraseDisplay(true);
                updateStatus('🔄 Listening: ' + interimTranscript.trim());
            }
        }
    };
}

function toggleListening() {
    if (isListening) stopListening();
    else startListening();
}
function startListening() {
    if (recognition && !isListening) try { recognition.start(); } catch (error) { updateStatus('Error starting recognition.'); }
}
function stopListening() {
    if (recognition && isListening) {
        isListening = false;
        recognition.stop();
        updateStatus('Stopped listening');
        updateListenButton();
    }
}
function updateListenButton() {
    const listenButton = document.getElementById('listenButton');
    if (listenButton) {
        if (isListening) {
            listenButton.textContent = 'STOP LISTENING';
            listenButton.className = 'control-btn btn-stop';
        } else {
            listenButton.textContent = 'START TALKING';
            listenButton.className = 'control-btn btn-listen';
        }
    }
}
function updateStatus(message) {
    const statusText = document.getElementById('statusText');
    if (statusText) statusText.textContent = message;
}

// --- DISPLAY ---
function updateCurrentPhraseDisplay(interimOnly) {
    const currentPhraseEl = document.getElementById('currentPhrase');
    if (currentPhraseEl) {
        let html = '';
        if (phraseHistory.length > 0) {
            html += `<div class="current-phrase">${phraseHistory[phraseHistory.length-1]}</div>`;
        }
        if (interimOnly && currentPhrase.trim()) {
            html += `<div class="current-phrase" style="background:#fff8e1; color:#999;">${currentPhrase}</div>`;
        }
        if (html) currentPhraseEl.innerHTML = html;
        else currentPhraseEl.textContent = 'Your speech will appear here...';
    }
}
function clearSpeechText() {
    currentPhrase = '';
    phraseHistory = [];
    updateCurrentPhraseDisplay();
    updateStatus('Text cleared - Ready to listen');
}
// --- TEXT INPUT PAGE ---
function speakTextInput() {
    const textInput = document.getElementById('largeTextInputField');
    const text = textInput.value.trim();
    if (text) leslieSpeak(text);
}
function updateTextSpeakButton() {
    const textInput = document.getElementById('largeTextInputField');
    const speakBtn = document.getElementById('speakTextBtn');
    if (speakBtn && textInput) {
        speakBtn.disabled = !textInput.value.trim();
        speakBtn.style.opacity = textInput.value.trim() ? '1' : '0.5';
    }
    // Always focus the text input when page opens
    if (currentPage === 'textInput' && textInput) textInput.focus();
}

// --- CONTACTS / PHONE PAGE ---
function initializeContacts() {
    contacts = [];
    filteredContacts = [];
    loadRealContacts();
}
async function loadRealContacts() {
    try {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            const props = ['name', 'tel'];
            const opts = {multiple: true};
            const contactList = await navigator.contacts.select(props, opts);
            if (contactList.length === 0) {
                displayNoContacts();
                return;
            }
            contacts = contactList.map(contact => ({
                name: contact.name && contact.name[0] ? contact.name[0] : 'Unknown',
                phone: contact.tel && contact.tel[0] ? contact.tel[0] : 'No phone'
            }));
            contacts.sort((a, b) => a.name.localeCompare(b.name));
            filteredContacts = [...contacts];
            displayContacts();
        } else {
            contacts = demoContacts.slice();
            filteredContacts = demoContacts.slice();
            displayContacts();
        }
    } catch (error) {
        contacts = demoContacts.slice();
        filteredContacts = demoContacts.slice();
        displayContacts();
    }
}
function displayContacts() {
    const contactsList = document.getElementById('contactsList');
    contactsList.innerHTML = '';
    if (filteredContacts.length === 0) {
        contactsList.innerHTML = `<div style="padding:16px; text-align:center;">No contacts found.</div>`;
        return;
    }
    filteredContacts.forEach((contact, index) => {
        const contactEl = document.createElement('div');
        contactEl.className = 'contact-item';
        contactEl.innerHTML = `
            <div class="contact-name">${contact.name}</div>
            <div class="contact-phone">${contact.phone}</div>
        `;
        contactEl.onclick = () => callContact(contact);
        contactsList.appendChild(contactEl);
    });
}
function filterContacts(searchTerm) {
    if (!searchTerm.trim()) {
        filteredContacts = [...contacts];
    } else {
        const searchLower = searchTerm.toLowerCase().trim();
        filteredContacts = contacts.filter(contact => {
            const nameLower = contact.name.toLowerCase();
            const phoneNumbers = contact.phone.replace(/[^0-9]/g, '');
            const searchNumbers = searchTerm.replace(/[^0-9]/g, '');
            return nameLower.includes(searchLower) ||
                nameLower.startsWith(searchLower) ||
                phoneNumbers.includes(searchNumbers) ||
                contact.name.toLowerCase().split(' ').some(word => word.startsWith(searchLower));
        });
    }
    displayContacts();
}
function callContact(contact) {
    window.location.href = `tel:${contact.phone.replace(/[^0-9]/g, '')}`;
}

// --- COMMANDS PAGE ---
function updateCommandPage() {
    document.getElementById('leslieCommandsText').innerHTML = `
    <strong>Available Voice Commands:</strong><br>
    <strong>Hey Leslie Start Talking</strong> – Go to Start Talking<br>
    <strong>Hey Leslie Start Texting</strong> – Go to Text Input<br>
    <strong>Hey Leslie Call &lt;name/number&gt;</strong> – Call a contact by name or number<br>
    <strong>Hey Leslie Home</strong> – Go to Home<br>
    <strong>Hey Leslie Current Weather</strong> – Show today’s weather<br>
    <strong>Hey Leslie Weather</strong> – Show today’s weather<br>
    <strong>Hey Leslie 7 Day Forecast</strong> – 7-day forecast<br>
    <strong>Hey Leslie 7 Day</strong> – 7-day forecast<br>
    <strong>Hey Leslie Hourly</strong> – 24-hour forecast<br>
    <strong>Hey Leslie Hourly Forecast</strong> – 24-hour forecast<br>
    <strong>Hey Leslie Clear Text</strong> – Clear Speech Text<br>
    <strong>Hey Leslie Enhanced Mode</strong> – Enhanced Recognition<br>
    <strong>Hey Leslie Close</strong> – Close weather display<br>
    <strong>Hey Leslie Go Homes</strong> – Go to Home<br>
    <strong>Hey Leslie Help</strong> – Show this page<br>
    <strong>Hey Leslie Pause More</strong> – Increase pause between words<br>
    <strong>Hey Leslie Pause Less</strong> – Decrease pause between words<br>
    <strong>Hey Leslie Speak Faster</strong> – Increase speech speed<br>
    <strong>Hey Leslie Talk Slower</strong> – Decrease speech speed<br>
    <strong>Hey Leslie Turn Off Voice Command Speech</strong> – Turn off voice command speech<br>
    <strong>Hey Leslie Turn On Voice Command Speech</strong> – Turn on voice command speech<br>
    `;
}

// --- SWIPE DETECTION (for weather) ---
function setupSwipeDetection() {
    const swipeBottom = document.getElementById('swipeBottom');
    const swipeLeft = document.getElementById('swipeLeft');
    const swipeRight = document.getElementById('swipeRight');
    let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
    swipeBottom.addEventListener('touchstart', function(e) {
        touchStartY = e.changedTouches[0].screenY;
    });
    swipeBottom.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].screenY;
        if (touchStartY - touchEndY > 30) showCurrentWeather();
    });
    swipeLeft.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });
    swipeLeft.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        if (touchEndX - touchStartX > 30) showHourlyWeather();
    });
    swipeRight.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });
    swipeRight.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        if (touchStartX - touchEndX > 30) showWeeklyWeather();
    });
}

// --- PAGE NAVIGATION ---
function showPage(pageId, addToHistory = true) {
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId + 'Page');
    if (targetPage) {
        targetPage.classList.add('active');
        currentPage = pageId;
        if (addToHistory) {
            pageHistory.push(pageId);
            history.pushState({page: pageId}, '', '');
        }
        if (pageId !== 'speech' && isListening) stopListening();
        if (pageId === 'textInput') setTimeout(updateTextSpeakButton, 100);
    }
}
function startTalkingFromHome() {
    showPage('speech');
    setTimeout(() => { toggleListening(); }, 400);
}
function navigateBack() {
    if (pageHistory.length > 1) {
        pageHistory.pop();
        const previousPage = pageHistory[pageHistory.length - 1];
        showPage(previousPage, false);
    } else {
        showPage('home', false);
    }
}

// --- SETTINGS ---
function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('leslieSettings');
        if (savedSettings) settings = {...settings, ...JSON.parse(savedSettings)};
    } catch (error) {}
    if (settings.pauseBetweenWords === undefined) settings.pauseBetweenWords = 1.0;
}
function saveSettings() {
    try {
        localStorage.setItem('leslieSettings', JSON.stringify(settings));
    } catch (error) {}
}
function updateSettingsUI() {
    document.getElementById('speechSpeedSlider').value = settings.speechSpeed;
    document.getElementById('speakVoiceCommandsSwitch').checked = settings.speakVoiceCommands;
    document.getElementById('pauseSlider').value = settings.pauseBetweenWords;
    document.getElementById('pauseValue').textContent = settings.pauseBetweenWords.toFixed(1) + 's';
    updateSpeechSpeed(settings.speechSpeed);
    updateVoiceCommandSetting(settings.speakVoiceCommands);
}
function updateSpeechSpeed(value) {
    settings.speechSpeed = Math.max(0.5, Math.min(2.0, parseFloat(value)));
    const label = document.getElementById('speechSpeedValue');
    if (label) {
        if (settings.speechSpeed == 1.0) label.textContent = 'Normal (1.0x)';
        else label.textContent = `${settings.speechSpeed.toFixed(1)}x`;
    }
    saveSettings();
}
function updateVoiceCommandSetting(checked) {
    settings.speakVoiceCommands = checked;
    const label = document.getElementById('speakVoiceCommandsLabel');
    if (label) label.textContent = `Voice Command Speech: ${checked ? 'ON' : 'OFF'}`;
    saveSettings();
}
function updatePauseBetweenWords(value) {
    settings.pauseBetweenWords = Math.max(0, Math.min(3.0, parseFloat(value)));
    document.getElementById('pauseValue').textContent = settings.pauseBetweenWords.toFixed(1) + 's';
    saveSettings();
}
// --- VOICE COMMANDS LOGIC ---
function processVoiceCommand(text) {
    let t = text.replace(/^hey leslie[ ,:]*|[.!?]+$/gi, '').trim();
    if (!t) return;

    // Voice command routing
    if (t === 'start talking') { showPage('speech'); setTimeout(() => toggleListening(), 500); doVoice('Speech recognition started.'); return; }
    if (t === 'start texting') { showPage('textInput'); doVoice('Text input page opened.'); return; }
    if (t.startsWith('call ')) {
        let arg = t.replace(/^call /, '').trim();
        handleCallCommand(arg);
        return;
    }
    if (t === 'home' || t === 'go homes') { showPage('home'); doVoice('Home page.'); return; }
    if (t === 'current weather' || t === 'weather') { showCurrentWeather(); doVoice('Here is the current weather.'); return; }
    if (t === '7 day forecast' || t === '7 day') { showWeeklyWeather(); doVoice('Here is the 7 day forecast.'); return; }
    if (t === 'hourly' || t === 'hourly forecast') { showHourlyWeather(); doVoice('Here is the hourly forecast.'); return; }
    if (t === 'clear text') { clearSpeechText(); doVoice('Speech text cleared.'); return; }
    if (t === 'enhanced mode') { doVoice('Enhanced recognition is not implemented in this version.'); return; }
    if (t === 'close') { hideWeather(); doVoice('Weather display closed.'); return; }
    if (t === 'help') { showPage('commands'); doVoice('Here are the available commands.'); return; }
    if (t === 'pause more') {
        settings.pauseBetweenWords = Math.min(3.0, (settings.pauseBetweenWords || 1.0) + 0.5);
        updateSettingsUI();
        doVoice('Pause between words increased.');
        return;
    }
    if (t === 'pause less') {
        settings.pauseBetweenWords = Math.max(0, (settings.pauseBetweenWords || 1.0) - 0.5);
        updateSettingsUI();
        doVoice('Pause between words decreased.');
        return;
    }
    if (t === 'speak faster') {
        settings.speechSpeed = Math.min(2.0, (settings.speechSpeed || 1.0) + 0.5);
        updateSettingsUI();
        doVoice('Speech speed increased.');
        return;
    }
    if (t === 'talk slower') {
        settings.speechSpeed = Math.max(0.5, (settings.speechSpeed || 1.0) - 0.5);
        updateSettingsUI();
        doVoice('Speech speed decreased.');
        return;
    }
    if (t === 'turn off voice command speech') {
        settings.speakVoiceCommands = false;
        updateSettingsUI();
        doVoice('Voice command speech turned off.');
        return;
    }
    if (t === 'turn on voice command speech') {
        settings.speakVoiceCommands = true;
        updateSettingsUI();
        doVoice('Voice command speech turned on.');
        return;
    }
    // If not recognized, ignore (no fallback "I didn't understand")
}
function doVoice(text) {
    if (settings.speakVoiceCommands && text.trim()) leslieSpeak(text);
}
function leslieSpeak(text, onend) {
    if (!text) return;
    speechSynth.cancel();
    let words = text.split(/\s+/);
    let index = 0;
    function speakNext() {
        if (index >= words.length) { if (onend) onend(); return; }
        let utter = new SpeechSynthesisUtterance(words[index]);
        utter.rate = settings.speechSpeed;
        utter.onend = function() {
            index++;
            setTimeout(speakNext, (settings.pauseBetweenWords || 1.0) * 1000);
        };
        speechSynth.speak(utter);
    }
    speakNext();
}
function handleCallCommand(arg) {
    if (/^\d{3,}/.test(arg.replace(/\D/g,''))) {
        doVoice('Calling ' + arg.replace(/[^\d]/g, ''));
        window.location.href = 'tel:' + arg.replace(/[^\d]/g, '');
        return;
    }
    let lower = arg.toLowerCase();
    let found = contacts.find(
        c => c.name.toLowerCase().includes(lower)
    );
    if (found) {
        doVoice('Calling ' + found.name);
        window.location.href = 'tel:' + found.phone.replace(/[^\d]/g, '');
    } else {
        doVoice('Could not find contact named ' + arg);
    }
}

// --- WEATHER MODALS ---
function showCurrentWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    const currentTime = new Date();
    const temperature = Math.floor(Math.random() * 30) + 60;
    const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Clear'][Math.floor(Math.random() * 5)];
    const humidity = Math.floor(Math.random() * 40) + 40;
    const windSpeed = Math.floor(Math.random() * 15) + 5;
    weatherTitle.textContent = `Current Weather (${currentTime.toLocaleDateString(undefined, {weekday: 'long', month: 'long', day: 'numeric'})})`;
    weatherContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
            <div style="font-size: 32px; font-weight: bold; color: #0099cc;">${temperature}°F</div>
            <div style="font-size: 20px; font-weight: bold; margin: 8px 0;">${conditions}</div>
        </div>
        <div style="line-height: 1.8;">
            <strong>Humidity:</strong> ${humidity}%<br>
            <strong>Wind:</strong> ${windSpeed} mph<br>
            <strong>Time:</strong> ${currentTime.toLocaleTimeString()}<br>
        </div>
    `;
    weatherDisplay.classList.remove('hidden');
}
function showHourlyWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    weatherTitle.textContent = '24-Hour Forecast';
    let hourlyData = '<div class="hourly-forecast">';
    const now = new Date();
    for (let i = 0; i < 24; i += 3) {
        const futureTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
        const hour = futureTime.getHours();
        const temp = Math.floor(Math.random() * 20) + 65;
        const conditions = ['Sunny', 'Cloudy', 'Rain', 'Clear'][Math.floor(Math.random() * 4)];
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'PM' : 'AM';
        hourlyData += `
            <div class="hourly-item">
                <strong>${displayHour}:00 ${ampm}</strong><br>
                ${temp}°F ${conditions}
            </div>
        `;
    }
    hourlyData += '</div>';
    weatherContent.innerHTML = hourlyData;
    weatherDisplay.classList.remove('hidden');
}
function showWeeklyWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    weatherTitle.textContent = '7-Day Forecast';
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let weeklyData = '<div class="weekly-forecast">';
    for (let i = 0; i < 7; i++) {
        const dayIndex = (new Date().getDay() + i) % 7;
        const high = Math.floor(Math.random() * 20) + 75;
        const low = high - Math.floor(Math.random() * 15) - 10;
        const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Rain', 'Storms'][Math.floor(Math.random() * 5)];
        weeklyData += `
            <div class="weekly-item">
                <div class="day-name">${days[dayIndex]}</div>
                <div class="day-temps">${high}°/${low}°</div>
                <div class="day-condition">${conditions}</div>
            </div>
        `;
    }
    weeklyData += '</div>';
    weatherContent.innerHTML = weeklyData;
    weatherDisplay.classList.remove('hidden');
}
function hideWeather() {
    document.getElementById('weatherDisplay').classList.add('hidden');
}

// --- BROWSER HISTORY ---
window.addEventListener('popstate', function(event) {
    event.preventDefault();
    navigateBack();
});
</script>
</body>
</html>
