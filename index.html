<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #0099cc;
            z-index: 1000;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            width: 90vw;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
            text-align: center;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .hourly-forecast, .weekly-forecast {
            display: grid;
            gap: 8px;
        }
        .hourly-item, .weekly-item {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }
        .weekly-item {
            display: grid;
            grid-template-columns: 80px 60px 1fr;
            gap: 8px;
            align-items: center;
            font-size: 14px;
        }
        .day-name { font-weight: bold; }
        .day-temps { color: #0099cc; font-weight: bold; }
        .day-condition { color: #666; }
        .swipe-edge {
            position: fixed;
            z-index: 998;
            background: rgba(0,153,204,0.3);
        }
        .swipe-bottom {
            bottom: 0;
            left: 40%;
            width: 20%;
            height: 40px;
        }
        .swipe-left {
            left: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .swipe-right {
            right: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .api-key-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        .contact-loading-section {
            padding: 20px;
            text-align: center;
            color: #669900;
            border: 2px solid #669900;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 16px;
        }
        .voice-command-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            border: 2px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .voice-command-status.active {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }
        .voice-command-status.permission-needed {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(220, 53, 69, 0.3);
        }
        .voice-command-status.ready {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(40, 167, 69, 0.3);
        }
        .voice-command-status.processing {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            display: block;
            border-color: rgba(255, 193, 7, 0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { 
                padding: 16px;
                width: 95vw;
                max-width: 450px;
            }
            .voice-command-status {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    üé§ START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    üìù START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    üìû PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    üó£Ô∏è LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Voice commands work on ALL pages including home - just say "Hey Leslie" + command<br>
                    ‚Ä¢ Watch the green indicator (top-right) for voice command status<br>
                    ‚Ä¢ START TALKING page has continuous speech recognition<br>
                    ‚Ä¢ Use Enhanced Recognition for better accuracy<br>
                    ‚Ä¢ Swipe gestures: bottom center (weather), left/right sides (forecasts)
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Ready to listen - Starting automatically...
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">üî¨ Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        üî¨ START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        STOP LISTENING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>üìû Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    üîç Search Your Contacts
                </div>
                <input type="text" class="contact-search-input" id="contactSearchInput" placeholder="Type to search contacts...">
            </div>
            
            <div class="contact-loading-section" id="contactLoadingSection">
                <p><strong>üì± GET YOUR REAL CONTACTS</strong></p>
                <p style="color: #333; margin: 10px 0; font-size: 16px;">Currently showing: <span style="color: #cc0000;">Demo Contacts Only</span></p>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Choose how to load YOUR real contacts from your phone:
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button id="loadAllContactsBtn" style="margin: 5px; padding: 16px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        üìû LOAD ALL CONTACTS
                    </button>
                    <button id="loadSelectedContactsBtn" style="margin: 5px; padding: 16px 24px; background: #0099cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        üìã SELECT SPECIFIC CONTACTS
                    </button>
                </div>
                <p style="margin-top: 12px; font-size: 12px; color: #666;">
                    <strong>üìû LOAD ALL:</strong> Opens contact picker with auto-selection attempt<br>
                    <strong>üìã SELECT:</strong> Opens contact picker for manual selection<br>
                    <strong>‚ö†Ô∏è Works on Chrome Android & Safari iOS only</strong>
                </p>
            </div>
            
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    üì± Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">üè† HOME</button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div style="font-size: 14px; font-weight: bold; color: #9933cc; margin-bottom: 8px;">
                        Type your text and tap speak to have it read aloud:
                    </div>
                    <textarea class="text-input large-text-input" id="largeTextInputField" placeholder="Type what you want to say here..."></textarea>
                    
                    <div class="speak-text-container">
                        <button class="speak-phrase-btn" id="speakTextBtn" disabled>
                            üîä SPEAK
                        </button>
                    </div>
                    
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">üè† HOME</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>üó£Ô∏è Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div style="padding: 16px; max-height: 70vh; overflow-y: auto; background: white; border-radius: 8px; margin: 8px;">
                <div style="font-size: 16px; line-height: 1.6; color: #333;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0099cc;">
                        <strong>üé§ Available Voice Commands</strong><br>
                        <span style="font-size: 14px; color: #666;">Voice commands work on all pages including home - watch for green indicator</span>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                            <strong style="color: #28a745;">üß≠ Navigation Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ "Hey Leslie, <strong>home</strong>" - Returns to home page<br>
                            ‚Ä¢ "Hey Leslie, <strong>start talking</strong>" - Speech recognition page<br>
                            ‚Ä¢ "Hey Leslie, <strong>start texting</strong>" - Text input page<br>
                            ‚Ä¢ "Hey Leslie, <strong>phone</strong>" - Phone contacts page<br>
                            ‚Ä¢ "Hey Leslie, <strong>settings</strong>" - Settings page<br>
                            ‚Ä¢ "Hey Leslie, <strong>help</strong>" - Shows this commands list<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #007bff;">
                            <strong style="color: #007bff;">üå§Ô∏è Weather Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ "Hey Leslie, <strong>weather</strong>" - Shows current weather<br>
                            ‚Ä¢ "Hey Leslie, <strong>hourly</strong>" - Shows 24-hour forecast<br>
                            ‚Ä¢ "Hey Leslie, <strong>weekly</strong>" - Shows 7-day forecast<br>
                            ‚Ä¢ "Hey Leslie, <strong>7 day</strong>" - Shows 7-day forecast<br>
                            ‚Ä¢ "Hey Leslie, <strong>close weather</strong>" - Closes weather displays<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #6f42c1;">
                            <strong style="color: #6f42c1;">üéôÔ∏è Recognition Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ "Hey Leslie, <strong>enhanced mode on</strong>" - Enables enhanced recognition<br>
                            ‚Ä¢ "Hey Leslie, <strong>enhanced mode off</strong>" - Disables enhanced recognition<br>
                            ‚Ä¢ "Hey Leslie, <strong>stop listening</strong>" - Stops speech recognition<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #dc3545;">
                            <strong style="color: #dc3545;">üîä Speech Settings Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ "Hey Leslie, <strong>speak faster</strong>" - Increases speech speed<br>
                            ‚Ä¢ "Hey Leslie, <strong>speak slower</strong>" - Decreases speech speed<br>
                            ‚Ä¢ "Hey Leslie, <strong>pause more</strong>" - Increases pause between words<br>
                            ‚Ä¢ "Hey Leslie, <strong>pause less</strong>" - Decreases pause between words<br>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">üí° Tips for Better Recognition</strong><br>
                        <div style="margin-top: 8px; font-size: 14px; color: #856404;">
                            ‚Ä¢ Speak clearly and at normal volume<br>
                            ‚Ä¢ Watch for the green indicator (top-right) to confirm voice commands are ready<br>
                            ‚Ä¢ Voice commands work on all pages including home with anti-pinging protection<br>
                            ‚Ä¢ After a command, wait for the green indicator to show it's ready again<br>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px; text-align: center;">
                <button class="btn-home" id="btnCommandsHome">üè† HOME</button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>‚öôÔ∏è Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Enhanced Recognition)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable enhanced speech recognition with better accuracy for unclear speech.
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your OpenAI API key here...">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        This key stays on your device and is only used for speech recognition.
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div class="switch">
                        <input type="checkbox" id="autoEnhancedSwitch">
                        <label for="autoEnhancedSwitch">Auto-suggest Enhanced Recognition when needed</label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.2" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to wait after you stop speaking before processing your complete phrase (higher = waits longer for you to finish)</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0.5" max="4" step="0.1" value="1.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">1.5 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Enhanced Recognition Mode</div>
                    <div class="settings-description">Use OpenAI Whisper for better accuracy with unclear speech</div>
                    <div class="switch">
                        <input type="checkbox" id="enhancedModeSwitch">
                        <label for="enhancedModeSwitch">Enable Enhanced Mode by default</label>
                    </div>
                    <div class="setting-value" id="enhancedModeLabel">Enhanced Mode: OFF</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speak Voice Commands</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Speak Voice Commands</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Speak Voice Commands: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">‚Üê Back</button>
        </div>

        <!-- Weather Display -->
        <div id="weatherDisplay" class="weather-display hidden">
            <div class="weather-title" id="weatherTitle">Weather Information</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Swipe Gesture Areas -->
        <div id="swipeBottom" class="swipe-edge swipe-bottom"></div>
        <div id="swipeLeft" class="swipe-edge swipe-left"></div>
        <div id="swipeRight" class="swipe-edge swipe-right"></div>

        <!-- Voice Command Status Indicator -->
        <div id="voiceCommandStatus" class="voice-command-status">üé§ Voice Commands Ready</div>
    </div>

    <script>
        // Global variables
        let speechRecognition = null;
        let voiceCommandRecognition = null;
        let isMainListening = false;
        let isVoiceCommandListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let contacts = [];
        let filteredContacts = [];
        let userLocation = null;
        let isInitialized = false;
        
        // FIXED: Voice commands with intelligent restart to stop pinging
        let voiceCommandsEnabled = true;
        let voiceCommandActive = false;
        let voiceCommandFailureCount = 0;
        let lastVoiceCommand = '';
        let lastVoiceCommandTime = 0;
        let voiceCommandRestartDelay = 3000; // Start with 3 second delay
        
        // FIXED: Speech page with proper continuous listening
        let shouldKeepListening = false;
        let userStoppedManually = false;
        let speechSessionActive = false;
        let speechInactivityTimer = null;
        let speechRestartTimer = null;
        const SPEECH_INACTIVITY_TIMEOUT = 120000; // 2 minutes
        
        // Speech processing - fixed to prevent duplicates and ensure speaking works
        let isSpeaking = false;
        let speechQueue = [];
        let lastSpokenText = '';
        let lastSpokenTime = 0;
        let speechCounter = 0;
        
        // Settings
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: '',
            pauseBetweenWords: 1.5,
            enhancedMode: false
        };

        // === FIXED SPEECH SYNTHESIS - NO MORE DUPLICATES ===
        function speakText(text, clearAfter = false) {
            const cleanText = text.trim();
            if (!cleanText) return;
            
            const currentTime = Date.now();
            const speechId = ++speechCounter;
            
            // Prevent duplicate speech within 2 seconds
            if (cleanText === lastSpokenText && (currentTime - lastSpokenTime) < 2000) {
                console.log('üö´ Duplicate speech prevented:', cleanText);
                return;
            }
            
            lastSpokenText = cleanText;
            lastSpokenTime = currentTime;
            
            console.log('üîä Speaking:', cleanText, 'ID:', speechId);
            
            // Cancel any existing speech
            speechSynth.cancel();
            
            // Clear speech queue and add new item
            speechQueue = [{ text: cleanText, clearAfter, id: speechId }];
            
            setTimeout(() => {
                processSpeechQueue();
            }, 100);
        }

        function processSpeechQueue() {
            if (isSpeaking || speechQueue.length === 0) return;
            
            const { text, clearAfter, id } = speechQueue.shift();
            
            // Skip if this is an old utterance
            if (id < speechCounter - 1) {
                console.log('üö´ Skipping old utterance:', id);
                processSpeechQueue();
                return;
            }
            
            isSpeaking = true;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = Math.max(0.5, Math.min(2.0, settings.speechSpeed || 1.0));
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            utterance.lang = 'en-US';
            
            let speechEnded = false;
            
            const finishSpeech = () => {
                if (speechEnded) return;
                speechEnded = true;
                
                isSpeaking = false;
                
                if (clearAfter && currentPage === 'textInput') {
                    const textField = document.getElementById('largeTextInputField');
                    if (textField) {
                        textField.value = '';
                        updateTextSpeakButton();
                    }
                }
                
                if (currentPage === 'speech') {
                    updateStatus('üé§ Listening... Speak your phrase!');
                }
                
                // Process next item in queue
                setTimeout(() => processSpeechQueue(), 200);
            };
            
            utterance.onstart = () => {
                console.log('üîä Speech started:', text);
                if (currentPage === 'speech') {
                    updateStatus('üîä Speaking: "' + text + '"');
                }
            };
            
            utterance.onend = finishSpeech;
            utterance.onerror = (event) => {
                console.error('Speech error:', event.error);
                finishSpeech();
            };
            
            speechSynth.speak(utterance);
        }

        // === FIXED SPEECH RECOGNITION - NO MORE PINGING ===
        function createSpeechRecognition() {
            console.log('üé§ Creating speech recognition...');
            
            // Clean up existing recognition
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                } catch (e) {}
                speechRecognition = null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('‚ùå Speech Recognition not supported');
                return false;
            }
            
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            speechRecognition.maxAlternatives = 1;

            speechRecognition.onstart = () => {
                console.log('üé§ ‚úÖ Speech recognition started');
                isMainListening = true;
                speechSessionActive = true;
                updateListenButton();
                updateStatus('üé§ Listening... Speak your phrase!');
                resetSpeechInactivityTimer();
            };

            speechRecognition.onend = () => {
                console.log('üé§ Speech recognition ended');
                isMainListening = false;
                updateListenButton();
                
                // Only restart if we should keep listening AND we're on speech page AND user didn't stop manually
                if (shouldKeepListening && 
                    speechSessionActive && 
                    currentPage === 'speech' && 
                    !userStoppedManually) {
                    
                    console.log('üîÑ Auto-restarting speech recognition...');
                    
                    // Clear any existing restart timer
                    if (speechRestartTimer) {
                        clearTimeout(speechRestartTimer);
                    }
                    
                    speechRestartTimer = setTimeout(() => {
                        if (shouldKeepListening && 
                            speechSessionActive && 
                            currentPage === 'speech' && 
                            !userStoppedManually) {
                            
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.error('‚ùå Speech restart failed:', e);
                                updateStatus('‚ùå Recognition failed - Click START TALKING to retry');
                                stopListening();
                            }
                        }
                        speechRestartTimer = null;
                    }, 1000); // 1 second delay
                } else {
                    updateStatus('üõë Speech recognition stopped');
                    speechSessionActive = false;
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('üé§ Speech error:', event.error);
                isMainListening = false;
                updateListenButton();
                
                if (event.error === 'not-allowed') {
                    updateStatus('‚ùå Microphone access denied');
                    stopListening();
                } else if (event.error === 'no-speech') {
                    updateStatus('üé§ No speech detected - Continuing to listen...');
                } else {
                    updateStatus('üé§ Listening... (Error: ' + event.error + ')');
                }
            };

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    
                    if (result.isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show interim results
                if (interimTranscript.trim()) {
                    displayInterimText(interimTranscript.trim());
                }
                
                // Process final results
                if (finalTranscript.trim()) {
                    const finalText = finalTranscript.trim();
                    console.log('üìù Final speech:', finalText);
                    resetSpeechInactivityTimer();
                    processFinalSpeech(finalText);
                }
            };
            
            return true;
        }

        function startListening() {
            console.log('üé§ Starting speech listening...');
            
            shouldKeepListening = true;
            userStoppedManually = false;
            speechSessionActive = true;
            
            // Clear any restart timers
            if (speechRestartTimer) {
                clearTimeout(speechRestartTimer);
                speechRestartTimer = null;
            }
            
            updateStatus('üé§ Requesting microphone access...');
            
            const created = createSpeechRecognition();
            if (!created) {
                updateStatus('‚ùå Speech recognition not supported');
                shouldKeepListening = false;
                speechSessionActive = false;
                return;
            }
            
            try {
                speechRecognition.start();
                updateStatus('üé§ Starting listening...');
            } catch (error) {
                console.error('‚ùå Failed to start recognition:', error);
                
                if (error.name === 'NotAllowedError' || error.message.includes('not-allowed')) {
                    updateStatus('üî¥ Microphone permission needed - Click to allow access');
                    showMicrophoneInstructions();
                } else {
                    updateStatus('‚ùå Failed to start - Try again');
                }
                
                shouldKeepListening = false;
                speechSessionActive = false;
                updateListenButton();
            }
        }

        function stopListening() {
            console.log('üõë Stopping speech listening...');
            
            shouldKeepListening = false;
            userStoppedManually = true;
            speechSessionActive = false;
            
            // Clear timers
            if (speechRestartTimer) {
                clearTimeout(speechRestartTimer);
                speechRestartTimer = null;
            }
            if (speechInactivityTimer) {
                clearTimeout(speechInactivityTimer);
                speechInactivityTimer = null;
            }
            
            // Stop recognition
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                } catch (e) {}
            }
            
            isMainListening = false;
            updateListenButton();
            updateStatus('üõë Stopped - Click "START TALKING" to begin again');
        }

        function resetSpeechInactivityTimer() {
            if (speechInactivityTimer) {
                clearTimeout(speechInactivityTimer);
            }
            
            speechInactivityTimer = setTimeout(() => {
                if (speechSessionActive && currentPage === 'speech') {
                    console.log('‚è∞ Speech inactivity timeout');
                    stopListening();
                    updateStatus('‚è∞ No speech for 2 minutes - Click "START TALKING" to restart');
                }
            }, SPEECH_INACTIVITY_TIMEOUT);
        }

        function displayInterimText(text) {
            const textEl = document.getElementById('recognizedText');
            if (textEl) {
                const existingContent = textEl.innerHTML;
                const interimDisplay = `
                    <div style="background: #fff8e1; padding: 8px; border-radius: 4px; margin: 4px 0; border-left: 3px solid #ffa000; color: #666; font-style: italic;">
                        üé§ Speaking: "${text}"
                    </div>
                `;
                
                // Replace only the last interim result or add new one
                if (existingContent.includes('üé§ Speaking:')) {
                    const lines = existingContent.split('<div style="background: #fff8e1;');
                    if (lines.length > 1) {
                        lines[lines.length - 1] = interimDisplay.substring(interimDisplay.indexOf('padding:'));
                        textEl.innerHTML = lines.join('<div style="background: #fff8e1;');
                    } else {
                        textEl.innerHTML = existingContent + interimDisplay;
                    }
                } else {
                    textEl.innerHTML = existingContent + interimDisplay;
                }
                
                textEl.scrollTop = textEl.scrollHeight;
            }
        }

        function processFinalSpeech(text) {
            console.log('‚úÖ Processing final speech:', text);
            
            // Check if it's a voice command first
            if (isVoiceCommand(text.toLowerCase())) {
                console.log('üéØ Voice command detected on speech page:', text);
                processVoiceCommand(text.toLowerCase(), true); // Silent processing
                return; // Don't display or speak voice commands
            }
            
            // Regular speech - display and speak
            displayFinalSpeech(text);
            speakText(text);
        }

        function displayFinalSpeech(text) {
            const textEl = document.getElementById('recognizedText');
            if (!textEl) return;
            
            let content = textEl.innerHTML;
            
            // Remove any interim results
            content = content.replace(/<div style="background: #fff8e1;[^<]*<\/div>/g, '');
            
            // Add the final result
            const finalDisplay = `
                <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #28a745; font-weight: bold;">
                    ‚úÖ You said: "${text}"
                </div>
            `;
            
            if (content.includes('Your speech will appear here') || 
                content.includes('Ready for your next phrase')) {
                textEl.innerHTML = finalDisplay;
            } else {
                textEl.innerHTML = content + finalDisplay;
            }
            
            textEl.scrollTop = textEl.scrollHeight;
        }

        // === MICROPHONE PERMISSION HANDLING ===
        async function requestMicrophonePermission() {
            console.log('üé§ Requesting microphone permission...');
            updateVoiceCommandStatus('processing');
            
            try {
                // Try to get microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Permission granted - stop the stream and restart voice commands
                stream.getTracks().forEach(track => track.stop());
                
                console.log('‚úÖ Microphone permission granted');
                voiceCommandsEnabled = true;
                voiceCommandFailureCount = 0; // Reset failure count
                
                // Restart voice commands after short delay
                setTimeout(() => {
                    startVoiceCommands();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Microphone permission denied:', error);
                
                // Show user instructions for enabling microphone
                showMicrophoneInstructions();
            }
        }

        function showMicrophoneInstructions() {
            const instructions = `
üé§ MICROPHONE ACCESS NEEDED

Leslie needs microphone access to work. Here's how to enable it:

CHROME:
1. Look for the microphone icon in the address bar
2. Click it and select "Always allow"
3. Refresh the page

SAFARI:
1. Go to Settings > Safari > Camera & Microphone
2. Select "Allow" for this website
3. Refresh the page

FIREFOX:
1. Click the shield icon in the address bar
2. Turn off "Enhanced Tracking Protection" for this site
3. Refresh and allow microphone when prompted

After enabling, click "START TALKING" to test!
            `;
            
            alert(instructions);
            updateVoiceCommandStatus('permission-needed');
        }

        // === FIXED VOICE COMMANDS - NO MORE PINGING ===
        function createVoiceCommandRecognition() {
            console.log('üó£Ô∏è Creating voice command recognition...');
            
            // Clean up existing
            if (voiceCommandRecognition) {
                try {
                    voiceCommandRecognition.abort();
                } catch (e) {}
                voiceCommandRecognition = null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('‚ùå Voice commands not supported');
                return false;
            }
            
            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';
            voiceCommandRecognition.maxAlternatives = 3;

            voiceCommandRecognition.onstart = () => {
                console.log('üó£Ô∏è ‚úÖ Voice commands started');
                isVoiceCommandListening = true;
                voiceCommandActive = true;
                voiceCommandFailureCount = 0; // Reset on successful start
                updateVoiceCommandStatus('ready');
            };

            voiceCommandRecognition.onend = () => {
                console.log('üó£Ô∏è Voice commands ended');
                isVoiceCommandListening = false;
                voiceCommandActive = false;
                
                // FIXED: Intelligent restart with exponential backoff to prevent pinging
                if (voiceCommandsEnabled) {
                    // Calculate delay based on failure count (exponential backoff)
                    voiceCommandRestartDelay = Math.min(3000 + (voiceCommandFailureCount * 2000), 15000); // 3s to 15s max
                    
                    console.log(`üîÑ Voice commands will restart in ${voiceCommandRestartDelay}ms (failures: ${voiceCommandFailureCount})`);
                    updateVoiceCommandStatus('inactive');
                    
                    setTimeout(() => {
                        if (voiceCommandsEnabled && !voiceCommandActive) {
                            try {
                                voiceCommandRecognition.start();
                                console.log('‚úÖ Voice commands restarted');
                            } catch (e) {
                                console.log('Voice command restart failed:', e);
                                voiceCommandFailureCount++;
                                updateVoiceCommandStatus('inactive');
                            }
                        }
                    }, voiceCommandRestartDelay);
                } else {
                    updateVoiceCommandStatus('inactive');
                }
            };

            voiceCommandRecognition.onerror = (event) => {
                console.error('üó£Ô∏è Voice command error:', event.error);
                voiceCommandFailureCount++;
                
                if (event.error === 'not-allowed') {
                    voiceCommandsEnabled = false;
                    voiceCommandActive = false;
                    updateVoiceCommandStatus('permission-needed');
                } else if (event.error !== 'no-speech') {
                    // Increase delay for non-speech errors
                    voiceCommandFailureCount++;
                }
            };

            voiceCommandRecognition.onresult = (event) => {
                const result = event.results[event.results.length - 1];
                if (!result.isFinal) return;
                
                updateVoiceCommandStatus('processing');
                
                // Check all alternatives for "Hey Leslie"
                let bestMatch = '';
                let foundCommand = false;
                
                for (let i = 0; i < result.length; i++) {
                    const transcript = result[i].transcript.trim().toLowerCase();
                    console.log(`üó£Ô∏è Voice alternative ${i}:`, transcript);
                    
                    if (isVoiceCommand(transcript)) {
                        bestMatch = transcript;
                        foundCommand = true;
                        break;
                    }
                }
                
                if (foundCommand) {
                    console.log('üéØ "Hey Leslie" command detected:', bestMatch);
                    processVoiceCommand(bestMatch);
                } else {
                    console.log('üö´ No "Hey Leslie" detected');
                    setTimeout(() => updateVoiceCommandStatus('ready'), 1000);
                }
            };
            
            return true;
        }

        function startVoiceCommands() {
            if (voiceCommandActive || !voiceCommandsEnabled) {
                console.log('üö´ Voice commands already active or disabled');
                return;
            }
            
            console.log('üó£Ô∏è Starting voice commands...');
            
            const created = createVoiceCommandRecognition();
            if (!created) {
                updateVoiceCommandStatus('inactive');
                return;
            }
            
            try {
                voiceCommandRecognition.start();
            } catch (error) {
                console.log('‚ö†Ô∏è Voice commands failed to start:', error);
                voiceCommandFailureCount++;
                updateVoiceCommandStatus('inactive');
                
                // Retry with longer delay
                setTimeout(() => {
                    if (voiceCommandsEnabled && !voiceCommandActive) {
                        try {
                            voiceCommandRecognition.start();
                        } catch (e) {
                            console.log('Voice commands retry failed');
                            voiceCommandFailureCount++;
                        }
                    }
                }, 5000);
            }
        }

        function stopVoiceCommands() {
            console.log('üõë Stopping voice commands...');
            voiceCommandsEnabled = false;
            voiceCommandActive = false;
            
            if (voiceCommandRecognition) {
                try {
                    voiceCommandRecognition.abort();
                } catch (e) {}
            }
            
            updateVoiceCommandStatus('inactive');
        }

        // === VOICE COMMAND PROCESSING ===
        function isVoiceCommand(phrase) {
            const variations = ['hey leslie', 'hey lesly', 'hey lesley', 'leslie', 'lesly', 'lesley'];
            return variations.some(variation => phrase.includes(variation));
        }

        function processVoiceCommand(phrase, silent = false) {
            const currentTime = Date.now();
            
            // Prevent duplicate commands
            if (phrase === lastVoiceCommand && (currentTime - lastVoiceCommandTime) < 3000) {
                console.log('üö´ Duplicate command ignored');
                setTimeout(() => updateVoiceCommandStatus('ready'), 500);
                return;
            }
            
            lastVoiceCommand = phrase;
            lastVoiceCommandTime = currentTime;
            
            const command = extractCommand(phrase);
            executeVoiceCommand(command, silent);
        }

        function extractCommand(phrase) {
            const variations = ['hey leslie', 'hey lesly', 'hey lesley'];
            
            for (const variation of variations) {
                if (phrase.includes(variation)) {
                    return phrase.split(variation)[1].trim();
                }
            }
            
            // Check for just "leslie" at start
            const simpleVariations = ['leslie', 'lesly', 'lesley'];
            for (const variation of simpleVariations) {
                if (phrase.startsWith(variation)) {
                    return phrase.substring(variation.length).trim();
                }
            }
            
            return '';
        }

        function executeVoiceCommand(cmd, silent = false) {
            console.log('üéØ Executing command:', cmd, silent ? '(silent)' : '');
            
            // Navigation commands
            if (cmd.includes('home')) {
                showPage('home');
                if (!silent) speakResponse('Going to home page');
                return;
            }
            
            if (cmd.includes('start talking') || cmd.includes('speech') || cmd.includes('talking')) {
                showPage('speech');
                if (!silent) speakResponse('Starting speech recognition');
                return;
            }
            
            if (cmd.includes('start texting') || cmd.includes('text') || cmd.includes('texting')) {
                showPage('textInput');
                if (!silent) speakResponse('Opening text input');
                return;
            }
            
            if (cmd.includes('phone') || cmd.includes('contact')) {
                showPage('phone');
                if (!silent) speakResponse('Opening contacts');
                return;
            }
            
            if (cmd.includes('settings')) {
                showPage('settings');
                if (!silent) speakResponse('Opening settings');
                return;
            }
            
            if (cmd.includes('help') || cmd.includes('commands')) {
                showPage('commands');
                if (!silent) speakResponse('Showing voice commands');
                return;
            }
            
            // Weather commands
            if (cmd.includes('weather') && !cmd.includes('close')) {
                showCurrentWeather();
                if (!silent) speakResponse('Showing current weather');
                return;
            }
            
            if (cmd.includes('hourly')) {
                showHourlyWeather();
                if (!silent) speakResponse('Showing hourly forecast');
                return;
            }
            
            if (cmd.includes('weekly') || cmd.includes('7 day')) {
                showWeeklyWeather();
                if (!silent) speakResponse('Showing weekly forecast');
                return;
            }
            
            if (cmd.includes('close')) {
                hideWeather();
                if (!silent) speakResponse('Closing weather');
                return;
            }
            
            // Speech settings
            if (cmd.includes('speak faster')) {
                adjustSpeechSpeed(0.2);
                if (!silent) speakResponse('Speech speed increased');
                return;
            }
            
            if (cmd.includes('speak slower')) {
                adjustSpeechSpeed(-0.2);
                if (!silent) speakResponse('Speech speed decreased');
                return;
            }
            
            if (cmd.includes('pause more')) {
                adjustPauseBetweenWords(0.3);
                if (!silent) speakResponse('Pause between words increased');
                return;
            }
            
            if (cmd.includes('pause less')) {
                adjustPauseBetweenWords(-0.3);
                if (!silent) speakResponse('Pause between words decreased');
                return;
            }
            
            // Recognition commands
            if (cmd.includes('enhanced mode on')) {
                updateEnhancedMode(true);
                if (!silent) speakResponse('Enhanced mode enabled');
                return;
            }
            
            if (cmd.includes('enhanced mode off')) {
                updateEnhancedMode(false);
                if (!silent) speakResponse('Enhanced mode disabled');
                return;
            }
            
            if (cmd.includes('stop listening')) {
                stopListening();
                if (!silent) speakResponse('Stopping speech recognition');
                return;
            }
            
            // Unknown command
            if (!silent) speakResponse('I did not understand that command');
            setTimeout(() => updateVoiceCommandStatus('ready'), 1000);
        }

        function speakResponse(text) {
            if (!settings.speakVoiceCommands) {
                updateVoiceCommandStatus('ready');
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = settings.speechSpeed || 1.0;
            utterance.volume = 0.8;
            utterance.lang = 'en-US';
            
            let hasEnded = false;
            const finishResponse = () => {
                if (hasEnded) return;
                hasEnded = true;
                setTimeout(() => updateVoiceCommandStatus('ready'), 500);
            };
            
            utterance.onend = finishResponse;
            utterance.onerror = finishResponse;
            
            speechSynth.speak(utterance);
        }

        function updateVoiceCommandStatus(status) {
            const statusEl = document.getElementById('voiceCommandStatus');
            if (!statusEl) return;
            
            statusEl.className = 'voice-command-status';
            
            switch (status) {
                case 'ready':
                    statusEl.classList.add('ready');
                    statusEl.textContent = 'üü¢ "Hey Leslie" Ready';
                    statusEl.style.display = 'block';
                    break;
                case 'processing':
                    statusEl.classList.add('processing');
                    statusEl.textContent = 'üü° Processing Command...';
                    statusEl.style.display = 'block';
                    break;
                case 'permission-needed':
                    statusEl.classList.add('permission-needed');
                    statusEl.textContent = 'üî¥ Click to Allow Microphone';
                    statusEl.style.display = 'block';
                    statusEl.style.cursor = 'pointer';
                    statusEl.onclick = requestMicrophonePermission;
                    break;
                default:
                    statusEl.textContent = '‚ö´ Voice Commands Off';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'rgba(128, 128, 128, 0.9)';
                    statusEl.style.color = 'white';
                    statusEl.style.cursor = 'default';
                    statusEl.onclick = null;
            }
        }

        // === UI FUNCTIONS ===
        function showPage(pageId) {
            console.log('üìÑ Showing page:', pageId);
            
            // Handle leaving speech page
            if (currentPage === 'speech' && pageId !== 'speech') {
                console.log('üßπ Leaving speech page - stopping speech recognition');
                stopListening();
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            // Show target page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                // Handle entering speech page
                if (pageId === 'speech') {
                    console.log('üìÑ Entering speech page - starting automatic listening');
                    
                    const textEl = document.getElementById('recognizedText');
                    if (textEl) {
                        textEl.innerHTML = '<div style="color: #0099cc; font-weight: bold; text-align: center; padding: 20px;">üé§ Starting automatic listening...</div>';
                    }
                    
                    updateStatus('üé§ Starting automatic listening...');
                    updateListenButton();
                    
                    // Auto-start listening after short delay
                    setTimeout(() => {
                        if (currentPage === 'speech') {
                            startListening();
                        }
                    }, 1000);
                }
                
                if (pageId === 'phone') {
                    displayContactsOnPhonePage();
                }
                
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textField = document.getElementById('largeTextInputField');
                        if (textField) textField.focus();
                    }, 300);
                }
            }
        }

        function toggleListening() {
            if (isMainListening || shouldKeepListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function updateListenButton() {
            const button = document.getElementById('listenButton');
            if (button) {
                if (isMainListening || shouldKeepListening) {
                    button.textContent = 'STOP LISTENING';
                    button.className = 'control-btn btn-stop';
                } else {
                    button.textContent = 'START TALKING';
                    button.className = 'control-btn btn-listen';
                }
            }
        }

        function updateStatus(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) {
                statusEl.textContent = message;
                console.log('üìù Status:', message);
            }
        }

        function clearSpeechText() {
            console.log('üóëÔ∏è Clearing speech display');
            
            const textEl = document.getElementById('recognizedText');
            if (textEl) {
                if (shouldKeepListening && speechSessionActive) {
                    textEl.innerHTML = '<div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">üé§ Ready for your next phrase...</div>';
                } else {
                    textEl.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Ready for speech recognition...</div>';
                }
            }
        }

        // === TEXT INPUT FUNCTIONS ===
        function speakTextInput() {
            const textField = document.getElementById('largeTextInputField');
            if (textField && textField.value.trim()) {
                speakText(textField.value.trim(), true);
            }
        }

        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            const textField = document.getElementById('largeTextInputField');
            
            if (speakBtn && textField) {
                if (textField.value.trim()) {
                    speakBtn.disabled = false;
                    speakBtn.style.opacity = '1';
                    speakBtn.style.backgroundColor = '#9933cc';
                } else {
                    speakBtn.disabled = true;
                    speakBtn.style.opacity = '0.5';
                    speakBtn.style.backgroundColor = '#ccc';
                }
            }
        }

        // === CONTACTS ===
        function initializeContacts() {
            contacts = [
                { name: 'Emergency Services', phone: '911' },
                { name: 'Demo Contact 1', phone: '(555) 123-4567' },
                { name: 'Demo Contact 2', phone: '(555) 987-6543' },
                { name: 'Demo Contact 3', phone: '(555) 246-8135' }
            ];
            filteredContacts = contacts.slice();
        }

        async function loadAllContacts() {
            const contactsList = document.getElementById('contactsList');
            const loadingSection = document.getElementById('contactLoadingSection');
            
            if (loadingSection) loadingSection.style.display = 'none';
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px; border: 2px solid #669900;">
                        <p><strong>üìû LOADING ALL CONTACTS</strong></p>
                        <p style="margin: 10px 0;">Opening contact picker...</p>
                    </div>
                `;
            }
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList && contactList.length > 0) {
                        const processedContacts = [];
                        contactList.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            const contactName = names[0] || 'Unknown Contact';
                            
                            if (phones.length > 0) {
                                phones.forEach((phone, phoneIndex) => {
                                    processedContacts.push({
                                        name: phones.length > 1 ? `${contactName} (${phoneIndex + 1})` : contactName,
                                        phone: phone
                                    });
                                });
                            } else {
                                processedContacts.push({
                                    name: contactName,
                                    phone: 'No phone number'
                                });
                            }
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        throw new Error('No contacts selected');
                    }
                } else {
                    throw new Error('Contacts API not supported on this device/browser');
                }
            } catch (error) {
                handleContactLoadingError(error, contactsList);
            }
        }

        async function loadSelectedContacts() {
            const contactsList = document.getElementById('contactsList');
            const loadingSection = document.getElementById('contactLoadingSection');
            
            if (loadingSection) loadingSection.style.display = 'none';
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: #0099cc; background: #f0f8ff; border-radius: 8px;">
                        <p><strong>üìã Choose Specific Contacts</strong></p>
                        <p>‚è≥ Opening contact picker...</p>
                    </div>
                `;
            }
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList.length > 0) {
                        const processedContacts = contactList.map(contact => {
                            const name = (contact.name && contact.name[0]) ? contact.name[0] : 'Unknown';  
                            const phone = (contact.tel && contact.tel[0]) ? contact.tel[0] : 'No phone';
                            return { name, phone };
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) => 
                            index === self.findIndex(c => c.name === contact.name && c.phone === contact.phone)
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        if (contactsList) {
                            contactsList.innerHTML = `
                                <div style="padding: 20px; text-align: center; color: #ff6600; border: 2px solid #ff6600; border-radius: 8px;">
                                    <p><strong>üì± No Contacts Selected</strong></p>
                                    <p>Demo contacts remain available</p>
                                </div>
                            `;
                        }
                        setTimeout(() => displayContactsOnPhonePage(), 3000);
                    }
                } else {
                    throw new Error('Contacts API not supported on this device/browser');
                }
            } catch (error) {
                handleContactLoadingError(error, contactsList);
            }
        }

        function handleContactLoadingError(error, contactsList) {
            let errorMessage = '';
            if (error.name === 'NotAllowedError') {
                errorMessage = `<p><strong>üì± Permission Denied</strong></p><p>You denied contact access</p>`;
            } else if (error.name === 'AbortError') {
                errorMessage = `<p><strong>üì± Contact Selection Cancelled</strong></p>`;
            } else if (error.message.includes('not supported')) {
                errorMessage = `<p><strong>üì± Contacts API Not Supported</strong></p><p>Requires Chrome Android or Safari iOS</p>`;
            } else {
                errorMessage = `<p><strong>üì± Contact Loading Error</strong></p><p>${error.message || 'Unknown error'}</p>`;
            }
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px;">
                        ${errorMessage}
                        <p style="margin-top: 15px;">Demo contacts will remain available</p>
                    </div>
                `;
            }
            
            setTimeout(() => displayContactsOnPhonePage(), 4000);
        }

        function displayRealContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';

            const successHeader = document.createElement('div');
            successHeader.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: white; background: #28a745; border-radius: 8px; margin-bottom: 8px;';
            successHeader.innerHTML = `‚úÖ SUCCESS: ${filteredContacts.length} REAL contacts loaded!`;
            contactsList.appendChild(successHeader);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.style.backgroundColor = '#e8f5e8';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });

            const footerNote = document.createElement('div');
            footerNote.style.cssText = 'padding: 8px; text-align: center; font-size: 12px; color: #28a745; font-weight: bold; margin-top: 8px;';
            footerNote.textContent = 'üì± These are YOUR real contacts - searchable and callable!';
            contactsList.appendChild(footerNote);
        }

        function displayContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><p><strong>üì± No contacts found</strong></p></div>';
                return;
            }

            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: #669900; background: #f0f8ff; border-radius: 8px; margin-bottom: 8px;';
            headerDiv.textContent = `üì± ${filteredContacts.length} contacts available - Tap any contact to call`;
            contactsList.appendChild(headerDiv);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });
        }

        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    return contact.name.toLowerCase().includes(searchLower) ||
                           contact.phone.replace(/[^0-9]/g, '').includes(searchTerm.replace(/[^0-9]/g, ''));
                });
            }
            displayContactsOnPhonePage();
        }

        function callContact(contact) {
            const phoneNumber = contact.phone.replace(/[^0-9]/g, '');
            if (phoneNumber) {
                window.location.href = `tel:${phoneNumber}`;
            }
        }

        // === WEATHER ===
        function getUserLocation() {
            userLocation = { lat: 38.8117, lon: -90.8529 }; // Wentzville, MO
            console.log('üìç Using default location');
        }

        async function showCurrentWeather() {
            showWeatherDisplay('Current Weather', 'Loading current weather...');
            
            try {
                const { lat, lon } = userLocation || { lat: 40.7128, lon: -74.0060 };
                
                const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const weatherData = await weatherResponse.json();
                
                let cityName = 'Your Location';
                try {
                    const locationResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                    const locationData = await locationResponse.json();
                    
                    if (locationData.city) {
                        cityName = locationData.city;
                    } else if (locationData.locality) {
                        cityName = locationData.locality;
                    }
                } catch (locationError) {
                    console.log('Could not get location name:', locationError);
                }
                
                const temperature = Math.round(weatherData.current.temperature_2m * 9/5 + 32);
                const humidity = weatherData.current.relative_humidity_2m;
                const windSpeed = Math.round(weatherData.current.wind_speed_10m * 0.621371);
                const conditions = getWeatherDescription(weatherData.current.weather_code);
                
                const weatherContent = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 16px; font-weight: bold; color: #0099cc; margin-bottom: 8px;">üìç ${cityName}</div>
                        <div style="font-size: 28px; font-weight: bold; color: #0099cc; margin-bottom: 8px;">${temperature}¬∞F</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">${conditions}</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <div><strong>Humidity:</strong> ${humidity}%</div>
                            <div><strong>Wind:</strong> ${windSpeed} mph</div>
                        </div>
                    </div>
                `;
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = weatherContent;
            } catch (error) {
                console.error('Weather error:', error);
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load weather data.</div>';
            }
        }

        async function showHourlyWeather() {
            showWeatherDisplay('Next 24 Hours', 'Loading 24-hour forecast...');
            
            try {
                const { lat, lon } = userLocation || { lat: 38.8117, lon: -90.8529 };
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=2`);
                const data = await response.json();
                
                const now = new Date();
                const currentHour = now.getHours();
                
                let hourlyData = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 4px; padding: 10px; max-height: 400px; overflow-y: auto;">';
                
                let startIndex = 0;
                for (let i = 0; i < data.hourly.time.length; i++) {
                    const timeDate = new Date(data.hourly.time[i]);
                    if (timeDate.getHours() === currentHour && 
                        timeDate.getDate() === now.getDate()) {
                        startIndex = i;
                        break;
                    }
                }
                
                for (let i = startIndex; i < Math.min(startIndex + 24, data.hourly.time.length); i++) {
                    const time = new Date(data.hourly.time[i]);
                    const hour = time.getHours();
                    const temp = Math.round(data.hourly.temperature_2m[i] * 9/5 + 32);
                    const weatherCode = data.hourly.weather_code[i];
                    const conditions = getWeatherDescription(weatherCode);
                    
                    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    
                    const isCurrent = i === startIndex;
                    const timeDisplay = isCurrent ? 'NOW' : `${displayHour}${ampm}`;
                    const bgColor = isCurrent ? '#0099cc' : '#f0f8ff';
                    const textColor = isCurrent ? 'white' : 'black';
                    
                    hourlyData += `
                        <div class="hourly-item" style="background-color: ${bgColor}; color: ${textColor}; padding: 6px; text-align: center; font-size: 10px; border-radius: 4px;">
                            <div style="font-weight: bold; font-size: 11px;">${timeDisplay}</div>
                            <div style="font-size: 12px; font-weight: bold; margin: 2px 0;">${temp}¬∞</div>
                            <div style="font-size: 9px; opacity: 0.9; line-height: 1.1;">${conditions}</div>
                        </div>
                    `;
                }
                hourlyData += '</div>';
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = hourlyData;
            } catch (error) {
                console.error('Hourly weather error:', error);
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load 24-hour forecast.</div>';
            }
        }

        async function showWeeklyWeather() {
            showWeatherDisplay('7-Day Forecast', 'Loading 7-day forecast...');
            
            try {
                const { lat, lon } = userLocation || { lat: 40.7128, lon: -74.0060 };
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7`);
                const data = await response.json();
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                let weeklyData = '<div style="display: grid; gap: 6px; padding: 10px;">';
                
                for (let i = 0; i < Math.min(7, data.daily.time.length); i++) {
                    const date = new Date(data.daily.time[i]);
                    const dayName = days[date.getDay()];
                    const high = Math.round(data.daily.temperature_2m_max[i] * 9/5 + 32);
                    const low = Math.round(data.daily.temperature_2m_min[i] * 9/5 + 32);
                    const conditions = getWeatherDescription(data.daily.weather_code[i]);
                    
                    weeklyData += `
                        <div class="weekly-item">
                            <div class="day-name">${dayName}</div>
                            <div class="day-temps">${high}¬∞/${low}¬∞</div>
                            <div class="day-condition">${conditions}</div>
                        </div>
                    `;
                }
                weeklyData += '</div>';
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = weeklyData;
            } catch (error) {
                console.error('Weekly weather error:', error);
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load 7-day forecast.</div>';
            }
        }

        function showWeatherDisplay(title, content) {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            if (weatherTitle) weatherTitle.textContent = title;
            if (weatherContent) weatherContent.innerHTML = `<div style="text-align: center; padding: 20px;">${content}</div>`;
            if (weatherDisplay) weatherDisplay.classList.remove('hidden');
        }

        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            if (weatherDisplay) {
                weatherDisplay.classList.add('hidden');
                console.log('‚úÖ Weather display hidden');
            }
        }

        function getWeatherDescription(code) {
            const weatherCodes = {
                0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog',
                51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Thunderstorm with heavy hail'
            };
            return weatherCodes[code] || 'Unknown';
        }

        // === SWIPE GESTURES ===
        function setupSwipeGestures() {
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            
            let touchStartX = 0;
            let touchStartY = 0;
            const minSwipeDistance = 50;

            if (swipeBottom) {
                swipeBottom.addEventListener('touchstart', function(e) {
                    touchStartY = e.changedTouches[0].clientY;
                    e.preventDefault();
                }, { passive: false });

                swipeBottom.addEventListener('touchend', function(e) {
                    const touchEndY = e.changedTouches[0].clientY;
                    const swipeDistance = touchStartY - touchEndY;
                    if (swipeDistance > minSwipeDistance) {
                        showCurrentWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }

            if (swipeLeft) {
                swipeLeft.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].clientX;
                    e.preventDefault();
                }, { passive: false });

                swipeLeft.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].clientX;
                    const swipeDistance = touchEndX - touchStartX;
                    if (swipeDistance > minSwipeDistance) {
                        showHourlyWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }

            if (swipeRight) {
                swipeRight.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].clientX;
                    e.preventDefault();
                }, { passive: false });

                swipeRight.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].clientX;
                    const swipeDistance = touchStartX - touchEndX;
                    if (swipeDistance > minSwipeDistance) {
                        showWeeklyWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }
        }

        // === SETTINGS ===
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) {
                    Object.assign(settings, JSON.parse(savedSettings));
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            updateSettingsUI();
        }

        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        function updateSettingsUI() {
            const elements = {
                speedSlider: document.getElementById('speechSpeedSlider'),
                pauseSlider: document.getElementById('pauseBetweenWordsSlider'),
                voiceSwitch: document.getElementById('speakVoiceCommandsSwitch'),
                enhancedSwitch: document.getElementById('autoEnhancedSwitch'),
                enhancedModeSwitch: document.getElementById('enhancedModeSwitch'),
                apiKeyInput: document.getElementById('apiKeyInput')
            };

            if (elements.speedSlider) elements.speedSlider.value = settings.speechSpeed;
            if (elements.pauseSlider) elements.pauseSlider.value = settings.pauseBetweenWords;
            if (elements.voiceSwitch) elements.voiceSwitch.checked = settings.speakVoiceCommands;
            if (elements.enhancedSwitch) elements.enhancedSwitch.checked = settings.autoEnhanced;
            if (elements.enhancedModeSwitch) elements.enhancedModeSwitch.checked = settings.enhancedMode;
            if (elements.apiKeyInput) elements.apiKeyInput.value = settings.apiKey;

            updateSpeechSpeed(settings.speechSpeed);
            updatePauseBetweenWords(settings.pauseBetweenWords);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateAutoEnhanced(settings.autoEnhanced);
            updateEnhancedMode(settings.enhancedMode);
        }

        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            const slider = document.getElementById('speechSpeedSlider');
            
            if (label) {
                const formattedValue = Math.round(parseFloat(value) * 10) / 10;
                label.textContent = formattedValue === 1.0 ? 'Normal (1.0x)' : formattedValue + 'x';
            }
            if (slider) {
                slider.value = value;
            }
            saveSettings();
        }

        function updatePauseBetweenWords(value) {
            settings.pauseBetweenWords = parseFloat(value);
            const label = document.getElementById('pauseBetweenWordsValue');
            const slider = document.getElementById('pauseBetweenWordsSlider');
            
            if (label) {
                const formattedValue = Math.round(parseFloat(value) * 10) / 10;
                label.textContent = formattedValue + ' seconds';
            }
            if (slider) {
                slider.value = value;
            }
            
            saveSettings();
        }

        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            const switchEl = document.getElementById('speakVoiceCommandsSwitch');
            
            if (label) {
                label.textContent = 'Speak Voice Commands: ' + (checked ? 'ON' : 'OFF');
            }
            if (switchEl) {
                switchEl.checked = checked;
            }
            saveSettings();
        }

        function updateAutoEnhanced(checked) {
            settings.autoEnhanced = checked;
            saveSettings();
        }

        function updateEnhancedMode(checked) {
            settings.enhancedMode = checked;
            const label = document.getElementById('enhancedModeLabel');
            const switchEl = document.getElementById('enhancedModeSwitch');
            
            if (label) {
                label.textContent = 'Enhanced Mode: ' + (checked ? 'ON' : 'OFF');
            }
            if (switchEl) {
                switchEl.checked = checked;
            }
            saveSettings();
        }

        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }

        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
            } else if (enhancedSection) {
                enhancedSection.classList.remove('show');
            }
        }

        function startEnhancedRecognition() {
            if (!settings.apiKey) {
                alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
                showPage('settings');
                return;
            }
            alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
        }

        function adjustSpeechSpeed(delta) {
            const newSpeed = Math.max(0.5, Math.min(2.0, settings.speechSpeed + delta));
            updateSpeechSpeed(newSpeed);
        }

        function adjustPauseBetweenWords(delta) {
            const newPause = Math.max(0.5, Math.min(4.0, settings.pauseBetweenWords + delta));
            updatePauseBetweenWords(newPause);
        }

        // === EVENT HANDLERS ===
        function setupEventHandlers() {
            // Navigation buttons
            const navigationButtons = [
                { id: 'btnStartTalking', page: 'speech' },
                { id: 'btnStartTexting', page: 'textInput' },
                { id: 'btnPhoneCall', page: 'phone' },
                { id: 'btnCommands', page: 'commands' },
                { id: 'btnSettings', page: 'settings' }
            ];
            
            navigationButtons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    element.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showPage(btn.page);
                    };
                }
            });
            
            // Close buttons
            const closeButtons = [
                'btnCloseSpeech', 'btnClosePhone', 'btnCloseCommands', 'btnCloseText', 'btnCloseSettings'
            ];
            
            closeButtons.forEach(btnId => {
                const element = document.getElementById(btnId);
                if (element) {
                    element.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showPage('home');
                    };
                }
            });
            
            // Home buttons
            const homeButtons = ['btnPhoneHome', 'btnTextHome', 'btnSettingsHome', 'btnCommandsHome'];
            homeButtons.forEach(btnId => {
                const element = document.getElementById(btnId);
                if (element) {
                    element.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showPage('home');
                    };
                }
            });
            
            // Speech page controls
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                listenButton.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleListening();
                };
            }
            
            const clearButton = document.getElementById('clearButton');
            if (clearButton) {
                clearButton.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    clearSpeechText();
                };
            }
            
            // Text input functionality
            const speakTextBtn = document.getElementById('speakTextBtn');
            if (speakTextBtn) {
                speakTextBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    speakTextInput();
                };
            }
            
            const textInputField = document.getElementById('largeTextInputField');
            if (textInputField) {
                textInputField.addEventListener('input', updateTextSpeakButton);
            }
            
            // Contact functionality
            const contactSearchInput = document.getElementById('contactSearchInput');
            if (contactSearchInput) {
                contactSearchInput.addEventListener('input', (e) => {
                    filterContacts(e.target.value);
                });
            }
            
            const loadAllBtn = document.getElementById('loadAllContactsBtn');
            const loadSelectedBtn = document.getElementById('loadSelectedContactsBtn');
            
            if (loadAllBtn) {
                loadAllBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    loadAllContacts();
                };
            }
            
            if (loadSelectedBtn) {
                loadSelectedBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    loadSelectedContacts();
                };
            }
            
            // Settings
            const settingsElements = [
                {id: 'apiKeyInput', event: 'change', handler: (e) => saveApiKey(e.target.value)},
                {id: 'speechSpeedSlider', event: 'input', handler: (e) => updateSpeechSpeed(e.target.value)},
                {id: 'pauseBetweenWordsSlider', event: 'input', handler: (e) => updatePauseBetweenWords(e.target.value)},
                {id: 'speakVoiceCommandsSwitch', event: 'change', handler: (e) => updateVoiceCommandSetting(e.target.checked)},
                {id: 'autoEnhancedSwitch', event: 'change', handler: (e) => updateAutoEnhanced(e.target.checked)},
                {id: 'enhancedModeSwitch', event: 'change', handler: (e) => updateEnhancedMode(e.target.checked)}
            ];
            
            settingsElements.forEach(setting => {
                const element = document.getElementById(setting.id);
                if (element) element.addEventListener(setting.event, setting.handler);
            });
        }

        // === INITIALIZATION ===
        function initApp() {
            console.log('üöÄ Initializing Leslie Speech Assistant...');
            
            if (isInitialized) {
                console.log('‚ö†Ô∏è App already initialized');
                return;
            }
            
            try {
                // Check browser support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.error('‚ùå Speech recognition not supported');
                    return;
                }
                
                console.log('‚úÖ Speech Recognition supported');
                
                // Initialize components
                loadSettings();
                setupEventHandlers();
                initializeContacts();
                setupSwipeGestures();
                getUserLocation();
                updateEnhancedSectionVisibility();
                updateTextSpeakButton();
                
                isInitialized = true;
                console.log('‚úÖ Leslie initialized successfully');
                
                // Start voice commands after delay to prevent immediate pinging
                setTimeout(() => {
                    if (!voiceCommandActive) {
                        startVoiceCommands();
                    }
                }, 2000); // 2 second delay
                
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
            }
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing...');
            initApp();
        });

        window.addEventListener('load', function() {
            if (!isInitialized) {
                console.log('üîÑ Window loaded - backup initialization...');
                initApp();
            }
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üîá Page hidden - pausing voice commands');
                if (voiceCommandRecognition && voiceCommandActive) {
                    try {
                        voiceCommandRecognition.abort();
                    } catch (e) {}
                }
            } else {
                console.log('üîá Page visible - restarting voice commands');
                if (!voiceCommandActive) {
                    setTimeout(() => {
                        if (!voiceCommandActive) {
                            startVoiceCommands();
                        }
                    }, 1000);
                }
            }
        });

        // === GLOBAL FUNCTIONS FOR INLINE HANDLERS ===
        window.showCurrentWeather = showCurrentWeather;
        window.showHourlyWeather = showHourlyWeather;
        window.showWeeklyWeather = showWeeklyWeather;
        window.hideWeather = hideWeather;
    </script>
</body>
</html>
