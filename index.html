<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        html, body {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: Arial, sans-serif;
            background: #fff;
            color: #111;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            position: relative;
            background: #fff;
        }
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0 8px 0;
            margin-bottom: 12px;
            background: #fff;
            border-bottom: 1.5px solid #e2e2e2;
        }
        .header h1 {
            flex-grow: 1;
            font-size: 25px;
            color: #0099cc;
            font-weight: bold;
            margin: 0;
            text-align: center;
            letter-spacing: 1px;
        }
        .settings-btn {
            width: 46px; height: 46px;
            background: transparent; border: none; cursor: pointer; border-radius: 50%; font-size: 20px;
        }
        .settings-btn:hover { background: #f0f0f0; }
        /* Home Page */
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .main-buttons-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            margin-bottom: 18px;
        }
        .main-button {
            width: 99vw;
            max-width: 340px;
            height: 66px;
            font-size: 19px;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 9px;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            cursor: pointer;
            display: block;
            transition: box-shadow 0.15s, transform 0.13s;
        }
        .main-button:active { transform: translateY(1px);}
        .btn-talking { background: #0099cc; }
        .btn-texting { background: #9933cc; }
        .btn-phone { background: #669900; }
        .btn-commands { background: #ff8800; }
        .tips-box {
            background: #f4f8fa;
            border-radius: 8px;
            padding: 13px 11px;
            font-size: 14px;
            color: #444;
            margin: 0 auto;
            max-width: 375px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.04);
        }
        /* Speech Page */
        .speech-page {
            display: flex;
            flex-direction: column;
            min-height: 79vh;
            padding: 0 0 12px 0;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 14px 8px 12px 8px;
            color: #fff;
            margin-bottom: 3px;
            border-radius: 7px;
        }
        .header-speech { background: #0099cc;}
        .header-phone { background: #669900;}
        .header-commands { background: #ff8800;}
        .header-text { background: #9933cc;}
        .header-settings { background: #0099cc;}
        .close-btn {
            width: 44px; height: 44px; background: transparent; border: none;
            color: #fff; cursor: pointer; border-radius: 50%; font-size: 24px;
            margin-left: 8px;
        }
        .close-btn:hover { background: rgba(255,255,255,0.16);}
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 14px;
            min-height: 45px;
            display: flex; align-items: center; justify-content: center;
        }
        .speech-display {
            border: 2px solid #e8e8e8;
            border-radius: 7px;
            padding: 8px;
            margin: 0 auto 12px auto;
            width: 98%; max-width: 390px;
            background: #fcfcfc;
        }
        .speech-header {
            background: #f6f6f6;
            padding: 6px 8px;
            font-size: 13px;
            font-weight: bold;
            color: #0099cc;
            border-radius: 5px 5px 0 0;
        }
        .speech-content { padding: 13px 7px 10px 7px; min-height: 43px;}
        .speech-text { font-size: 16px; line-height: 1.5; color: #000; }
        .current-phrase {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 3px;
            border-left: 4px solid #0099cc;
            font-size: 16px;
            font-weight: bold;
            word-break: break-word;
        }
        .control-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            margin-top: 12px;
        }
        .control-btn {
            min-width: 200px; max-width: 350px;
            height: 62px;
            font-size: 19px;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 9px rgba(0,0,0,0.10);
            display: block;
            margin: 0 auto;
            background: #0099cc;
            transition: background 0.13s;
        }
        .btn-listen { background: #0099cc;}
        .btn-stop { background: #cc0000;}
        .btn-disabled { background: #ccc !important; cursor: not-allowed !important;}
        /* No trash icon! */
        /* Text Input Page */
        .text-input-page { min-height: 85vh; display: flex; flex-direction: column;}
        .page-header.header-text { margin-bottom: 8px;}
        .text-input-content { flex-grow: 1; padding: 0 9px 0 9px; }
        .speak-row {
            display: flex; justify-content: flex-end; align-items: center;
            margin-top: 16px; margin-bottom: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 8px 18px 8px 18px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin: 0 0 0 0;
            box-shadow: 0 1.5px 6px rgba(153,51,204,0.10);
            transition: background 0.12s;
        }
        .speak-phrase-btn:disabled {
            background: #9933cc;
            color: #fff;
            opacity: 1;
            cursor: pointer;
        }
        .large-text-input {
            width: 99%;
            padding: 18px;
            margin: 0 0 0 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 260px; /* ENLARGED as requested */
            max-height: 420px;
            box-sizing: border-box;
        }
        .text-input-content .btn-home { margin-top: 21px;}
        /* Phone Page */
        .contact-search-section {
            padding: 11px 7px 4px 7px;
            background: #f0f0f0;
            border-radius: 0 0 9px 9px;
        }
        .contact-search-input {
            width: 100%; height: 42px; padding: 9px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 4px;
        }
        .contacts-list {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 8px;
            min-height: 75px; max-height: 340px;
            overflow-y: auto;
            background: #fff;
            margin-bottom: 7px;
        }
        .contact-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.18s;
        }
        .contact-item:hover {
            background: #e5ffe5;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        /* Leslie Commands Page */
        .commands-content {
            padding: 18px 12px;
            max-width: 470px;
            margin: 0 auto;
            background: #fff;
        }
        .command-list {
            background: #f7f7ff;
            border-radius: 8px;
            box-shadow: 0 2px 7px rgba(102,51,204,0.07);
            padding: 13px 16px;
        }
        .command-list-item {
            margin-bottom: 9px;
            font-size: 15px;
        }
        .command-key {
            font-weight: bold; color: #9933cc;
        }
        .command-desc {
            color: #111;
        }
        /* Settings Page: Grouped Card Styles */
        .settings-section {
            background: #f6fafd;
            border-radius: 11px;
            border: 1.5px solid #e0e9ee;
            padding: 15px 14px 12px 14px;
            margin-bottom: 16px;
            box-shadow: 0 1.5px 6px rgba(0,153,204,0.03);
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 5px;
        }
        .settings-description {
            font-size: 12px;
            color: #555;
            margin-bottom: 11px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 7px;
        }
        .setting-value {
            text-align: right;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
            margin-top: 0;
        }
        .switch { display: flex; align-items: center; margin-bottom: 0;}
        .switch input { margin-right: 8px; transform: scale(1.4);}
        .back-btn {
            width: 200px; height: 52px;
            background: #0099cc; color: #fff;
            border: none; border-radius: 8px;
            font-size: 18px; font-weight: bold;
            cursor: pointer;
            margin: 14px auto 17px;
            display: block;
        }
        /* Weather Modal */
        .weather-display {
            background: #f0f8ff;
            border: 2px solid #0099cc;
            border-radius: 8px;
            padding: 20px;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 93%; max-width: 430px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
        }
        .weather-title {
            font-size: 22px; font-weight: bold; color: #0099cc; margin-bottom: 13px; text-align: center;
        }
        .weather-content { font-size: 18px; line-height: 1.7;}
        .weather-controls { display: flex; gap: 8px; justify-content: center; margin-top: 19px; flex-wrap: wrap;}
        .weather-btn {
            padding: 10px 15px;
            background: #0099cc;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
        }
        .weather-btn.active { background: #006699; }
        .hourly-forecast { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0;}
        .hourly-item { background: rgba(255,255,255,0.8); padding: 8px; border-radius: 4px; font-size: 16px;}
        .weekly-forecast { margin: 8px 0;}
        .weekly-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.79); padding: 10px; margin: 4px 0;
            border-radius: 4px; font-size: 16px;
        }
        .day-name { font-weight: bold; width: 100px;}
        .day-temps { font-weight: bold;}
        .day-condition { color: #666; text-align: right; flex-grow: 1; margin-left: 8px;}
        /* Swipe Detection Areas */
        .swipe-edge { position: fixed; z-index: 998; pointer-events: auto;}
        .swipe-bottom { bottom: 0; left: 27%; right: 27%; height: 14px;}
        .swipe-left { left: 0; top: 24%; bottom: 24%; width: 12px;}
        .swipe-right { right: 0; top: 24%; bottom: 24%; width: 12px;}
        .hidden { display: none;}
        @media (max-width: 700px) {
            .container { padding: 0;}
            .main-button { max-width: 99vw; }
            .contacts-list { max-height: 205px;}
            .weather-display { padding: 9px; }
        }
    </style>
</head>
<body>
    <!-- YOUR FULL HTML (all page sections) GOES HERE UNCHANGED (as in your original) -->
    <!-- ... -->
    <!-- Do NOT cut anything from your original structure! -->
    <!-- At the bottom, before </body>, paste the full JS below -->
<script>
let recognition = null;
let isListening = false;
let speechSynth = window.speechSynthesis;
let currentPage = 'home';
let pageHistory = ['home'];
let contacts = [];
let filteredContacts = [];
let currentPhrase = '';
let isSpeaking = false;
let phraseHistory = [];
let silenceTimeout = null;
let voiceCommandRecognition = null;
let microphonePermissionGranted = false;

// Settings object
let settings = {
    speechSpeed: 1.0,
    pauseBetweenWords: 1.0,
    speakVoiceCommands: true,
};

// ------- PAGE NAVIGATION / BUTTONS -------
function showPage(pageId, addToHistory = true) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const pageEl = document.getElementById(pageId + 'Page');
    if (pageEl) {
        pageEl.classList.add('active');
        currentPage = pageId;
        if (addToHistory) {
            pageHistory.push(pageId);
            if (window.history && window.history.pushState) {
                window.history.pushState({page: pageId}, '', '');
            }
        }
        // Home resets all
        if (pageId === 'home') stopListening();
        if (pageId === 'speech') {
            updateCurrentPhraseDisplay();
            updateStatus('Ready to listen - Click "START TALKING" below');
        }
        if (pageId === 'textInput') {
            setTimeout(() => {
                const txt = document.getElementById('largeTextInputField');
                if (txt) { txt.value = ''; txt.focus(); updateTextSpeakButton(); }
            }, 200);
            enableTextSpeakButton();
        }
        if (pageId === 'commands') fillCommandsList();
        if (pageId === 'settings') updateSettingsUI();
    }
}
function navigateBack() {
    if (pageHistory.length > 1) {
        pageHistory.pop();
        showPage(pageHistory[pageHistory.length - 1], false);
    } else {
        showPage('home', false);
    }
}
window.addEventListener('popstate', (e) => { navigateBack(); });

function wireMainButtons() {
    document.getElementById('btnStartTalking').onclick = () => { showPage('speech'); };
    document.getElementById('btnStartTexting').onclick = () => { showPage('textInput'); };
    document.getElementById('btnPhoneCall').onclick = () => { showPage('phone'); };
    document.getElementById('btnCommands').onclick = () => { showPage('commands'); };
    document.getElementById('btnCloseSpeech').onclick = () => { showPage('home'); };
    document.getElementById('btnCloseText').onclick = () => { showPage('home'); };
    document.getElementById('btnClosePhone').onclick = () => { showPage('home'); };
    document.getElementById('btnCloseCommands').onclick = () => { showPage('home'); };
    document.getElementById('btnCloseSettings').onclick = () => { showPage('home'); };
    document.getElementById('btnTextHome').onclick = () => { showPage('home'); };
    document.getElementById('btnPhoneHome').onclick = () => { showPage('home'); };
    document.getElementById('btnSettingsHome').onclick = () => { showPage('home'); };
    document.getElementById('listenButton').onclick = toggleListening;
    document.getElementById('speakTextBtn').onclick = speakTextInput;
    document.getElementById('largeTextInputField').oninput = updateTextSpeakButton;
}

// LESLIE COMMANDS: RENDER LIST
function fillCommandsList() {
    const cmdList = [
        {k:'Hey Leslie Start Talking', d:'Go to speech recognition'},
        {k:'Hey Leslie Start Texting', d:'Go to text input'},
        {k:'Hey Leslie Call "John Doe"', d:'Call contact by name'},
        {k:'Hey Leslie Call "555-123-4567"', d:'Call a phone number'},
        {k:'Hey Leslie Home', d:'Go to main page'},
        {k:'Hey Leslie Current Weather', d:'Show current weather'},
        {k:'Hey Leslie Weather', d:'Show today\'s weather with date'},
        {k:'Hey Leslie 7 Day Forecast', d:'Show 7-day forecast'},
        {k:'Hey Leslie 7 Day', d:'Show 7-day forecast'},
        {k:'Hey Leslie Hourly', d:'Show hourly forecast'},
        {k:'Hey Leslie Hourly Forecast', d:'Show hourly forecast'},
        {k:'Hey Leslie Clear Text', d:'Clear speech recognition text'},
        {k:'Hey Leslie Enhanced Mode', d:'Switch to enhanced mode (not available)'},
        {k:'Hey Leslie Close', d:'Close weather display'},
        {k:'Hey Leslie Go Homes', d:'Go to home page'},
        {k:'Hey Leslie Help', d:'Show this command list'},
        {k:'Hey Leslie Pause More', d:'Increase pause between words'},
        {k:'Hey Leslie Pause Less', d:'Decrease pause between words'},
        {k:'Hey Leslie Speak Faster', d:'Speak faster'},
        {k:'Hey Leslie Talk Slower', d:'Speak slower'},
        {k:'Hey Leslie Turn off Voice Command Speech', d:'Disable voice feedback'},
        {k:'Hey Leslie Turn On Voice Command Speech', d:'Enable voice feedback'},
    ];
    let html = '';
    for (let cmd of cmdList) {
        html += `<div class="command-list-item"><span class="command-key">${cmd.k}</span><span class="command-desc"> – ${cmd.d}</span></div>`;
    }
    document.getElementById('leslieCommandsText').innerHTML = html;
}

// SETTINGS UI & CONTROLS
function updateSettingsUI() {
    // Speech speed
    const speedSlider = document.getElementById('speechSpeedSlider');
    const speedLabel = document.getElementById('speechSpeedValue');
    speedSlider.value = settings.speechSpeed;
    speedLabel.textContent = settings.speechSpeed == 1.0 ? 'Normal (1.0x)' : settings.speechSpeed + 'x';
    speedSlider.oninput = (e) => {
        settings.speechSpeed = parseFloat(e.target.value);
        speedLabel.textContent = settings.speechSpeed == 1.0 ? 'Normal (1.0x)' : settings.speechSpeed + 'x';
    };
    // Pause between words
    const pauseSlider = document.getElementById('pauseSlider');
    const pauseLabel = document.getElementById('pauseValue');
    pauseSlider.value = settings.pauseBetweenWords;
    pauseLabel.textContent = settings.pauseBetweenWords.toFixed(1) + 's';
    pauseSlider.oninput = (e) => {
        settings.pauseBetweenWords = parseFloat(e.target.value);
        pauseLabel.textContent = settings.pauseBetweenWords.toFixed(1) + 's';
    };
    // Voice command speech toggle
    const vcSwitch = document.getElementById('speakVoiceCommandsSwitch');
    const vcLabel = document.getElementById('speakVoiceCommandsLabel');
    vcSwitch.checked = !!settings.speakVoiceCommands;
    vcLabel.textContent = 'Voice Command Speech: ' + (settings.speakVoiceCommands ? 'ON' : 'OFF');
    vcSwitch.onchange = (e) => {
        settings.speakVoiceCommands = !!e.target.checked;
        vcLabel.textContent = 'Voice Command Speech: ' + (settings.speakVoiceCommands ? 'ON' : 'OFF');
    };
}

document.addEventListener('DOMContentLoaded', function() {
    wireMainButtons();
    setupSpeechRecognition();
    setupVoiceCommandListener();
    setupSwipeDetection();
    fillCommandsList();
    updateSettingsUI();
    enableTextSpeakButton();
});

// --- SPEECH RECOGNITION ---
function setupSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        updateStatus('Speech recognition not supported. Use Chrome, Edge, or Safari.');
        return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';
    recognition.onstart = function() {
        isListening = true;
        updateListenButton();
        updateStatus('🎤 Listening... Say something!');
        silenceTimeout && clearTimeout(silenceTimeout);
        silenceTimeout = setTimeout(stopListening, 180000); // 3 minutes
    };
    recognition.onend = function() {
        isListening = false;
        updateListenButton();
        updateStatus('Stopped listening');
    };
    recognition.onerror = function(event) {
        updateStatus('Speech recognition error: ' + event.error);
        isListening = false;
        updateListenButton();
    };
    recognition.onresult = function(event) {
        let interim = '';
        let final = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                final += transcript;
            } else {
                interim += transcript;
            }
        }
        if (final && /^hey leslie[ .,:]/i.test(final)) {
            processVoiceCommand(final.toLowerCase().trim());
            updateStatus('Command performed.');
            currentPhrase = '';
            updateCurrentPhraseDisplay();
            return;
        }
        if (final.trim()) {
            currentPhrase = final.trim();
            updateCurrentPhraseDisplay();
            updateStatus('✅ Heard: ' + final.trim());
            leslieSpeak(currentPhrase);
            currentPhrase = '';
        } else if (interim.trim()) {
            currentPhrase = interim.trim();
            updateCurrentPhraseDisplay(true);
            updateStatus('🔄 Listening: ' + interim.trim());
        }
        silenceTimeout && clearTimeout(silenceTimeout);
        silenceTimeout = setTimeout(stopListening, 180000);
    };
}
function toggleListening() {
    if (isListening) stopListening();
    else startListening();
}
function startListening() {
    if (recognition && !isListening) {
        try { recognition.start(); } catch (e) {}
    }
}
function stopListening() {
    if (recognition && isListening) {
        isListening = false;
        recognition.stop();
        updateStatus('Stopped listening');
        updateListenButton();
    }
}
function updateListenButton() {
    const listenButton = document.getElementById('listenButton');
    if (isListening) {
        listenButton.textContent = 'STOP LISTENING';
        listenButton.className = 'control-btn btn-stop';
    } else {
        listenButton.textContent = 'START TALKING';
        listenButton.className = 'control-btn btn-listen';
    }
}
function updateStatus(msg) {
    const el = document.getElementById('statusText');
    if (el) el.textContent = msg;
}
function updateCurrentPhraseDisplay() {
    const phraseEl = document.getElementById('currentPhrase');
    if (phraseEl) {
        if (currentPhrase) {
            phraseEl.innerHTML = `<div class="current-phrase">${currentPhrase}</div>`;
        } else {
            phraseEl.innerHTML = '<div class="current-phrase">Your speech will appear here...</div>';
        }
    }
}

// --- SPEAKING ---
function leslieSpeak(text) {
    if (!text) return;
    speechSynth.cancel();
    let utter = new SpeechSynthesisUtterance(text);
    utter.rate = settings.speechSpeed || 1.0;
    utter.onend = function() {};
    speechSynth.speak(utter);
}

// --- TEXT INPUT PAGE SPEAK BUTTON ---
// Always enabled & purple on page startup (as per your fix)
function speakTextInput() {
    const txt = document.getElementById('largeTextInputField').value.trim();
    if (txt) leslieSpeak(txt);
}
function enableTextSpeakButton() {
    const btn = document.getElementById('speakTextBtn');
    btn.disabled = false; // always enabled
    btn.style.background = '#9933cc';
    btn.style.color = '#fff';
}

// (optional) update button style if you want to ever disable
function updateTextSpeakButton() {
    enableTextSpeakButton(); // never disables!
}

// --- CONTACTS LOGIC ---
function loadRealContacts() {
    const contactsList = document.getElementById('contactsList');
    if (!('contacts' in navigator && 'ContactsManager' in window)) {
        contactsList.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #cc0000;">
                <strong>No contacts available.</strong><br>Your device or browser may not support contacts, or you denied permission.
            </div>`;
        return;
    }
    // Must be in a user gesture handler!
    navigator.contacts.select(['name', 'tel'], {multiple:true})
        .then(list => {
            if (!list.length) {
                contactsList.innerHTML = '<div style="padding:18px; text-align:center; color:#0099cc;">No contacts found.</div>';
                return;
            }
            contacts = list.map(c => ({
                name: c.name && c.name[0] ? c.name[0] : 'Unknown',
                phone: c.tel && c.tel[0] ? c.tel[0] : 'No phone'
            }));
            filteredContacts = [...contacts];
            displayContacts();
        })
        .catch(error => {
            contactsList.innerHTML = `<div style="padding:18px; text-align:center; color:#cc0000;">
                <strong>No contacts available</strong><br>Your device or browser may not support contacts, or you denied permission.<br>
                <span style="font-size:13px;">Error: ${error.message || error}</span></div>`;
        });
}
function displayContacts() {
    const contactsList = document.getElementById('contactsList');
    contactsList.innerHTML = '';
    if (!filteredContacts.length) {
        contactsList.innerHTML = '<div style="padding:18px; text-align:center; color:#0099cc;">No contacts loaded.</div>';
        return;
    }
    filteredContacts.slice(0,300).forEach(contact => {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
        div.onclick = () => { window.location.href = 'tel:' + contact.phone.replace(/[^\d]/g, ''); };
        contactsList.appendChild(div);
    });
}
function filterContacts(term) {
    if (!term.trim()) { filteredContacts = [...contacts]; }
    else {
        const t = term.toLowerCase().trim();
        filteredContacts = contacts.filter(c =>
            c.name.toLowerCase().includes(t) ||
            c.phone.replace(/[^\d]/g,'').includes(t.replace(/[^\d]/g,''))
        );
    }
    displayContacts();
}

// --- SWIPE DETECTION ---
function setupSwipeDetection() {
    let startX=0, startY=0, endX=0, endY=0;
    function addSwipeEvents(edgeId, callback) {
        const el = document.getElementById(edgeId);
        el.addEventListener('touchstart', e => {
            if (e.touches.length) {
                startX = e.touches[0].screenX;
                startY = e.touches[0].screenY;
            }
        });
        el.addEventListener('touchend', e => {
            if (e.changedTouches.length) {
                endX = e.changedTouches[0].screenX;
                endY = e.changedTouches[0].screenY;
                callback();
            }
        });
    }
    addSwipeEvents('swipeBottom', () => showCurrentWeather());
    addSwipeEvents('swipeLeft', () => showHourlyWeather());
    addSwipeEvents('swipeRight', () => showWeeklyWeather());
}

// --- WEATHER MODALS ---
function showCurrentWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    const currentTime = new Date();
    const temperature = Math.floor(Math.random() * 30) + 60;
    const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Clear'][Math.floor(Math.random() * 5)];
    const humidity = Math.floor(Math.random() * 40) + 40;
    const windSpeed = Math.floor(Math.random() * 15) + 5;
    weatherTitle.textContent = `Current Weather (${currentTime.toLocaleDateString(undefined, {weekday: 'long', month: 'long', day: 'numeric'})})`;
    weatherContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
            <div style="font-size: 32px; font-weight: bold; color: #0099cc;">${temperature}°F</div>
            <div style="font-size: 20px; font-weight: bold; margin: 8px 0;">${conditions}</div>
        </div>
        <div style="line-height: 1.8;">
            <strong>Humidity:</strong> ${humidity}%<br>
            <strong>Wind:</strong> ${windSpeed} mph<br>
            <strong>Time:</strong> ${currentTime.toLocaleTimeString()}<br>
        </div>
    `;
    weatherDisplay.classList.remove('hidden');
}
function showHourlyWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    weatherTitle.textContent = '24-Hour Forecast';
    let hourlyData = '<div class="hourly-forecast">';
    const now = new Date();
    for (let i = 0; i < 24; i += 3) {
        const futureTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
        const hour = futureTime.getHours();
        const temp = Math.floor(Math.random() * 20) + 65;
        const conditions = ['Sunny', 'Cloudy', 'Rain', 'Clear'][Math.floor(Math.random() * 4)];
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        const ampm = hour >= 12 ? 'PM' : 'AM';
        hourlyData += `
            <div class="hourly-item">
                <strong>${displayHour}:00 ${ampm}</strong><br>
                ${temp}°F ${conditions}
            </div>
        `;
    }
    hourlyData += '</div>';
    weatherContent.innerHTML = hourlyData;
    weatherDisplay.classList.remove('hidden');
}
function show
function showWeeklyWeather() {
    const weatherDisplay = document.getElementById('weatherDisplay');
    const weatherTitle = document.getElementById('weatherTitle');
    const weatherContent = document.getElementById('weatherContent');
    weatherTitle.textContent = '7-Day Forecast';
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let weeklyData = '<div class="weekly-forecast">';
    for (let i = 0; i < 7; i++) {
        const dayIndex = (new Date().getDay() + i) % 7;
        const high = Math.floor(Math.random() * 20) + 75;
        const low = high - Math.floor(Math.random() * 15) - 10;
        const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Rain', 'Storms'][Math.floor(Math.random() * 5)];
        weeklyData += `
            <div class="weekly-item">
                <div class="day-name">${days[dayIndex]}</div>
                <div class="day-temps">${high}°/${low}°</div>
                <div class="day-condition">${conditions}</div>
            </div>
        `;
    }
    weeklyData += '</div>';
    weatherContent.innerHTML = weeklyData;
    weatherDisplay.classList.remove('hidden');
}
function hideWeather() {
    document.getElementById('weatherDisplay').classList.add('hidden');
}

// --- VOICE COMMAND LISTENER ---
function setupVoiceCommandListener() {
    // Browser privacy: this needs to be started after a user gesture
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return;
    if (voiceCommandRecognition) {
        try { voiceCommandRecognition.abort(); } catch (e) {}
        voiceCommandRecognition = null;
    }
    voiceCommandRecognition = new SpeechRecognition();
    voiceCommandRecognition.continuous = true;
    voiceCommandRecognition.interimResults = false;
    voiceCommandRecognition.lang = 'en-US';
    voiceCommandRecognition.onresult = function(event) {
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                let transcript = event.results[i][0].transcript.toLowerCase().trim();
                if (/^hey leslie /.test(transcript)) {
                    processVoiceCommand(transcript);
                }
            }
        }
    };
    voiceCommandRecognition.onerror = function(event) {
        setTimeout(() => { try { voiceCommandRecognition.start(); } catch(e){} }, 2500);
    };
    voiceCommandRecognition.onend = function() {
        setTimeout(() => { try { voiceCommandRecognition.start(); } catch(e){} }, 1500);
    };
    // Try to start after a brief delay
    setTimeout(() => { try { voiceCommandRecognition.start(); } catch(e){} }, 1500);
}

// --- VOICE COMMAND LOGIC ---
function processVoiceCommand(text) {
    let t = text.replace(/^hey leslie[ ,:]*|[.!?]+$/gi, '').trim();
    if (!t) return;
    if (t === 'start talking') { showPage('speech'); setTimeout(() => toggleListening(), 300); return; }
    if (t === 'start texting') { showPage('textInput'); return; }
    if (t.startsWith('call ')) {
        let arg = t.replace(/^call /, '').trim();
        handleCallCommand(arg);
        return;
    }
    if (t === 'home' || t === 'go homes') { showPage('home'); return; }
    if (t === 'current weather' || t === 'weather') { showCurrentWeather(); return; }
    if (t === '7 day forecast' || t === '7 day') { showWeeklyWeather(); return; }
    if (t === 'hourly' || t === 'hourly forecast') { showHourlyWeather(); return; }
    if (t === 'clear text') { clearSpeechText(); return; }
    if (t === 'enhanced mode') { /* Not implemented */ return; }
    if (t === 'close') { hideWeather(); return; }
    if (t === 'help') { showPage('commands'); return; }
    if (t === 'pause more') {
        settings.pauseBetweenWords = Math.min(3.0, (settings.pauseBetweenWords || 1.0) + 0.5);
        updateSettingsUI(); return;
    }
    if (t === 'pause less') {
        settings.pauseBetweenWords = Math.max(0, (settings.pauseBetweenWords || 1.0) - 0.5);
        updateSettingsUI(); return;
    }
    if (t === 'speak faster') {
        settings.speechSpeed = Math.min(2.0, (settings.speechSpeed || 1.0) + 0.5);
        updateSettingsUI(); return;
    }
    if (t === 'talk slower') {
        settings.speechSpeed = Math.max(0.5, (settings.speechSpeed || 1.0) - 0.5);
        updateSettingsUI(); return;
    }
    if (t === 'turn off voice command speech') {
        settings.speakVoiceCommands = false; updateSettingsUI(); return;
    }
    if (t === 'turn on voice command speech') {
        settings.speakVoiceCommands = true; updateSettingsUI(); return;
    }
    // not recognized: ignore
}
function handleCallCommand(arg) {
    if (/^\d{3,}/.test(arg.replace(/\D/g,''))) {
        window.location.href = 'tel:' + arg.replace(/[^\d]/g, '');
        return;
    }
    let lower = arg.toLowerCase();
    let found = contacts.find(c => c.name.toLowerCase().includes(lower));
    if (found) {
        window.location.href = 'tel:' + found.phone.replace(/[^\d]/g, '');
    }
}

// --- CLEAR SPEECH TEXT ---
function clearSpeechText() {
    currentPhrase = '';
    updateCurrentPhraseDisplay();
    updateStatus('Text cleared - Ready to listen');
}
</script>
