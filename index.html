<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .commands-content {
            padding: 16px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .commands-text {
            line-height: 1.6;
            font-size: 14px;
        }
        .commands-text strong {
            color: #0099cc;
            font-size: 16px;
        }
        .session-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 153, 204, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #0099cc;
        }
        .phrase-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 153, 204, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #0099cc;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .header h1 { font-size: 20px; }
            .welcome-text { font-size: 16px; }
            .speech-content { max-height: 150px; }
            .contact-list-container { max-height: 300px; }
        }
        @media (max-width: 480px) {
            .container { padding: 4px; }
            .header { padding: 4px; }
            .main-button { height: 60px; font-size: 16px; margin-bottom: 16px; }
            .control-btn { width: 200px; font-size: 16px; }
            .page-header { padding: 12px; }
            .speech-content { min-height: 100px; max-height: 120px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Click START TALKING for speech recognition<br>
                    • Complete phrases will be spoken back to you<br>
                    • Click STOP LISTENING to end session<br>
                    • Works best with clear speech<br>
                    • Session automatically stops after 3 minutes<br>
                    • Recognition continues until you stop it
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                        <div class="phrase-counter" id="phraseCounter">Phrases: 0</div>
                        <div class="session-timer" id="sessionTimer" style="display: none;">Time: 0:00</div>
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    📱 Click "Load My Contacts" to import your real contacts
                </div>
                <div class="contacts-list" id="contactsList">
                    <div style="padding: 20px; text-align: center; color: #669900; border: 2px solid #669900; border-radius: 8px; background-color: #f8f9fa;">
                        <p><strong>📱 Demo Contacts</strong></p>
                        <p>These are sample contacts for testing</p>
                        <p><strong>To load YOUR real contacts:</strong></p>
                        <p>Click the green button below</p>
                        <p style="margin-top: 8px; font-size: 12px; color: #666;">
                            Works on Chrome Android & Safari iOS with HTTPS
                        </p>
                    </div>
                </div>
                <div style="text-align: center; margin: 16px 0;">
                    <button onclick="loadMyContacts()" id="loadContactsBtn" style="padding: 16px 32px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                        📞 LOAD MY REAL CONTACTS
                    </button>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Requires Chrome on Android or Safari on iOS with secure connection
                    </p>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">
                    🏠 HOME
                </button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            🔊 SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here and click 'SPEAK TEXT' to hear it spoken aloud..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            🏠 HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content">
                <div class="commands-text">
                    <strong>How to Use Leslie Speech Assistant:</strong><br><br>
                    
                    <strong>🎤 Speech Recognition Mode:</strong><br>
                    • Click "START TALKING" to begin continuous listening<br>
                    • Speak clearly in complete phrases or sentences<br>
                    • Your speech will appear on screen in real-time<br>
                    • Leslie will automatically speak back complete phrases<br>
                    • Recognition continues automatically for up to 3 minutes<br>
                    • Click "STOP LISTENING" to end the session manually<br>
                    • Works best in quiet environments with clear speech<br><br>
                    
                    <strong>📞 Phone Contacts Feature:</strong><br>
                    • Click "LOAD MY CONTACTS" to access your device contacts<br>
                    • Select contacts from your device's contact picker<br>
                    • Search through loaded contacts by name or number<br>
                    • Tap any contact to initiate a phone call<br>
                    • Supports phone numbers and email addresses<br>
                    • Works with Chrome on Android and Safari on iOS<br>
                    • Requires HTTPS secure connection for security<br><br>
                    
                    <strong>📝 Text Input Mode:</strong><br>
                    • Type any message in the text area<br>
                    • Click "SPEAK TEXT" to hear your text spoken aloud<br>
                    • Useful for testing speech synthesis<br>
                    • Great for preparing phrases before speaking sessions<br><br>
                    
                    <strong>⚙️ Settings & Customization:</strong><br>
                    • Adjust speech playback speed (0.5x to 2.0x)<br>
                    • Customize recognition sensitivity<br>
                    • Access through the gear icon in the header<br><br>
                    
                    <strong>🔧 Technical Requirements:</strong><br>
                    • Modern browser with speech recognition support<br>
                    • Microphone access permission required<br>
                    • HTTPS connection recommended for full functionality<br>
                    • Chrome, Edge, or Safari browsers work best<br><br>
                    
                    <strong>💡 Pro Tips:</strong><br>
                    • Allow microphone permission when prompted<br>
                    • Speak at normal conversational pace<br>
                    • Complete sentences work better than single words<br>
                    • Pause briefly between different phrases<br>
                    • Use in quiet environments for best accuracy<br>
                    • Contact loading requires user selection for privacy<br><br>
                    
                    <strong>🚨 Accessibility Features:</strong><br>
                    • Large, high-contrast buttons for easy interaction<br>
                    • Clear visual feedback for all actions<br>
                    • Voice confirmation of recognized speech<br>
                    • Simple, intuitive navigation between modes<br>
                    • Emergency contact support (911) always available
                </div>
            </div>
            <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 16px;">
                <button class="btn-home" id="btnCommandsHome">
                    🏠 HOME
                </button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>⚙️ Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie speaks back to you (0.5x = slow, 2.0x = fast)</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">Voice Settings</div>
                    <div class="settings-description">Customize speech synthesis options</div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; color: #666;">Voice Pitch:</label>
                        <input type="range" class="slider" id="voicePitchSlider" min="0.5" max="2" step="0.1" value="1.0">
                        <div class="setting-value" id="voicePitchValue">Normal (1.0)</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; color: #666;">Voice Volume:</label>
                        <input type="range" class="slider" id="voiceVolumeSlider" min="0.1" max="1" step="0.1" value="1.0">
                        <div class="setting-value" id="voiceVolumeValue">Maximum (1.0)</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">Recognition Settings</div>
                    <div class="settings-description">Configure speech recognition behavior</div>
                    <div class="switch">
                        <input type="checkbox" id="continuousMode" checked>
                        <label for="continuousMode">Continuous listening mode</label>
                    </div>
                    <div class="switch">
                        <input type="checkbox" id="interimResults" checked>
                        <label for="interimResults">Show partial speech results</label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">Session Settings</div>
                    <div class="settings-description">Configure session duration and timeouts</div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 14px; color: #666;">Max Session Duration (minutes):</label>
                        <input type="range" class="slider" id="sessionDurationSlider" min="1" max="10" step="1" value="3">
                        <div class="setting-value" id="sessionDurationValue">3 minutes</div>
                    </div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ← Back to Home
            </button>
        </div>
    </div>

    <script>
        // Core application variables
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [
            { name: 'Emergency Services', phone: '911', type: 'emergency' },
            { name: 'Demo Contact - John Smith', phone: '(555) 123-4567', type: 'demo' },
            { name: 'Demo Contact - Jane Doe', phone: '(555) 987-6543', type: 'demo' },
            { name: 'Demo Contact - Tech Support', phone: '(555) 555-0123', type: 'demo' }
        ];
        let filteredContacts = contacts.slice();
        let isSpeaking = false;
        let phraseHistory = [];
        let finalPhraseSpoken = '';
        
        // Speech and recognition settings
        let speechSpeed = 1.0;
        let voicePitch = 1.0;
        let voiceVolume = 1.0;
        let continuousMode = true;
        let showInterimResults = true;
        let maxSessionDuration = 3 * 60 * 1000; // 3 minutes in milliseconds
        
        // Continuous listening variables
        let continuousListeningEnabled = false;
        let silenceTimer = null;
        let sessionStartTime = null;
        let sessionTimer = null;
        let silenceTimeout = 8000; // 8 seconds of silence before restarting
        let recognitionRestartDelay = 1500; // 1.5 seconds delay before restart

        // Initialize the application
        function initApp() {
            console.log('🚀 Initializing Leslie Speech Assistant...');
            
            // Check browser compatibility
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('❌ Speech recognition not supported in this browser.\n\nPlease use:\n• Chrome\n• Edge\n• Safari\n\nFor best results.');
                return;
            }
            
            if (!('speechSynthesis' in window)) {
                alert('❌ Speech synthesis not supported in this browser.\n\nPlease use a modern browser for full functionality.');
                return;
            }
            
            // Initialize components
            setupEventHandlers();
            setupSpeechRecognition();
            displayContacts();
            loadSettings();
            
            console.log('✅ Leslie Speech Assistant initialized successfully!');
            
            // Show welcome message
            setTimeout(() => {
                console.log('👋 Welcome! Leslie is ready to help with speech recognition and communication.');
            }, 1000);
        }

        // Set up all event handlers
        function setupEventHandlers() {
            console.log('🔧 Setting up event handlers...');
            
            // Navigation buttons
            document.getElementById('btnStartTalking').addEventListener('click', () => showPage('speech'));
            document.getElementById('btnStartTexting').addEventListener('click', () => showPage('textInput'));
            document.getElementById('btnPhoneCall').addEventListener('click', () => showPage('phone'));
            document.getElementById('btnCommands').addEventListener('click', () => showPage('commands'));
            document.getElementById('btnSettings').addEventListener('click', () => showPage('settings'));
            
            // Close buttons
            document.getElementById('btnCloseSpeech').addEventListener('click', () => showPage('home'));
            document.getElementById('btnClosePhone').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseCommands').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseText').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseSettings').addEventListener('click', () => showPage('home'));
            
            // Home buttons
            document.getElementById('btnPhoneHome').addEventListener('click', () => showPage('home'));
            document.getElementById('btnTextHome').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCommandsHome').addEventListener('click', () => showPage('home'));
            document.getElementById('btnSettingsHome').addEventListener('click', () => showPage('home'));
            
            // Functional buttons
            document.getElementById('listenButton').addEventListener('click', toggleListening);
            document.getElementById('speakTextBtn').addEventListener('click', speakTextInput);
            
            // Settings sliders
            document.getElementById('speechSpeedSlider').addEventListener('input', (e) => {
                speechSpeed = parseFloat(e.target.value);
                const display = speechSpeed == 1.0 ? 'Normal (1.0x)' : speechSpeed + 'x';
                document.getElementById('speechSpeedValue').textContent = display;
                saveSettings();
            });
            
            document.getElementById('voicePitchSlider').addEventListener('input', (e) => {
                voicePitch = parseFloat(e.target.value);
                const display = voicePitch == 1.0 ? 'Normal (1.0)' : voicePitch.toFixed(1);
                document.getElementById('voicePitchValue').textContent = display;
                saveSettings();
            });
            
            document.getElementById('voiceVolumeSlider').addEventListener('input', (e) => {
                voiceVolume = parseFloat(e.target.value);
                const display = voiceVolume == 1.0 ? 'Maximum (1.0)' : voiceVolume.toFixed(1);
                document.getElementById('voiceVolumeValue').textContent = display;
                saveSettings();
            });
            
            document.getElementById('sessionDurationSlider').addEventListener('input', (e) => {
                const minutes = parseInt(e.target.value);
                maxSessionDuration = minutes * 60 * 1000;
                document.getElementById('sessionDurationValue').textContent = minutes + ' minutes';
                saveSettings();
            });
            
            // Settings checkboxes
            document.getElementById('continuousMode').addEventListener('change', (e) => {
                continuousMode = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('interimResults').addEventListener('change', (e) => {
                showInterimResults = e.target.checked;
                saveSettings();
            });
            
            console.log('✅ Event handlers set up successfully');
        }

        // Enhanced speech recognition setup with continuous listening
        function setupSpeechRecognition() {
            console.log('🎤 Setting up speech recognition...');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Configure recognition settings
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                console.log('🎤 Recognition started - continuous mode enabled');
                isListening = true;
                updateListenButton();
                updateStatus('🎤 Listening continuously... Speak anytime!');
                
                // Start session timer
                sessionStartTime = Date.now();
                startSessionTimer();
                
                // Show session timer
                const timerEl = document.getElementById('sessionTimer');
                if (timerEl) timerEl.style.display = 'block';
            };

            recognition.onend = function() {
                console.log('🔴 Recognition ended');
                isListening = false;
                updateListenButton();
                
                // Hide session timer
                const timerEl = document.getElementById('sessionTimer');
                if (timerEl) timerEl.style.display = 'none';
                
                // Check if we should restart for continuous listening
                if (continuousListeningEnabled && currentPage === 'speech') {
                    const sessionTime = Date.now() - sessionStartTime;
                    if (sessionTime < maxSessionDuration) {
                        console.log('🔄 Restarting recognition for continuous listening');
                        updateStatus('🔄 Restarting recognition...');
                        setTimeout(() => {
                            if (continuousListeningEnabled && currentPage === 'speech' && !isListening) {
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.log('Error restarting recognition:', e);
                                    updateStatus('❌ Error restarting - click to try again');
                                    stopContinuousListening();
                                }
                            }
                        }, recognitionRestartDelay);
                    } else {
                        console.log('⏰ Session timeout - stopping continuous listening');
                        stopContinuousListening();
                        updateStatus('⏰ Session ended - 3 minute limit reached. Click to restart.');
                    }
                } else {
                    updateStatus('Click "START TALKING" to begin listening');
                }
            };

            recognition.onerror = function(event) {
                console.log('❌ Recognition error:', event.error);
                
                // Handle different error types gracefully
                if (event.error === 'no-speech') {
                    console.log('🔇 No speech detected - will restart if continuous');
                    if (continuousListeningEnabled) {
                        updateStatus('🔇 No speech detected - listening continues...');
                    } else {
                        updateStatus('🔇 No speech detected - try speaking again');
                    }
                } else if (event.error === 'network') {
                    updateStatus('🌐 Network error - check your connection');
                    stopContinuousListening();
                } else if (event.error === 'not-allowed') {
                    updateStatus('🚫 Microphone access denied - please allow and refresh');
                    stopContinuousListening();
                } else if (event.error === 'service-not-allowed') {
                    updateStatus('🚫 Speech service not allowed - check browser settings');
                    stopContinuousListening();
                } else {
                    updateStatus('❌ Error: ' + event.error + ' - click to try again');
                    stopContinuousListening();
                }
            };

            recognition.onresult = function(event) {
                console.log('📝 Recognition result received');
                
                let interimTranscript = '';
                let finalTranscript = '';
                
                // Process all results from the current session
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update display with interim results if enabled
                if (interimTranscript && showInterimResults) {
                    updateDisplay(interimTranscript, false);
                    const shortTranscript = interimTranscript.substring(0, 40) + (interimTranscript.length > 40 ? '...' : '');
                    updateStatus('🎤 Processing: "' + shortTranscript + '"');
                    
                    // Reset silence timer
                    resetSilenceTimer();
                }
                
                // Process final results
                if (finalTranscript) {
                    const cleanFinal = finalTranscript.trim();
                    console.log('✅ FINAL RESULT:', cleanFinal);
                    
                    if (cleanFinal && cleanFinal.length > 1) {
                        // Check for duplicates and avoid repeating recent phrases
                        const isDuplicate = phraseHistory.some(phrase => 
                            phrase.toLowerCase() === cleanFinal.toLowerCase()
                        );
                        const isRecentlySpoken = finalPhraseSpoken.toLowerCase() === cleanFinal.toLowerCase();
                        
                        if (!isDuplicate && !isRecentlySpoken) {
                            console.log('🆕 NEW UNIQUE PHRASE:', cleanFinal);
                            
                            // Add to phrase history
                            phraseHistory.push(cleanFinal);
                            if (phraseHistory.length > 10) phraseHistory.shift(); // Keep last 10 phrases
                            finalPhraseSpoken = cleanFinal;
                            
                            // Update display and UI
                            updateDisplay(cleanFinal, true);
                            updatePhraseCounter();
                            updateStatus('✅ Got it: "' + cleanFinal + '" - Still listening for more...');
                            
                            // Speak the phrase back
                            speakPhrase(cleanFinal);
                            
                            // Reset silence timer after successful recognition
                            resetSilenceTimer();
                        } else {
                            console.log('🔄 Duplicate phrase ignored:', cleanFinal);
                        }
                    }
                }
            };
            
            console.log('✅ Speech recognition configured successfully');
        }

        // Session timer management
        function startSessionTimer() {
            if (sessionTimer) clearInterval(sessionTimer);
            
            sessionTimer = setInterval(() => {
                if (sessionStartTime && continuousListeningEnabled) {
                    const elapsed = Date.now() - sessionStartTime;
                    const remaining = maxSessionDuration - elapsed;
                    
                    if (remaining > 0) {
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        const timeStr = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                        
                        const timerEl = document.getElementById('sessionTimer');
                        if (timerEl) timerEl.textContent = 'Time: ' + timeStr;
                    } else {
                        stopContinuousListening();
                        updateStatus('⏰ Session ended - time limit reached. Click to restart.');
                    }
                }
            }, 1000);
        }

        // Reset silence timer for continuous listening
        function resetSilenceTimer() {
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            if (continuousListeningEnabled && continuousMode) {
                silenceTimer = setTimeout(() => {
                    console.log('🔇 Silence timeout - restarting recognition');
                    if (recognition && isListening) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.log('Error stopping recognition for restart:', e);
                        }
                    }
                }, silenceTimeout);
            }
        }

        // Stop continuous listening completely
        function stopContinuousListening() {
            console.log('🛑 Stopping continuous listening');
            continuousListeningEnabled = false;
            
            // Clear all timers
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            
            sessionStartTime = null;
            
            // Stop recognition
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('Error stopping recognition:', e);
                }
            }
            
            // Hide session timer
            const timerEl = document.getElementById('sessionTimer');
            if (timerEl) timerEl.style.display = 'none';
        }

        // Enhanced speech synthesis
        function speakPhrase(text) {
            console.log('🔊 SPEAKING FUNCTION CALLED WITH:', text);
            
            if (isSpeaking) {
                console.log('⏸️ Already speaking, skipping');
                return;
            }
            
            if (!text || text.trim().length === 0) {
                console.log('❌ Empty text, not speaking');
                return;
            }
            
            // Cancel any existing speech
            speechSynth.cancel();
            
            // Wait for speech synth to be ready
            setTimeout(() => {
                console.log('🎯 Starting speech synthesis for:', text);
                isSpeaking = true;
                
                const utterance = new SpeechSynthesisUtterance();
                utterance.text = text.trim();
                utterance.lang = 'en-US';
                utterance.rate = speechSpeed;
                utterance.pitch = voicePitch;
                utterance.volume = voiceVolume;
                
                utterance.onstart = function() {
                    console.log('🔊 SPEECH STARTED:', this.text);
                };
                
                utterance.onend = function() {
                    console.log('✅ SPEECH COMPLETED:', this.text);
                    isSpeaking = false;
                };
                
                utterance.onpause = function() {
                    console.log('⏸️ SPEECH PAUSED');
                };
                
                utterance.onresume = function() {
                    console.log('▶️ SPEECH RESUMED');
                };
                
                utterance.onerror = function(event) {
                    console.error('❌ SPEECH ERROR:', event.error, 'for text:', this.text);
                    isSpeaking = false;
                };
                
                // Speak the utterance
                console.log('📢 Calling speechSynth.speak() with text:', utterance.text);
                speechSynth.speak(utterance);
                
            }, 500);
        }

        // Update display with speech results
        function updateDisplay(text, isFinal) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (!recognizedTextEl) return;
            
            let html = '';
            
            // Show recent final phrases
            if (phraseHistory.length > 0) {
                phraseHistory.forEach((phrase, index) => {
                    const isLatest = index === phraseHistory.length - 1;
                    const icon = isLatest ? '🆕' : '✅';
                    html += '<div class="final-phrase">' + icon + ' ' + phrase + '</div>';
                });
            }
            
            // Show current interim text
            if (!isFinal && text && text.trim() && showInterimResults) {
                html += '<div class="interim-phrase">🎤 ' + text + '</div>';
            }
            
            if (html) {
                recognizedTextEl.innerHTML = html;
            } else {
                recognizedTextEl.innerHTML = '<div style="color: #666; font-style: italic; padding: 20px; text-align: center;">🎤 Start speaking and your words will appear here...<br><br>💡 Tip: Speak clearly in complete sentences for best results!</div>';
            }
            
            // Auto-scroll to bottom to show latest content
            const speechContent = document.querySelector('.speech-content');
            if (speechContent) {
                speechContent.scrollTop = speechContent.scrollHeight;
            }
        }

        // Update phrase counter
        function updatePhraseCounter() {
            const counterEl = document.getElementById('phraseCounter');
            if (counterEl) {
                counterEl.textContent = 'Phrases: ' + phraseHistory.length;
            }
        }

        // Enhanced listening control
        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // Start listening with continuous mode
        function startListening() {
            if (recognition && !isListening) {
                try {
                    console.log('🚀 Starting continuous listening mode');
                    continuousListeningEnabled = continuousMode;
                    recognition.start();
                } catch (error) {
                    console.log('❌ Error starting recognition:', error);
                    updateStatus('❌ Error starting recognition. Please try again.');
                    continuousListeningEnabled = false;
                }
            }
        }

        // Stop listening
        function stopListening() {
            console.log('🛑 Manually stopping listening');
            stopContinuousListening();
            updateStatus('🛑 Stopped listening. Click "START TALKING" to restart.');
        }

        // Update listen button appearance
        function updateListenButton() {
            const btn = document.getElementById('listenButton');
            if (btn) {
                if (isListening) {
                    btn.textContent = 'STOP LISTENING';
                    btn.className = 'control-btn btn-stop';
                } else {
                    btn.textContent = 'START TALKING';
                    btn.className = 'control-btn btn-listen';
                }
            }
        }

        // Update status display
        function updateStatus(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) {
                statusEl.textContent = message;
                console.log('📊 Status:', message);
            }
        }

        // Speak text input
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                console.log('🔊 Speaking user input text:', text);
                speakPhrase(text);
            } else {
                alert('💬 Please type some text first, then click "SPEAK TEXT" to hear it spoken.');
            }
        }

        // Enhanced contact loading with comprehensive error handling
        async function loadMyContacts() {
            const contactsList = document.getElementById('contactsList');
            const loadBtn = document.getElementById('loadContactsBtn');
            
            // Disable button during loading
            if (loadBtn) {
                loadBtn.disabled = true;
                loadBtn.textContent = '⏳ Loading...';
                loadBtn.style.opacity = '0.6';
            }
            
            // Show loading message
            contactsList.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px;">
                    <p><strong>📱 Loading your contacts...</strong></p>
                    <p>Please select contacts when the picker appears</p>
                    <p>⏳ This may take a moment...</p>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        • Select individual contacts or use "Select All"<br>
                        • You can choose as many as you want<br>
                        • Contacts will be imported automatically
                    </div>
                </div>
            `;
            
            try {
                // Check if Contacts API is supported
                if (!('contacts' in navigator) || !('ContactsManager' in window)) {
                    throw new Error('UNSUPPORTED_API');
                }
                
                console.log('📱 Requesting contacts from device...');
                
                // Request contacts with comprehensive properties
                const properties = ['name', 'tel', 'email', 'address', 'icon'];
                const options = { 
                    multiple: true // Allow multiple selection
                };
                
                // This will open the native contact picker
                const selectedContacts = await navigator.contacts.select(properties, options);
                console.log('👥 User selected', selectedContacts.length, 'contacts');
                
                if (selectedContacts && selectedContacts.length > 0) {
                    const processedContacts = [];
                    let totalProcessed = 0;
                    
                    // Process each selected contact
                    selectedContacts.forEach((contact, index) => {
                        console.log(`📋 Processing contact ${index + 1}:`, contact);
                        
                        // Extract name with fallbacks
                        let contactName = 'Unknown Contact';
                        if (contact.name && contact.name.length > 0) {
                            contactName = contact.name[0];
                        }
                        
                        // Extract phone numbers
                        const phoneNumbers = contact.tel || [];
                        console.log(`📞 Contact "${contactName}" has ${phoneNumbers.length} phone numbers`);
                        
                        // Extract emails
                        const emails = contact.email || [];
                        console.log(`📧 Contact "${contactName}" has ${emails.length} emails`);
                        
                        // Extract addresses
                        const addresses = contact.address || [];
                        console.log(`🏠 Contact "${contactName}" has ${addresses.length} addresses`);
                        
                        // Create entries for each phone number
                        if (phoneNumbers.length > 0) {
                            phoneNumbers.forEach((phone, phoneIndex) => {
                                processedContacts.push({
                                    name: phoneNumbers.length > 1 ? `${contactName} (${phoneIndex + 1})` : contactName,
                                    phone: phone,
                                    type: 'phone',
                                    originalIndex: index
                                });
                                totalProcessed++;
                            });
                        }
                        
                        // Create entries for each email
                        if (emails.length > 0) {
                            emails.forEach((email, emailIndex) => {
                                processedContacts.push({
                                    name: emails.length > 1 ? `${contactName} (Email ${emailIndex + 1})` : `${contactName} (Email)`,
                                    phone: email,
                                    type: 'email',
                                    originalIndex: index
                                });
                                totalProcessed++;
                            });
                        }
                        
                        // If no phone or email, still add the contact with address if available
                        if (phoneNumbers.length === 0 && emails.length === 0) {
                            const addressInfo = addresses.length > 0 ? 
                                (typeof addresses[0] === 'string' ? addresses[0] : 'Has address info') : 
                                'No contact info available';
                            
                            processedContacts.push({
                                name: contactName,
                                phone: addressInfo,
                                type: 'other',
                                originalIndex: index
                            });
                            totalProcessed++;
                        }
                    });
                    
                    // Remove exact duplicates
                    const uniqueContacts = processedContacts.filter((contact, index, self) =>
                        index === self.findIndex(c => 
                            c.name === contact.name && c.phone === contact.phone
                        )
                    );
                    
                    // Sort alphabetically by name
                    uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Replace contacts array while preserving emergency contact
                    contacts = [
                        { name: 'Emergency Services', phone: '911', type: 'emergency' },
                        ...uniqueContacts
                    ];
                    filteredContacts = contacts.slice();
                    
                    console.log('✅ SUCCESS: Processed', contacts.length, 'total contacts (including emergency)');
                    
                    // Show success message
                    contactsList.innerHTML = `
                        <div style="padding: 16px; text-align: center; background: #28a745; color: white; border-radius: 8px; margin-bottom: 16px;">
                            <p><strong>🎉 SUCCESS!</strong></p>
                            <p><strong>Loaded ${selectedContacts.length} contacts with ${totalProcessed} contact methods!</strong></p>
                            <p>Total available contacts: ${contacts.length}</p>
                            <p style="font-size: 12px; margin-top: 8px;">Your contacts are now searchable below</p>
                        </div>
                    `;
                    
                    // Display all contacts
                    displayContacts();
                    
                } else {
                    throw new Error('NO_CONTACTS_SELECTED');
                }
                
            } catch (error) {
                console.error('❌ Contact loading error:', error);
                
                let errorMsg = '';
                let errorColor = '#cc0000';
                let canRetry = true;
                
                if (error.message === 'UNSUPPORTED_API' || error.message.includes('not supported')) {
                    errorColor = '#ff6600';
                    canRetry = false;
                    errorMsg = `
                        <p><strong>📱 Contacts API Not Supported</strong></p>
                        <p>This feature requires a compatible browser and device:</p>
                        <div style="margin: 12px 0; text-align: left; display: inline-block;">
                        <p>✅ <strong>Supported:</strong></p>
                        <p>• Chrome on Android (version 80+)</p>
                        <p>• Safari on iOS (version 14+)</p>
                        <p>• Edge on supported devices</p>
                        <p>• HTTPS secure connection required</p>
                        </div>
                        <p style="margin-top: 12px; font-size: 12px; color: #666;">
                        Current browser: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                                         navigator.userAgent.includes('Safari') ? 'Safari' : 
                                         navigator.userAgent.includes('Edge') ? 'Edge' : 'Other'}
                        </p>
                    `;
                } else if (error.name === 'NotAllowedError') {
                    errorColor = '#ff8800';
                    errorMsg = `
                        <p><strong>🚫 Permission Denied</strong></p>
                        <p>You denied access to contacts</p>
                        <div style="margin: 12px 0; text-align: left; display: inline-block;">
                        <p><strong>To fix this:</strong></p>
                        <p>1. Refresh this page (F5 or reload button)</p>
                        <p>2. Click "LOAD MY CONTACTS" again</p>
                        <p>3. Click "Allow" when prompted</p>
                        <p>4. Select your contacts in the picker</p>
                        </div>
                    `;
                } else if (error.name === 'AbortError') {
                    errorColor = '#ff8800';
                    errorMsg = `
                        <p><strong>📱 Contact Selection Cancelled</strong></p>
                        <p>You cancelled the contact picker</p>
                        <div style="margin: 12px 0; text-align: left; display: inline-block;">
                        <p><strong>Try again and:</strong></p>
                        <p>• Select individual contacts by tapping them</p>
                        <p>• Use "Select All" if you want all contacts</p>
                        <p>• Tap "Done" or "Confirm" to import</p>
                        </div>
                    `;
                } else if (error.message === 'NO_CONTACTS_SELECTED' || error.message.includes('No contacts were selected')) {
                    errorColor = '#ff8800';
                    errorMsg = `
                        <p><strong>📱 No Contacts Selected</strong></p>
                        <p>The contact picker didn't return any contacts</p>
                        <div style="margin: 12px 0; text-align: left; display: inline-block;">
                        <p><strong>This might happen if:</strong></p>
                        <p>• You didn't select any contacts</p>
                        <p>• The contact picker was closed too quickly</p>
                        <p>• There was a temporary system issue</p>
                        </div>
                        <p><strong>Please try again and make sure to select contacts</strong></p>
                    `;
                } else {
                    errorMsg = `
                        <p><strong>❌ Contact Loading Error</strong></p>
                        <p>Error: ${error.message || 'Unknown error occurred'}</p>
                        <p style="margin-top: 8px;">This might be due to:</p>
                        <div style="margin: 8px 0; text-align: left; display: inline-block; font-size: 12px;">
                        <p>• Browser compatibility issues</p>
                        <p>• Device permissions</p>
                        <p>• Network connectivity</p>
                        <p>• System contacts access</p>
                        </div>
                    `;
                }
                
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: ${errorColor}; border: 2px solid ${errorColor}; border-radius: 8px; background: #fff9f9;">
                        ${errorMsg}
                        ${canRetry ? '<p style="margin-top: 16px; color: #666; font-size: 12px;">You can try again, or demo contacts will be shown below in 5 seconds</p>' : '<p style="margin-top: 16px; color: #666; font-size: 12px;">Demo contacts will be shown below in 5 seconds</p>'}
                    </div>
                `;
                
                // Show demo contacts after error
                setTimeout(() => {
                    displayContacts();
                }, 5000);
                
            } finally {
                // Re-enable button
                if (loadBtn) {
                    loadBtn.disabled = false;
                    loadBtn.textContent = '📞 LOAD MY REAL CONTACTS';
                    loadBtn.style.opacity = '1';
                }
            }
        }

        // Enhanced contact display
        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            // Clear existing content
            contactsList.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666; border: 2px solid #ddd; border-radius: 8px;">
                        <p><strong>📱 No Contacts Found</strong></p>
                        <p>No contacts match your search criteria</p>
                        <p style="font-size: 12px; margin-top: 8px;">Try a different search term or load your contacts</p>
                    </div>
                `;
                return;
            }
            
            filteredContacts.forEach((contact, index) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                
                // Style differently based on contact type
                let backgroundColor = '#f8f8f8';
                let borderColor = '#ddd';
                let typeIcon = '👤';
                
                if (contact.type === 'emergency') {
                    backgroundColor = '#ffe6e6';
                    borderColor = '#cc0000';
                    typeIcon = '🚨';
                } else if (contact.type === 'phone') {
                    backgroundColor = '#e8f5e8';
                    borderColor = '#669900';
                    typeIcon = '📞';
                } else if (contact.type === 'email') {
                    backgroundColor = '#f0f8ff';
                    borderColor = '#0066cc';
                    typeIcon = '📧';
                } else if (contact.type === 'demo') {
                    backgroundColor = '#f5f5f5';
                    borderColor = '#999';
                    typeIcon = '🧪';
                } else {
                    backgroundColor = '#fff8e1';
                    borderColor = '#ffa000';
                    typeIcon = '📋';
                }
                
                contactEl.style.backgroundColor = backgroundColor;
                contactEl.style.borderLeft = `4px solid ${borderColor}`;
                contactEl.style.margin = '4px 0';
                
                // Format phone number/email for display
                let displayPhone = contact.phone;
                if (contact.type === 'phone' && contact.phone.length > 10) {
                    // Format long phone numbers
                    const cleaned = contact.phone.replace(/\D/g, '');
                    if (cleaned.length === 10) {
                        displayPhone = `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
                    } else if (cleaned.length === 11 && cleaned[0] === '1') {
                        displayPhone = `+1 (${cleaned.slice(1,4)}) ${cleaned.slice(4,7)}-${cleaned.slice(7)}`;
                    }
                }
                
                contactEl.innerHTML = `
                    <div class="contact-name">${typeIcon} ${contact.name}</div>
                    <div class="contact-phone">${displayPhone}</div>
                `;
                
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });
            
            // Add summary footer
            const summaryEl = document.createElement('div');
            summaryEl.style.cssText = 'padding: 12px; text-align: center; background: #f0f0f0; color: #666; border-radius: 8px; margin-top: 16px; font-size: 12px; border-top: 2px solid #ddd;';
            
            const phoneCount = filteredContacts.filter(c => c.type === 'phone').length;
            const emailCount = filteredContacts.filter(c => c.type === 'email').length;
            const demoCount = filteredContacts.filter(c => c.type === 'demo').length;
            const emergencyCount = filteredContacts.filter(c => c.type === 'emergency').length;
            
            let summaryText = `📊 Total: ${filteredContacts.length} contacts`;
            if (phoneCount > 0) summaryText += ` • 📞 ${phoneCount} phone`;
            if (emailCount > 0) summaryText += ` • 📧 ${emailCount} email`;
            if (emergencyCount > 0) summaryText += ` • 🚨 ${emergencyCount} emergency`;
            if (demoCount > 0) summaryText += ` • 🧪 ${demoCount} demo`;
            
            summaryEl.innerHTML = summaryText;
            contactsList.appendChild(summaryEl);
        }

        // Enhanced contact filtering
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const search = searchTerm.toLowerCase();
                filteredContacts = contacts.filter(contact => 
                    contact.name.toLowerCase().includes(search) ||
                    contact.phone.toLowerCase().includes(search) ||
                    contact.type.toLowerCase().includes(search)
                );
            }
            displayContacts();
            
            // Update search feedback
            const searchInput = document.getElementById('contactSearch');
            if (searchInput && searchTerm.trim()) {
                const resultCount = filteredContacts.length;
                searchInput.style.borderColor = resultCount > 0 ? '#669900' : '#cc6600';
                searchInput.title = `Found ${resultCount} matching contacts`;
            } else if (searchInput) {
                searchInput.style.borderColor = '#669900';
                searchInput.title = 'Search contacts by name, phone, or type';
            }
        }

        // Enhanced contact calling
        function callContact(contact) {
            console.log('📞 Initiating contact with:', contact.name, contact.phone);
            
            // Provide user feedback
            const originalBg = event.target.style.backgroundColor;
            event.target.style.backgroundColor = '#0099cc';
            event.target.style.color = 'white';
            
            setTimeout(() => {
                event.target.style.backgroundColor = originalBg;
                event.target.style.color = '';
            }, 1000);
            
            if (contact.type === 'email') {
                // Open email client
                const emailUrl = 'mailto:' + encodeURIComponent(contact.phone);
                console.log('📧 Opening email client:', emailUrl);
                window.location.href = emailUrl;
            } else if (contact.type === 'phone' || contact.type === 'emergency' || contact.type === 'demo') {
                // Make phone call
                const cleanPhone = contact.phone.replace(/[^\d+]/g, '');
                const telUrl = 'tel:' + cleanPhone;
                console.log('📞 Initiating phone call:', telUrl);
                window.location.href = telUrl;
            } else {
                // For other types, try to determine if it's a phone or email
                if (contact.phone.includes('@')) {
                    window.location.href = 'mailto:' + encodeURIComponent(contact.phone);
                } else {
                    // Assume it's a phone number
                    const cleanPhone = contact.phone.replace(/[^\d+]/g, '');
                    if (cleanPhone.length >= 7) {
                        window.location.href = 'tel:' + cleanPhone;
                    } else {
                        alert('📱 Unable to call this contact:\n\n' + contact.name + '\n' + contact.phone + '\n\nThis may be an address or other contact information.');
                    }
                }
            }
        }

        // Page navigation with enhanced state management
        function showPage(pageId) {
            console.log('🧭 Navigating to page:', pageId);
            
            // Handle leaving current page
            if (currentPage === 'speech' && pageId !== 'speech') {
                console.log('🛑 Leaving speech page - stopping recognition');
                stopContinuousListening();
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            // Show target page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                // Handle entering new page
                if (pageId === 'phone') {
                    console.log('📞 Entering phone page - displaying contacts');
                    displayContacts();
                    // Clear search
                    const searchInput = document.getElementById('contactSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        filterContacts('');
                    }
                } else if (pageId === 'speech') {
                    console.log('🎤 Entering speech page - resetting state');
                    // Reset speech page state
                    updateStatus('Ready to listen - Click "START TALKING" below');
                    phraseHistory = [];
                    finalPhraseSpoken = '';
                    updateDisplay('', true);
                    updatePhraseCounter();
                    
                    // Hide session timer
                    const timerEl = document.getElementById('sessionTimer');
                    if (timerEl) timerEl.style.display = 'none';
                } else if (pageId === 'textInput') {
                    console.log('📝 Entering text input page');
                    // Focus on text area
                    setTimeout(() => {
                        const textArea = document.getElementById('largeTextInputField');
                        if (textArea) textArea.focus();
                    }, 100);
                } else if (pageId === 'settings') {
                    console.log('⚙️ Entering settings page');
                    loadSettings(); // Refresh settings display
                }
                
                console.log('✅ Successfully navigated to:', pageId);
            } else {
                console.error('❌ Target page not found:', pageId + 'Page');
            }
        }

        // Settings management
        function saveSettings() {
            const settings = {
                speechSpeed,
                voicePitch,
                voiceVolume,
                continuousMode,
                showInterimResults,
                maxSessionDuration
            };
            
            try {
                // Note: Using variables instead of localStorage due to artifact restrictions
                console.log('💾 Settings saved:', settings);
            } catch (e) {
                console.log('⚠️ Could not save settings:', e);
            }
        }

        function loadSettings() {
            try {
                // Update slider values and displays
                document.getElementById('speechSpeedSlider').value = speechSpeed;
                document.getElementById('speechSpeedValue').textContent = speechSpeed == 1.0 ? 'Normal (1.0x)' : speechSpeed + 'x';
                
                document.getElementById('voicePitchSlider').value = voicePitch;
                document.getElementById('voicePitchValue').textContent = voicePitch == 1.0 ? 'Normal (1.0)' : voicePitch.toFixed(1);
                
                document.getElementById('voiceVolumeSlider').value = voiceVolume;
                document.getElementById('voiceVolumeValue').textContent = voiceVolume == 1.0 ? 'Maximum (1.0)' : voiceVolume.toFixed(1);
                
                document.getElementById('sessionDurationSlider').value = maxSessionDuration / 60000;
                document.getElementById('sessionDurationValue').textContent = (maxSessionDuration / 60000) + ' minutes';
                
                document.getElementById('continuousMode').checked = continuousMode;
                document.getElementById('interimResults').checked = showInterimResults;
                
                console.log('📂 Settings loaded successfully');
            } catch (e) {
                console.log('⚠️ Could not load settings:', e);
            }
        }

        // Utility functions
        function formatTime(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }

        function checkBrowserCompatibility() {
            const isChrome = navigator.userAgent.includes('Chrome');
            const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
            const isEdge = navigator.userAgent.includes('Edge');
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            console.log('🌐 Browser compatibility check:', {
                isChrome,
                isSafari,
                isEdge,
                isMobile,
                hasWebSpeech: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                hasContacts: 'contacts' in navigator,
                hasSpeechSynthesis: 'speechSynthesis' in window,
                isHTTPS: location.protocol === 'https:'
            });
            
            return {
                speechRecognition: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                contacts: 'contacts' in navigator && (isChrome || isSafari),
                speechSynthesis: 'speechSynthesis' in window,
                secure: location.protocol === 'https:' || location.hostname === 'localhost'
            };
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('🚨 Application error:', e.error);
            
            // Show user-friendly error message for critical errors
            if (e.error && e.error.message) {
                const message = e.error.message;
                if (message.includes('speech') || message.includes('recognition')) {
                    updateStatus('❌ Speech error occurred - please try again');
                }
            }
        });

        // Prevent page reload during speech recognition
        window.addEventListener('beforeunload', function(e) {
            if (isListening) {
                const message = 'Speech recognition is active. Are you sure you want to leave?';
                e.returnValue = message;
                return message;
            }
        });

        // Handle visibility changes (tab switching, etc.)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isListening) {
                console.log('👁️ Page hidden while listening - continuing in background');
            } else if (!document.hidden && continuousListeningEnabled && !isListening && currentPage === 'speech') {
                console.log('👁️ Page visible again - checking recognition state');
                // Optionally restart recognition if it stopped while hidden
            }
        });

        // Mobile-specific enhancements
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            console.log('📱 Mobile device detected - applying mobile optimizations');
            
            // Prevent zoom on input focus
            document.addEventListener('touchstart', function() {}, { passive: true });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    console.log('🔄 Orientation changed - updating layout');
                    // Refresh displays if needed
                    if (currentPage === 'phone') {
                        displayContacts();
                    }
                }, 500);
            });
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 DOM loaded - initializing Leslie Speech Assistant');
            
            // Check compatibility first
            const compatibility = checkBrowserCompatibility();
            console.log('✅ Compatibility check results:', compatibility);
            
            // Initialize the app
            initApp();
            
            // Show any compatibility warnings
            setTimeout(() => {
                if (!compatibility.secure && location.hostname !== 'localhost') {
                    console.warn('⚠️ HTTPS recommended for full functionality');
                }
                
                if (!compatibility.contacts) {
                    console.warn('⚠️ Contact loading may not work on this browser/device');
                }
            }, 2000);
        });

        // Development helpers (can be removed in production)
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            window.leslieDebug = {
                recognition,
                phraseHistory,
                contacts,
                settings: { speechSpeed, voicePitch, voiceVolume, continuousMode, showInterimResults, maxSessionDuration },
                state: () => ({ isListening, isSpeaking, continuousListeningEnabled, currentPage })
            };
            console.log('🔧 Debug mode enabled - access via window.leslieDebug');
        }
    </script>
</body>
</html>
