<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-send { background-color: #669900; }
        .btn-keyboard { background-color: #99cc00; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .btn-disabled { background-color: #ccc !important; cursor: not-allowed !important; }
        /* --- Text Input Styles --- */
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            width: 90vw;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
            text-align: center;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .hourly-forecast, .weekly-forecast {
            display: grid;
            gap: 8px;
        }
        .hourly-item, .weekly-item {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }
        .weekly-item {
            display: grid;
            grid-template-columns: 80px 60px 1fr;
            gap: 8px;
            align-items: center;
            font-size: 14px;
        }
        .day-name { font-weight: bold; }
        .day-temps { color: #0099cc; font-weight: bold; }
        .day-condition { color: #666; }
        /* Swipe edge detection areas */
        .swipe-edge {
            position: fixed;
            z-index: 998;
            background: rgba(0,153,204,0.1);
        }
        .swipe-bottom {
            bottom: 0;
            left: 40%;
            width: 20%;
            height: 40px;
        }
        .swipe-left {
            left: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .swipe-right {
            right: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .api-key-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { 
                padding: 16px;
                width: 95vw;
                max-width: 450px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Swipe Edge Detection Areas -->
        <div class="swipe-edge swipe-bottom" id="swipeBottom"></div>
        <div class="swipe-edge swipe-left" id="swipeLeft"></div>
        <div class="swipe-edge swipe-right" id="swipeRight"></div>

        <!-- Weather Display (Hidden by default) -->
        <div class="weather-display hidden" id="weatherDisplay">
            <div class="weather-title" id="weatherTitle">Current Weather</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    üé§ START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    üìù START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    üìû PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    üó£Ô∏è LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Voice commands work best with microphone permission granted<br>
                    ‚Ä¢ Say "Hey Leslie" followed by commands for voice control<br>
                    ‚Ä¢ Click START TALKING for continuous speech recognition<br>
                    ‚Ä¢ Use Enhanced Recognition for better accuracy with unclear speech<br>
                    ‚Ä¢ Small swipe areas: bottom center, left/right sides for weather<br>
                    ‚Ä¢ Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <!-- Enhanced Recognition Section -->
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">üî¨ Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        üî¨ START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>üìû Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    üîç Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    üì± Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList">
                    <div style="padding: 20px; text-align: center; color: #669900; border: 2px solid #669900; border-radius: 8px; background-color: #f8f9fa;">
                        <p><strong>üì± Ready to Load Contacts</strong></p>
                        <p><strong>Contacts will appear RIGHT HERE on this page</strong></p>
                        <p><strong>NO redirects - they stay on THIS screen</strong></p>
                        <br>
                        <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 14px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            üìû Load Contacts HERE
                        </button>
                        <p style="margin-top: 8px; font-size: 12px; color: #666;">
                            Click above and your contacts will display on this exact page
                        </p>
                    </div>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">
                    üè† HOME
                </button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            üîä SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            üè† HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>üó£Ô∏è Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text" id="leslieCommandsText">
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>üé§ IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <strong>Navigation Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, start talking" - Goes to speech recognition page<br>
                    ‚Ä¢ "Hey Leslie, start texting" - Goes to text input page<br>
                    ‚Ä¢ "Hey Leslie, home" - Returns to home page<br>
                    ‚Ä¢ "Hey Leslie, help" - Shows this commands list<br><br>
                    <strong>Phone Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, call John Doe" - Opens phone page and calls contact<br>
                    ‚Ä¢ "Hey Leslie, call 555-123-4567" - Calls the number directly<br><br>
                    <strong>Weather Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, current weather" - Shows today's weather<br>
                    ‚Ä¢ "Hey Leslie, weather" - Shows today's weather<br>
                    ‚Ä¢ "Hey Leslie, 7 day forecast" - Shows 7-day forecast<br>
                    ‚Ä¢ "Hey Leslie, 7 day" - Shows 7-day forecast<br>
                    ‚Ä¢ "Hey Leslie, hourly" - Shows 24-hour forecast<br>
                    ‚Ä¢ "Hey Leslie, hourly forecast" - Shows 24-hour forecast<br>
                    ‚Ä¢ "Hey Leslie, close" - Closes weather displays<br><br>
                    <strong>Recognition Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, clear text" - Clears speech recognition text<br>
                    ‚Ä¢ "Hey Leslie, enhanced mode" - Switches to enhanced recognition<br>
                    ‚Ä¢ "Hey Leslie, turn off enhanced mode" - Switches to regular recognition<br><br>
                    <strong>Speech Settings Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, speak faster" - Increases speech speed<br>
                    ‚Ä¢ "Hey Leslie, talk slower" - Decreases speech speed<br>
                    ‚Ä¢ "Hey Leslie, pause more" - Increases pause between words<br>
                    ‚Ä¢ "Hey Leslie, pause less" - Decreases pause between words<br>
                    ‚Ä¢ "Hey Leslie, turn off voice command speech" - Disables voice responses<br>
                    ‚Ä¢ "Hey Leslie, turn on voice command speech" - Enables voice responses<br><br>
                    <strong>Tips for better voice recognition:</strong><br>
                    ‚Ä¢ Allow microphone permission when prompted<br>
                    ‚Ä¢ Voice commands work from any page<br>
                    ‚Ä¢ Speech stays active until you press STOP LISTENING<br>
                    ‚Ä¢ Complete phrases are spoken back to you<br>
                    ‚Ä¢ Try Enhanced Mode if standard recognition struggles
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <!-- OpenAI API Key Section -->
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Enhanced Recognition)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable Enhanced Recognition mode.
                        Get yours at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput"
                           placeholder="sk-...">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        Your API key is stored locally and never shared
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div class="switch">
                        <input type="checkbox" id="autoEnhancedSwitch">
                        <label for="autoEnhancedSwitch">Auto-suggest Enhanced Recognition when needed</label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.5" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to pause between words when speaking</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0" max="2" step="0.5" value="0.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">0.5 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Enhanced Recognition Mode</div>
                    <div class="settings-description">Use OpenAI Whisper for better accuracy with unclear speech</div>
                    <div class="switch">
                        <input type="checkbox" id="enhancedModeSwitch">
                        <label for="enhancedModeSwitch">Enable Enhanced Mode by default</label>
                    </div>
                    <div class="setting-value" id="enhancedModeLabel">Enhanced Mode: OFF</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Voice Command Speech</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ‚Üê Back
            </button>
        </div>
    </div>

    <script>
        // All variables and functions contained within this single script block
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let isSpeaking = false;
        let silenceTimer = null;
        let userLocation = null;
        let finalPhraseSpoken = '';
        let phraseHistory = [];
        let currentInterimTranscript = '';
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: '',
            pauseBetweenWords: 0.5,
            enhancedMode: false
        };

        function initApp() {
            loadSettings();
            setupButtonHandlers();
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            setupSpeechRecognition();
            initializeContacts();
            setupSwipeDetection();
            setupBackButtonHandling();
            getUserLocation();
            updateEnhancedSectionVisibility();
            updateTextSpeakButton();
            console.log('Leslie Speech Assistant initialized successfully!');
        }

        function setupButtonHandlers() {
            document.getElementById('btnStartTalking').onclick = startTalkingFromHome;
            document.getElementById('btnStartTexting').onclick = function() { showPage('textInput'); };
            document.getElementById('btnPhoneCall').onclick = function() { showPage('phone'); };
            document.getElementById('btnCommands').onclick = function() { showPage('commands'); };
            document.getElementById('btnSettings').onclick = function() { showPage('settings'); };
            document.getElementById('btnCloseSpeech').onclick = navigateBack;
            document.getElementById('listenButton').onclick = toggleListening;
            document.getElementById('enhancedButton').onclick = startEnhancedRecognition;
            document.getElementById('btnClosePhone').onclick = function() { showPage('home'); };
            document.getElementById('btnPhoneHome').onclick = function() { showPage('home'); };
            document.getElementById('btnCloseCommands').onclick = navigateBack;
            document.getElementById('btnCloseText').onclick = navigateBack;
            document.getElementById('speakTextBtn').onclick = speakTextInput;
            document.getElementById('btnTextHome').onclick = function() { showPage('home'); };
            document.getElementById('largeTextInputField').oninput = updateTextSpeakButton;
            document.getElementById('btnCloseSettings').onclick = navigateBack;
            document.getElementById('btnSettingsHome').onclick = function() { showPage('home'); };
            document.getElementById('apiKeyInput').onchange = function(e) { saveApiKey(e.target.value); };
            document.getElementById('speechSpeedSlider').oninput = function(e) { updateSpeechSpeed(e.target.value); };
            document.getElementById('pauseBetweenWordsSlider').oninput = function(e) { updatePauseBetweenWords(e.target.value); };
            document.getElementById('speakVoiceCommandsSwitch').onchange = function(e) { updateVoiceCommandSetting(e.target.checked); };
            document.getElementById('autoEnhancedSwitch').onchange = function(e) { updateAutoEnhanced(e.target.checked); };
            document.getElementById('enhancedModeSwitch').onchange = function(e) { updateEnhancedMode(e.target.checked); };
        }

        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser.');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                updateListenButton();
                updateStatus('üé§ Listening... Say something!');
                console.log('Speech recognition started - eliminating all background audio');
                
                try {
                    speechSynth.cancel();
                    const audioElements = document.querySelectorAll('audio, video');
                    audioElements.forEach(el => {
                        el.pause();
                        el.currentTime = 0;
                    });
                    console.log('All background audio stopped');
                } catch (e) {
                    console.log('Error stopping audio:', e);
                }
                
                if (silenceTimer) clearTimeout(silenceTimer);
                silenceTimer = setTimeout(function() {
                    if (isListening) {
                        stopListening();
                        updateStatus('Stopped listening due to 3 minutes of silence');
                    }
                }, 3 * 60 * 1000);
            };

            recognition.onend = function() {
                if (isListening) {
                    setTimeout(() => {
                        if (isListening) {
                            try {
                                recognition.start();
                            } catch (error) {
                                console.log('Could not restart recognition');
                                isListening = false;
                                updateListenButton();
                                updateStatus('Recognition stopped');
                            }
                        }
                    }, 100);
                } else {
                    updateListenButton();
                    updateStatus('Ready to listen - Click "START TALKING" below');
                }
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
            };

            recognition.onerror = function(event) {
                console.log('Recognition error:', event.error);
                isListening = false;
                updateListenButton();
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                updateStatus('Recognition error (' + event.error + '). Please try again.');
            };

            recognition.onresult = function(event) {
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = setTimeout(function() {
                        if (isListening) {
                            stopListening();
                            updateStatus('Stopped listening due to 3 minutes of silence');
                        }
                    }, 3 * 60 * 1000);
                }
                
                let latestInterim = '';
                let latestFinal = '';
                
                for (let i = event.results.length - 1; i >= 0; i--) {
                    if (event.results[i].isFinal && !latestFinal) {
                        latestFinal = event.results[i][0].transcript.trim();
                    } else if (!event.results[i].isFinal && !latestInterim) {
                        latestInterim = event.results[i][0].transcript.trim();
                    }
                    if (latestFinal || latestInterim) break;
                }

                if (latestFinal && latestFinal.length > 3) {
                    if (latestFinal.toLowerCase().includes('leslie')) {
                        console.log('Filtered Leslie command:', latestFinal);
                        return;
                    }
                    
                    const isDuplicate = phraseHistory.includes(latestFinal) || 
                                      finalPhraseSpoken === latestFinal ||
                                      (phraseHistory.length > 0 && phraseHistory[phraseHistory.length - 1] === latestFinal);
                    
                    if (!isDuplicate) {
                        console.log('New complete phrase detected:', latestFinal);
                        currentInterimTranscript = '';
                        phraseHistory.push(latestFinal);
                        if (phraseHistory.length > 5) phraseHistory.shift();
                        updateSpeechDisplay();
                        finalPhraseSpoken = latestFinal;
                        updateStatus('‚úÖ Complete: ' + latestFinal);
                        
                        if (!isSpeaking) {
                            isSpeaking = true;
                            console.log('About to speak complete phrase:', latestFinal);
                            
                            if (speechSynth.speaking) {
                                speechSynth.cancel();
                            }
                            
                            setTimeout(() => {
                                const utterance = new SpeechSynthesisUtterance();
                                utterance.text = latestFinal;
                                utterance.lang = 'en-US';
                                utterance.rate = 1.0;
                                utterance.pitch = 1.0;
                                utterance.volume = 1.0;
                                
                                utterance.onstart = function() {
                                    console.log('Started speaking:', this.text);
                                };
                                
                                utterance.onend = function() {
                                    console.log('Completed speaking:', this.text);
                                    isSpeaking = false;
                                };
                                
                                utterance.onerror = function(event) {
                                    console.error('Speech error:', event.error);
                                    isSpeaking = false;
                                };
                                
                                console.log('Calling speechSynth.speak()');
                                speechSynth.speak(utterance);
                            }, 200);
                        }
                    }
                } else if (latestInterim && !isSpeaking && !latestFinal) {
                    if (!latestInterim.toLowerCase().includes('leslie')) {
                        if (currentInterimTranscript !== latestInterim) {
                            currentInterimTranscript = latestInterim;
                            updateSpeechDisplay();
                            updateStatus('üîÑ Listening: ' + latestInterim);
                        }
                    }
                }
            };
        }

        function updateSpeechDisplay() {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                let html = '';
                
                if (phraseHistory.length > 0) {
                    const lastPhrase = phraseHistory[phraseHistory.length - 1];
                    html += '<div class="final-phrase">‚úÖ ' + lastPhrase + '</div>';
                    
                    if (phraseHistory.length > 1) {
                        html += '<div style="color: #999; font-size: 12px; margin-top: 8px;">Previous phrases: ' + (phraseHistory.length - 1) + '</div>';
                    }
                }
                
                if (currentInterimTranscript.trim() && !isSpeaking) {
                    const lastFinal = phraseHistory.length > 0 ? phraseHistory[phraseHistory.length - 1] : '';
                    if (currentInterimTranscript !== lastFinal) {
                        html += '<div class="interim-phrase">üîÑ ' + currentInterimTranscript + '</div>';
                    }
                }
                
                if (html) {
                    recognizedTextEl.innerHTML = html;
                } else {
                    recognizedTextEl.innerHTML = '<div style="color: #666; font-style: italic;">Say something and your complete phrase will appear here...</div>';
                }
                
                const speechContent = document.querySelector('.speech-content');
                if (speechContent) {
                    speechContent.scrollTop = speechContent.scrollHeight;
                }
            }
        }

        function startTalkingFromHome() {
            showPage('speech');
            setTimeout(() => { 
                if (!isListening && !isSpeaking) {
                    startListening();
                }
            }, 1500);
        }

        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (recognition && !isListening && !isSpeaking) {
                try { 
                    recognition.start(); 
                } catch (error) {
                    console.log('Error starting recognition:', error);
                    updateStatus('Error starting recognition. Please try again.');
                }
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                isListening = false;
                try {
                    recognition.stop();
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                }
                
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }
                
                updateStatus('Stopped listening');
                updateListenButton();
            }
        }

        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }

        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = message;
        }

        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                console.log('Speaking text input:', text);
                
                if (speechSynth.speaking) {
                    speechSynth.cancel();
                }
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance();
                    utterance.text = text;
                    utterance.lang = 'en-US';
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onstart = function() {
                        console.log('Started speaking text:', this.text);
                    };
                    
                    utterance.onend = function() {
                        console.log('Completed speaking text:', this.text);
                    };
                    
                    speechSynth.speak(utterance);
                }, 200);
            }
        }

        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            if (speakBtn) {
                speakBtn.disabled = false;
                speakBtn.style.opacity = '1';
                speakBtn.style.background = '#9933cc';
            }
        }

        function initializeContacts() {
            contacts = [];
            filteredContacts = [];
        }

        async function loadRealContacts() {
            console.log('Loading contacts on same page');
            const contactsList = document.getElementById('contactsList');
            
            if (currentPage !== 'phone') {
                showPage('phone');
                setTimeout(() => loadRealContacts(), 300);
                return;
            }
            
            contactsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px;"><p><strong>üì± Loading your contacts...</strong></p><p>Contacts will appear RIGHT HERE on this page</p></div>';
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = {multiple: true};
                    
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList.length > 0) {
                        contacts = contactList.map(contact => ({
                            name: contact.name && contact.name[0] ? contact.name[0] : 'Unknown',
                            phone: contact.tel && contact.tel[0] ? contact.tel[0] : 'No phone'
                        }));
                        contacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayContactsOnPhonePage();
                    } else {
                        displayNoContactsMessage();
                    }
                } else {
                    contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #669900; border: 2px solid #669900; border-radius: 8px; background-color: #f8f9fa;"><p><strong>üì± Contacts Not Available</strong></p><p>Your browser doesn\'t support the Contacts API</p><p><strong>This works on:</strong></p><p>‚Ä¢ Chrome on Android</p><p>‚Ä¢ Safari on iOS</p><p>‚Ä¢ Make sure you\'re using HTTPS</p></div>';
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px; background: #ffebee;"><p><strong>üì± Contact Access Error</strong></p><p>Error: ' + (error.message || 'Unknown error') + '</p><p><strong>Contacts will appear on THIS page when loaded</strong></p></div>';
            }
        }

        function displayContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                displayNoContactsMessage();
                return;
            }

            const headerDiv = document.createElement('div');
            headerDiv.style.padding = '12px';
            headerDiv.style.textAlign = 'center';
            headerDiv.style.fontWeight = 'bold';
            headerDiv.style.color = '#669900';
            headerDiv.style.background = '#f0f8ff';
            headerDiv.style.borderRadius = '8px';
            headerDiv.style.marginBottom = '8px';
            headerDiv.textContent = 'üì± ' + filteredContacts.length + ' contacts loaded - Tap any contact to call';
            contactsList.appendChild(headerDiv);

            const contactsToShow = filteredContacts.slice(0, 100);
            contactsToShow.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = '<div class="contact-name">' + contact.name + '</div><div class="contact-phone">' + contact.phone + '</div>';
                contactEl.onclick = () => callContact(contact);
                contactsList.appendChild(contactEl);
            });

            if (filteredContacts.length > 100) {
                const moreDiv = document.createElement('div');
                moreDiv.style.padding = '16px';
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#666';
                moreDiv.textContent = '... and ' + (filteredContacts.length - 100) + ' more contacts. Use search above to find specific contacts.';
                contactsList.appendChild(moreDiv);
            }
        }

        function displayNoContactsMessage() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666; border: 2px solid #669900; border-radius: 8px; background: #f8f9fa;"><p><strong>üì± No Contacts Loaded</strong></p><p>You can try loading contacts again</p></div>';
        }

        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    const nameLower = contact.name.toLowerCase();
                    const phoneNumbers = contact.phone.replace(/[^0-9]/g, '');
                    const searchNumbers = searchTerm.replace(/[^0-9]/g, '');
                    return nameLower.includes(searchLower) ||
                        nameLower.startsWith(searchLower) ||
                        phoneNumbers.includes(searchNumbers) ||
                        contact.name.toLowerCase().split(' ').some(word => word.startsWith(searchLower));
                });
            }
            displayContactsOnPhonePage();
        }

        function callContact(contact) {
            window.location.href = 'tel:' + contact.phone.replace(/[^0-9]/g, '');
        }

        function showPage(pageId, addToHistory) {
            if (addToHistory === undefined) addToHistory = true;
            
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (addToHistory) {
                    pageHistory.push(pageId);
                    history.pushState({page: pageId}, '', '');
                }
                
                if (pageId !== 'speech' && isListening) {
                    stopListening();
                }
                
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textInput = document.getElementById('largeTextInputField');
                        if (textInput) {
                            textInput.focus();
                        }
                        updateTextSpeakButton();
                    }, 100);
                }
            }
        }

        function navigateBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPage = pageHistory[pageHistory.length - 1];
                showPage(previousPage, false);
            } else {
                showPage('home', false);
            }
        }

        function setupBackButtonHandling() {
            window.addEventListener('popstate', function(event) {
                event.preventDefault();
                navigateBack();
            });
            history.pushState({page: 'home'}, '', '');
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                };
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        console.log('Location obtained:', userLocation);
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        fetch('https://ipapi.co/json/')
                            .then(response => response.json())
                            .then(data => {
                                if (data.latitude && data.longitude) {
                                    userLocation = { 
                                        lat: data.latitude, 
                                        lon: data.longitude 
                                    };
                                    console.log('IP-based location obtained:', userLocation);
                                } else {
                                    throw new Error('IP location failed');
                                }
                            })
                            .catch(() => {
                                userLocation = { lat: 40.7128, lon: -74.0060 };
                                console.log('Using fallback location (New York):', userLocation);
                            });
                    },
                    options
                );
            } else {
                userLocation = { lat: 40.7128, lon: -74.0060 };
                console.log('Geolocation not supported, using fallback location');
            }
        }

        async function showCurrentWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            weatherTitle.textContent = '7-Day Forecast';
            weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Loading 7-day forecast...</div>';
            weatherDisplay.classList.remove('hidden');
            
            try {
                let lat, lon;
                if (userLocation) {
                    lat = userLocation.lat;
                    lon = userLocation.lon;
                } else {
                    lat = 40.7128;
                    lon = -74.0060;
                }
                
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + '&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7');
                const data = await response.json();
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                let weeklyData = '<div class="weekly-forecast" style="display: grid; gap: 6px; padding: 10px;">';
                
                for (let i = 0; i < 7; i++) {
                    if (i < data.daily.time.length) {
                        const date = new Date(data.daily.time[i]);
                        const dayName = days[date.getDay()];
                        const high = Math.round(data.daily.temperature_2m_max[i] * 9/5 + 32);
                        const low = Math.round(data.daily.temperature_2m_min[i] * 9/5 + 32);
                        const conditions = getWeatherDescription(data.daily.weather_code[i]);
                        
                        weeklyData += '<div class="weekly-item"><div class="day-name">' + dayName + '</div><div class="day-temps">' + high + '¬∞/' + low + '¬∞</div><div class="day-condition">' + conditions + '</div></div>';
                    }
                }
                weeklyData += '</div>';
                weatherContent.innerHTML = weeklyData;
            } catch (error) {
                console.error('Weekly weather fetch error:', error);
                weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load 7-day forecast.</div>';
            }
        }

        function getWeatherDescription(code) {
            const weatherCodes = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Fog',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with hail',
                99: 'Thunderstorm with heavy hail'
            };
            return weatherCodes[code] || 'Unknown';
        }

        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            weatherDisplay.classList.add('hidden');
        }

        function setupSwipeDetection() {
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            let minSwipeDistance = 50;

            swipeBottom.addEventListener('touchstart', function(e) {
                touchStartY = e.changedTouches[0].clientY;
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            swipeBottom.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].clientY;
                const swipeDistance = touchStartY - touchEndY;
                if (swipeDistance > minSwipeDistance) {
                    showCurrentWeather();
                }
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            swipeLeft.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].clientX;
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            swipeLeft.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].clientX;
                const swipeDistance = touchEndX - touchStartX;
                if (swipeDistance > minSwipeDistance) {
                    showHourlyWeather();
                }
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            swipeRight.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].clientX;
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            swipeRight.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].clientX;
                const swipeDistance = touchStartX - touchEndX;
                if (swipeDistance > minSwipeDistance) {
                    showWeeklyWeather();
                }
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    for (let key in parsed) {
                        if (settings.hasOwnProperty(key)) {
                            settings[key] = parsed[key];
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            updateSettingsUI();
        }

        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        function updateSettingsUI() {
            const speedSlider = document.getElementById('speechSpeedSlider');
            const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
            const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
            const enhancedSwitch = document.getElementById('autoEnhancedSwitch');
            const enhancedModeSwitch = document.getElementById('enhancedModeSwitch');
            const apiKeyInput = document.getElementById('apiKeyInput');

            if (speedSlider) speedSlider.value = settings.speechSpeed;
            if (pauseSlider) pauseSlider.value = settings.pauseBetweenWords;
            if (voiceSwitch) voiceSwitch.checked = settings.speakVoiceCommands;
            if (enhancedSwitch) enhancedSwitch.checked = settings.autoEnhanced;
            if (enhancedModeSwitch) enhancedModeSwitch.checked = settings.enhancedMode;
            if (apiKeyInput) apiKeyInput.value = settings.apiKey;

            updateSpeechSpeed(settings.speechSpeed);
            updatePauseBetweenWords(settings.pauseBetweenWords);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateAutoEnhanced(settings.autoEnhanced);
            updateEnhancedMode(settings.enhancedMode);
        }

        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            if (label) {
                if (value == 1.0) {
                    label.textContent = 'Normal (1.0x)';
                } else {
                    label.textContent = value + 'x';
                }
            }
            saveSettings();
        }

        function updatePauseBetweenWords(value) {
            settings.pauseBetweenWords = parseFloat(value);
            const label = document.getElementById('pauseBetweenWordsValue');
            if (label) {
                label.textContent = value + ' seconds';
            }
            saveSettings();
        }

        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            if (label) {
                label.textContent = 'Voice Command Speech: ' + (checked ? 'ON' : 'OFF');
            }
            
            const switchElement = document.getElementById('speakVoiceCommandsSwitch');
            if (switchElement) {
                switchElement.checked = checked;
            }
            
            saveSettings();
        }

        function updateAutoEnhanced(checked) {
            settings.autoEnhanced = checked;
            saveSettings();
        }

        function updateEnhancedMode(checked) {
            settings.enhancedMode = checked;
            const label = document.getElementById('enhancedModeLabel');
            if (label) {
                label.textContent = 'Enhanced Mode: ' + (checked ? 'ON' : 'OFF');
            }
            
            const switchElement = document.getElementById('enhancedModeSwitch');
            if (switchElement) {
                switchElement.checked = checked;
            }
            
            saveSettings();
        }

        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }

        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
            } else if (enhancedSection) {
                enhancedSection.classList.remove('show');
            }
        }

        function startEnhancedRecognition() {
            if (!settings.apiKey) {
                alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
                showPage('settings');
                return;
            }
            alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
        }

        function showEnhancedSuggestion() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
                const enhancedStatus = document.getElementById('enhancedStatus');
                if (enhancedStatus) {
                    enhancedStatus.textContent = 'Low confidence detected. Try Enhanced Recognition for better accuracy.';
                    enhancedStatus.style.color = '#ff6600';
                    enhancedStatus.style.fontWeight = 'bold';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Leslie Speech Assistant...');
            initApp();
        });

        document.addEventListener('visibilitychange', function() {
            console.log('Tab visibility changed - maintaining current state');
        });
    </script>
</body>
</html>Title.textContent = 'Current Weather';
            weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Loading weather data...</div>';
            weatherDisplay.classList.remove('hidden');
            
            try {
                let lat, lon;
                if (userLocation) {
                    lat = userLocation.lat;
                    lon = userLocation.lon;
                } else {
                    lat = 40.7128;
                    lon = -74.0060;
                }
                
                let locationName = 'Current Location';
                try {
                    const geoResponse = await fetch('https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + '&current=temperature_2m&timezone=auto');
                    const geoData = await geoResponse.json();
                    if (geoData.timezone) {
                        const timezoneParts = geoData.timezone.split('/');
                        if (timezoneParts.length > 1) {
                            locationName = timezoneParts[timezoneParts.length - 1].replace(/_/g, ' ');
                        }
                    }
                } catch (e) {
                    locationName = lat.toFixed(1) + ', ' + lon.toFixed(1);
                }
                
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + '&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto');
                const data = await response.json();
                
                const currentTime = new Date();
                const dateString = currentTime.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const temperature = Math.round(data.current.temperature_2m * 9/5 + 32);
                const humidity = data.current.relative_humidity_2m;
                const windSpeed = Math.round(data.current.wind_speed_10m * 0.621371);
                const conditions = getWeatherDescription(data.current.weather_code);
                
                weatherContent.innerHTML = '<div style="text-align: center; padding: 10px;"><div style="font-size: 16px; color: #666; margin-bottom: 12px; font-weight: bold;">' + dateString + '</div><div style="font-size: 28px; font-weight: bold; color: #0099cc; margin-bottom: 8px;">' + temperature + '¬∞F</div><div style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333;">' + conditions + '</div><div style="font-size: 14px; line-height: 1.6;"><div><strong>Humidity:</strong> ' + humidity + '%</div><div><strong>Wind:</strong> ' + windSpeed + ' mph</div><div><strong>Time:</strong> ' + currentTime.toLocaleTimeString() + '</div><div><strong>Location:</strong> ' + locationName + '</div></div></div>';
            } catch (error) {
                console.error('Weather fetch error:', error);
                weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load weather data.</div>';
            }
        }

        async function showHourlyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            weatherTitle.textContent = '24-Hour Forecast';
            weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Loading hourly forecast...</div>';
            weatherDisplay.classList.remove('hidden');
            
            try {
                let lat, lon;
                if (userLocation) {
                    lat = userLocation.lat;
                    lon = userLocation.lon;
                } else {
                    lat = 40.7128;
                    lon = -74.0060;
                }
                
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + '&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=1');
                const data = await response.json();
                
                let hourlyData = '<div class="hourly-forecast" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px; padding: 10px;">';
                
                for (let i = 0; i < 24; i++) {
                    if (i < data.hourly.time.length) {
                        const time = new Date(data.hourly.time[i]);
                        const hour = time.getHours();
                        const temp = Math.round(data.hourly.temperature_2m[i] * 9/5 + 32);
                        const conditions = getWeatherDescription(data.hourly.weather_code[i]);
                        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        
                        hourlyData += '<div class="hourly-item"><strong>' + displayHour + ' ' + ampm + '</strong><br>' + temp + '¬∞F<br><small>' + conditions + '</small></div>';
                    }
                }
                hourlyData += '</div>';
                weatherContent.innerHTML = hourlyData;
            } catch (error) {
                console.error('Hourly weather fetch error:', error);
                weatherContent.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load hourly forecast.</div>';
            }
        }

        async function showWeeklyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            weather
