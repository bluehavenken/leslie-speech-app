<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #0099cc;
            z-index: 1000;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            width: 90vw;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
            text-align: center;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .hourly-forecast, .weekly-forecast {
            display: grid;
            gap: 8px;
        }
        .hourly-item, .weekly-item {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }
        .weekly-item {
            display: grid;
            grid-template-columns: 80px 60px 1fr;
            gap: 8px;
            align-items: center;
            font-size: 14px;
        }
        .day-name { font-weight: bold; }
        .day-temps { color: #0099cc; font-weight: bold; }
        .day-condition { color: #666; }
        .swipe-edge {
            position: fixed;
            z-index: 998;
            background: rgba(0,153,204,0.3);
        }
        .swipe-bottom {
            bottom: 0;
            left: 40%;
            width: 20%;
            height: 40px;
        }
        .swipe-left {
            left: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .swipe-right {
            right: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .api-key-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        .contact-loading-section {
            padding: 20px;
            text-align: center;
            color: #669900;
            border: 2px solid #669900;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 16px;
        }
        .voice-command-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            border: 2px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .voice-command-status.active {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }
        .voice-command-status.permission-needed {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(220, 53, 69, 0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { 
                padding: 16px;
                width: 95vw;
                max-width: 450px;
            }
            .voice-command-status {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Voice commands work anywhere - just say "Hey Leslie" + command<br>
                    • Watch the green indicator (top-right) for voice command status<br>
                    • START TALKING page has continuous speech recognition<br>
                    • Use Enhanced Recognition for better accuracy<br>
                    • Swipe gestures: bottom center (weather), left/right sides (forecasts)
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Ready to listen - Starting automatically...
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">🔬 Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        🔬 START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        🗑️
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts
                </div>
                <input type="text" class="contact-search-input" id="contactSearchInput" placeholder="Type to search contacts...">
            </div>
            
            <div class="contact-loading-section" id="contactLoadingSection">
                <p><strong>📱 GET YOUR REAL CONTACTS</strong></p>
                <p style="color: #333; margin: 10px 0; font-size: 16px;">Currently showing: <span style="color: #cc0000;">Demo Contacts Only</span></p>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Choose how to load YOUR real contacts from your phone:
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button id="loadAllContactsBtn" style="margin: 5px; padding: 16px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📞 LOAD ALL CONTACTS
                    </button>
                    <button id="loadSelectedContactsBtn" style="margin: 5px; padding: 16px 24px; background: #0099cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📋 SELECT SPECIFIC CONTACTS
                    </button>
                </div>
                <p style="margin-top: 12px; font-size: 12px; color: #666;">
                    <strong>📞 LOAD ALL:</strong> Opens contact picker with auto-selection attempt<br>
                    <strong>📋 SELECT:</strong> Opens contact picker for manual selection<br>
                    <strong>⚠️ Works on Chrome Android & Safari iOS only</strong>
                </p>
            </div>
            
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    📱 Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">🏠 HOME</button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div style="font-size: 14px; font-weight: bold; color: #9933cc; margin-bottom: 8px;">
                        Type your text and tap speak to have it read aloud:
                    </div>
                    <textarea class="text-input large-text-input" id="largeTextInputField" placeholder="Type what you want to say here..."></textarea>
                    
                    <div class="speak-text-container">
                        <button class="speak-phrase-btn" id="speakTextBtn" disabled>
                            🔊 SPEAK
                        </button>
                    </div>
                    
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">🏠 HOME</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div style="padding: 16px; max-height: 70vh; overflow-y: auto; background: white; border-radius: 8px; margin: 8px;">
                <div style="font-size: 16px; line-height: 1.6; color: #333;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0099cc;">
                        <strong>🎤 Available Voice Commands</strong><br>
                        <span style="font-size: 14px; color: #666;">Voice commands work on all pages - watch for green indicator</span>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                            <strong style="color: #28a745;">🧭 Navigation Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>home</strong>" - Returns to home page<br>
                            • "Hey Leslie, <strong>start talking</strong>" - Speech recognition page<br>
                            • "Hey Leslie, <strong>start texting</strong>" - Text input page<br>
                            • "Hey Leslie, <strong>phone</strong>" - Phone contacts page<br>
                            • "Hey Leslie, <strong>settings</strong>" - Settings page<br>
                            • "Hey Leslie, <strong>help</strong>" - Shows this commands list<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #007bff;">
                            <strong style="color: #007bff;">🌤️ Weather Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>weather</strong>" - Shows current weather<br>
                            • "Hey Leslie, <strong>hourly</strong>" - Shows 24-hour forecast<br>
                            • "Hey Leslie, <strong>weekly</strong>" - Shows 7-day forecast<br>
                            • "Hey Leslie, <strong>7 day</strong>" - Shows 7-day forecast<br>
                            • "Hey Leslie, <strong>close weather</strong>" - Closes weather displays<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #6f42c1;">
                            <strong style="color: #6f42c1;">🎙️ Recognition Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>enhanced mode on</strong>" - Enables enhanced recognition<br>
                            • "Hey Leslie, <strong>enhanced mode off</strong>" - Disables enhanced recognition<br>
                            • "Hey Leslie, <strong>stop listening</strong>" - Stops speech recognition<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #dc3545;">
                            <strong style="color: #dc3545;">🔊 Speech Settings Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>speak faster</strong>" - Increases speech speed<br>
                            • "Hey Leslie, <strong>speak slower</strong>" - Decreases speech speed<br>
                            • "Hey Leslie, <strong>pause more</strong>" - Increases pause between words<br>
                            • "Hey Leslie, <strong>pause less</strong>" - Decreases pause between words<br>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">💡 Tips for Better Recognition</strong><br>
                        <div style="margin-top: 8px; font-size: 14px; color: #856404;">
                            • Speak clearly and at normal volume<br>
                            • Watch for the green indicator (top-right) to confirm voice commands are active<br>
                            • Voice commands work globally on all pages<br>
                            • Speech page has separate continuous recognition for phrases<br>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px; text-align: center;">
                <button class="btn-home" id="btnCommandsHome">🏠 HOME</button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>⚙️ Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Enhanced Recognition)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable enhanced speech recognition with better accuracy for unclear speech.
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your OpenAI API key here...">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        This key stays on your device and is only used for speech recognition.
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div class="switch">
                        <input type="checkbox" id="autoEnhancedSwitch">
                        <label for="autoEnhancedSwitch">Auto-suggest Enhanced Recognition when needed</label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.2" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to wait after you stop speaking before processing your complete phrase (higher = waits longer for you to finish)</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0.5" max="4" step="0.1" value="1.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">1.5 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Enhanced Recognition Mode</div>
                    <div class="settings-description">Use OpenAI Whisper for better accuracy with unclear speech</div>
                    <div class="switch">
                        <input type="checkbox" id="enhancedModeSwitch">
                        <label for="enhancedModeSwitch">Enable Enhanced Mode by default</label>
                    </div>
                    <div class="setting-value" id="enhancedModeLabel">Enhanced Mode: OFF</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Voice Command Speech</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">← Back</button>
        </div>

        <!-- Weather Display -->
        <div id="weatherDisplay" class="weather-display hidden">
            <div class="weather-title" id="weatherTitle">Weather Information</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Swipe Gesture Areas -->
        <div id="swipeBottom" class="swipe-edge swipe-bottom"></div>
        <div id="swipeLeft" class="swipe-edge swipe-left"></div>
        <div id="swipeRight" class="swipe-edge swipe-right"></div>

        <!-- Voice Command Status Indicator -->
        <div id="voiceCommandStatus" class="voice-command-status">🎤 Voice Commands Ready</div>
    </div>

    <script>
        // === GLOBAL STATE MANAGEMENT ===
        let speechRecognition = null; // For speech page continuous listening
        let voiceCommandRecognition = null; // For global voice commands
        let isMainListening = false; // Speech page listening
        let isVoiceCommandListening = false; // Global voice command listening
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let contacts = [];
        let filteredContacts = [];
        let userLocation = null;
        let isInitialized = false;
        
        // Voice command control
        let lastVoiceCommand = '';
        let lastVoiceCommandTime = 0;
        
        // Speech page recognition control
        let shouldKeepListening = false;
        let userStoppedManually = false;
        let sessionTimeoutId = null;
        let lastSpeechTime = null;
        const SESSION_TIMEOUT = 2 * 60 * 1000; // 2 minutes
        
        // Speech processing control
        let lastSpokenPhrase = '';
        let lastSpokenTime = 0;
        let isSpeaking = false;
        let currentSpeechUtterance = null;
        
        // Settings
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: '',
            pauseBetweenWords: 1.5,
            enhancedMode: false
        };

        // === SPEECH PAGE CONTINUOUS RECOGNITION ===
        function createSpeechRecognition() {
            console.log('🎤 Creating speech page continuous recognition...');
            
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                    speechRecognition.onstart = null;
                    speechRecognition.onend = null;
                    speechRecognition.onerror = null;
                    speechRecognition.onresult = null;
                } catch (e) {}
                speechRecognition = null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('❌ Speech Recognition not supported');
                updateStatus('❌ Speech Recognition not supported');
                return false;
            }
            
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            speechRecognition.maxAlternatives = 1;

            let lastResultIndex = 0;

            speechRecognition.onstart = function() {
                console.log('🎤 ✅ Speech page recognition started');
                isMainListening = true;
                lastResultIndex = 0;
                updateListenButton();
                updateStatus('🎤 Listening continuously... Speak your phrases!');
                resetSessionTimeout();
            };

            speechRecognition.onend = function() {
                console.log('🎤 Speech page recognition ended');
                isMainListening = false;
                updateListenButton();
                
                if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                    console.log('🔄 Restarting speech page session...');
                    setTimeout(() => {
                        if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                            try {
                                lastResultIndex = 0;
                                speechRecognition.start();
                            } catch (e) {
                                console.log('Restart failed');
                                updateStatus('✅ Session complete - click START TALKING to restart');
                            }
                        }
                    }, 200);
                } else {
                    updateStatus('✅ Stopped listening');
                    clearSessionTimeout();
                }
            };

            speechRecognition.onerror = function(event) {
                console.error('🎤 Speech recognition error:', event.error);
                isMainListening = false;
                updateListenButton();
                
                if (event.error === 'not-allowed') {
                    updateStatus('❌ Microphone access denied');
                    shouldKeepListening = false;
                } else if (event.error === 'no-speech') {
                    console.log('No speech - continuing...');
                    resetSessionTimeout();
                } else {
                    if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                        setTimeout(() => {
                            if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                                try {
                                    lastResultIndex = 0;
                                    speechRecognition.start();
                                } catch (e) {
                                    console.log('Error restart failed');
                                }
                            }
                        }, 1000);
                    }
                }
            };

            speechRecognition.onresult = function(event) {
                let allInterimText = '';
                let newFinalText = '';
                
                for (let i = lastResultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    
                    if (result.isFinal) {
                        console.log('✅ FINAL speech result:', transcript);
                        newFinalText += transcript;
                        lastResultIndex = i + 1;
                    } else {
                        allInterimText += transcript;
                    }
                }
                
                if (allInterimText.trim()) {
                    displayInterimPhrase(allInterimText.trim());
                }
                
                if (newFinalText.trim()) {
                    const cleanFinalText = newFinalText.trim();
                    console.log('📝 Processing speech phrase:', cleanFinalText);
                    processSpeechPhrase(cleanFinalText);
                }
                
                resetSessionTimeout();
            };
            
            return true;
        }

        // === GLOBAL VOICE COMMANDS RECOGNITION ===
        function createVoiceCommandRecognition() {
            console.log('🗣️ Creating GLOBAL voice command recognition...');
            
            if (voiceCommandRecognition) {
                try {
                    voiceCommandRecognition.abort();
                    voiceCommandRecognition.onstart = null;
                    voiceCommandRecognition.onend = null;
                    voiceCommandRecognition.onerror = null;
                    voiceCommandRecognition.onresult = null;
                } catch (e) {}
                voiceCommandRecognition = null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('❌ Voice commands not supported');
                return false;
            }
            
            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';
            voiceCommandRecognition.maxAlternatives = 1;

            voiceCommandRecognition.onstart = function() {
                console.log('🗣️ ✅ Global voice commands started');
                isVoiceCommandListening = true;
                updateVoiceCommandStatus('active');
            };

            voiceCommandRecognition.onend = function() {
                console.log('🗣️ Global voice commands ended');
                isVoiceCommandListening = false;
                updateVoiceCommandStatus('inactive');
                
                // Always restart voice commands (they should be always active)
                setTimeout(() => {
                    if (isInitialized) {
                        try {
                            voiceCommandRecognition.start();
                        } catch (e) {
                            console.log('Voice command restart failed');
                            setTimeout(() => {
                                if (isInitialized) {
                                    try {
                                        voiceCommandRecognition.start();
                                    } catch (e2) {
                                        console.log('Voice command restart failed again');
                                    }
                                }
                            }, 2000);
                        }
                    }
                }, 500);
            };

            voiceCommandRecognition.onerror = function(event) {
                console.error('🗣️ Voice command error:', event.error);
                isVoiceCommandListening = false;
                
                if (event.error === 'not-allowed') {
                    updateVoiceCommandStatus('permission-needed');
                } else {
                    updateVoiceCommandStatus('inactive');
                    setTimeout(() => {
                        if (isInitialized) {
                            try {
                                voiceCommandRecognition.start();
                            } catch (e) {
                                console.log('Voice command error restart failed');
                            }
                        }
                    }, 2000);
                }
            };

            voiceCommandRecognition.onresult = function(event) {
                const result = event.results[event.results.length - 1];
                if (result.isFinal) {
                    const transcript = result[0].transcript.trim();
                    console.log('🗣️ Voice command heard:', transcript);
                    
                    if (isVoiceCommand(transcript)) {
                        processVoiceCommand(transcript);
                    }
                }
            };
            
            return true;
        }

        // Display functions for speech page
        function displayInterimPhrase(interimText) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl && interimText.trim()) {
                recognizedTextEl.innerHTML = `
                    <div style="background: #fff8e1; padding: 12px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #ffa000; color: #666; font-style: italic;">
                        🎤 Speaking: "${interimText}"
                    </div>
                `;
                recognizedTextEl.scrollTop = recognizedTextEl.scrollHeight;
            }
        }

        function processSpeechPhrase(phrase) {
            console.log('✅ Processing speech phrase:', phrase);
            displayFinalPhrase(phrase);
            
            if (!isSpeaking) {
                setTimeout(() => {
                    speakCompletePhrase(phrase);
                }, 300);
            }
        }

        function displayFinalPhrase(phrase) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                recognizedTextEl.innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #28a745; font-weight: bold; font-size: 16px;">
                        ✅ You said: "${phrase}"
                    </div>
                `;
                recognizedTextEl.scrollTop = recognizedTextEl.scrollHeight;
            }
        }

        // FIXED SPEECH SYNTHESIS
        function speakCompletePhrase(phrase) {
            if (isSpeaking) {
                console.log('🔊 Already speaking, skipping');
                return;
            }
            
            if (phrase === lastSpokenPhrase && (Date.now() - lastSpokenTime) < 3000) {
                console.log('🔊 Duplicate phrase, skipping');
                return;
            }
            
            console.log('🔊 Speaking complete phrase:', phrase);
            isSpeaking = true;
            lastSpokenPhrase = phrase;
            lastSpokenTime = Date.now();
            
            speechSynth.cancel();
            
            setTimeout(() => {
                try {
                    const utterance = new SpeechSynthesisUtterance(phrase);
                    utterance.text = phrase;
                    utterance.lang = 'en-US';
                    utterance.rate = Math.max(0.5, Math.min(2.0, settings.speechSpeed || 1.0));
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onstart = function() {
                        console.log('🔊 ✅ Speech started for:', phrase);
                        updateStatus('🔊 Speaking: "' + phrase + '"');
                    };
                    
                    utterance.onend = function() {
                        console.log('🔊 ✅ Speech completed');
                        isSpeaking = false;
                        currentSpeechUtterance = null;
                        updateStatus('🎤 Ready for your next phrase!');
                        
                        // AUTO-CLEAR screen after speech as requested
                        setTimeout(() => {
                            const recognizedTextEl = document.getElementById('recognizedText');
                            if (recognizedTextEl && shouldKeepListening) {
                                recognizedTextEl.innerHTML = '<div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">🎤 Ready for your next phrase...</div>';
                            }
                        }, 1000);
                    };
                    
                    utterance.onerror = function(event) {
                        console.error('🔊 Speech error:', event.error);
                        isSpeaking = false;
                        currentSpeechUtterance = null;
                        speechSynth.cancel();
                    };
                    
                    currentSpeechUtterance = utterance;
                    speechSynth.speak(utterance);
                    
                } catch (error) {
                    console.error('🔊 Speech synthesis error:', error);
                    isSpeaking = false;
                    currentSpeechUtterance = null;
                }
            }, 500);
        }

        // === VOICE COMMANDS ===
        function isVoiceCommand(phrase) {
            const normalizedPhrase = phrase.toLowerCase().trim();
            return normalizedPhrase.includes('hey leslie') || normalizedPhrase.startsWith('leslie');
        }

        function processVoiceCommand(phrase) {
            const normalizedPhrase = phrase.toLowerCase().trim();
            console.log('🗣️ Processing voice command:', normalizedPhrase);
            
            if (normalizedPhrase === lastVoiceCommand && (Date.now() - lastVoiceCommandTime) < 3000) {
                console.log('🚫 Duplicate voice command ignored');
                return;
            }
            
            lastVoiceCommand = normalizedPhrase;
            lastVoiceCommandTime = Date.now();
            
            let command = '';
            if (normalizedPhrase.includes('hey leslie')) {
                command = normalizedPhrase.split('hey leslie')[1].trim();
            } else if (normalizedPhrase.startsWith('leslie')) {
                command = normalizedPhrase.substring(6).trim();
            }
            
            executeVoiceCommand(command);
        }

        function executeVoiceCommand(cmd) {
            console.log('🎯 Executing voice command:', cmd);
            
            // Navigation commands
            if (cmd.includes('home')) {
                showPage('home');
                speakResponse('Going to home page');
                return;
            }
            
            if (cmd.includes('start talking') || cmd.includes('speech')) {
                showPage('speech');
                speakResponse('Starting speech recognition');
                return;
            }
            
            if (cmd.includes('start texting') || cmd.includes('text')) {
                showPage('textInput');
                speakResponse('Opening text input');
                return;
            }
            
            if (cmd.includes('phone') || cmd.includes('contact')) {
                showPage('phone');
                speakResponse('Opening contacts');
                return;
            }
            
            if (cmd.includes('settings')) {
                showPage('settings');
                speakResponse('Opening settings');
                return;
            }
            
            if (cmd.includes('help') || cmd.includes('commands')) {
                showPage('commands');
                speakResponse('Showing voice commands');
                return;
            }
            
            // Weather commands
            if (cmd.includes('weather') && !cmd.includes('close')) {
                showCurrentWeather();
                speakResponse('Showing current weather');
                return;
            }
            
            if (cmd.includes('hourly')) {
                showHourlyWeather();
                speakResponse('Showing hourly forecast');
                return;
            }
            
            if (cmd.includes('weekly') || cmd.includes('7 day')) {
                showWeeklyWeather();
                speakResponse('Showing weekly forecast');
                return;
            }
            
            if (cmd.includes('close')) {
                hideWeather();
                speakResponse('Closing weather');
                return;
            }
            
            // Speech settings
            if (cmd.includes('speak faster')) {
                adjustSpeechSpeed(0.2);
                speakResponse('Speech speed increased');
                return;
            }
            
            if (cmd.includes('speak slower')) {
                adjustSpeechSpeed(-0.2);
                speakResponse('Speech speed decreased');
                return;
            }
            
            if (cmd.includes('pause more')) {
                adjustPauseBetweenWords(0.3);
                speakResponse('Pause between words increased');
                return;
            }
            
            if (cmd.includes('pause less')) {
                adjustPauseBetweenWords(-0.3);
                speakResponse('Pause between words decreased');
                return;
            }
            
            // Recognition commands
            if (cmd.includes('enhanced mode on')) {
                updateEnhancedMode(true);
                speakResponse('Enhanced mode enabled');
                return;
            }
            
            if (cmd.includes('enhanced mode off')) {
                updateEnhancedMode(false);
                speakResponse('Enhanced mode disabled');
                return;
            }
            
            if (cmd.includes('stop listening')) {
                stopListening();
                speakResponse('Stopping speech recognition');
                return;
            }
            
            console.log('❓ Unknown voice command:', cmd);
            speakResponse('I did not understand that command');
        }

        function speakResponse(text) {
            if (!settings.speakVoiceCommands) return;
            
            console.log('🔊 Speaking response:', text);
            speechSynth.cancel();
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed || 1.0;
                utterance.volume = 0.8;
                speechSynth.speak(utterance);
            }, 100);
        }

        function adjustSpeechSpeed(delta) {
            const newSpeed = Math.max(0.5, Math.min(2.0, settings.speechSpeed + delta));
            updateSpeechSpeed(newSpeed);
        }

        function adjustPauseBetweenWords(delta) {
            const newPause = Math.max(0.5, Math.min(4.0, settings.pauseBetweenWords + delta));
            updatePauseBetweenWords(newPause);
        }

        function updateVoiceCommandStatus(status) {
            const statusEl = document.getElementById('voiceCommandStatus');
            if (statusEl) {
                statusEl.className = 'voice-command-status';
                
                if (status === 'active') {
                    statusEl.classList.add('active');
                    statusEl.textContent = '🎤 Voice Commands Active';
                } else if (status === 'permission-needed') {
                    statusEl.classList.add('permission-needed');
                    statusEl.textContent = '🎤 Microphone Permission Needed';
                } else {
                    statusEl.style.display = 'none';
                }
            }
        }

        // Session timeout for speech page
        function resetSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
            
            lastSpeechTime = Date.now();
            
            sessionTimeoutId = setTimeout(() => {
                if (shouldKeepListening && currentPage === 'speech') {
                    console.log('⏰ 2-minute session timeout reached');
                    stopListening();
                    updateStatus('⏰ Session timeout (2 minutes) - Click "START TALKING" to restart');
                }
                sessionTimeoutId = null;
            }, SESSION_TIMEOUT);
        }

        function clearSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
        }

        // Speech page controls
        function toggleListening() {
            if (isMainListening || shouldKeepListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            console.log('🎤 Starting speech page listening...');
            
            if (shouldKeepListening) {
                console.log('⚠️ Already listening');
                return;
            }
            
            shouldKeepListening = true;
            userStoppedManually = false;
            isSpeaking = false;
            
            updateStatus('🎤 Preparing continuous recognition...');
            
            const recognitionCreated = createSpeechRecognition();
            
            if (!recognitionCreated) {
                updateStatus('❌ Speech recognition not supported');
                shouldKeepListening = false;
                return;
            }
            
            try {
                updateStatus('🎤 Starting continuous listening...');
                speechRecognition.start();
            } catch (error) {
                console.error('❌ Failed to start recognition:', error);
                shouldKeepListening = false;
                isMainListening = false;
                updateListenButton();
                updateStatus('❌ Failed to start recognition');
            }
        }

        function stopListening() {
            console.log('🛑 Stopping speech page listening...');
            
            shouldKeepListening = false;
            userStoppedManually = true;
            
            clearSessionTimeout();
            
            speechSynth.cancel();
            if (currentSpeechUtterance) {
                currentSpeechUtterance = null;
            }
            isSpeaking = false;
            
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                } catch (e) {
                    console.log('Recognition already stopped');
                }
            }
            
            isMainListening = false;
            updateListenButton();
            updateStatus('🛑 Stopped - Click "START TALKING" to begin again');
        }

        // === UI FUNCTIONS ===
        function showPage(pageId) {
            console.log('📄 Showing page:', pageId);
            
            try {
                if (currentPage === 'speech' && pageId !== 'speech') {
                    console.log('🧹 Leaving speech page - stopping listening...');
                    stopListening();
                }
                
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                    currentPage = pageId;
                    
                    if (pageId === 'speech') {
                        console.log('📄 Entering speech page - AUTO-START');
                        
                        const recognizedTextEl = document.getElementById('recognizedText');
                        if (recognizedTextEl) {
                            recognizedTextEl.innerHTML = '<div style="color: #0099cc; font-weight: bold; text-align: center; padding: 20px; font-size: 18px;">🎤 Initializing continuous speech recognition...<br><br>Get ready to speak!</div>';
                        }
                        
                        updateStatus('🎤 Auto-starting...');
                        updateListenButton();
                        
                        // AUTO-START listening as requested
                        setTimeout(() => {
                            startListening();
                        }, 800);
                    }
                    
                    if (pageId === 'phone') {
                        displayContactsOnPhonePage();
                    }
                    
                    if (pageId === 'textInput') {
                        const textField = document.getElementById('largeTextInputField');
                        if (textField) {
                            setTimeout(() => textField.focus(), 100);
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Error showing page:', error);
            }
        }

        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isMainListening || shouldKeepListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }

        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) {
                statusText.textContent = message;
