<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        /* Voice Command Status */
        .voice-command-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 153, 204, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .voice-command-status.active {
            background: rgba(40, 167, 69, 0.9);
            display: block;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Voice Command Status Indicator -->
        <div class="voice-command-status" id="voiceCommandStatus">üéôÔ∏è Voice Commands Ready</div>

        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    üé§ START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    üìù START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    üìû PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    üó£Ô∏è LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Voice commands work best with microphone permission granted<br>
                    ‚Ä¢ Say "Hey Leslie" followed by commands for voice control<br>
                    ‚Ä¢ Click START TALKING for continuous speech recognition<br>
                    ‚Ä¢ Voice commands are active when the indicator shows green<br>
                    ‚Ä¢ Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Ready to listen - Click START TALKING to begin!
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>üìû Voice Commands Demo</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div style="padding: 20px; text-align: center;">
                <p>This page demonstrates voice commands functionality.</p>
                <p>Try saying: "Hey Leslie, home" to return to the home page.</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-home" id="btnPhoneHome">üè† HOME</button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            üîä SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">üè† HOME</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>üó£Ô∏è Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text" id="leslieCommandsText">
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>üé§ IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <strong>Navigation Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, start talking" - Goes to speech recognition page<br>
                    ‚Ä¢ "Hey Leslie, start texting" - Goes to text input page<br>
                    ‚Ä¢ "Hey Leslie, home" - Returns to home page<br>
                    ‚Ä¢ "Hey Leslie, help" - Shows this commands list<br><br>
                    <strong>Recognition Commands:</strong><br>
                    ‚Ä¢ "Hey Leslie, clear text" - Clears speech recognition text<br><br>
                    <strong>Tips for better voice recognition:</strong><br>
                    ‚Ä¢ Allow microphone permission when prompted<br>
                    ‚Ä¢ Voice commands work from any page<br>
                    ‚Ä¢ Look for the green voice command indicator<br>
                    ‚Ä¢ Speech stays active until you press STOP LISTENING<br>
                    ‚Ä¢ Complete phrases are spoken back to you
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let recognition = null;
        let voiceCommandRecognition = null;
        let isListening = false;
        let isVoiceCommandListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let phraseHistory = [];
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true
        };

        // Voice command restart management
        let voiceCommandRestartTimeout = null;
        let voiceCommandAttempts = 0;
        const MAX_VOICE_COMMAND_ATTEMPTS = 5;

        // Initialize app
        function initApp() {
            console.log('üöÄ Initializing Leslie Speech Assistant...');
            loadSettings();
            setupEventHandlers();
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            
            setupSpeechRecognition();
            setupBackButtonHandling();
            
            // Initialize voice commands after a delay
            setTimeout(() => {
                initializeVoiceCommands();
            }, 2000);
            
            console.log('‚úÖ Leslie Speech Assistant initialized!');
        }

        // Set up all event handlers
        function setupEventHandlers() {
            // Main navigation buttons
            document.getElementById('btnStartTalking').addEventListener('click', startTalkingFromHome);
            document.getElementById('btnStartTexting').addEventListener('click', () => showPage('textInput'));
            document.getElementById('btnPhoneCall').addEventListener('click', () => showPage('phone'));
            document.getElementById('btnCommands').addEventListener('click', () => showPage('commands'));
            document.getElementById('btnSettings').addEventListener('click', () => alert('Settings page not implemented in this demo'));
            
            // Page close buttons
            document.getElementById('btnCloseSpeech').addEventListener('click', () => showPage('home'));
            document.getElementById('btnClosePhone').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseCommands').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseText').addEventListener('click', () => showPage('home'));
            
            // Speech page controls
            document.getElementById('listenButton').addEventListener('click', toggleListening);
            document.getElementById('clearButton').addEventListener('click', clearSpeechText);
            
            // Phone page controls
            document.getElementById('btnPhoneHome').addEventListener('click', () => showPage('home'));
            
            // Text page controls
            document.getElementById('speakTextBtn').addEventListener('click', speakTextInput);
            document.getElementById('btnTextHome').addEventListener('click', () => showPage('home'));
            document.getElementById('largeTextInputField').addEventListener('input', updateTextSpeakButton);
        }

        // Setup main speech recognition
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.error('‚ùå Speech recognition not supported');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isListening = true;
                updateListenButton();
                updateStatus('üé§ Listening - Speak clearly');
                console.log('‚úÖ Main recognition started');
            };

            recognition.onend = function() {
                console.log('üîÑ Main recognition ended');
                isListening = false;
                
                const listenButton = document.getElementById('listenButton');
                if (currentPage === 'speech' && 
                    listenButton && 
                    listenButton.textContent === 'STOP LISTENING') {
                    
                    console.log('üîÑ Restarting main recognition...');
                    setTimeout(() => {
                        if (currentPage === 'speech' && 
                            listenButton.textContent === 'STOP LISTENING') {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('‚ùå Restart failed:', e);
                                updateListenButton();
                                updateStatus('‚ùå Click "START TALKING" to restart');
                            }
                        }
                    }, 500);
                } else {
                    updateListenButton();
                    updateStatus('‚úÖ Stopped - Click "START TALKING" to restart');
                }
            };

            recognition.onerror = function(event) {
                console.log('‚ùå Main recognition error:', event.error);
                isListening = false;
                updateListenButton();
                
                if (event.error === 'no-speech') {
                    updateStatus('üîá No speech detected - speak louder');
                } else if (event.error === 'audio-capture') {
                    updateStatus('üé§ Check microphone permissions');
                } else {
                    updateStatus('‚ùå Error: ' + event.error);
                }
            };

            recognition.onresult = function(event) {
                console.log('üìù Processing main speech results...');
                
                let finalText = '';
                for (let i = event.results.length - 1; i >= 0; i--) {
                    if (event.results[i].isFinal) {
                        finalText = event.results[i][0].transcript.trim();
                        break;
                    }
                }
                
                if (finalText && finalText.length > 1) {
                    console.log('üìù Final phrase:', finalText);
                    
                    // Skip duplicates
                    if (phraseHistory.length > 0 && phraseHistory[phraseHistory.length - 1] === finalText) {
                        console.log('‚ö†Ô∏è Skipping duplicate');
                        return;
                    }
                    
                    // Check for voice commands
                    if (finalText.toLowerCase().includes('hey leslie') || finalText.toLowerCase().includes('leslie')) {
                        console.log('üéôÔ∏è Voice command in main recognition:', finalText);
                        processVoiceCommand(finalText);
                        return;
                    }
                    
                    // Regular speech processing
                    phraseHistory.push(finalText);
                    if (phraseHistory.length > 10) phraseHistory.shift();
                    updateSpeechDisplay();
                    updateStatus(`‚úÖ Got: "${finalText}"`);
                    
                    // Speak back
                    setTimeout(() => {
                        speakCompletePhrase(finalText);
                    }, 500);
                }
            };
            
            console.log('‚úÖ Main speech recognition setup complete');
        }

        // FIXED: Initialize voice commands properly
        function initializeVoiceCommands() {
            console.log('üéôÔ∏è Initializing voice commands...');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('‚ùå Speech recognition not supported for voice commands');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceCommandRecognition = new SpeechRecognition();
            
            voiceCommandRecognition.continuous = false;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';
            voiceCommandRecognition.maxAlternatives = 1;
            
            voiceCommandRecognition.onstart = function() {
                isVoiceCommandListening = true;
                updateVoiceCommandStatus(true);
                console.log('‚úÖ Voice commands listening started');
            };
            
            voiceCommandRecognition.onresult = function(event) {
                if (event.results.length > 0 && event.results[0].isFinal) {
                    const transcript = event.results[0][0].transcript.trim();
                    console.log('üéôÔ∏è Voice command heard:', transcript);
                    
                    if (transcript.toLowerCase().includes('hey leslie') || 
                        transcript.toLowerCase().includes('leslie')) {
                        console.log('üéôÔ∏è Processing voice command:', transcript);
                        processVoiceCommand(transcript);
                    }
                }
            };
            
            voiceCommandRecognition.onend = function() {
                isVoiceCommandListening = false;
                updateVoiceCommandStatus(false);
                console.log('üéôÔ∏è Voice command session ended');
                
                // Restart voice commands if not on speech page and not listening
                if (currentPage !== 'speech' && !isListening) {
                    scheduleVoiceCommandRestart();
                }
            };
            
            voiceCommandRecognition.onerror = function(event) {
                isVoiceCommandListening = false;
                updateVoiceCommandStatus(false);
                console.log('üéôÔ∏è Voice command error:', event.error);
                
                // Restart after error with backoff
                if (currentPage !== 'speech' && !isListening) {
                    scheduleVoiceCommandRestart(true);
                }
            };
            
            // Start voice commands initially
            startVoiceCommands();
        }

        // FIXED: Proper voice command restart scheduling
        function scheduleVoiceCommandRestart(isError = false) {
            // Clear any existing restart timeout
            if (voiceCommandRestartTimeout) {
                clearTimeout(voiceCommandRestartTimeout);
            }
            
            // Increase delay on errors
            const delay = isError ? 3000 : 1500;
            
            // Limit restart attempts
            if (voiceCommandAttempts >= MAX_VOICE_COMMAND_ATTEMPTS) {
                console.log('üõë Max voice command restart attempts reached');
                return;
            }
            
            voiceCommandAttempts++;
            
            voiceCommandRestartTimeout = setTimeout(() => {
                if (currentPage !== 'speech' && !isListening && !isVoiceCommandListening) {
                    console.log('üîÑ Restarting voice commands (attempt', voiceCommandAttempts, ')');
                    startVoiceCommands();
                }
            }, delay);
        }

        // FIXED: Start voice commands with proper state management
        function startVoiceCommands() {
            if (currentPage === 'speech' || isListening || isVoiceCommandListening) {
                console.log('üéôÔ∏è Skipping voice command start - main recognition active or already listening');
                return;
            }
            
            if (!voiceCommandRecognition) {
                console.log('‚ùå Voice command recognition not initialized');
                return;
            }
            
            try {
                console.log('üéôÔ∏è Starting voice command listening...');
                voiceCommandRecognition.start();
                voiceCommandAttempts = 0; // Reset attempts on successful start
            } catch (e) {
                console.log('üéôÔ∏è Error starting voice commands:', e.message);
                isVoiceCommandListening = false;
                updateVoiceCommandStatus(false);
                
                // Schedule restart on error
                scheduleVoiceCommandRestart(true);
            }
        }

        // Stop voice commands
        function stopVoiceCommands() {
            if (voiceCommandRecognition && isVoiceCommandListening) {
                try {
                    voiceCommandRecognition.abort();
                    console.log('üõë Voice commands stopped');
                } catch (e) {
                    console.log('üéôÔ∏è Error stopping voice commands:', e);
                }
            }
            
            isVoiceCommandListening = false;
            updateVoiceCommandStatus(false);
            
            // Clear restart timeout
            if (voiceCommandRestartTimeout) {
                clearTimeout(voiceCommandRestartTimeout);
                voiceCommandRestartTimeout = null;
            }
        }

        // Update voice command status indicator
        function updateVoiceCommandStatus(isActive) {
            const statusEl = document.getElementById('voiceCommandStatus');
            if (statusEl) {
                if (isActive) {
                    statusEl.classList.add('active');
                    statusEl.textContent = 'üéôÔ∏è Voice Commands Active';
                } else {
                    statusEl.classList.remove('active');
                    statusEl.textContent = 'üéôÔ∏è Voice Commands Ready';
                }
            }
        }

        // FIXED: Process voice commands with proper navigation
        function processVoiceCommand(command) {
            console.log('üéôÔ∏è Processing voice command:', command);
            const cmd = command.toLowerCase().trim();
            
            if (cmd.includes('home')) {
                console.log('‚úÖ HOME command');
                showPage('home');
                speakResponse('Going home');
            } else if (cmd.includes('start talking')) {
                console.log('‚úÖ START TALKING command');
                startTalkingFromHome();
                speakResponse('Starting speech recognition');
            } else if (cmd.includes('start texting')) {
                console.log('‚úÖ START TEXTING command');
                showPage('textInput');
                speakResponse('Opening text input');
            } else if (cmd.includes('help') || cmd.includes('commands')) {
                console.log('‚úÖ HELP command');
                showPage('commands');
                speakResponse('Showing commands');
            } else if (cmd.includes('clear text') || cmd.includes('clear speech')) {
                console.log('‚úÖ CLEAR command');
                clearSpeechText();
                speakResponse('Clearing text');
            } else {
                console.log('‚ùå Command not recognized:', cmd);
                speakResponse('Command not recognized');
            }
        }

        // Speak response to voice commands
        function speakResponse(text) {
            if (!settings.speakVoiceCommands) return;
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                speechSynth.speak(utterance);
            }, 300);
        }

        // Speak complete phrase
        function speakCompletePhrase(text) {
            console.log('üîä Speaking phrase:', text);
            
            try {
                speechSynth.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = settings.speechSpeed;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onstart = function() {
                        console.log('‚úÖ Speech started');
                    };
                    
                    utterance.onend = function() {
                        console.log('‚úÖ Speech completed');
                    };
                    
                    utterance.onerror = function(event) {
                        console.error('‚ùå Speech error:', event.error);
                    };
                    
                    speechSynth.speak(utterance);
                }, 500);
            } catch (e) {
                console.error('‚ùå Error in speech synthesis:', e);
            }
        }

        // Update speech display
        function updateSpeechDisplay() {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                let html = '';
                
                if (phraseHistory.length > 0) {
                    const latestPhrase = phraseHistory[phraseHistory.length - 1];
                    html += `<div class="final-phrase" style="font-size: 18px; font-weight: bold;">
                                ‚úÖ LATEST: ${latestPhrase}
                             </div>`;
                    
                    if (phraseHistory.length > 1) {
                        html += `<div style="color: #999; font-size: 14px; margin-top: 12px; text-align: center; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                                    üìù Previous phrases: ${phraseHistory.length - 1}
                                 </div>`;
                    }
                } else {
                    html = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Say something and your phrase will appear here...</div>';
                }
                
                recognizedTextEl.innerHTML = html;
            }
        }

        // Clear speech text
        function clearSpeechText() {
            phraseHistory = [];
            updateSpeechDisplay();
            console.log('üóëÔ∏è Speech text cleared');
        }

        // Start talking from home page
        function startTalkingFromHome() {
            showPage('speech');
            setTimeout(() => {
                if (!isListening && currentPage === 'speech') {
                    startListening();
                }
            }, 200);
        }

        // Toggle listening
        function toggleListening() {
            if (isListening) {
                console.log('üõë Stopping main recognition');
                if (recognition) {
                    try {
                        recognition.abort();
                    } catch (error) {
                        console.log('Error stopping recognition:', error);
                    }
                }
                isListening = false;
                updateListenButton();
                updateStatus('üõë Stopped. Click "START TALKING" to restart.');
                
                // Restart voice commands
                setTimeout(() => {
                    if (!isListening && currentPage !== 'speech') {
                        startVoiceCommands();
                    }
                }, 1000);
            } else {
                console.log('üé§ Starting main recognition');
                startListening();
            }
        }

        // Start listening
        function startListening() {
            if (recognition && !isListening) {
                try {
                    // Stop voice commands when starting main recognition
                    if (isVoiceCommandListening) {
                        console.log('üõë Stopping voice commands for main recognition');
                        stopVoiceCommands();
                    }
                    
                    recognition.start();
                    console.log('‚úÖ Main recognition start command sent');
                } catch (error) {
                    console.log('‚ùå Error starting main recognition:', error);
                    updateStatus('‚ùå Error: ' + error.message);
                }
            }
        }

        // Update listen button
        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }

        // Update status text
        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = message;
        }

        // Speak text input
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                if (speechSynth.speaking) speechSynth.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = settings.speechSpeed;
                    
                    utterance.onend = function() {
                        console.log('‚úÖ Text speech finished');
                        textInput.value = '';
                        updateTextSpeakButton();
                    };
                    
                    speechSynth.speak(utterance);
                }, 200);
            }
        }

        // Update text speak button
        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            if (speakBtn) {
                speakBtn.disabled = false;
                speakBtn.style.opacity = '1';
            }
        }

        // FIXED: Page navigation with proper voice command management
        function showPage(pageId, addToHistory = true) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (addToHistory) {
                    pageHistory.push(pageId);
                    history.pushState({page: pageId}, '', '');
                }
                
                // Voice command management based on page
                if (pageId === 'speech') {
                    // Stop voice commands when entering speech page
                    console.log('üõë Entering speech page - stopping voice commands');
                    stopVoiceCommands();
                } else {
                    // Stop main recognition when leaving speech page
                    if (isListening) {
                        console.log('üõë Leaving speech page - stopping main recognition');
                        if (recognition) {
                            try {
                                recognition.abort();
                            } catch (e) {
                                console.log('Error stopping recognition:', e);
                            }
                        }
                        isListening = false;
                    }
                    
                    // Start voice commands for other pages
                    setTimeout(() => {
                        if (currentPage !== 'speech' && !isListening) {
                            console.log('üéôÔ∏è Starting voice commands for page:', pageId);
                            startVoiceCommands();
                        }
                    }, 500);
                }
                
                // Page-specific setup
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textInput = document.getElementById('largeTextInputField');
                        if (textInput) {
                            textInput.value = '';
                            textInput.focus();
                        }
                        updateTextSpeakButton();
                    }, 100);
                }
            }
        }

        // Setup back button handling
        function setupBackButtonHandling() {
            window.addEventListener('popstate', function(event) {
                event.preventDefault();
                showPage('home', false);
            });
            history.pushState({page: 'home'}, '', '');
        }

        // Settings functions
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    Object.assign(settings, parsed);
                }
            } catch (error) {
                console.error('‚öôÔ∏è Error loading settings:', error);
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing...');
            initApp();
        });

        // Handle visibility change to restart voice commands
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentPage !== 'speech' && !isListening && !isVoiceCommandListening) {
                console.log('üëÅÔ∏è Tab visible - restarting voice commands');
                setTimeout(() => {
                    startVoiceCommands();
                }, 1000);
            }
        });
    </script>
</body>
</html>
