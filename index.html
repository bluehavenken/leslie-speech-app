<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-send { background-color: #669900; }
        .btn-keyboard { background-color: #99cc00; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .btn-disabled { background-color: #ccc !important; cursor: not-allowed !important; }
        /* --- Text Input Styles --- */
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            width: 90vw;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
            text-align: center;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { 
                padding: 16px;
                width: 95vw;
                max-width: 450px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Weather Display (Hidden by default) -->
        <div class="weather-display hidden" id="weatherDisplay">
            <div class="weather-title" id="weatherTitle">Current Weather</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Voice commands work best with microphone permission granted<br>
                    • Say "Hey Leslie" followed by commands for voice control<br>
                    • Click START TALKING for continuous speech recognition<br>
                    • Use Enhanced Recognition for better accuracy with unclear speech<br>
                    • Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Ready to listen - Already listening for your voice!
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <!-- Enhanced Recognition Section -->
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">🔬 Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        🔬 START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        STOP LISTENING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        🗑️
                    </button>
                </div>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            🔊 SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            🏠 HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text" id="leslieCommandsText">
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>🎤 IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <strong>Navigation Commands:</strong><br>
                    • "Hey Leslie, start talking" - Goes to speech recognition page<br>
                    • "Hey Leslie, start texting" - Goes to text input page<br>
                    • "Hey Leslie, home" - Returns to home page<br>
                    • "Hey Leslie, close" - Closes current page<br>
                    • "Hey Leslie, help" - Shows this commands list<br><br>
                    <strong>Weather Commands:</strong><br>
                    • "Hey Leslie, current weather" - Shows today's weather<br>
                    • "Hey Leslie, weather" - Shows today's weather<br>
                    • "Hey Leslie, 7 day forecast" - Shows 7-day forecast<br>
                    • "Hey Leslie, 7 day" - Shows 7-day forecast<br>
                    • "Hey Leslie, hourly" - Shows 24-hour forecast<br>
                    • "Hey Leslie, hourly forecast" - Shows 24-hour forecast<br>
                    • "Hey Leslie, close" - Closes weather displays<br><br>
                    <strong>Speech Settings Commands:</strong><br>
                    • "Hey Leslie, speak faster" - Increases speech speed<br>
                    • "Hey Leslie, talk slower" - Decreases speech speed<br>
                    • "Hey Leslie, pause more" - Increases pause between words<br>
                    • "Hey Leslie, pause less" - Decreases pause between words<br>
                    • "Hey Leslie, voice commands off" - Disables voice responses<br>
                    • "Hey Leslie, voice commands on" - Enables voice responses<br><br>
                    <strong>Tips for better voice recognition:</strong><br>
                    • Allow microphone permission when prompted<br>
                    • Voice commands work from any page<br>
                    • Complete phrases are spoken back to you<br>
                    • Try Enhanced Mode if standard recognition struggles
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.5" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to pause between words when speaking</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0" max="2" step="0.5" value="0.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">0.5 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Voice Command Speech</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ← Back
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let isSpeaking = false;
        let userLocation = null;
        let phraseHistory = [];
        let currentInterimTranscript = '';
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            pauseBetweenWords: 0.5
        };

        // Voice command recognition
        let voiceCommandRecognition = null;
        let isVoiceCommandListening = false;
        let lastVoiceCommand = '';
        let lastVoiceCommandTime = 0;

        // FIXED: Initialize speech recognition for immediate talking mode
        function initApp() {
            console.log('Initializing Leslie Speech Assistant...');
            loadSettings();
            setupEventHandlers();
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            
            setupSpeechRecognition();
            setupVoiceCommands();
            getUserLocation();
            clearTextInput();
            
            console.log('Leslie Speech Assistant initialized successfully!');
        }

        // Set up all event handlers
        function setupEventHandlers() {
            // Main navigation buttons
            document.getElementById('btnStartTalking').addEventListener('click', startTalkingFromHome);
            document.getElementById('btnStartTexting').addEventListener('click', () => showPage('textInput'));
            document.getElementById('btnCommands').addEventListener('click', () => showPage('commands'));
            document.getElementById('btnSettings').addEventListener('click', () => showPage('settings'));
            
            // Page close buttons
            document.getElementById('btnCloseSpeech').addEventListener('click', navigateBack);
            document.getElementById('btnCloseCommands').addEventListener('click', navigateBack);
            document.getElementById('btnCloseText').addEventListener('click', navigateBack);
            document.getElementById('btnCloseSettings').addEventListener('click', navigateBack);
            
            // Speech page controls
            document.getElementById('listenButton').addEventListener('click', toggleListening);
            document.getElementById('clearButton').addEventListener('click', clearSpeechText);
            
            // Text page controls
            document.getElementById('speakTextBtn').addEventListener('click', speakTextInput);
            document.getElementById('btnTextHome').addEventListener('click', () => showPage('home'));
            document.getElementById('largeTextInputField').addEventListener('input', updateTextSpeakButton);
            
            // Settings controls
            document.getElementById('btnSettingsHome').addEventListener('click', () => showPage('home'));
            document.getElementById('speechSpeedSlider').addEventListener('input', (e) => updateSpeechSpeed(e.target.value));
            document.getElementById('pauseBetweenWordsSlider').addEventListener('input', (e) => updatePauseBetweenWords(e.target.value));
            document.getElementById('speakVoiceCommandsSwitch').addEventListener('change', (e) => updateVoiceCommandSetting(e.target.checked));
        }

        // FIXED: Speech recognition that properly speaks phrases back and shows all words
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; // FIXED: Continuous for better capture
            recognition.interimResults = false; // Only final results
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isListening = true;
                updateListenButton();
                updateStatus('🎤 Listening for your voice... Speak clearly!');
                console.log('✅ Recognition started and ready');
            };

            recognition.onend = function() {
                console.log('🔄 Recognition ended - checking restart...');
                
                // FIXED: Only restart if user hasn't manually stopped and we're still on speech page
                if (currentPage === 'speech' && 
                    document.getElementById('listenButton').textContent === 'STOP LISTENING') {
                    
                    console.log('🔄 Auto-restarting for continuous listening...');
                    setTimeout(() => {
                        if (currentPage === 'speech' && 
                            document.getElementById('listenButton').textContent === 'STOP LISTENING') {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('❌ Restart failed:', e);
                                isListening = false;
                                updateListenButton();
                                updateStatus('❌ Click "START TALKING" to restart');
                            }
                        }
                    }, 1000); // FIXED: Proper delay for restart
                } else {
                    isListening = false;
                    updateListenButton();
                    updateStatus('✅ Stopped listening - Click "START TALKING" to restart');
                }
            };

            recognition.onerror = function(event) {
                console.log('❌ Recognition error:', event.error);
                
                if (event.error === 'no-speech' || event.error === 'audio-capture') {
                    // Don't stop for these errors, just continue
                    updateStatus('🔇 No speech detected - still listening...');
                } else if (event.error === 'aborted') {
                    isListening = false;
                    updateListenButton();
                    updateStatus('✅ Stopped listening - Click "START TALKING" to restart');
                } else {
                    // For other errors, try to restart
                    updateStatus('⚠️ Audio error - retrying...');
                    setTimeout(() => {
                        if (currentPage === 'speech' && 
                            document.getElementById('listenButton').textContent === 'STOP LISTENING') {
                            try {
                                recognition.start();
                            } catch (e) {
                                isListening = false;
                                updateListenButton();
                                updateStatus('❌ Error: ' + event.error);
                            }
                        }
                    }, 2000);
                }
            };

            recognition.onresult = function(event) {
                // FIXED: Process only final results and speak them back
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.trim();
                        console.log('📝 COMPLETE PHRASE:', transcript);
                        
                        if (transcript && transcript.length > 1) {
                            // Check for duplicates
                            const lastPhrase = phraseHistory.length > 0 ? phraseHistory[phraseHistory.length - 1] : '';
                            if (transcript === lastPhrase) {
                                console.log('⚠️ Ignoring duplicate phrase');
                                return;
                            }
                            
                            // Check for voice commands first
                            if (transcript.toLowerCase().includes('hey leslie') || transcript.toLowerCase().includes('leslie')) {
                                console.log('🎙️ Voice command in speech mode:', transcript);
                                processVoiceCommand(transcript);
                                updateStatus('🎙️ Voice command processed - Still listening...');
                                return;
                            }
                            
                            // FIXED: Regular speech processing - add to history and speak back
                            phraseHistory.push(transcript);
                            if (phraseHistory.length > 10) phraseHistory.shift(); // Keep more history
                            updateSpeechDisplay();
                            updateStatus('✅ Got: "' + transcript + '" - Still listening...');
                            
                            // FIXED: Always speak the phrase back with proper delay
                            console.log('🔊 Speaking phrase back:', transcript);
                            speakCompletePhrase(transcript);
                        }
                        break;
                    }
                }
            };
        }

        // FIXED: Voice commands with better duplicate detection and close command
        function setupVoiceCommands() {
            console.log('🎙️ Setting up voice commands...');
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    console.log('✅ Microphone permission granted');
                    stream.getTracks().forEach(track => track.stop());
                    setTimeout(() => {
                        initializePersistentVoiceCommands();
                    }, 2000);
                })
                .catch(function(error) {
                    console.log('❌ Microphone permission denied:', error);
                });
        }
        
        function initializePersistentVoiceCommands() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceCommandRecognition = new SpeechRecognition();
            
            voiceCommandRecognition.continuous = false;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';
            
            voiceCommandRecognition.onstart = function() {
                isVoiceCommandListening = true;
                console.log('✅ Voice commands started');
            };
            
            voiceCommandRecognition.onresult = function(event) {
                if (event.results.length > 0 && event.results[0].isFinal) {
                    const transcript = event.results[0][0].transcript.trim();
                    const now = Date.now();
                    
                    console.log('🎙️ Voice input:', transcript);
                    
                    // Check for Leslie commands
                    if (transcript.toLowerCase().includes('hey leslie') || 
                        transcript.toLowerCase().includes('leslie')) {
                        
                        // FIXED: Better duplicate detection - longer time window
                        if (transcript !== lastVoiceCommand || 
                            (now - lastVoiceCommandTime) > 3000) {
                            
                            lastVoiceCommand = transcript;
                            lastVoiceCommandTime = now;
                            
                            console.log('🎙️ PROCESSING:', transcript);
                            processVoiceCommand(transcript);
                        } else {
                            console.log('🎙️ Skipping recent duplicate');
                        }
                    }
                }
            };
            
            voiceCommandRecognition.onend = function() {
                isVoiceCommandListening = false;
                console.log('🎙️ Voice command session ended');
                
                // Always restart if not on speech page
                if (currentPage !== 'speech' && !isListening) {
                    setTimeout(() => {
                        startPersistentVoiceCommands();
                    }, 1500);
                }
            };
            
            voiceCommandRecognition.onerror = function(event) {
                isVoiceCommandListening = false;
                console.log('🎙️ Voice command error:', event.error);
                
                // Restart after error if not on speech page
                if (event.error !== 'aborted' && currentPage !== 'speech' && !isListening) {
                    setTimeout(() => {
                        startPersistentVoiceCommands();
                    }, 3000);
                }
            };
            
            startPersistentVoiceCommands();
        }
        
        function startPersistentVoiceCommands() {
            if (currentPage !== 'speech' && !isListening && !isVoiceCommandListening && voiceCommandRecognition) {
                try {
                    console.log('🎙️ Starting persistent voice command session...');
                    voiceCommandRecognition.start();
                } catch (e) {
                    console.log('🎙️ Failed to start voice commands:', e);
                    isVoiceCommandListening = false;
                    setTimeout(() => {
                        startPersistentVoiceCommands();
                    }, 5000);
                }
            }
        }
        
        function stopVoiceCommands() {
            if (voiceCommandRecognition && isVoiceCommandListening) {
                try {
                    voiceCommandRecognition.abort();
                    isVoiceCommandListening = false;
                    console.log('🛑 Voice commands stopped');
                } catch (e) {
                    console.log('🎙️ Error stopping voice commands:', e);
                    isVoiceCommandListening = false;
                }
            }
        }

        // FIXED: Process voice commands with better close command handling
        function processVoiceCommand(command) {
            console.log('Processing voice command:', command);
            const cmd = command.toLowerCase();
            
            // Navigation commands
            if (cmd.includes('start talking')) {
                startTalkingFromHome();
                speakResponse('Starting speech recognition');
            } else if (cmd.includes('start texting')) {
                showPage('textInput');
                speakResponse('Opening text input');
            } else if (cmd.includes('home')) {
                showPage('home');
                speakResponse('Going home');
            } else if (cmd.includes('help') || cmd.includes('commands')) {
                showPage('commands');
                speakResponse('Showing commands');
            } else if (cmd.includes('settings')) {
                showPage('settings');
                speakResponse('Opening settings');
                
            // FIXED: Enhanced close command - works from any page
            } else if (cmd.includes('close')) {
                // Hide weather if visible
                const weatherDisplay = document.getElementById('weatherDisplay');
                if (weatherDisplay && !weatherDisplay.classList.contains('hidden')) {
                    hideWeather();
                    speakResponse('Closing weather');
                } else if (currentPage !== 'home') {
                    // Close current page and go home
                    showPage('home');
                    speakResponse('Closing and going home');
                } else {
                    speakResponse('Already on home page');
                }
                
            // Weather commands
            } else if (cmd.includes('current weather') || (cmd.includes('weather') && !cmd.includes('forecast'))) {
                showCurrentWeather();
                speakResponse('Showing current weather');
            } else if (cmd.includes('7 day') || cmd.includes('weekly') || cmd.includes('week')) {
                showWeeklyWeather();
                speakResponse('Showing 7 day forecast');
            } else if (cmd.includes('hourly') || cmd.includes('24 hour')) {
                showHourlyWeather();
                speakResponse('Showing hourly forecast');
                
            // Speech speed commands with UI updates
            } else if (cmd.includes('speak faster') || cmd.includes('talk faster')) {
                const newSpeed = Math.min(settings.speechSpeed + 0.5, 2.0);
                settings.speechSpeed = newSpeed;
                updateSpeechSpeed(newSpeed);
                saveSettings();
                const speedSlider = document.getElementById('speechSpeedSlider');
                if (speedSlider) speedSlider.value = newSpeed;
                speakResponse('Speaking faster');
            } else if (cmd.includes('speak slower') || cmd.includes('talk slower')) {
                const newSpeed = Math.max(settings.speechSpeed - 0.5, 0.5);
                settings.speechSpeed = newSpeed;
                updateSpeechSpeed(newSpeed);
                saveSettings();
                const speedSlider = document.getElementById('speechSpeedSlider');
                if (speedSlider) speedSlider.value = newSpeed;
                speakResponse('Speaking slower');
                
            // Pause commands with UI updates
            } else if (cmd.includes('pause more')) {
                const newPause = Math.min(settings.pauseBetweenWords + 0.5, 2.0);
                settings.pauseBetweenWords = newPause;
                updatePauseBetweenWords(newPause);
                saveSettings();
                const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
                if (pauseSlider) pauseSlider.value = newPause;
                speakResponse('Pausing more between words');
            } else if (cmd.includes('pause less')) {
                const newPause = Math.max(settings.pauseBetweenWords - 0.5, 0.0);
                settings.pauseBetweenWords = newPause;
                updatePauseBetweenWords(newPause);
                saveSettings();
                const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
                if (pauseSlider) pauseSlider.value = newPause;
                speakResponse('Pausing less between words');
                
            // Voice command speech toggle
            } else if (cmd.includes('voice commands off') || (cmd.includes('voice commands') && cmd.includes('off'))) {
                settings.speakVoiceCommands = false;
                updateVoiceCommandSetting(false);
                saveSettings();
                const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
                if (voiceSwitch) voiceSwitch.checked = false;
                speakResponse('Voice commands off');
            } else if (cmd.includes('voice commands on') || (cmd.includes('voice commands') && cmd.includes('on'))) {
                settings.speakVoiceCommands = true;
                updateVoiceCommandSetting(true);
                saveSettings();
                const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
                if (voiceSwitch) voiceSwitch.checked = true;
                speakResponse('Voice commands on');
                
            } else {
                console.log('Voice command not recognized:', cmd);
                speakResponse('Command not recognized');
            }
        }

        // Speak a response to voice commands
        function speakResponse(text) {
            if (!settings.speakVoiceCommands) return;
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                speechSynth.speak(utterance);
            }, 300);
        }

        // FIXED: Speak complete phrase with better timing and pause handling
        function speakCompletePhrase(text) {
            console.log('🔊 Speaking complete phrase:', text);
            
            // Cancel any existing speech
            speechSynth.cancel();
            
            // Wait a moment then speak
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = 'en-US';
                
                // FIXED: Apply pause between words setting properly
                if (settings.pauseBetweenWords > 0) {
                    const words = text.split(' ');
                    let speechText = '';
                    for (let i = 0; i < words.length; i++) {
                        speechText += words[i];
                        if (i < words.length - 1) {
                            // Add pauses as commas (speech synthesis pauses)
                            const pauseCount = Math.round(settings.pauseBetweenWords * 2);
                            speechText += ','.repeat(pauseCount) + ' ';
                        }
                    }
                    utterance.text = speechText;
                }
                
                utterance.onstart = function() {
                    console.log('Started speaking:', text);
                    isSpeaking = true;
                };
                
                utterance.onend = function() {
                    console.log('Finished speaking:', text);
                    isSpeaking = false;
                };
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                    isSpeaking = false;
                };
                
                speechSynth.speak(utterance);
            }, 800); // FIXED: Longer delay to ensure clean speech
        }

        // FIXED: Speech display shows all phrases clearly
        function updateSpeechDisplay() {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                let html = '';
                
                if (phraseHistory.length > 0) {
                    // Show all phrases with the most recent first
                    for (let i = phraseHistory.length - 1; i >= 0; i--) {
                        const phrase = phraseHistory[i];
                        const isLatest = i === phraseHistory.length - 1;
                        html += `<div class="final-phrase" style="background-color: ${isLatest ? '#e3f2fd' : '#f5f5f5'}; border-left-color: ${isLatest ? '#0099cc' : '#ccc'};">
                                    ${isLatest ? '✅ LATEST: ' : ''}${phrase}
                                 </div>`;
                    }
                    html += `<div style="color: #999; font-size: 12px; margin-top: 8px; text-align: center;">
                                Total phrases captured: ${phraseHistory.length}
                             </div>`;
                } else {
                    html = '<div style="color: #666; font-style: italic;">Say something and your complete phrase will appear here...</div>';
                }
                
                recognizedTextEl.innerHTML = html;
                
                // Auto-scroll to show latest
                const speechContent = document.querySelector('.speech-content');
                if (speechContent) {
                    speechContent.scrollTop = 0; // Scroll to top to show latest
                }
            }
        }

        // Clear speech text
        function clearSpeechText() {
            phraseHistory = [];
            currentInterimTranscript = '';
            updateSpeechDisplay();
            console.log('🗑️ Speech text cleared');
        }

        // FIXED: Start talking from home page - auto-start listening
        function startTalkingFromHome() {
            showPage('speech');
            // FIXED: Auto-start listening immediately when entering speech page
            setTimeout(() => {
                if (!isListening && currentPage === 'speech') {
                    console.log('🎤 Auto-starting listening on speech page entry');
                    startListening();
                }
            }, 500);
        }

        // Toggle listening
        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // Start listening
        function startListening() {
            if (recognition && !isListening && !isSpeaking) {
                try {
                    // Stop voice commands when main recognition starts
                    if (isVoiceCommandListening) {
                        stopVoiceCommands();
                    }
                    recognition.start();
                } catch (error) {
                    console.log('Error starting recognition:', error);
                    updateStatus('Error starting recognition. Please try again.');
                }
            }
        }

        // Stop listening
        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.abort(); // Force stop
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                }
            }
            isListening = false;
            updateListenButton();
            updateStatus('🛑 Stopped listening. Click "START TALKING" to restart.');
            
            // Restart voice commands when main recognition stops
            setTimeout(() => {
                if (!isListening && currentPage !== 'speech') {
                    startPersistentVoiceCommands();
                }
            }, 1000);
        }

        // Update listen button
        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }

        // Update status text
        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = message;
        }

        // Clear text input function
        function clearTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            if (textInput) {
                textInput.value = '';
                console.log('🗑️ Text input cleared');
            }
        }

        // Speak text input and clear after speaking
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                if (speechSynth.speaking) speechSynth.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = settings.speechSpeed;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // Apply pause between words setting
                    if (settings.pauseBetweenWords > 0) {
                        const words = text.split(' ');
                        let speechText = '';
                        for (let i = 0; i < words.length; i++) {
                            speechText += words[i];
                            if (i < words.length - 1) {
                                const pauseCount = Math.round(settings.pauseBetweenWords * 2);
                                speechText += ','.repeat(pauseCount) + ' ';
                            }
                        }
                        utterance.text = speechText;
                    }
                    
                    utterance.onend = function() {
                        console.log('✅ Text speech finished - clearing text input');
                        textInput.value = '';
                        updateTextSpeakButton();
                    };
                    
                    utterance.onerror = function(event) {
                        console.log('❌ Text speech error:', event.error);
                        textInput.value = '';
                        updateTextSpeakButton();
                    };
                    
                    speechSynth.speak(utterance);
                }, 200);
            }
        }

        // Update text speak button
        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            if (speakBtn) {
                speakBtn.disabled = false;
                speakBtn.style.opacity = '1';
            }
        }

        // FIXED: Page navigation with proper voice command management and speech page auto-start
        function showPage(pageId, addToHistory = true) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (addToHistory) {
                    pageHistory.push(pageId);
                    history.pushState({page: pageId}, '', '');
                }
                
                // Handle page-specific logic
                if (pageId === 'speech') {
                    // Stop voice commands when entering speech page
                    console.log('🛑 Entering speech page - stopping voice commands');
                    stopVoiceCommands();
                    
                    // FIXED: Auto-start listening with proper button state
                    setTimeout(() => {
                        if (currentPage === 'speech' && !isListening) {
                            console.log('🎤 Auto-starting listening for speech page');
                            // Set button to show we're about to start
                            const listenButton = document.getElementById('listenButton');
                            if (listenButton) {
                                listenButton.textContent = 'STOP LISTENING';
                                listenButton.className = 'control-btn btn-stop';
                            }
                            updateStatus('🎤 Starting up - Get ready to speak!');
                            startListening();
                        }
                    }, 100);
                } else {
                    // Stop speech recognition when leaving speech page
                    if (isListening) {
                        console.log('🛑 Leaving speech page - stopping recognition');
                        if (recognition) {
                            try {
                                recognition.abort();
                            } catch (e) {
                                console.log('Error stopping recognition:', e);
                            }
                        }
                        isListening = false;
                    }
                    
                    // Start voice commands when on other pages
                    console.log('🎙️ On non-speech page - ensuring voice commands active');
                    setTimeout(() => {
                        if (currentPage !== 'speech' && !isListening) {
                            startPersistentVoiceCommands();
                        }
                    }, 1000);
                }
                
                // Focus and clear text input when entering text page
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textInput = document.getElementById('largeTextInputField');
                        if (textInput) {
                            textInput.value = '';
                            textInput.focus();
                        }
                        updateTextSpeakButton();
                    }, 100);
                }
            }
        }

        // Navigate back
        function navigateBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPage = pageHistory[pageHistory.length - 1];
                showPage(previousPage, false);
            } else {
                showPage('home', false);
            }
        }

        // Get user location for weather
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        console.log('📍 Location obtained:', userLocation);
                    },
                    function(error) {
                        console.error('📍 Geolocation error:', error);
                        userLocation = { lat: 40.7128, lon: -74.0060 }; // NYC fallback
                    }
                );
            } else {
                userLocation = { lat: 40.7128, lon: -74.0060 }; // NYC fallback
            }
        }

        // Weather functions (simplified for this fix)
        async function showCurrentWeather() {
            showWeatherDisplay('Current Weather', 'Loading current weather...');
            
            try {
                const { lat, lon } = userLocation || { lat: 40.7128, lon: -74.0060 };
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const data = await response.json();
                
                const temperature = Math.round(data.current.temperature_2m * 9/5 + 32);
                const humidity = data.current.relative_humidity_2m;
                const windSpeed = Math.round(data.current.wind_speed_10m * 0.621371);
                
                const weatherContent = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 28px; font-weight: bold; color: #0099cc; margin-bottom: 8px;">${temperature}°F</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <div><strong>Humidity:</strong> ${humidity}%</div>
                            <div><strong>Wind:</strong> ${windSpeed} mph</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('weatherContent').innerHTML = weatherContent;
            } catch (error) {
                console.error('🌤️ Weather error:', error);
                document.getElementById('weatherContent').innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load weather data.</div>';
            }
        }

        async function showHourlyWeather() {
            showWeatherDisplay('24-Hour Forecast', 'Loading hourly forecast...');
            // Simplified implementation
        }

        async function showWeeklyWeather() {
            showWeatherDisplay('7-Day Forecast', 'Loading 7-day forecast...');
            // Simplified implementation
        }

        function showWeatherDisplay(title, content) {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            weatherTitle.textContent = title;
            weatherContent.innerHTML = `<div style="text-align: center; padding: 20px;">${content}</div>`;
            weatherDisplay.classList.remove('hidden');
        }

        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            weatherDisplay.classList.add('hidden');
        }

        // Settings functions
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    Object.assign(settings, parsed);
                }
            } catch (error) {
                console.error('⚙️ Error loading settings:', error);
            }
            updateSettingsUI();
        }

        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('⚙️ Error saving settings:', error);
            }
        }

        function updateSettingsUI() {
            const elements = {
                speedSlider: document.getElementById('speechSpeedSlider'),
                pauseSlider: document.getElementById('pauseBetweenWordsSlider'),
                voiceSwitch: document.getElementById('speakVoiceCommandsSwitch')
            };

            if (elements.speedSlider) elements.speedSlider.value = settings.speechSpeed;
            if (elements.pauseSlider) elements.pauseSlider.value = settings.pauseBetweenWords;
            if (elements.voiceSwitch) elements.voiceSwitch.checked = settings.speakVoiceCommands;

            updateSpeechSpeed(settings.speechSpeed);
            updatePauseBetweenWords(settings.pauseBetweenWords);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
        }

        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            if (label) {
                label.textContent = value == 1.0 ? 'Normal (1.0x)' : value + 'x';
            }
            saveSettings();
        }

        function updatePauseBetweenWords(value) {
            settings.pauseBetweenWords = parseFloat(value);
            const label = document.getElementById('pauseBetweenWordsValue');
            if (label) {
                label.textContent = value + ' seconds';
            }
            saveSettings();
        }

        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            if (label) {
                label.textContent = 'Voice Command Speech: ' + (checked ? 'ON' : 'OFF');
            }
            saveSettings();
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing Leslie Speech Assistant...');
            initApp();
        });
    </script>
</body>
</html>
