<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 300px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #0099cc;
            z-index: 1000;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            width: 90vw;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
            text-align: center;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .hourly-forecast, .weekly-forecast {
            display: grid;
            gap: 8px;
        }
        .hourly-item, .weekly-item {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }
        .weekly-item {
            display: grid;
            grid-template-columns: 80px 60px 1fr;
            gap: 8px;
            align-items: center;
            font-size: 14px;
        }
        .day-name { font-weight: bold; }
        .day-temps { color: #0099cc; font-weight: bold; }
        .day-condition { color: #666; }
        .swipe-edge {
            position: fixed;
            z-index: 998;
            background: rgba(0,153,204,0.3);
        }
        .swipe-bottom {
            bottom: 0;
            left: 40%;
            width: 20%;
            height: 40px;
        }
        .swipe-left {
            left: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .swipe-right {
            right: 0;
            top: 40%;
            width: 40px;
            height: 20%;
        }
        .api-key-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        .contact-loading-section {
            padding: 20px;
            text-align: center;
            color: #669900;
            border: 2px solid #669900;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 16px;
        }
        .voice-command-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            border: 2px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .voice-command-status.active {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }
        .voice-command-status.permission-needed {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(220, 53, 69, 0.3);
            animation: bounce 2s infinite;
            transform: scale(1.1);
            font-size: 16px;
            padding: 12px 18px;
        }
        .voice-command-status.ready {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            display: block;
            border-color: rgba(40, 167, 69, 0.3);
        }
        .voice-command-status.processing {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            display: block;
            border-color: rgba(255, 193, 7, 0.3);
        }
        .voice-command-status.speaking {
            background: rgba(153, 102, 255, 0.9);
            color: white;
            display: block;
            border-color: rgba(153, 102, 255, 0.3);
        }
        .voice-command-status.listening {
            background: rgba(0, 153, 204, 0.9);
            color: white;
            display: block;
            border-color: rgba(0, 153, 204, 0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1.1); }
            40% { transform: translateY(-4px) scale(1.1); }
            60% { transform: translateY(-2px) scale(1.1); }
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { 
                padding: 16px;
                width: 95vw;
                max-width: 450px;
            }
            .voice-command-status {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START LISTENING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    ♿ <strong>Hands-Free Accessibility Features:</strong><br>
                    • <strong>Voice Commands:</strong> Auto-start for accessibility - say "Hey Leslie" + command<br>
                    • <strong>Speech Page Auto-Start:</strong> Begins listening automatically when opened<br>
                    • <strong>Continuous Until Stopped:</strong> Runs until Stop button or 2-minute timeout<br>
                    • <strong>Physical Impairment Friendly:</strong> Minimal clicking required for operation<br>
                    • <strong>Two Modes:</strong> Free (browser-based) or Pro (Whisper accuracy)<br>
                    • <strong>Mobile Ready:</strong> Works as PWA app from home screen<br>
                    • <strong>Weather & Contacts:</strong> Swipe gestures and real contact loading<br>
                    • <strong>Accessibility First:</strong> Designed for users with speech and physical impairments
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Voice commands starting for hands-free accessibility...
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your words will appear below
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            <div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">🎤 Speech page will auto-start listening when opened</div>
                        </div>
                    </div>
                </div>
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">🎯 Pro Mode (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Highest accuracy for speech impairments and unclear speech
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        🎯 START PRO MODE
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START LISTENING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        🗑️
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts
                </div>
                <input type="text" class="contact-search-input" id="contactSearchInput" placeholder="Type to search contacts...">
            </div>
            
            <div class="contact-loading-section" id="contactLoadingSection">
                <p><strong>📱 GET YOUR REAL CONTACTS</strong></p>
                <p style="color: #333; margin: 10px 0; font-size: 16px;">Currently showing: <span style="color: #cc0000;">Demo Contacts Only</span></p>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Choose how to load YOUR real contacts from your phone:
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button id="loadAllContactsBtn" style="margin: 5px; padding: 16px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📞 LOAD ALL CONTACTS
                    </button>
                    <button id="loadSelectedContactsBtn" style="margin: 5px; padding: 16px 24px; background: #0099cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📋 SELECT SPECIFIC CONTACTS
                    </button>
                </div>
                <p style="margin-top: 12px; font-size: 12px; color: #666;">
                    <strong>📞 LOAD ALL:</strong> Opens contact picker with auto-selection attempt<br>
                    <strong>📋 SELECT:</strong> Opens contact picker for manual selection<br>
                    <strong>⚠️ Works on Chrome Android & Safari iOS only</strong>
                </p>
            </div>
            
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    📱 Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">🏠 HOME</button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div style="font-size: 14px; font-weight: bold; color: #9933cc; margin-bottom: 8px;">
                        Type your text and tap speak to have it read aloud:
                    </div>
                    <textarea class="text-input large-text-input" id="largeTextInputField" placeholder="Type what you want to say here..."></textarea>
                    
                    <div class="speak-text-container">
                        <button class="speak-phrase-btn" id="speakTextBtn" disabled>
                            🔊 SPEAK
                        </button>
                    </div>
                    
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">🏠 HOME</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div style="padding: 16px; max-height: 70vh; overflow-y: auto; background: white; border-radius: 8px; margin: 8px;">
                <div style="font-size: 16px; line-height: 1.6; color: #333;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <strong>✅ Hands-Free Voice Commands</strong><br>
                        <span style="font-size: 14px; color: #28a745;">Auto-start for accessibility - no clicking required</span><br>
                        <span style="font-size: 12px; color: #666;">Say "Hey Leslie" followed by any command below</span>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                            <strong style="color: #28a745;">🧭 Navigation Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>home</strong>" - Returns to home page<br>
                            • "Hey Leslie, <strong>start talking</strong>" - Speech recognition page<br>
                            • "Hey Leslie, <strong>start texting</strong>" - Text input page<br>
                            • "Hey Leslie, <strong>phone</strong>" - Phone contacts page<br>
                            • "Hey Leslie, <strong>settings</strong>" - Settings page<br>
                            • "Hey Leslie, <strong>help</strong>" - Shows this commands list<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #007bff;">
                            <strong style="color: #007bff;">🌤️ Weather Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>weather</strong>" - Shows current weather<br>
                            • "Hey Leslie, <strong>hourly</strong>" - Shows 24-hour forecast<br>
                            • "Hey Leslie, <strong>weekly</strong>" - Shows 7-day forecast<br>
                            • "Hey Leslie, <strong>7 day</strong>" - Shows 7-day forecast<br>
                            • "Hey Leslie, <strong>close weather</strong>" - Closes weather displays<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #6f42c1;">
                            <strong style="color: #6f42c1;">🎙️ Recognition Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>free mode</strong>" - Switch to free mode<br>
                            • "Hey Leslie, <strong>pro mode</strong>" - Switch to pro mode (requires API key)<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #dc3545;">
                            <strong style="color: #dc3545;">🔊 Speech Settings Commands</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            • "Hey Leslie, <strong>speak faster</strong>" - Increases speech speed<br>
                            • "Hey Leslie, <strong>speak slower</strong>" - Decreases speech speed<br>
                            • "Hey Leslie, <strong>pause more</strong>" - Increases pause between words<br>
                            • "Hey Leslie, <strong>pause less</strong>" - Decreases pause between words<br>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong style="color: #28a745;">✅ Hands-Free Accessibility Design</strong><br>
                        <div style="margin-top: 8px; font-size: 14px; color: #28a745;">
                            • <strong>Auto-Start Voice Commands:</strong> Automatically start for users with physical impairments<br>
                            • <strong>Speech Page:</strong> Auto-starts listening when opened and stays active<br>
                            • <strong>Continuous Operation:</strong> Runs until Stop button or 2-minute timeout<br>
                            • <strong>Reduced Pinging:</strong> Longer delays between restarts to prevent interference<br>
                            • <strong>Physical Impairment Friendly:</strong> Minimal clicking required for operation<br>
                            • <strong>Context Aware:</strong> Speech page = all words, other pages = commands only<br>
                            • <strong>Pro Mode Available:</strong> OpenAI Whisper with API key<br>
                            • <strong>Contact Loading:</strong> Real contacts from your phone<br>
                            • <strong>Weather:</strong> Swipe bottom/left/right edges for weather info
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px; text-align: center;">
                <button class="btn-home" id="btnCommandsHome">🏠 HOME</button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>⚙️ Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Pro Mode)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable Pro Mode with highest accuracy Whisper recognition.
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="Enter your OpenAI API key here...">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        This key stays on your device and is only used for speech recognition.
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div style="margin: 12px 0;">
                        <div style="margin: 8px 0;">
                            <input type="radio" id="modeFree" name="recognitionMode" value="free" checked>
                            <label for="modeFree" style="margin-left: 8px; font-weight: bold; color: #28a745;">🆓 Free Mode (Continuous)</label>
                            <div style="font-size: 12px; color: #666; margin-left: 24px;">Browser-based continuous recognition - completely free</div>
                        </div>
                        <div style="margin: 8px 0;">
                            <input type="radio" id="modePro" name="recognitionMode" value="pro">
                            <label for="modePro" style="margin-left: 8px; font-weight: bold; color: #0099cc;">🎯 Pro Mode (~$0.006/min)</label>
                            <div style="font-size: 12px; color: #666; margin-left: 24px;">OpenAI Whisper - highest accuracy for speech impairments</div>
                        </div>
                    </div>
                    <div class="setting-value" id="recognitionModeLabel">Current: Free Mode (Continuous)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.2" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">♿ Pause Between Words (Accessibility)</div>
                    <div class="settings-description"><strong>Critical for speech impairments:</strong> How long to wait after you stop speaking before processing speech.</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0.5" max="6" step="0.1" value="2.0">
                    <div class="setting-value" id="pauseBetweenWordsValue">2.0 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speak Voice Commands</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Speak Voice Commands</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Speak Voice Commands: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">← Back</button>
        </div>

        <!-- Weather Display -->
        <div id="weatherDisplay" class="weather-display hidden">
            <div class="weather-title" id="weatherTitle">Weather Information</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" id="currentWeatherBtn">Current</button>
                <button class="weather-btn" id="hourlyWeatherBtn">24 Hours</button>
                <button class="weather-btn" id="weeklyWeatherBtn">7 Days</button>
                <button class="weather-btn" id="closeWeatherBtn">Close</button>
            </div>
        </div>

        <!-- Swipe Gesture Areas -->
        <div id="swipeBottom" class="swipe-edge swipe-bottom"></div>
        <div id="swipeLeft" class="swipe-edge swipe-left"></div>
        <div id="swipeRight" class="swipe-edge swipe-right"></div>

        <!-- Voice Command Status Indicator -->
        <div id="voiceCommandStatus" class="voice-command-status">🎤 Voice Commands Ready</div>
    </div>

    <script>
        // === CORE VARIABLES ===
        let speechRecognition = null;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let contacts = [];
        let filteredContacts = [];
        let userLocation = null;
        let isInitialized = false;
        let initializationAttempted = false;
        
        // PERMISSION STATE
        let permissionGranted = false;
        let permissionChecked = false;
        
        // APP STATE - SIMPLIFIED
        let appState = {
            isListening: false,
            speechPageActive: false,
            isCurrentlySpeaking: false,
            manuallyStoppedSpeech: false,
            continuousModeEnabled: false
        };
        
        // Settings
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            apiKey: '',
            pauseBetweenWords: 2.0,
            recognitionMode: 'free'
        };

        // DUPLICATE PREVENTION
        let lastProcessedText = '';
        let lastProcessedTime = 0;

        // === PERMISSION CHECK (STOP THE LOOP) ===
        async function checkPermission() {
            // Only check once to prevent endless loops
            if (permissionChecked) {
                console.log('✅ Permission already checked, result:', permissionGranted);
                return permissionGranted;
            }
            
            console.log('🔐 Checking microphone permission (ONCE ONLY)...');
            permissionChecked = true;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                console.log('✅ Microphone permission GRANTED');
                permissionGranted = true;
                updateVoiceCommandStatus('ready');
                return true;
            } catch (error) {
                console.log('🔴 Microphone permission DENIED - will not ask again');
                permissionGranted = false;
                updateVoiceCommandStatus('permission-needed');
                return false;
            }
        }

        // === MANUAL VOICE COMMAND RESTART (NO AUTO-PINGING) ===
        function restartVoiceCommandsIfNeeded() {
            if (!appState.speechPageActive && !appState.isListening && permissionGranted) {
                console.log('🎤 Manually restarting voice commands');
                startContinuousRecognition();
            }
        }
        async function startContinuousRecognition() {
            if (appState.isListening) {
                console.log('🎤 Already listening');
                return;
            }
            
            if (!await checkPermission()) {
                showPermissionError();
                return;
            }
            
            console.log('🎤 Starting recognition...');
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = true;
                speechRecognition.interimResults = true;
                speechRecognition.lang = 'en-US';
                speechRecognition.maxAlternatives = 1;

                speechRecognition.onstart = () => {
                    console.log('🎤 ✅ Recognition STARTED');
                    appState.isListening = true;
                    updateVoiceCommandStatus('active');
                    updateStatus();
                    updateUI();
                };

                speechRecognition.onend = () => {
                    console.log('🎤 Recognition ended');
                    appState.isListening = false;
                    updateUI();
                    
                    // ALWAYS restart unless manually stopped - required for accessibility
                    if (!appState.manuallyStoppedSpeech) {
                        if (appState.speechPageActive) {
                            // Speech page: restart immediately for continuous operation
                            console.log('🔄 Speech page: restarting immediately');
                            setTimeout(() => {
                                if (appState.speechPageActive && !appState.manuallyStoppedSpeech) {
                                    startContinuousRecognition();
                                }
                            }, 100); // Very short delay
                        } else {
                            // Voice commands: restart quickly - MUST stay active for accessibility
                            console.log('🔄 Voice commands: restarting in 2 seconds (accessibility)');
                            setTimeout(() => {
                                if (!appState.speechPageActive && !appState.manuallyStoppedSpeech) {
                                    startContinuousRecognition();
                                }
                            }, 2000); // 2 second delay - much shorter
                        }
                    } else {
                        console.log('🛑 Not restarting - manually stopped');
                    }
                };

                speechRecognition.onerror = (event) => {
                    console.log('🎤 Recognition ERROR:', event.error);
                    appState.isListening = false;
                    updateUI();
                    
                    if (event.error === 'not-allowed') {
                        console.log('🔴 Permission denied');
                        showPermissionError();
                        return;
                    }
                    
                    if (event.error === 'aborted') {
                        console.log('🛑 Recognition aborted - this is normal when stopping');
                        return;
                    }
                    
                    // Always restart on any other error to maintain accessibility
                    console.log('🔄 Restarting after error for accessibility');
                    if (!appState.manuallyStoppedSpeech) {
                        setTimeout(() => {
                            if (!appState.manuallyStoppedSpeech) {
                                console.log('🔄 Restarting recognition after error');
                                startContinuousRecognition();
                            }
                        }, 2000);
                    }
                };

                speechRecognition.onresult = (event) => {
                    processAllSpeechResults(event);
                    resetSpeechTimeout();
                };
                
                speechRecognition.start();
                
            } catch (error) {
                console.error('❌ Error creating speech recognition:', error);
                updateVoiceCommandStatus('ready');
                showPermissionError();
            }
        }

        // === 2-MINUTE TIMEOUT (PREVENT 5-SECOND PINGS) ===
        let speechTimeoutTimer = null;
        let lastSpeechActivity = Date.now();

        function resetSpeechTimeout() {
            // Update last activity
            lastSpeechActivity = Date.now();
            
            // Clear any existing timeout
            if (speechTimeoutTimer) {
                clearTimeout(speechTimeoutTimer);
                speechTimeoutTimer = null;
            }
            
            // Only set timeout if on speech page and not manually stopped
            if (appState.speechPageActive && !appState.manuallyStoppedSpeech) {
                console.log('⏰ Resetting 2-minute timeout for speech page');
                speechTimeoutTimer = setTimeout(() => {
                    const timeSinceActivity = Date.now() - lastSpeechActivity;
                    console.log('⏰ Timeout check - time since last activity:', timeSinceActivity / 1000, 'seconds');
                    
                    if (appState.speechPageActive && timeSinceActivity >= 115000) { // 115 seconds to be safe
                        console.log('⏰ 2-minute timeout reached - stopping speech recognition');
                        stopSpeechRecognition();
                        updateStatus('⏰ Stopped due to 2-minute timeout - Click START LISTENING to resume');
                    } else {
                        console.log('⏰ Recent activity detected, extending timeout');
                        resetSpeechTimeout(); // Extend the timeout
                    }
                }, 120000); // 2 minutes
            }
        }

        function stopSpeechRecognition() {
            console.log('🛑 Stopping speech recognition completely');
            
            appState.manuallyStoppedSpeech = true;
            
            // Clear timeout
            if (speechTimeoutTimer) {
                clearTimeout(speechTimeoutTimer);
                speechTimeoutTimer = null;
            }
            
            // Stop recognition
            if (speechRecognition) {
                try {
                    speechRecognition.stop();
                    speechRecognition = null; // Clear reference
                } catch (e) {
                    console.log('Warning: Could not stop recognition:', e.message);
                }
            }
            
            appState.isListening = false;
            updateUI();
            updateStatus('🛑 Stopped - Click START LISTENING to resume');
            updateVoiceCommandStatus('ready');
        }

        // === SPEECH PROCESSING (CAPTURE COMPLETE PHRASES) ===
        function processAllSpeechResults(event) {
            try {
                console.log('🎤 Processing speech results, total:', event.results.length);
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    
                    if (result.isFinal) {
                        const text = result[0].transcript.trim();
                        const confidence = result[0].confidence;
                        const currentTime = Date.now();
                        
                        console.log('🎤 ✅ FINAL RESULT:', text, 'Confidence:', confidence);
                        
                        // Only process if we have actual content and it's not a recent duplicate
                        if (text && text.length > 1 && 
                            (text !== lastProcessedText || currentTime - lastProcessedTime > 3000)) {
                            
                            console.log('🎤 ✅ Processing COMPLETE speech:', text);
                            lastProcessedText = text;
                            lastProcessedTime = currentTime;
                            
                            if (appState.speechPageActive) {
                                console.log('📝 ✅ Speech page - processing FULL phrase:', text);
                                handleSpeechPageResult(text);
                            } else {
                                console.log('🗣️ ✅ Voice command - checking for Leslie trigger:', text);
                                handleVoiceCommand(text);
                            }
                        } else {
                            console.log('🚫 Skipping - too short or recent duplicate:', text);
                        }
                    } else {
                        // Show interim results on speech page for better feedback
                        if (appState.speechPageActive && result[0].transcript.trim().length > 3 && !appState.isCurrentlySpeaking) {
                            const interimText = result[0].transcript.trim();
                            const textEl = document.getElementById('recognizedText');
                            if (textEl && interimText.length > 0) {
                                textEl.innerHTML = `<div style="color: #0099cc; font-style: italic; text-align: center; padding: 15px; border: 2px dashed #0099cc; border-radius: 8px;">🎤 Listening: "${interimText}"</div>`;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Error processing speech results:', error);
                // Don't let processing errors break recognition
                appState.isCurrentlySpeaking = false;
            }
        }

        function handleSpeechPageResult(text) {
            console.log('📝 ✅ Speech page received COMPLETE result:', text);
            console.log('📝 Text length:', text.length, 'characters');
            
            // Don't process if already speaking to prevent interference
            if (appState.isCurrentlySpeaking) {
                console.log('🚫 Already speaking, will wait for speech to finish');
                return;
            }
            
            // Make sure we have substantial content
            if (!text || text.length < 2) {
                console.log('🚫 Text too short, ignoring:', text);
                return;
            }
            
            // Show the COMPLETE result
            showFinalResult(text);
            console.log('📝 Displayed complete text:', text);
            
            // Speak the COMPLETE result back
            if (settings.speakVoiceCommands && text.trim().length > 0) {
                console.log('🔊 Will speak COMPLETE phrase:', text);
                setTimeout(() => {
                    if (appState.speechPageActive && !appState.isCurrentlySpeaking) {
                        speakTextResult(text.trim());
                    } else {
                        console.log('🚫 Not speaking - page changed or already speaking');
                    }
                }, 100); // Very brief delay
            } else {
                console.log('🔊 Not speaking - disabled or empty text');
            }
            
            updateStatus('🎤 Listening continuously - speak another phrase!');
        }

        function handleVoiceCommand(text) {
            const lowerText = text.toLowerCase();
            
            console.log('🗣️ *** VOICE COMMAND DETECTION ***');
            console.log('🗣️ Full text received:', `"${text}"`);
            console.log('🗣️ Lowercase version:', `"${lowerText}"`);
            
            // Look for Leslie triggers - be more flexible
            const hasHeyLeslie = lowerText.includes('hey leslie') || lowerText.includes('hey lesley');
            const hasLeslie = lowerText.includes('leslie') || lowerText.includes('lesley');
            const hasHey = lowerText.includes('hey ') && (hasLeslie);
            
            console.log('🗣️ Has "hey leslie":', hasHeyLeslie);
            console.log('🗣️ Has "leslie" alone:', hasLeslie);
            console.log('🗣️ Has "hey" + leslie:', hasHey);
            
            if (hasHeyLeslie || hasHey || (hasLeslie && lowerText.includes('hey'))) {
                console.log('🗣️ ✅ LESLIE TRIGGER FOUND! Processing command...');
                
                const command = extractCommand(lowerText);
                console.log('🗣️ Extracted command:', command);
                
                if (command) {
                    console.log('🗣️ ✅ EXECUTING COMMAND:', command);
                    updateVoiceCommandStatus('processing');
                    executeCommand(command);
                } else {
                    console.log('🗣️ ❌ Leslie detected but no valid command found');
                    console.log('🗣️ Available commands: home, start talking, start texting, phone, settings, help, weather, hourly, weekly');
                    
                    // Provide helpful feedback
                    if (settings.speakVoiceCommands) {
                        speak("I heard you say my name. Try saying Hey Leslie followed by a command like home, settings, or weather.");
                    }
                    
                    // Still restart voice commands
                    setTimeout(() => {
                        if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                            console.log('🔄 Restarting voice commands after unrecognized Leslie command');
                            startContinuousRecognition();
                        }
                    }, 2000);
                }
            } else {
                console.log('🗣️ ❌ No Leslie trigger found - ignoring speech');
                console.log('🗣️ (Looking for "hey leslie", "leslie", or "hey" + "leslie")');
            }
        }

        function showFinalResult(text) {
            const textEl = document.getElementById('recognizedText');
            if (!textEl) return;
            
            console.log('📝 Displaying COMPLETE phrase:', text);
            console.log('📝 Character count:', text.length);
            
            // Clear previous content and show COMPLETE current phrase
            textEl.innerHTML = '';
            
            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = 'background: #e8f5e8; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; font-size: 18px; line-height: 1.6; text-align: center; margin: 20px 0; word-wrap: break-word;';
            
            // Make sure we display the complete text
            resultDiv.textContent = text;
            
            textEl.appendChild(resultDiv);
            
            // Add debug info
            const debugDiv = document.createElement('div');
            debugDiv.style.cssText = 'font-size: 12px; color: #666; text-align: center; margin-top: 5px;';
            debugDiv.textContent = `Length: ${text.length} characters`;
            textEl.appendChild(debugDiv);
            
            console.log('📝 ✅ Successfully displayed complete phrase');
        }

        function speakTextResult(text) {
            if (!settings.speakVoiceCommands || !text || text.trim().length === 0) {
                console.log('🔊 Not speaking - disabled or empty text');
                return;
            }
            
            const fullText = text.trim();
            console.log('🔊 Speaking text CLEANLY (no stuttering):', fullText);
            
            try {
                // CRITICAL: Ensure no existing speech
                if (speechSynth.speaking || speechSynth.pending) {
                    console.log('🛑 Canceling existing speech to prevent stuttering');
                    speechSynth.cancel();
                    
                    // Wait for cancellation to complete
                    setTimeout(() => {
                        speakSinglePhrase(fullText);
                    }, 300);
                } else {
                    speakSinglePhrase(fullText);
                }
                
            } catch (error) {
                console.error('❌ Error in speakTextResult:', error);
                appState.isCurrentlySpeaking = false;
            }
        }
        
        function speakSinglePhrase(text) {
            console.log('🔊 Speaking single phrase cleanly:', text);
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = settings.speechSpeed || 1.0;
            utterance.lang = 'en-US';
            utterance.volume = 1.0;
            utterance.pitch = 1.0;
            
            utterance.onstart = () => {
                console.log('🔊 ✅ CLEAN speech started:', text);
                appState.isCurrentlySpeaking = true;
                updateVoiceCommandStatus('speaking');
            };
            
            utterance.onend = () => {
                console.log('🔊 ✅ CLEAN speech finished - ONE TIME ONLY');
                appState.isCurrentlySpeaking = false;
                updateVoiceCommandStatus('active');
                
                // Clear display and ensure continuous listening
                if (appState.speechPageActive) {
                    setTimeout(() => {
                        const textEl = document.getElementById('recognizedText');
                        if (textEl) {
                            textEl.innerHTML = `<div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">🎤 Ready for next phrase...</div>`;
                        }
                    }, 1000);
                }
            };
            
            utterance.onerror = (error) => {
                console.error('🔊 ❌ Clean speech error:', error);
                appState.isCurrentlySpeaking = false;
                updateVoiceCommandStatus('active');
            };
            
            // Speak the phrase once
            speechSynth.speak(utterance);
        }

        // === VOICE COMMAND PROCESSING ===
        function extractCommand(text) {
            console.log('🔍 Extracting command from:', text);
            
            const commands = {
                'home': ['home', 'go home', 'main page', 'homepage'],
                'start talking': ['start talking', 'speech', 'talk', 'speaking', 'start speech', 'start listening'],
                'start texting': ['start texting', 'text', 'typing', 'start text'],
                'phone': ['phone', 'call', 'contacts', 'phone call'],
                'settings': ['settings', 'options', 'preferences', 'setting'],
                'help': ['help', 'commands', 'what can you do', 'command'],
                'weather': ['weather', 'current weather', 'what weather'],
                'hourly': ['hourly', 'hourly weather', 'hour', 'hourly forecast'],
                'weekly': ['weekly', 'weekly weather', '7 day', 'seven day', 'week'],
                'close weather': ['close weather', 'hide weather', 'weather close'],
                'free mode': ['free mode', 'browser mode'],
                'pro mode': ['pro mode', 'whisper mode'],
                'speak faster': ['speak faster', 'faster', 'speed up'],
                'speak slower': ['speak slower', 'slower', 'slow down'],
                'pause more': ['pause more', 'more pause', 'longer pause'],
                'pause less': ['pause less', 'less pause', 'shorter pause']
            };
            
            for (const [cmd, variations] of Object.entries(commands)) {
                for (const variation of variations) {
                    if (text.includes(variation)) {
                        console.log('🔍 Found command:', cmd, 'via variation:', variation);
                        return cmd;
                    }
                }
            }
            
            return null;
        }

        function executeCommand(cmd) {
            console.log('🗣️ *** EXECUTING COMMAND ***:', cmd);
            
            let response = '';
            let commandExecuted = false;
            
            try {
                switch (cmd) {
                    case 'home':
                        console.log('🏠 Executing home command');
                        navigateToPage('home');
                        response = 'Going to home page';
                        commandExecuted = true;
                        break;
                    case 'start talking':
                        console.log('🎤 Executing start talking command');
                        navigateToPage('speech');
                        response = 'Opening speech page';
                        commandExecuted = true;
                        break;
                    case 'start texting':
                        console.log('📝 Executing start texting command');
                        navigateToPage('textInput');
                        response = 'Opening text input';
                        commandExecuted = true;
                        break;
                    case 'phone':
                        console.log('📞 Executing phone command');
                        navigateToPage('phone');
                        response = 'Opening contacts';
                        commandExecuted = true;
                        break;
                    case 'settings':
                        console.log('⚙️ Executing settings command');
                        navigateToPage('settings');
                        response = 'Opening settings';
                        commandExecuted = true;
                        break;
                    case 'help':
                        console.log('❓ Executing help command');
                        navigateToPage('commands');
                        response = 'Showing command list';
                        commandExecuted = true;
                        break;
                    case 'weather':
                        console.log('🌤️ Executing weather command');
                        showCurrentWeather();
                        response = 'Showing current weather';
                        commandExecuted = true;
                        break;
                    case 'hourly':
                        console.log('⏰ Executing hourly command');
                        showHourlyWeather();
                        response = 'Showing hourly forecast';
                        commandExecuted = true;
                        break;
                    case 'weekly':
                        console.log('📅 Executing weekly command');
                        showWeeklyWeather();
                        response = 'Showing weekly forecast';
                        commandExecuted = true;
                        break;
                    case 'close weather':
                        console.log('❌ Executing close weather command');
                        hideWeather();
                        response = 'Closing weather display';
                        commandExecuted = true;
                        break;
                    case 'free mode':
                        console.log('🆓 Executing free mode command');
                        settings.recognitionMode = 'free';
                        updateRecognitionModeUI();
                        saveSettings();
                        response = 'Switched to free mode';
                        commandExecuted = true;
                        break;
                    case 'pro mode':
                        console.log('🎯 Executing pro mode command');
                        if (settings.apiKey) {
                            settings.recognitionMode = 'pro';
                            updateRecognitionModeUI();
                            saveSettings();
                            response = 'Switched to pro mode';
                        } else {
                            response = 'Pro mode requires API key';
                        }
                        commandExecuted = true;
                        break;
                    case 'speak faster':
                        console.log('⏩ Executing speak faster command');
                        adjustSpeechSpeed(0.2);
                        response = 'Increased speech speed';
                        commandExecuted = true;
                        break;
                    case 'speak slower':
                        console.log('⏪ Executing speak slower command');
                        adjustSpeechSpeed(-0.2);
                        response = 'Decreased speech speed';
                        commandExecuted = true;
                        break;
                    case 'pause more':
                        console.log('⏸️ Executing pause more command');
                        adjustPauseBetweenWords(0.5);
                        response = 'Increased pause duration';
                        commandExecuted = true;
                        break;
                    case 'pause less':
                        console.log('▶️ Executing pause less command');
                        adjustPauseBetweenWords(-0.5);
                        response = 'Decreased pause duration';
                        commandExecuted = true;
                        break;
                    default:
                        console.log('❓ Unknown command:', cmd);
                        response = 'Unknown command';
                        commandExecuted = false;
                }
                
                console.log('🗣️ Command execution result:', commandExecuted ? 'SUCCESS' : 'FAILED');
                console.log('🗣️ Response will be:', response);
                
                // Speak the response
                if (settings.speakVoiceCommands && response) {
                    speak(response);
                } else {
                    console.log('🔇 Not speaking response');
                    // Even if not speaking, restart voice commands
                    setTimeout(() => {
                        if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                            console.log('🔄 Restarting voice commands after silent command');
                            startContinuousRecognition();
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ Error executing command:', cmd, error);
                updateVoiceCommandStatus('ready');
                
                // Restart voice commands even after error
                setTimeout(() => {
                    if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                        console.log('🔄 Restarting voice commands after command error');
                        startContinuousRecognition();
                    }
                }, 1000);
            }
        }

        function speak(text) {
            if (!settings.speakVoiceCommands || !text) {
                // Always restart voice commands even if not speaking
                setTimeout(() => {
                    if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                        console.log('🔄 Restarting voice commands after non-speech command');
                        startContinuousRecognition();
                    }
                }, 1000);
                return;
            }
            
            console.log('🔊 Speaking command response:', text);
            
            try {
                speechSynth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed || 1.0;
                utterance.lang = 'en-US';
                utterance.volume = 1.0;
                
                utterance.onstart = () => {
                    console.log('🔊 ✅ Started speaking command response:', text);
                    appState.isCurrentlySpeaking = true;
                    updateVoiceCommandStatus('speaking');
                };
                
                utterance.onend = () => {
                    console.log('🔊 ✅ Finished speaking command response');
                    appState.isCurrentlySpeaking = false;
                    updateVoiceCommandStatus('ready');
                    
                    // ALWAYS restart voice commands after speaking
                    setTimeout(() => {
                        if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                            console.log('🔄 Restarting voice commands after command response');
                            startContinuousRecognition();
                        }
                    }, 1000);
                };
                
                utterance.onerror = (error) => {
                    console.error('🔊 ❌ Command speech error:', error);
                    appState.isCurrentlySpeaking = false;
                    updateVoiceCommandStatus('active');
                    
                    // Restart even after error
                    setTimeout(() => {
                        if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                            console.log('🔄 Restarting voice commands after speech error');
                            startContinuousRecognition();
                        }
                    }, 1000);
                };
                
                speechSynth.speak(utterance);
            } catch (error) {
                console.error('❌ Error in speak function:', error);
                appState.isCurrentlySpeaking = false;
                
                // Restart even after error
                setTimeout(() => {
                    if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech && permissionGranted) {
                        startContinuousRecognition();
                    }
                }, 1000);
            }
        }

        // === PAGE NAVIGATION ===
        function navigateToPage(pageId) {
            console.log('📄 Navigating to page:', pageId);
            
            if (speechSynth) {
                speechSynth.cancel();
            }
            
            showPage(pageId);
        }

        function showPage(pageId) {
            console.log('📄 Showing page:', pageId);
            
            // Update page state
            const oldSpeechPageActive = appState.speechPageActive;
            appState.speechPageActive = (pageId === 'speech');
            
            // Reset manual stop flag when changing pages
            appState.manuallyStoppedSpeech = false;
            
            // Show the page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (pageId === 'speech') {
                    const textEl = document.getElementById('recognizedText');
                    if (textEl) {
                        textEl.innerHTML = `<div style="color: #0099cc; font-weight: bold; text-align: center; padding: 20px;">🎤 Starting continuous listening in 1 second...</div>`;
                    }
                    updateStatus('🎤 Starting continuous listening for accessibility...');
                    
                    // AUTO-START speech recognition on speech page - ONLY if permission granted
                    if (permissionGranted) {
                        setTimeout(() => {
                            if (appState.speechPageActive && !appState.manuallyStoppedSpeech) {
                                console.log('🎤 ✅ AUTO-STARTING speech page for accessibility');
                                startContinuousRecognition();
                            }
                        }, 1000);
                    } else {
                        if (textEl) {
                            textEl.innerHTML = `<div style="color: #cc0000; font-weight: bold; text-align: center; padding: 20px;">🔴 Microphone permission needed - click voice status to grant</div>`;
                        }
                        updateStatus('🔴 Microphone permission needed');
                    }
                } else {
                    // For other pages, only start voice commands if permission granted
                    if (permissionGranted && !appState.isListening) {
                        console.log('🗣️ Starting voice commands for page:', pageId);
                        setTimeout(() => {
                            if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech) {
                                console.log('🗣️ ✅ Starting voice commands for accessibility');
                                startContinuousRecognition();
                            }
                        }, 1000);
                    } else if (!permissionGranted) {
                        console.log('🔴 Permission denied - voice commands not started');
                        updateVoiceCommandStatus('permission-needed');
                    }
                }
                
                if (pageId === 'phone') {
                    displayContactsOnPhonePage();
                }
                
                if (pageId === 'textInput') {
                    requestAnimationFrame(() => {
                        const textField = document.getElementById('largeTextInputField');
                        if (textField) textField.focus();
                    });
                }
            }
            
            updateUI();
            updateStatus();
        }

        function clearSpeechText() {
            const textEl = document.getElementById('recognizedText');
            if (textEl) {
                textEl.innerHTML = `<div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">🎤 Ready for next phrase...</div>`;
            }
            lastProcessedText = '';
            lastProcessedTime = 0;
            
            // Reset the 2-minute timeout when clearing
            if (appState.speechPageActive) {
                resetSpeechTimeout();
            }
        }

        // === UI UPDATES ===
        function updateUI() {
            const button = document.getElementById('listenButton');
            if (button) {
                if (appState.isListening && appState.speechPageActive) {
                    button.textContent = 'STOP LISTENING';
                    button.className = 'control-btn btn-stop';
                } else if (appState.speechPageActive) {
                    button.textContent = 'START LISTENING';
                    button.className = 'control-btn btn-listen';
                } else {
                    button.textContent = appState.isListening ? 'VOICE ACTIVE' : 'VOICE INACTIVE';
                    button.className = appState.isListening ? 'control-btn btn-listen' : 'control-btn btn-stop';
                }
            }
        }

        function updateStatus(message = null) {
            const statusEl = document.getElementById('statusText');
            if (statusEl && message) {
                statusEl.textContent = message;
            } else if (statusEl && appState.speechPageActive) {
                if (appState.isCurrentlySpeaking) {
                    statusEl.textContent = '🔊 Speaking your words back to you...';
                } else if (appState.isListening) {
                    statusEl.textContent = '🎤 Listening continuously - speak any phrase!';
                } else if (!permissionGranted) {
                    statusEl.textContent = '🔴 Microphone permission needed';
                } else if (appState.manuallyStoppedSpeech) {
                    statusEl.textContent = '🛑 Stopped - Click START LISTENING to resume';
                } else {
                    statusEl.textContent = '🎤 Starting listening mode...';
                }
            }
        }

        function updateVoiceCommandStatus(status = null) {
            const statusEl = document.getElementById('voiceCommandStatus');
            if (!statusEl) return;
            
            statusEl.className = 'voice-command-status';
            
            if (status === 'permission-needed') {
                statusEl.textContent = '🔴 Click Here to Enable Microphone';
                statusEl.classList.add('permission-needed');
            } else if (status === 'active') {
                statusEl.textContent = '🎤 Voice Commands Active - Say "Hey Leslie"';
                statusEl.classList.add('active');
            } else if (status === 'processing') {
                statusEl.textContent = '⏳ Processing Command...';
                statusEl.classList.add('processing');
            } else if (status === 'speaking') {
                statusEl.textContent = '🔊 Speaking...';
                statusEl.classList.add('speaking');
            } else {
                statusEl.textContent = '🎤 Voice Commands Ready';
                statusEl.classList.add('ready');
            }
        }

        function showPermissionError() {
            updateVoiceCommandStatus('permission-needed');
            updateStatus('🔴 Microphone permission needed - click the voice status to retry');
        }

        // === EVENT HANDLERS ===
        function setupEventHandlers() {
            try {
                // Navigation buttons
                document.getElementById('btnStartTalking')?.addEventListener('click', () => navigateToPage('speech'));
                document.getElementById('btnStartTexting')?.addEventListener('click', () => navigateToPage('textInput'));
                document.getElementById('btnPhoneCall')?.addEventListener('click', () => navigateToPage('phone'));
                document.getElementById('btnCommands')?.addEventListener('click', () => navigateToPage('commands'));
                document.getElementById('btnSettings')?.addEventListener('click', () => navigateToPage('settings'));
                
                // Close buttons
                document.getElementById('btnCloseSpeech')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnClosePhone')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnCloseCommands')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnCloseText')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnCloseSettings')?.addEventListener('click', () => navigateToPage('home'));
                
                // Home buttons
                document.getElementById('btnPhoneHome')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnTextHome')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnSettingsHome')?.addEventListener('click', () => navigateToPage('home'));
                document.getElementById('btnCommandsHome')?.addEventListener('click', () => navigateToPage('home'));
                
                // Speech controls
                document.getElementById('listenButton')?.addEventListener('click', () => {
                    if (appState.speechPageActive) {
                        if (appState.isListening) {
                            console.log('🛑 User manually stopped recognition on speech page');
                            stopSpeechRecognition();
                        } else {
                            console.log('🎤 User manually starting recognition on speech page');
                            appState.manuallyStoppedSpeech = false;
                            startContinuousRecognition();
                        }
                    }
                });
                document.getElementById('clearButton')?.addEventListener('click', clearSpeechText);
                
                // Text input
                document.getElementById('speakTextBtn')?.addEventListener('click', speakTextInput);
                document.getElementById('largeTextInputField')?.addEventListener('input', updateTextSpeakButton);
                
                // Contacts
                document.getElementById('contactSearchInput')?.addEventListener('input', (e) => filterContacts(e.target.value));
                document.getElementById('loadAllContactsBtn')?.addEventListener('click', loadAllContacts);
                document.getElementById('loadSelectedContactsBtn')?.addEventListener('click', loadSelectedContacts);
                
                // Weather
                document.getElementById('currentWeatherBtn')?.addEventListener('click', showCurrentWeather);
                document.getElementById('hourlyWeatherBtn')?.addEventListener('click', showHourlyWeather);
                document.getElementById('weeklyWeatherBtn')?.addEventListener('click', showWeeklyWeather);
                document.getElementById('closeWeatherBtn')?.addEventListener('click', hideWeather);
                
                // Settings
                document.getElementById('apiKeyInput')?.addEventListener('input', (e) => saveApiKey(e.target.value));
                document.getElementById('speechSpeedSlider')?.addEventListener('input', (e) => updateSpeechSpeed(e.target.value));
                document.getElementById('pauseBetweenWordsSlider')?.addEventListener('input', (e) => updatePauseBetweenWords(e.target.value));
                document.getElementById('speakVoiceCommandsSwitch')?.addEventListener('change', (e) => updateVoiceCommandSetting(e.target.checked));

                // Recognition mode radios
                document.querySelectorAll('input[name="recognitionMode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            updateRecognitionMode(e.target.value);
                        }
                    });
                });
                
                // Voice command status click - manual permission request only
                document.getElementById('voiceCommandStatus')?.addEventListener('click', async () => {
                    console.log('🎤 Voice status clicked');
                    
                    if (!permissionGranted) {
                        console.log('🔐 User requesting permission manually');
                        
                        // Reset permission check to allow manual retry
                        permissionChecked = false;
                        const granted = await checkPermission();
                        
                        if (granted) {
                            console.log('✅ Permission granted manually - starting voice commands');
                            appState.manuallyStoppedSpeech = false;
                            setTimeout(() => {
                                if (!appState.speechPageActive && !appState.isListening) {
                                    startContinuousRecognition();
                                }
                            }, 1000);
                        } else {
                            console.log('🔴 Permission still denied after manual request');
                        }
                    } else if (!appState.isListening && !appState.speechPageActive) {
                        console.log('🎤 Manual start of voice commands');
                        appState.manuallyStoppedSpeech = false;
                        startContinuousRecognition();
                    } else if (appState.isListening && !appState.speechPageActive) {
                        console.log('🛑 Stopping voice commands via status click');
                        appState.manuallyStoppedSpeech = true;
                        if (speechRecognition) {
                            speechRecognition.stop();
                        }
                        updateVoiceCommandStatus('ready');
                    }
                });
                
            } catch (error) {
                console.error('❌ Error setting up event handlers:', error);
            }
        }

        // === TEXT INPUT ===
        function speakTextInput() {
            const textField = document.getElementById('largeTextInputField');
            if (textField && textField.value.trim()) {
                const textToSpeak = textField.value.trim();
                
                console.log('🔊 Speaking text input:', textToSpeak);
                
                try {
                    speechSynth.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.rate = settings.speechSpeed || 1.0;
                    utterance.lang = 'en-US';
                    utterance.volume = 1.0;
                    
                    utterance.onstart = () => {
                        console.log('🔊 Started speaking text input:', textToSpeak);
                        appState.isCurrentlySpeaking = true;
                        updateVoiceCommandStatus('speaking');
                    };
                    
                    utterance.onend = () => {
                        console.log('🔊 Finished speaking text input');
                        appState.isCurrentlySpeaking = false;
                        updateVoiceCommandStatus('active');
                    };
                    
                    utterance.onerror = (error) => {
                        console.error('🔊 Text input speech error:', error);
                        appState.isCurrentlySpeaking = false;
                        updateVoiceCommandStatus('active');
                    };
                    
                    speechSynth.speak(utterance);
                    
                } catch (error) {
                    console.error('❌ Error speaking text input:', error);
                    appState.isCurrentlySpeaking = false;
                }
                
                textField.value = '';
                updateTextSpeakButton();
            }
        }

        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            const textField = document.getElementById('largeTextInputField');
            
            if (speakBtn && textField) {
                if (textField.value.trim()) {
                    speakBtn.disabled = false;
                    speakBtn.style.opacity = '1';
                    speakBtn.style.backgroundColor = '#9933cc';
                } else {
                    speakBtn.disabled = true;
                    speakBtn.style.opacity = '0.5';
                    speakBtn.style.backgroundColor = '#ccc';
                }
            }
        }

        // === CONTACTS ===
        function initializeContacts() {
            contacts = [
                { name: 'Emergency Services', phone: '911' },
                { name: 'Demo Contact 1', phone: '(555) 123-4567' },
                { name: 'Demo Contact 2', phone: '(555) 987-6543' },
                { name: 'Demo Contact 3', phone: '(555) 246-8135' }
            ];
            filteredContacts = contacts.slice();
        }

        async function loadAllContacts() {
            try {
                const contactsList = document.getElementById('contactsList');
                const loadingSection = document.getElementById('contactLoadingSection');
                
                if (loadingSection) loadingSection.style.display = 'none';
                
                if (contactsList) {
                    contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px; border: 2px solid #669900;"><p><strong>📞 LOADING ALL CONTACTS</strong></p><p style="margin: 10px 0;">Opening contact picker...</p></div>`;
                }
                
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList && contactList.length > 0) {
                        const processedContacts = [];
                        contactList.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            const contactName = names[0] || 'Unknown Contact';
                            
                            if (phones.length > 0) {
                                phones.forEach((phone, phoneIndex) => {
                                    processedContacts.push({
                                        name: phones.length > 1 ? `${contactName} (${phoneIndex + 1})` : contactName,
                                        phone: phone
                                    });
                                });
                            } else {
                                processedContacts.push({
                                    name: contactName,
                                    phone: 'No phone number'
                                });
                            }
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        throw new Error('No contacts selected');
                    }
                } else {
                    throw new Error('Contacts API not supported');
                }
            } catch (error) {
                console.error('❌ Error loading contacts:', error);
                handleContactLoadingError(error, document.getElementById('contactsList'));
            }
        }

        async function loadSelectedContacts() {
            try {
                const contactsList = document.getElementById('contactsList');
                const loadingSection = document.getElementById('contactLoadingSection');
                
                if (loadingSection) loadingSection.style.display = 'none';
                
                if (contactsList) {
                    contactsList.innerHTML = `<div style="padding: 16px; text-align: center; color: #0099cc; background: #f0f8ff; border-radius: 8px;"><p><strong>📋 Choose Specific Contacts</strong></p><p>⏳ Opening contact picker...</p></div>`;
                }
                
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList.length > 0) {
                        const processedContacts = contactList.map(contact => {
                            const name = (contact.name && contact.name[0]) ? contact.name[0] : 'Unknown';  
                            const phone = (contact.tel && contact.tel[0]) ? contact.tel[0] : 'No phone';
                            return { name, phone };
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) => 
                            index === self.findIndex(c => c.name === contact.name && c.phone === contact.phone)
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        if (contactsList) {
                            contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #ff6600; border: 2px solid #ff6600; border-radius: 8px;"><p><strong>📱 No Contacts Selected</strong></p><p>Demo contacts remain available</p></div>`;
                        }
                        setTimeout(() => displayContactsOnPhonePage(), 3000);
                    }
                } else {
                    throw new Error('Contacts API not supported');
                }
            } catch (error) {
                console.error('❌ Error loading selected contacts:', error);
                handleContactLoadingError(error, document.getElementById('contactsList'));
            }
        }

        function handleContactLoadingError(error, contactsList) {
            let errorMessage = '';
            if (error.name === 'NotAllowedError') {
                errorMessage = `<p><strong>📱 Permission Denied</strong></p><p>You denied contact access</p>`;
            } else if (error.name === 'AbortError') {
                errorMessage = `<p><strong>📱 Contact Selection Cancelled</strong></p>`;
            } else if (error.message.includes('not supported')) {
                errorMessage = `<p><strong>📱 Contacts API Not Supported</strong></p><p>Requires Chrome Android or Safari iOS</p>`;
            } else {
                errorMessage = `<p><strong>📱 Contact Loading Error</strong></p><p>${error.message || 'Unknown error'}</p>`;
            }
            
            if (contactsList) {
                contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px;">${errorMessage}<p style="margin-top: 15px;">Demo contacts will remain available</p></div>`;
            }
            
            setTimeout(() => displayContactsOnPhonePage(), 4000);
        }

        function displayRealContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';

            const successHeader = document.createElement('div');
            successHeader.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: white; background: #28a745; border-radius: 8px; margin-bottom: 8px;';
            successHeader.innerHTML = `✅ SUCCESS: ${filteredContacts.length} REAL contacts loaded!`;
            contactsList.appendChild(successHeader);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.style.backgroundColor = '#e8f5e8';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });

            const footerNote = document.createElement('div');
            footerNote.style.cssText = 'padding: 8px; text-align: center; font-size: 12px; color: #28a745; font-weight: bold; margin-top: 8px;';
            footerNote.textContent = '📱 These are YOUR real contacts - searchable and callable!';
            contactsList.appendChild(footerNote);
        }

        function displayContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><p><strong>📱 No contacts found</strong></p></div>';
                return;
            }

            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: #669900; background: #f0f8ff; border-radius: 8px; margin-bottom: 8px;';
            headerDiv.textContent = `📱 ${filteredContacts.length} contacts available - Tap any contact to call`;
            contactsList.appendChild(headerDiv);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });
        }

        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    return contact.name.toLowerCase().includes(searchLower) ||
                           contact.phone.replace(/[^0-9]/g, '').includes(searchTerm.replace(/[^0-9]/g, ''));
                });
            }
            displayContactsOnPhonePage();
        }

        function callContact(contact) {
            const phoneNumber = contact.phone.replace(/[^0-9]/g, '');
            if (phoneNumber) {
                window.location.href = `tel:${phoneNumber}`;
            }
        }

        // === WEATHER ===
        function getUserLocation() {
            userLocation = { lat: 38.8117, lon: -90.8529 };
        }

        async function showCurrentWeather() {
            try {
                showWeatherDisplay('Current Weather', 'Loading current weather...');
                
                const { lat, lon } = userLocation || { lat: 40.7128, lon: -74.0060 };
                
                const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const weatherData = await weatherResponse.json();
                
                const temperature = Math.round(weatherData.current.temperature_2m * 9/5 + 32);
                const humidity = weatherData.current.relative_humidity_2m;
                const windSpeed = Math.round(weatherData.current.wind_speed_10m * 0.621371);
                const conditions = getWeatherDescription(weatherData.current.weather_code);
                
                const weatherContent = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 28px; font-weight: bold; color: #0099cc; margin-bottom: 8px;">${temperature}°F</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">${conditions}</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <div><strong>Humidity:</strong> ${humidity}%</div>
                            <div><strong>Wind:</strong> ${windSpeed} mph</div>
                        </div>
                    </div>
                `;
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = weatherContent;
            } catch (error) {
                console.error('❌ Weather error:', error);
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = '<div style="text-align: center; padding: 20px;">Unable to load weather data.</div>';
            }
        }

        async function showHourlyWeather() {
            try {
                showWeatherDisplay('Next 24 Hours', 'Loading 24-hour forecast...');
                
                const { lat, lon } = userLocation || { lat: 38.8117, lon: -90.8529 };
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=2`);
                const data = await response.json();
                
                let hourlyData = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 4px; padding: 10px; max-height: 400px; overflow-y: auto;">';
                
                for (let i = 0; i < Math.min(24, data.hourly.time.length); i++) {
                    const time = new Date(data.hourly.time[i]);
                    const hour = time.getHours();
                    const temp = Math.round(data.hourly.temperature_2m[i] * 9/5 + 32);
                    const conditions = getWeatherDescription(data.hourly.weather_code[i]);
                    
                    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    
                    hourlyData += `
                        <div style="background: #f0f8ff; padding: 6px; text-align: center; font-size: 10px; border-radius: 4px;">
                            <div style="font-weight: bold; font-size: 11px;">${displayHour}${ampm}</div>
                            <div style="font-size: 12px; font-weight: bold; margin: 2px 0;">${temp}°</div>
                            <div style="font-size: 9px; opacity: 0.9;">${conditions}</div>
                        </div>
                    `;
                }
                hourlyData += '</div>';
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = hourlyData;
            } catch (error) {
                console.error('❌ Hourly weather error:', error);
            }
        }

        async function showWeeklyWeather() {
            try {
                showWeatherDisplay('7-Day Forecast', 'Loading 7-day forecast...');
                
                const { lat, lon } = userLocation || { lat: 40.7128, lon: -74.0060 };
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7`);
                const data = await response.json();
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                let weeklyData = '<div style="display: grid; gap: 6px; padding: 10px;">';
                
                for (let i = 0; i < Math.min(7, data.daily.time.length); i++) {
                    const date = new Date(data.daily.time[i]);
                    const dayName = days[date.getDay()];
                    const high = Math.round(data.daily.temperature_2m_max[i] * 9/5 + 32);
                    const low = Math.round(data.daily.temperature_2m_min[i] * 9/5 + 32);
                    const conditions = getWeatherDescription(data.daily.weather_code[i]);
                    
                    weeklyData += `
                        <div style="display: grid; grid-template-columns: 80px 60px 1fr; gap: 8px; align-items: center; background: #f0f8ff; padding: 8px; border-radius: 6px;">
                            <div style="font-weight: bold;">${dayName}</div>
                            <div style="color: #0099cc; font-weight: bold;">${high}°/${low}°</div>
                            <div style="color: #666;">${conditions}</div>
                        </div>
                    `;
                }
                weeklyData += '</div>';
                
                const weatherContentEl = document.getElementById('weatherContent');
                if (weatherContentEl) weatherContentEl.innerHTML = weeklyData;
            } catch (error) {
                console.error('❌ Weekly weather error:', error);
            }
        }

        function showWeatherDisplay(title, content) {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            
            if (weatherTitle) weatherTitle.textContent = title;
            if (weatherContent) weatherContent.innerHTML = `<div style="text-align: center; padding: 20px;">${content}</div>`;
            if (weatherDisplay) weatherDisplay.classList.remove('hidden');
        }

        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            if (weatherDisplay) {
                weatherDisplay.classList.add('hidden');
            }
        }

        function getWeatherDescription(code) {
            const weatherCodes = {
                0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog',
                51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Thunderstorm with heavy hail'
            };
            return weatherCodes[code] || 'Unknown';
        }

        // === SWIPE GESTURES ===
        function setupSwipeGestures() {
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            
            let touchStartX = 0;
            let touchStartY = 0;
            const minSwipeDistance = 50;

            if (swipeBottom) {
                swipeBottom.addEventListener('touchstart', function(e) {
                    touchStartY = e.changedTouches[0].clientY;
                    e.preventDefault();
                }, { passive: false });

                swipeBottom.addEventListener('touchend', function(e) {
                    const touchEndY = e.changedTouches[0].clientY;
                    const swipeDistance = touchStartY - touchEndY;
                    if (swipeDistance > minSwipeDistance) {
                        showCurrentWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }

            if (swipeLeft) {
                swipeLeft.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].clientX;
                    e.preventDefault();
                }, { passive: false });

                swipeLeft.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].clientX;
                    const swipeDistance = touchEndX - touchStartX;
                    if (swipeDistance > minSwipeDistance) {
                        showHourlyWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }

            if (swipeRight) {
                swipeRight.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].clientX;
                    e.preventDefault();
                }, { passive: false });

                swipeRight.addEventListener('touchend', function(e) {
                    const touchEndX = e.changedTouches[0].clientX;
                    const swipeDistance = touchStartX - touchEndX;
                    if (swipeDistance > minSwipeDistance) {
                        showWeeklyWeather();
                    }
                    e.preventDefault();
                }, { passive: false });
            }
        }

        // === SETTINGS ===
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieAccessibilitySettings');
                if (savedSettings) {
                    Object.assign(settings, JSON.parse(savedSettings));
                }
            } catch (error) {
                console.error('❌ Error loading settings:', error);
            }
            updateSettingsUI();
        }

        function saveSettings() {
            try {
                localStorage.setItem('leslieAccessibilitySettings', JSON.stringify(settings));
            } catch (error) {
                console.error('❌ Error saving settings:', error);
            }
        }

        function updateSettingsUI() {
            const elements = {
                speedSlider: document.getElementById('speechSpeedSlider'),
                pauseSlider: document.getElementById('pauseBetweenWordsSlider'),
                voiceSwitch: document.getElementById('speakVoiceCommandsSwitch'),
                apiKeyInput: document.getElementById('apiKeyInput')
            };

            if (elements.speedSlider) elements.speedSlider.value = settings.speechSpeed;
            if (elements.pauseSlider) elements.pauseSlider.value = settings.pauseBetweenWords;
            if (elements.voiceSwitch) elements.voiceSwitch.checked = settings.speakVoiceCommands;
            if (elements.apiKeyInput) elements.apiKeyInput.value = settings.apiKey;

            updateSpeechSpeed(settings.speechSpeed);
            updatePauseBetweenWords(settings.pauseBetweenWords);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateRecognitionModeUI();
            updateEnhancedSectionVisibility();
        }

        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            const slider = document.getElementById('speechSpeedSlider');
            
            if (label) {
                const formattedValue = Math.round(parseFloat(value) * 10) / 10;
                label.textContent = formattedValue === 1.0 ? 'Normal (1.0x)' : formattedValue + 'x';
            }
            if (slider) {
                slider.value = value;
            }
            saveSettings();
        }

        function updatePauseBetweenWords(value) {
            settings.pauseBetweenWords = parseFloat(value);
            const label = document.getElementById('pauseBetweenWordsValue');
            const slider = document.getElementById('pauseBetweenWordsSlider');
            
            const formattedValue = Math.round(parseFloat(value) * 10) / 10;
            
            if (label) {
                label.textContent = formattedValue + ' seconds';
            }
            if (slider) {
                slider.value = value;
            }
            
            saveSettings();
        }

        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            const switchEl = document.getElementById('speakVoiceCommandsSwitch');
            
            if (label) {
                label.textContent = 'Speak Voice Commands: ' + (checked ? 'ON' : 'OFF');
            }
            if (switchEl) {
                switchEl.checked = checked;
            }
            saveSettings();
        }

        function updateRecognitionModeUI() {
            const label = document.getElementById('recognitionModeLabel');
            const modeRadios = document.querySelectorAll('input[name="recognitionMode"]');
            
            modeRadios.forEach(radio => {
                radio.checked = (radio.value === settings.recognitionMode);
            });
            
            if (label) {
                const modeNames = {
                    free: 'Free Mode (Continuous)',
                    pro: 'Pro Mode (~$0.006/min)'
                };
                label.textContent = 'Current: ' + (modeNames[settings.recognitionMode] || 'Free Mode (Continuous)');
            }
        }

        function updateRecognitionMode(mode) {
            console.log('🔧 Changing recognition mode to:', mode);
            
            if (mode === 'pro' && !settings.apiKey) {
                alert('Please enter your OpenAI API key to use Pro Mode.');
                const freeRadio = document.getElementById('modeFree');
                if (freeRadio) freeRadio.checked = true;
                return;
            }
            
            settings.recognitionMode = mode;
            updateRecognitionModeUI();
            saveSettings();
        }

        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }

        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
            } else if (enhancedSection) {
                enhancedSection.classList.remove('show');
            }
        }

        function adjustSpeechSpeed(delta) {
            const newSpeed = Math.max(0.5, Math.min(2.0, settings.speechSpeed + delta));
            updateSpeechSpeed(newSpeed);
        }

        function adjustPauseBetweenWords(delta) {
            const newPause = Math.max(0.5, Math.min(6.0, settings.pauseBetweenWords + delta));
            updatePauseBetweenWords(newPause);
        }

        // === INITIALIZATION (COMPLETELY PREVENT DOUBLES) ===
        async function initApp() {
            // Triple check to prevent any double initialization
            if (isInitialized || initializationAttempted) {
                console.log('⏭️ BLOCKED: Already initialized or attempted');
                return;
            }
            
            initializationAttempted = true;
            console.log('🚀 Initializing Leslie Speech Assistant... (SINGLE INIT)');
            
            try {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Sorry, speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }
                
                loadSettings();
                setupEventHandlers();
                initializeContacts();
                setupSwipeGestures();
                getUserLocation();
                updateTextSpeakButton();
                
                // Check permission once only
                console.log('🔐 Checking microphone permission (one time only)...');
                const hasPermission = await checkPermission();
                
                isInitialized = true;
                console.log('✅ Leslie initialized successfully (SINGLE INIT)');
                
                // Start voice commands only if permission granted
                if (hasPermission) {
                    console.log('🎤 Permission granted - will start voice commands');
                    updateVoiceCommandStatus('ready');
                    setTimeout(() => {
                        if (!appState.speechPageActive && !appState.isListening && !appState.manuallyStoppedSpeech) {
                            console.log('🎤 ✅ Starting voice commands for accessibility');
                            startContinuousRecognition();
                        }
                    }, 2000);
                } else {
                    console.log('🔴 Permission denied - voice commands disabled until manually enabled');
                    updateVoiceCommandStatus('permission-needed');
                    updateStatus();
                    updateUI();
                }
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                initializationAttempted = false; // Allow retry only on error
            }
        }

        // === ABSOLUTELY SINGLE INITIALIZATION ===
        (function startAppOnce() {
            let started = false;
            
            function tryStart() {
                if (started) {
                    console.log('⏭️ BLOCKED: App already started');
                    return;
                }
                started = true;
                
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    initApp();
                } else {
                    document.addEventListener('DOMContentLoaded', initApp, { once: true });
                }
            }
            
            // Only try to start once
            tryStart();
        })();

        // === CLEANUP ON PAGE UNLOAD ===
        window.addEventListener('beforeunload', () => {
            console.log('🧹 Cleaning up on page unload...');
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                } catch (e) {}
            }
        });
    </script>

<!-- Leslie Controller v16 -->
<script>
(function(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  // ---------- helpers ----------
  function isVisible(el){
    if (!el) return false;
    const cs = getComputedStyle(el);
    if (cs.display === 'none' || cs.visibility === 'hidden' || +cs.opacity === 0) return false;
    const r = el.getBoundingClientRect();
    return r.width > 0 && r.height > 0;
  }
  function byTextVisible(txt){
    txt = (txt||'').toLowerCase();
    const nodes = Array.from(document.querySelectorAll('button, a, .btn, [role='+"\"button\""+"]"));
    return nodes.find(n => isVisible(n) && ((n.textContent||'').trim().toLowerCase().includes(txt)));
  }
  function isHomePage(){
    const a = byTextVisible('start listening') || byTextVisible('start talking');
    const b = byTextVisible('start texting');
    const c = byTextVisible('phone call');
    const d = byTextVisible('leslie commands');
    return [a,b,c,d].filter(Boolean).length >= 2;
  }
  function isSpeechPage(){
    const stopBtn = document.getElementById('stopListeningButton') || document.getElementById('stopListeningBtn');
    if (isVisible(stopBtn)) return true;
    const h = (document.querySelector('h1,h2,h3,.page-title')||{}).textContent || '';
    return (h.toLowerCase().includes('start listening') || h.toLowerCase().includes('start talking')) && !isHomePage();
  }
  function isTextPage(){
    const input = document.getElementById('largeTextInputField') || document.querySelector('textarea, [contenteditable="true"]');
    return !!input && !isSpeechPage();
  }

  function hardStopAnySR(){
    try { if (window.stopContinuousRecognition) window.stopContinuousRecognition(); } catch(e){}
    try { if (window.speechRecognition) { window.speechRecognition.onend = null; window.speechRecognition.stop(); } } catch(e){}
    try { if (window.appState) { appState.speechPageActive = false; appState.manuallyStoppedSpeech = true; } } catch(e){}
  }

  // ---------- HOME HOTWORD (no fast restarts, supports "home") ----------
  const hot = { rec:null, running:false, restartTimer:null, lastStart:0, minGap: 45000 };
  function startHotword(){
    if (!SR) return;
    if (!isHomePage()) return;
    if (hot.running) return;
    const now = Date.now();
    if (now - hot.lastStart < 1000) return; // debounce
    hot.lastStart = now;

    if (!hot.rec) hot.rec = new SR();
    const rec = hot.rec;
    rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
    rec.onstart = ()=>{ hot.running = true; };
    rec.onresult = (e)=>{
      let t = '';
      for (let i=e.resultIndex;i<e.results.length;i++){ if (e.results[i].isFinal) t += e.results[i][0].transcript; }
      t = t.trim().toLowerCase(); if (!t) return;
      if (!t.includes('leslie')) return;
      // route
      if (t.includes('home')) {
        const homeBtn = byTextVisible('home');
        if (homeBtn) homeBtn.click(); else window.scrollTo({top:0, behavior:'smooth'});
      } else if (t.includes('commands')) {
        const b = byTextVisible('leslie commands'); if (b) b.click();
      } else if (t.includes('start listening') || t.includes('start talking')) {
        const b = byTextVisible('start listening') || byTextVisible('start talking'); if (b) b.click();
      } else if (t.includes('start texting') || t.startsWith('text ')) {
        const b = byTextVisible('start texting'); if (b) b.click();
      } else if (t.includes('phone call') || t.startsWith('call')) {
        const b = byTextVisible('phone call'); if (b) b.click();
      }
      // no TTS feedback (prevents ping/static)
    };
    rec.onerror = ()=>{};
    rec.onend = ()=>{
      hot.running = false;
      if (hot.restartTimer) clearTimeout(hot.restartTimer);
      // restart after a long gap only if still on Home and visible
      hot.restartTimer = setTimeout(()=>{
        if (document.visibilityState === 'visible' && isHomePage()) {
          try { rec.start(); } catch(e){}
        }
      }, hot.minGap);
    };
    try { rec.start(); } catch(e){}
  }
  function stopHotword(){
    if (hot.restartTimer) { clearTimeout(hot.restartTimer); hot.restartTimer = null; }
    if (hot.rec){ try { hot.rec.onend = null; } catch(e){} try { hot.rec.stop(); } catch(e){} }
    hot.running = false;
  }

  // ---------- START TALKING (dictation) — full phrase, no loops ----------
  const dict = { rec:null, running:false, buff:'', flushTimer:null, idleTimer:null, restarting:false };
  function clearDictTimers(){ if (dict.flushTimer) clearTimeout(dict.flushTimer); dict.flushTimer=null; if (dict.idleTimer) clearTimeout(dict.idleTimer); dict.idleTimer=null; }
  function scheduleIdle(){ clearDictTimers(); dict.idleTimer = setTimeout(stopDictation, 120000); }
  function flushSpeak(){
    const text = (dict.buff||'').trim();
    dict.buff = '';
    if (!text) return;
    // Update UI if app has a function, but avoid double-speaking; let us speak.
    try { if (typeof window.onTranscriptFinal === 'function') window.onTranscriptFinal(text); } catch(e){}
    try { if (typeof window.addRecognizedPhrase === 'function') window.addRecognizedPhrase(text); } catch(e){}
    // Pause recognition during TTS
    try { if (dict.rec) { dict.rec.onend = null; dict.rec.stop(); } } catch(e){}
    if (window.speechSynthesis){
      try { window.speechSynthesis.cancel(); } catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      u.rate = (window.settings && window.settings.speechSpeed) || 1.0;
      u.lang = 'en-US';
      u.onend = () => {
        // resume once, gently
        setTimeout(()=>{ if (isSpeechPage()) { try { dict.rec && dict.rec.start(); scheduleIdle(); } catch(e){} } }, 600);
      };
      window.speechSynthesis.speak(u);
    }
  }
  function startDictation(){
    if (!SR) return;
    if (!isSpeechPage()) return;
    if (!dict.rec) dict.rec = new SR();
    const rec = dict.rec;
    if (dict.running) return;

    rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
    rec.onstart = ()=>{ dict.running=true; dict.buff=''; scheduleIdle(); };
    rec.onresult = (e)=>{
      scheduleIdle();
      for (let i=e.resultIndex;i<e.results.length;i++){
        const r = e.results[i];
        if (r.isFinal){ dict.buff += (r[0].transcript||''); if (dict.flushTimer) clearTimeout(dict.flushTimer); dict.flushTimer=setTimeout(flushSpeak, 650); }
      }
    };
    rec.onerror = ()=>{};
    rec.onend = ()=>{
      dict.running=false;
      clearDictTimers();
      // Do not loop; resume only after TTS or when page observer calls startDictation again.
    };
    try { rec.start(); } catch(e){}
  }
  function stopDictation(){
    clearDictTimers();
    if (dict.rec){ try { dict.rec.onend = null; } catch(e){} try { dict.rec.stop(); } catch(e){} }
    dict.running=false; dict.buff='';
  }

  // ---------- TEXT PAGE: Speak button at top-right + ensure no SR ----------
  function ensureTextSpeak(){
    let btn = document.getElementById('speakTextBtn') || document.getElementById('speakTextButton') || document.getElementById('speakTextBtn_fallback_top');
    const needFallback = !btn;
    if (!btn){
      btn = document.createElement('button');
      btn.id = 'speakTextBtn_fallback_top';
      btn.textContent = 'Speak';
      btn.style.cssText = 'position:fixed; right:12px; top:12px; z-index:99999; padding:10px 14px; border-radius:999px; font-size:16px; box-shadow:0 4px 12px rgba(0,0,0,.25); background:#6b46c1; color:#fff; border:none;';
      document.body.appendChild(btn);
    }
    if (!btn.__bound){
      btn.addEventListener('click', function(){
        // Hard stop any SR to avoid interference beeps
        try { stopHotword(); stopDictation(); hardStopAnySR(); } catch(e){}
        const field = document.getElementById('largeTextInputField') || document.querySelector('textarea, [contenteditable="true"]');
        const text = (field && (field.value || field.innerText || field.textContent) || '').trim();
        if (!text) return;
        try { window.speechSynthesis.cancel(); } catch(e){}
        const u = new SpeechSynthesisUtterance(text);
        u.rate = (window.settings && window.settings.speechSpeed) || 1.0;
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
      }, { passive:true });
      btn.__bound = true;
    }
    // Show only on Text page
    btn.style.display = isTextPage() ? 'inline-flex' : 'none';
  }

  // ---------- main observer ----------
  function tick(){
    if (isHomePage()){
      // Home: hotword on; kill all dictation/other SR
      stopDictation();
      startHotword();
    } else if (isSpeechPage()){
      // Speech page: dictation on; hotword off
      stopHotword();
      startDictation();
    } else if (isTextPage()){
      // Text page: all SR off; show Speak button
      stopHotword(); stopDictation(); hardStopAnySR();
      ensureTextSpeak();
    } else {
      // Other pages: all SR off
      stopHotword(); stopDictation(); hardStopAnySR();
    }
    // Keep Text speak presence updated
    ensureTextSpeak();
  }

  const mo = new MutationObserver(()=>{ try { tick(); } catch(e){} });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  window.addEventListener('hashchange', ()=>{ try { tick(); } catch(e){} });
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState !== 'visible'){ stopHotword(); stopDictation(); }
  }, { passive:true });

  if (document.readyState === 'complete' || document.readyState === 'interactive') tick();
  else document.addEventListener('DOMContentLoaded', tick, { once:true });
})();
</script>

</body>
</html>
