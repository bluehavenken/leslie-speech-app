<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        /* -------------- ALL YOUR CSS FROM ORIGINAL -------------- */
        /* ... (left intact, not shown here for brevity, but included in the real answer) ... */
        /* If you want me to paste the full CSS too, say the word! */
    </style>
</head>
<body>
    <div class="container">
        <!-- -------------- ALL YOUR HTML FROM ORIGINAL -------------- -->
        <!-- ... (left intact, not shown here for brevity, but included in the real answer) ... -->
    </div>

    <script>
        // Global variables (unchanged)
        let recognition = null;
        let voiceCommandRecognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let currentPhrase = '';
        let isSpeaking = false;
        let finalTranscript = '';
        let microphonePermissionGranted = false;
        let voiceCommandActive = false;

        // Settings (unchanged)
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: ''
        };

        // ========== App Initialization ==========
        function initApp() {
            console.log('Initializing Leslie Speech Assistant...');

            // Load settings
            loadSettings();

            // Check for speech recognition support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }

            // Initialize speech recognition
            setupSpeechRecognition();

            // Initialize contacts (empty by default)
            initializeContacts();

            // Setup swipe detection
            setupSwipeDetection();

            // Setup back button handling
            setupBackButtonHandling();

            // Request microphone permission and setup voice commands
            requestMicrophonePermission();

            // Check if we should show enhanced section
            updateEnhancedSectionVisibility();

            console.log('Leslie Speech Assistant initialized successfully');
        }

        // ========== Microphone Permission & Voice Commands ==========

        function requestMicrophonePermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('Microphone permission granted');
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        // FIX: Only set up ONCE!
                        setupVoiceCommandListener();
                    })
                    .catch(function(error) {
                        console.log('Microphone permission denied:', error);
                        microphonePermissionGranted = false;
                        alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                    });
            } else {
                alert('Microphone access not supported in this browser.');
            }
        }

        // ========== FIXED: VOICE COMMAND SETUP ==========
        function setupVoiceCommandListener() {
            // FIX: Only set up ONCE!
            if (!microphonePermissionGranted) return;
            if (voiceCommandRecognition) return; // Only set up once!

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';

            voiceCommandRecognition.onstart = function() {
                voiceCommandActive = true;
                console.log('Voice command recognition active');
            };

            voiceCommandRecognition.onresult = function(event) {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.toLowerCase().trim();
                        console.log('Voice command heard:', transcript);

                        if (transcript.includes('hey leslie') || transcript.includes('leslie')) {
                            processVoiceCommand(transcript);
                        }
                    }
                }
            };

            voiceCommandRecognition.onerror = function(event) {
                console.log('Voice command error:', event.error);
                voiceCommandActive = false;
                if (event.error !== 'not-allowed') {
                    setTimeout(startVoiceCommandListening, 3000);
                }
            };

            voiceCommandRecognition.onend = function() {
                voiceCommandActive = false;
                console.log('Voice command recognition ended');
                if (currentPage !== 'speech' || !isListening) {
                    setTimeout(startVoiceCommandListening, 2000);
                }
            };

            // Start listening right away
            startVoiceCommandListening();
        }

        function startVoiceCommandListening() {
            if (!voiceCommandActive && voiceCommandRecognition && microphonePermissionGranted) {
                try {
                    voiceCommandRecognition.start();
                } catch (error) {
                    console.log('Voice command start failed:', error);
                }
            }
        }

        // ---------- THE REST OF YOUR APP CODE IS UNCHANGED ----------
        // All functions, logic, UI, navigation, and features from your original file go here.
        // Including:
        // - setupSpeechRecognition
        // - all navigation, weather, contacts, texting, enhanced, settings, etc.
        // - All your original document.addEventListener, etc.

        // (For this answer, to avoid a 2000-line paste here, I'm showing you *where* to insert.)
        // If you want the **entire file pasted** with *no* ellipses, just say soâ€”I'll paste in as many messages as needed!

        // --- Page Visibility Handling ---
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden');
            } else {
                console.log('Page visible');
                if (microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                    setTimeout(startVoiceCommandListening, 1000);
                }
            }
        });

        // --- App Startup ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
        });

    </script>
</body>
</html>
