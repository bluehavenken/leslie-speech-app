<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover {
            background-color: #f0f0f0;
        }
        .page {
            display: none;
            width: 100%;
        }
        .page.active {
            display: block;
        }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active {
            transform: translateY(0);
        }
        .btn-talking {
            background-color: #0099cc;
        }
        .btn-texting {
            background-color: #9933cc;
        }
        .btn-phone {
            background-color: #669900;
        }
        .btn-commands {
            background-color: #ff8800;
        }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .header-speech {
            background-color: #0099cc;
        }
        .header-phone {
            background-color: #669900;
        }
        .header-commands {
            background-color: #ff8800;
        }
        .header-text {
            background-color: #9933cc;
        }
        .header-settings {
            background-color: #0099cc;
        }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .current-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show {
            display: block;
        }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title {
            font-size: 14px;
            font-weight: bold;
            color: #6f42c1;
        }
        .cost-info {
            font-size: 12px;
            color: #666;
        }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen {
            background-color: #0099cc;
        }
        .btn-stop {
            background-color: #cc0000;
        }
        .btn-enhanced {
            background-color: #6f42c1;
        }
        .btn-send {
            background-color: #669900;
        }
        .btn-keyboard {
            background-color: #99cc00;
        }
        .btn-clear {
            background-color: #ffaa00;
        }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .btn-disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
        }
        /* Text Input Styles */
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 300px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 8px;
            float: right;
            position: relative;
            top: 3px; /* moved down 3px as requested */
            z-index: 10;
        }
        .speak-phrase-btn:hover {
            background: #7a2a99;
        }
        .speak-phrase-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            height: 300px;
            overflow-y: auto;
            background-color: white;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover {
            background-color: #f0f0f0;
        }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone {
            color: #fff;
        }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
        }
        .phone-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
            background-color: #669900;
        }
        .phone-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .phone-header .close-btn {
            margin-left: auto;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input {
            margin-right: 8px;
            transform: scale(1.5);
        }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .commands-content {
            padding: 16px;
            max-height: 500px;
            overflow-y: auto;
        }
        .commands-text {
            font-size: 14px;
            line-height: 1.5;
            color: #000;
        }
        .api-key-section {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        .weather-display {
            background-color: #f0f8ff;
            border: 2px solid #0099cc;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            text-align: left;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .weather-title {
            font-size: 22px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            text-align: center;
        }
        .weather-content {
            font-size: 18px;
            line-height: 1.6;
        }
        .weather-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 10px 14px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .weather-btn.active {
            background: #006699;
        }
        .hourly-forecast {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }
        .hourly-item {
            background: rgba(255,255,255,0.7);
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }
        .weekly-forecast {
            margin: 8px 0;
        }
        .weekly-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.7);
            padding: 10px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 16px;
        }
        .day-name {
            font-weight: bold;
            width: 100px;
        }
        .day-temps {
            font-weight: bold;
        }
        .day-condition {
            color: #666;
            text-align: right;
            flex-grow: 1;
            margin-left: 8px;
        }
        .swipe-edge {
            position: fixed;
            z-index: 998;
            pointer-events: auto;
        }
        .swipe-bottom {
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 10px;
        }
        .swipe-left {
            left: 0;
            top: 25%;
            bottom: 25%;
            width: 10px;
        }
        .swipe-right {
            right: 0;
            top: 25%;
            bottom: 25%;
            width: 10px;
        }
        .hidden {
            display: none;
        }
        .success-msg {
            background-color: #d4edda;
            color: #155724
;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .error-msg {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            .main-button {
                height: 70px;
                font-size: 18px;
            }
            .control-btn {
                height: 60px;
                font-size: 16px;
                width: 250px;
            }
            .btn-home {
                height: 60px;
                font-size: 16px;
                width: 250px;
            }
            .icon-btn {
                width: 60px;
                height: 60px;
            }
            .contact-item {
                font-size: 13px;
            }
            .weather-btn {
                font-size: 12px;
                padding: 8px 10px;
            }
            .weather-content {
                font-size: 16px;
            }
            .hourly-item, .weekly-item {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Swipe Edge Detection Areas -->
        <div class="swipe-edge swipe-bottom" id="swipeBottom"></div>
        <div class="swipe-edge swipe-left" id="swipeLeft"></div>
        <div class="swipe-edge swipe-right" id="swipeRight"></div>

        <!-- Weather Display (Hidden by default) -->
        <div class="weather-display hidden" id="weatherDisplay">
            <div class="weather-title" id="weatherTitle">Current Weather</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" onclick="showPage('settings')">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" onclick="startTalkingFromHome()">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" onclick="showPage('textInput')">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" onclick="showPage('phone')">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" onclick="showPage('commands')">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Voice commands work best with microphone permission granted<br>
                    • Say "Hey Leslie" followed by commands for voice control<br>
                    • Click START TALKING for continuous speech recognition<br>
                    • Use Enhanced Recognition for better accuracy with unclear speech<br>
                    • Very small swipe areas: bottom center, left/right sides for weather<br>
                    • Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" onclick="navigateBack()">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Current Phrase
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            <div class="current-phrase" id="currentPhrase">
                                Your speech will appear here...
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Enhanced Recognition Section -->
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">🔬 Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton" onclick="startEnhancedRecognition()">
                        🔬 START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton" onclick="toggleListening()">
                        START TALKING
                    </button>
                    <button class="icon-btn btn-clear" onclick="clearSpeechText()" title="Clear Text">
                        🗑️
                    </button>
                </div>
            </div>
        </div>
        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="phone-header">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" onclick="showPage('home')">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                    Click "Load Your Contacts" to access your real device contacts.
                </div>
            </div>
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px;">
                    📱 Tap contact to call directly:
                </div>
                <div class="contacts-list" id="contactsList">
                    <div style="padding: 16px; text-align: center; color: #666;">
                        <p><strong>📱 Access Your Real Contacts</strong></p>
                        <p>Your contacts are accessed locally on your device only.</p>
                        <p>No contact data is sent to servers or made public.</p>
                        <br>
                        <p><strong>📱 On PHONE/TABLET:</strong></p>
                        <p>1. Click the button below</p>
                        <p>2. Look for "Select All" or "All" button in the picker</p>
                        <p>3. If no "Select All", manually tap contacts you want</p>
                        <p>4. Tap "Done" or "Select"</p>
                        <br>
                        <p><strong>💻 On COMPUTER:</strong></p>
                        <p>Press Ctrl+A (PC) or Cmd+A (Mac) to select all</p>
                        <br>
                        <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            📞 Load Your Contacts
                        </button>
                    </div>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" onclick="showPage('home')">
                    🏠 HOME
                </button>
            </div>
        </div>
        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" onclick="navigateBack()">&times;</button>
            </div>
            <div class="commands-content">
                <div class="commands-text" id="leslieCommandsText">
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>🎤 IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <strong>• "Hey Leslie, what time is it?"</strong><br>
                    - Tells you the current time<br><br>
                    <strong>• "Hey Leslie, what's the date?"</strong><br>
                    - Tells you today's date<br><br>
                    <strong>• "Hey Leslie, start talking"</strong><br>
                    - Goes to speech recognition page and starts continuous listening<br><br>
                    <strong>• "Hey Leslie, speak this"</strong><br>
                    - Repeats back what you just said<br><br>
                    <strong>• "Hey Leslie, clear text"</strong><br>
                    - Clears the speech recognition text<br><br>
                    <strong>• "Hey Leslie, enhanced mode"</strong><br>
                    - Switches to enhanced recognition for better accuracy<br><br>
                    <strong>• "Hey Leslie, weather"</strong><br>
                    - Shows current weather information<br><br>
                    <strong>• "Hey Leslie, close"</strong><br>
                    - Closes weather displays<br><br>
                    <strong>• "Hey Leslie, go home"</strong><br>
                    - Returns to the main menu<br><br>
                    <strong>• "Hey Leslie, help"</strong><br>
                    - Shows this commands list<br><br>
                    <strong>Recognition Modes:</strong><br>
                    • <strong>Standard Mode:</strong> Free, continuous, real-time recognition<br>
                    • <strong>Enhanced Mode:</strong> Better for unclear speech, whispers, accents (~1¢/minute)<br><br>
                    <strong>Weather Gestures (tiny swipe areas):</strong><br>
                    • <strong>Bottom center edge:</strong> Current weather<br>
                    • <strong>Left middle edge:</strong> 24-hour forecast<br>
                    • <strong>Right middle edge:</strong> 7-day forecast<br><br>
                    <strong>Tips for better voice recognition:</strong><br>
                    • Allow microphone permission when prompted<br>
                    • Voice commands work even when not on speech page<br>
                    • Speech stays active until you press STOP LISTENING<br>
                    • Complete phrases are spoken back to you<br>
                    • Text stays displayed after being spoken<br>
                    • Try Enhanced Mode if standard recognition struggles
                </div>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" onclick="navigateBack()">&times;</button>
                </div>
                <div class="text-input-content">
                    <!-- Speak button moved down 3px (CSS fix) -->
                    <div style="margin-bottom: 8px; text-align: right;">
                        <button class="speak-phrase-btn" onclick="speakTextInput()" id="speakTextBtn">
                            🔊 SPEAK TEXT
                        </button>
                    </div>
                    <textarea class="text-input large-text-input" id="largeTextInputField"
                              placeholder="Type your message here..." oninput="updateTextSpeakButton()"></textarea>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" onclick="showPage('home')">
                            🏠 HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" onclick="navigateBack()">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <!-- OpenAI API Key Section -->
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Enhanced Recognition)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable Enhanced Recognition mode.
                        Get yours at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput"
                           placeholder="sk-..." onchange="saveApiKey(this.value)">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        Your API key is stored locally and never shared
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div class="switch">
                        <input type="checkbox" id="autoEnhancedSwitch" onchange="updateAutoEnhanced(this.checked)">
                        <label for="autoEnhancedSwitch">Auto-suggest Enhanced Recognition when needed</label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0"
                           oninput="updateSpeechSpeed(this.value)">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Voice Command Speech</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked
                               onchange="updateVoiceCommandSetting(this.checked)">
                        <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
                </div>
            </div>
            <button class="back-btn" onclick="showPage('home')">
                ← Back
            </button>
        </div>
    </div>
    <script>
        // --- GLOBALS ---
        let recognition = null;
        let voiceCommandRecognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let currentPhrase = '';
        let isSpeaking = false;
        let finalTranscript = '';
        let microphonePermissionGranted = false;
        let voiceCommandActive = false;

        // Settings
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: ''
        };

        // Stores up to 20 spoken phrases for speech history display
        let phraseHistory = [];

        // ---- INIT APP ----
        function initApp() {
            loadSettings();
            // Check speech recognition support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            setupSpeechRecognition();
            initializeContacts();
            setupSwipeDetection();
            setupBackButtonHandling();
            requestMicrophonePermission();
            updateEnhancedSectionVisibility();
        }

        // --- MICROPHONE PERMISSION ---
        function requestMicrophonePermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        setTimeout(setupVoiceCommandListener, 500);
                    })
                    .catch(function(error) {
                        microphonePermissionGranted = false;
                        alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                    });
            } else {
                alert('Microphone access not supported in this browser.');
            }
        }

        // --- VOICE COMMAND LISTENER ---
        function setupVoiceCommandListener() {
            if (!microphonePermissionGranted) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            if (voiceCommandRecognition) {
                try { voiceCommandRecognition.abort(); } catch (e) {}
                voiceCommandRecognition = null;
            }
            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';

            voiceCommandRecognition.onstart = function() {
                voiceCommandActive = true;
            };
            voiceCommandRecognition.onresult = function(event) {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.toLowerCase().trim();
                        if (transcript.includes('hey leslie') || transcript.includes('leslie')) {
                            processVoiceCommand(transcript);
                        }
                    }
                }
            };
            voiceCommandRecognition.onerror = function(event) {
                voiceCommandActive = false;
                if (event.error !== 'not-allowed') {
                    setTimeout(startVoiceCommandListening, 3000);
                }
            };
            voiceCommandRecognition.onend = function() {
                voiceCommandActive = false;
                if (currentPage !== 'speech' || !isListening) {
                    setTimeout(startVoiceCommandListening, 2000);
                }
            };

            function startVoiceCommandListening() {
                if ((currentPage !== 'speech' || !isListening) && microphonePermissionGranted && !voiceCommandActive) {
                    try { voiceCommandRecognition.start(); } catch (error) {}
                }
            }
            startVoiceCommandListening();
            setInterval(() => {
                if (!voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                    startVoiceCommandListening();
                }
            }, 30000);
        }
        // --- WEATHER ---
        function showCurrentWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            const currentTime = new Date();
            const temperature = Math.floor(Math.random() * 30) + 60;
            const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Clear'][Math.floor(Math.random() * 5)];
            const humidity = Math.floor(Math.random() * 40) + 40;
            const windSpeed = Math.floor(Math.random() * 15) + 5;
            weatherTitle.textContent = 'Current Weather';
            weatherContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 32px; font-weight: bold; color: #0099cc;">${temperature}°F</div>
                    <div style="font-size: 20px; font-weight: bold; margin: 8px 0;">${conditions}</div>
                </div>
                <div style="line-height: 1.8;">
                    <strong>Humidity:</strong> ${humidity}%<br>
                    <strong>Wind:</strong> ${windSpeed} mph<br>
                    <strong>Time:</strong> ${currentTime.toLocaleTimeString()}<br>
                </div>
            `;
            weatherDisplay.classList.remove('hidden');
        }
        function showHourlyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            weatherTitle.textContent = '24-Hour Forecast';
            let hourlyData = '<div class="hourly-forecast">';
            const now = new Date();
            for (let i = 0; i < 24; i += 3) {
                const futureTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
                const hour = futureTime.getHours();
                const temp = Math.floor(Math.random() * 20) + 65;
                const conditions = ['Sunny', 'Cloudy', 'Rain', 'Clear'][Math.floor(Math.random() * 4)];
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hourlyData += `
                    <div class="hourly-item">
                        <strong>${displayHour}:00 ${ampm}</strong><br>
                        ${temp}°F ${conditions}
                    </div>
                `;
            }
            hourlyData += '</div>';
            weatherContent.innerHTML = hourlyData;
            weatherDisplay.classList.remove('hidden');
        }
        function showWeeklyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            weatherTitle.textContent = '7-Day Forecast';
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let weeklyData = '<div class="weekly-forecast">';
            for (let i = 0; i < 7; i++) {
                const dayIndex = (new Date().getDay() + i) % 7;
                const high = Math.floor(Math.random() * 20) + 75;
                const low = high - Math.floor(Math.random() * 15) - 10;
                const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Rain', 'Storms'][Math.floor(Math.random() * 5)];
                weeklyData += `
                    <div class="weekly-item">
                        <div class="day-name">${days[dayIndex]}</div>
                        <div class="day-temps">${high}°/${low}°</div>
                        <div class="day-condition">${conditions}</div>
                    </div>
                `;
            }
            weeklyData += '</div>';
            weatherContent.innerHTML = weeklyData;
            weatherDisplay.classList.remove('hidden');
        }
        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            weatherDisplay.classList.add('hidden');
        }
        // --- SWIPE DETECTION ---
        function setupSwipeDetection() {
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            swipeBottom.addEventListener('touchstart', function(e) {
                touchStartY = e.changedTouches[0].screenY;
                e.stopPropagation();
            });
            swipeBottom.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].screenY;
                const swipeDistance = touchStartY - touchEndY;
                if (swipeDistance > 30) showCurrentWeather();
                e.stopPropagation();
            });
            swipeLeft.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                e.stopPropagation();
            });
            swipeLeft.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const swipeDistance = touchEndX - touchStartX;
                if (swipeDistance > 30) showHourlyWeather();
                e.stopPropagation();
            });
            swipeRight.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                e.stopPropagation();
            });
            swipeRight.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const swipeDistance = touchStartX - touchEndX;
                if (swipeDistance > 30) showWeeklyWeather();
                e.stopPropagation();
            });
        }
        // --- SETTINGS ---
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) settings = {...settings, ...JSON.parse(savedSettings)};
            } catch (error) {}
            updateSettingsUI();
        }
        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {}
        }
        function updateSettingsUI() {
            const speedSlider = document.getElementById('speechSpeedSlider');
            const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
            const enhancedSwitch = document.getElementById('autoEnhancedSwitch');
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (speedSlider) speedSlider.value = settings.speechSpeed;
            if (voiceSwitch) voiceSwitch.checked = settings.speakVoiceCommands;
            if (enhancedSwitch) enhancedSwitch.checked = settings.autoEnhanced;
            if (apiKeyInput) apiKeyInput.value = settings.apiKey;
            updateSpeechSpeed(settings.speechSpeed);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateAutoEnhanced(settings.autoEnhanced);
        }
        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            if (label) {
                if (value == 1.0) label.textContent = 'Normal (1.0x)';
                else label.textContent = `${value}x`;
            }
            saveSettings();
        }
        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            if (label) label.textContent = `Voice Command Speech: ${checked ? 'ON' : 'OFF'}`;
            saveSettings();
        }
        function updateAutoEnhanced(checked) {
            settings.autoEnhanced = checked;
            saveSettings();
        }
        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }
        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) enhancedSection.classList.add('show');
            else if (enhancedSection) enhancedSection.classList.remove('show');
        }
        // --- ENHANCED RECOGNITION PLACEHOLDER ---
        function startEnhancedRecognition() {
            if (!settings.apiKey) {
                alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
                showPage('settings');
                return;
            }
            alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
        }
        function showEnhancedSuggestion() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
                const enhancedStatus = document.getElementById('enhancedStatus');
                if (enhancedStatus) {
                    enhancedStatus.textContent = 'Low confidence detected. Try Enhanced Recognition for better accuracy.';
                    enhancedStatus.style.color = '#ff6600';
                    enhancedStatus.style.fontWeight = 'bold';
                }
            }
        }
        // --- DOM READY & VISIBILITY ---
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // (Optional: Stop listeners if needed)
            } else {
                if (microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                    setTimeout(setupVoiceCommandListener, 1000);
                }
            }
        });
    </script>
</body>
</html>
