<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover {
            background-color: #f0f0f0;
        }
        .page {
            display: none;
            width: 100%;
        }
        .page.active {
            display: block;
        }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active {
            transform: translateY(0);
        }
        .btn-talking {
            background-color: #0099cc;
        }
        .btn-texting {
            background-color: #9933cc;
        }
        .btn-phone {
            background-color: #669900;
        }
        .btn-commands {
            background-color: #ff8800;
        }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .header-speech {
            background-color: #0099cc;
        }
        .header-phone {
            background-color: #669900;
        }
        .header-commands {
            background-color: #ff8800;
        }
        .header-text {
            background-color: #9933cc;
        }
        .header-settings {
            background-color: #0099cc;
        }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .current-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show {
            display: block;
        }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title {
            font-size: 14px;
            font-weight: bold;
            color: #6f42c1;
        }
        .cost-info {
            font-size: 12px;
            color: #666;
        }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen {
            background-color: #0099cc;
        }
        .btn-stop {
            background-color: #cc0000;
        }
        .btn-enhanced {
            background-color: #6f42c1;
        }
        .btn-send {
            background-color: #669900;
        }
        .btn-keyboard {
            background-color: #99cc00;
        }
        .btn-clear {
            background-color: #ffaa00;
        }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .btn-disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
        }
        /* Text Input Styles */
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 300px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 8px;
            float: right;
            position: relative;
            top: 3px; /* FIXED: Move button down 3px */
            z-index: 10;
        }
        .speak-phrase-btn:hover {
            background: #7a2a99;
        }
        .speak-phrase-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* [the rest of your styles remain unchanged] */
        /* ... (omitted here for space, you already have them) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- All your original HTML goes here, unchanged -->
        <!-- ... -->
        <!-- (YOUR ENTIRE MARKUP REMAINS INTACT) -->
    </div>
    <script>
        // --- GLOBALS ---
        let recognition = null;
        let voiceCommandRecognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let currentPhrase = '';
        let isSpeaking = false;
        let finalTranscript = '';
        let microphonePermissionGranted = false;
        let voiceCommandActive = false;

        // Settings
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: ''
        };

        // Stores up to 20 spoken phrases for speech history display
        let phraseHistory = [];

        // ---- INIT APP ----
        function initApp() {
            loadSettings();
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            setupSpeechRecognition();
            initializeContacts();
            setupSwipeDetection();
            setupBackButtonHandling();
            requestMicrophonePermission();
            updateEnhancedSectionVisibility();
        }

        // --- MICROPHONE PERMISSION (unchanged) ---
        function requestMicrophonePermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        setTimeout(setupVoiceCommandListener, 500);
                    })
                    .catch(function(error) {
                        microphonePermissionGranted = false;
                        alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                    });
            } else {
                alert('Microphone access not supported in this browser.');
            }
        }

        // --- VOICE COMMAND LISTENER (unchanged) ---
        // ... All your original code ...

        function speak(text) {
            if (settings.speakVoiceCommands && text.trim()) {
                speechSynth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynth.speak(utterance);
            }
        }

        // --- SPEECH RECOGNITION SETUP (FIXED) ---
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                updateListenButton();
                updateStatus('ðŸŽ¤ Listening... Say something!');
                if (voiceCommandRecognition && voiceCommandActive) {
                    try { voiceCommandRecognition.stop(); } catch (e) {}
                    voiceCommandActive = false;
                }
            };
            recognition.onend = function() {
                if (isListening && currentPage === 'speech') {
                    setTimeout(() => {
                        if (isListening && currentPage === 'speech') {
                            try { recognition.start(); } catch (error) {
                                isListening = false;
                                updateListenButton();
                                updateStatus('Speech recognition stopped. Click START TALKING to begin again.');
                                setTimeout(() => {
                                    if (!voiceCommandActive) setupVoiceCommandListener();
                                }, 1000);
                            }
                        }
                    }, 500);
                } else {
                    updateStatus('Ready to listen - Click "START TALKING" below');
                    updateListenButton();
                    setTimeout(() => {
                        if (!voiceCommandActive) setupVoiceCommandListener();
                    }, 1000);
                }
            };
            recognition.onerror = function(event) {
                if (event.error === 'no-speech') {
                    updateStatus('No speech detected. Keep talking or click START TALKING again.');
                } else if (event.error === 'audio-capture') {
                    updateStatus('Microphone error. Please check permissions and try again.');
                } else if (event.error === 'not-allowed') {
                    updateStatus('Microphone permission denied. Please allow microphone access.');
                    isListening = false;
                    updateListenButton();
                } else if (event.error === 'network') {
                    updateStatus('Network error. Please check your connection.');
                } else {
                    updateStatus(`Recognition error (${event.error}). Try again or use Enhanced Recognition.`);
                    if (settings.autoEnhanced) {
                        showEnhancedSuggestion();
                    }
                }
            };

            // --- FIX: Only final phrases are spoken, shown once, then cleared after speaking ---
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let gotFinal = false;
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript.trim();
                    if (event.results[i].isFinal && transcript) {
                        // Only say each phrase ONCE, then clear after speaking
                        phraseHistory.push(transcript);
                        if (phraseHistory.length > 20) phraseHistory.shift();
                        updateCurrentPhraseDisplay();
                        finalTranscript = transcript;
                        updateStatus('âœ… Heard: ' + finalTranscript);
                        if (!isSpeaking) {
                            isSpeaking = true;
                            speechSynth.cancel();
                            const utterance = new SpeechSynthesisUtterance(finalTranscript);
                            utterance.rate = settings.speechSpeed;
                            utterance.pitch = 1;
                            utterance.volume = 0.8;
                            utterance.onend = () => {
                                isSpeaking = false;
                                setTimeout(() => {
                                    clearSpeechText();
                                }, 300); // clear after speaking
                            };
                            speechSynth.speak(utterance);
                        }
                        gotFinal = true;
                    } else if (!event.results[i].isFinal && transcript) {
                        interimTranscript = transcript;
                    }
                }
                // Show interim if no new final
                if (!gotFinal && interimTranscript) {
                    updateCurrentPhraseDisplay(interimTranscript, true);
                    updateStatus('ðŸ”„ Listening: ' + interimTranscript);
                }
            };
        }

        // Show phrase history, with interim last if present (unchanged except allows interim again)
        function updateCurrentPhraseDisplay(interimText = '', isInterim = false) {
            const currentPhraseEl = document.getElementById('currentPhrase');
            let html = '';
            phraseHistory.forEach(phrase => {
                html += `<div class="current-phrase">${phrase}</div>`;
            });
            if (isInterim && interimText) {
                html += `<div class="current-phrase" style="background:#fff8e1; color:#999;">${interimText}</div>`;
            }
            if (html) {
                currentPhraseEl.innerHTML = html;
            } else {
                currentPhraseEl.textContent = 'Your speech will appear here...';
            }
        }

        function clearSpeechText() {
            currentPhrase = '';
            finalTranscript = '';
            phraseHistory = [];
            updateCurrentPhraseDisplay();
            updateStatus('Text cleared - Ready to listen');
        }

        // --- CONTACTS PAGE FIX ---
        function initializeContacts() {
            contacts = [];
            filteredContacts = [];
            loadRealContacts();
        }

        async function loadRealContacts() {
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = {multiple: true};
                    const contactList = await navigator.contacts.select(props, opts);
                    if (contactList.length === 0) {
                        displayNoContacts();
                        return;
                    }
                    contacts = contact
                    contacts = contactList.map(contact => ({
                        name: contact.name && contact.name[0] ? contact.name[0] : 'Unknown',
                        phone: contact.tel && contact.tel[0] ? contact.tel[0] : 'No phone'
                    }));
                    contacts.sort((a, b) => a.name.localeCompare(b.name));
                    filteredContacts = [...contacts];
                    displayContacts();
                } else {
                    displayNoContacts();
                }
            } catch (error) {
                displayNoContacts(); // FRIENDLY: No raw error message to user!
            }
        }

        function displayNoContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #0099cc;">
                    <p><strong>ðŸ“± Access Your Real Contacts</strong></p>
                    <p>Your contacts are accessed locally on your device only.</p>
                    <p>No contact data is sent to servers or made public.</p>
                    <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        ðŸ“ž Load Your Contacts
                    </button>
                </div>
            `;
        }

        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            if (filteredContacts.length === 0) {
                displayNoContacts();
                return;
            }
            const countDiv = document.createElement('div');
            countDiv.style.padding = '8px';
            countDiv.style.textAlign = 'center';
            countDiv.style.fontWeight = 'bold';
            countDiv.style.color = '#669900';
            countDiv.textContent = `${filteredContacts.length} contacts loaded`;
            contactsList.appendChild(countDiv);
            const contactsToShow = filteredContacts.slice(0, 200);
            contactsToShow.forEach((contact, index) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = `
                    <div class="contact-name">${contact.name}</div>
                    <div class="contact-phone">${contact.phone}</div>
                `;
                contactEl.onclick = () => callContact(contact);
                contactsList.appendChild(contactEl);
            });
            if (filteredContacts.length > 200) {
                const moreDiv = document.createElement('div');
                moreDiv.style.padding = '16px';
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#666';
                moreDiv.textContent = `... and ${filteredContacts.length - 200} more contacts. Use search to find specific contacts.`;
                contactsList.appendChild(moreDiv);
            }
        }

        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = [...contacts];
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    const nameLower = contact.name.toLowerCase();
                    const phoneNumbers = contact.phone.replace(/[^0-9]/g, '');
                    const searchNumbers = searchTerm.replace(/[^0-9]/g, '');
                    return nameLower.includes(searchLower) ||
                        nameLower.startsWith(searchLower) ||
                        phoneNumbers.includes(searchNumbers) ||
                        contact.name.toLowerCase().split(' ').some(word => word.startsWith(searchLower));
                });
            }
            displayContacts();
        }

        function callContact(contact) {
            window.location.href = `tel:${contact.phone.replace(/[^0-9]/g, '')}`;
        }

        // --- PAGE NAVIGATION & BUTTONS ---
        function showPage(pageId, addToHistory = true) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                if (addToHistory) {
                    pageHistory.push(pageId);
                    history.pushState({page: pageId}, '', '');
                }
                // Stop listening if leaving speech page
                if (pageId !== 'speech' && isListening) stopListening();
                // Auto-focus text input and show keyboard
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textInput = document.getElementById('largeTextInputField');
                        if (textInput) textInput.focus();
                    }, 100);
                }
            }
        }
        function startTalkingFromHome() {
            showPage('speech');
            setTimeout(() => { toggleListening(); }, 500);
        }
        function toggleListening() {
            if (isListening) stopListening();
            else startListening();
        }
        function startListening() {
            if (recognition && !isListening) {
                try { recognition.start(); } catch (error) {
                    updateStatus('Error starting recognition. Please try again.');
                }
            }
        }
        function stopListening() {
            if (recognition && isListening) {
                isListening = false;
                recognition.stop();
                updateStatus('Stopped listening');
                updateListenButton();
            }
        }
        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }
        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = message;
        }

        // --- TEXT INPUT ---
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                speak(text);
            }
        }
        function updateTextSpeakButton() {
            const textInput = document.getElementById('largeTextInputField');
            const speakBtn = document.getElementById('speakTextBtn');
            if (speakBtn && textInput) {
                speakBtn.disabled = !textInput.value.trim();
                speakBtn.style.opacity = textInput.value.trim() ? '1' : '0.5';
            }
        }

        // --- WEATHER (unchanged, all your weather code remains) ---
        // ... showCurrentWeather, showHourlyWeather, showWeeklyWeather, hideWeather ...

        // --- SWIPE DETECTION ---
        function setupSwipeDetection() {
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            swipeBottom.addEventListener('touchstart', function(e) {
                touchStartY = e.changedTouches[0].screenY;
                e.stopPropagation();
            });
            swipeBottom.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].screenY;
                const swipeDistance = touchStartY - touchEndY;
                if (swipeDistance > 30) showCurrentWeather();
                e.stopPropagation();
            });
            swipeLeft.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                e.stopPropagation();
            });
            swipeLeft.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const swipeDistance = touchEndX - touchStartX;
                if (swipeDistance > 30) showHourlyWeather();
                e.stopPropagation();
            });
            swipeRight.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                e.stopPropagation();
            });
            swipeRight.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const swipeDistance = touchStartX - touchEndX;
                if (swipeDistance > 30) showWeeklyWeather();
                e.stopPropagation();
            });
        }

        // --- SETTINGS (unchanged) ---
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) settings = {...settings, ...JSON.parse(savedSettings)};
            } catch (error) {}
            updateSettingsUI();
        }
        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {}
        }
        function updateSettingsUI() {
            const speedSlider = document.getElementById('speechSpeedSlider');
            const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
            const enhancedSwitch = document.getElementById('autoEnhancedSwitch');
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (speedSlider) speedSlider.value = settings.speechSpeed;
            if (voiceSwitch) voiceSwitch.checked = settings.speakVoiceCommands;
            if (enhancedSwitch) enhancedSwitch.checked = settings.autoEnhanced;
            if (apiKeyInput) apiKeyInput.value = settings.apiKey;
            updateSpeechSpeed(settings.speechSpeed);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateAutoEnhanced(settings.autoEnhanced);
        }
        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            if (label) {
                if (value == 1.0) label.textContent = 'Normal (1.0x)';
                else label.textContent = `${value}x`;
            }
            saveSettings();
        }
        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            if (label) label.textContent = `Voice Command Speech: ${checked ? 'ON' : 'OFF'}`;
            saveSettings();
        }
        function updateAutoEnhanced(checked) {
            settings.autoEnhanced = checked;
            saveSettings();
        }
        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }
        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) enhancedSection.classList.add('show');
            else if (enhancedSection) enhancedSection.classList.remove('show');
        }
        // --- ENHANCED RECOGNITION PLACEHOLDER ---
        function startEnhancedRecognition() {
            if (!settings.apiKey) {
                alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
                showPage('settings');
                return;
            }
            alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
        }
        function showEnhancedSuggestion() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
                const enhancedStatus = document.getElementById('enhancedStatus');
                if (enhancedStatus) {
                    enhancedStatus.textContent = 'Low confidence detected. Try Enhanced Recognition for better accuracy.';
                    enhancedStatus.style.color = '#ff6600';
                    enhancedStatus.style.fontWeight = 'bold';
                }
            }
        }

        // --- DOM READY & VISIBILITY ---
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // (Optional: Stop listeners if needed)
            } else {
                if (microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                    setTimeout(setupVoiceCommandListener, 1000);
                }
            }
        });

        // --- BACK BUTTON HANDLING (unchanged) ---
        function setupBackButtonHandling() {
            window.addEventListener('popstate', function(event) {
                event.preventDefault();
                navigateBack();
            });
            history.pushState({page: 'home'}, '', '');
        }
        function navigateBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPage = pageHistory[pageHistory.length - 1];
                showPage(previousPage, false);
            } else {
                showPage('home', false);
            }
        }
    </script>
</body>
</html>
