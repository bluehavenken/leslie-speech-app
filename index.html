<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .current-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .enhanced-section {
            background-color: #f8f9fa;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }
        .enhanced-section.show { display: block; }
        .enhanced-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .enhanced-title { font-size: 14px; font-weight: bold; color: #6f42c1; }
        .cost-info { font-size: 12px; color: #666; }
        .enhanced-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            min-height: 20px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-enhanced { background-color: #6f42c1; }
        .btn-send { background-color: #669900; }
        .btn-keyboard { background-color: #99cc00; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .btn-disabled { background-color: #ccc !important; cursor: not-allowed !important; }
        /* --- Text Input Styles --- */
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            height: 320px;
            overflow-y: auto;
            background-color: white;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
        }
        .phone-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
            background-color: #669900;
        }
        .phone-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .phone-header .close-btn { margin-left: auto; }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .weather-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #0099cc;
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .weather-display.hidden { display: none; }
        .weather-title {
            font-size: 20px;
            font-weight: bold;
            color: #0099cc;
            text-align: center;
            margin-bottom: 16px;
        }
        .weather-content {
            margin-bottom: 16px;
            line-height: 1.6;
        }
        .weather-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .weather-btn {
            padding: 8px 16px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .weather-btn:hover { background: #0077aa; }
        .hourly-forecast, .weekly-forecast {
            display: grid;
            gap: 12px;
        }
        .hourly-item, .weekly-item {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .weekly-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        .day-name { font-weight: bold; }
        .day-temps { color: #0099cc; font-weight: bold; }
        .day-condition { color: #666; }
        /* Swipe edge detection areas */
        .swipe-edge {
            position: fixed;
            z-index: 999;
        }
        .swipe-bottom {
            bottom: 0;
            left: 45%;
            width: 10%;
            height: 20px;
        }
        .swipe-left {
            left: 0;
            top: 45%;
            width: 20px;
            height: 10%;
        }
        .swipe-right {
            right: 0;
            top: 45%;
            width: 20px;
            height: 10%;
        }
        .api-key-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 8px;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
            .weather-display { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Swipe Edge Detection Areas -->
        <div class="swipe-edge swipe-bottom" id="swipeBottom"></div>
        <div class="swipe-edge swipe-left" id="swipeLeft"></div>
        <div class="swipe-edge swipe-right" id="swipeRight"></div>

        <!-- Weather Display (Hidden by default) -->
        <div class="weather-display hidden" id="weatherDisplay">
            <div class="weather-title" id="weatherTitle">Current Weather</div>
            <div class="weather-content" id="weatherContent">Loading weather data...</div>
            <div class="weather-controls">
                <button class="weather-btn" onclick="showCurrentWeather()">Current</button>
                <button class="weather-btn" onclick="showHourlyWeather()">24 Hours</button>
                <button class="weather-btn" onclick="showWeeklyWeather()">7 Days</button>
                <button class="weather-btn" onclick="hideWeather()">Close</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Voice commands work best with microphone permission granted<br>
                    • Say "Hey Leslie" followed by commands for voice control<br>
                    • Click START TALKING for continuous speech recognition<br>
                    • Use Enhanced Recognition for better accuracy with unclear speech<br>
                    • Very small swipe areas: bottom center, left/right sides for weather<br>
                    • Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Current Phrase
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            <div class="current-phrase" id="currentPhrase">
                                Your speech will appear here...
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Enhanced Recognition Section -->
                <div class="enhanced-section" id="enhancedSection">
                    <div class="enhanced-header">
                        <div class="enhanced-title">🔬 Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton">
                        🔬 START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="phone-header">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    📱 Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList">
                    <div style="padding: 20px; text-align: center; color: #669900; border: 2px solid #669900; border-radius: 8px; background-color: #f8f9fa;">
                        <p><strong>📱 Click to Load Your Contacts</strong></p>
                        <p>Your contacts will be displayed right here on this page</p>
                        <br>
                        <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 14px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            📞 Load Your Contacts
                        </button>
                    </div>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">
                    🏠 HOME
                </button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            🔊 SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            🏠 HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text" id="leslieCommandsText">
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>🎤 IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <strong>Navigation Commands:</strong><br>
                    • "Hey Leslie, start talking" - Goes to speech recognition page<br>
                    • "Hey Leslie, start texting" - Goes to text input page<br>
                    • "Hey Leslie, home" - Returns to home page<br>
                    • "Hey Leslie, help" - Shows this commands list<br><br>
                    <strong>Phone Commands:</strong><br>
                    • "Hey Leslie, call John Doe" - Opens phone page and calls contact<br>
                    • "Hey Leslie, call 555-123-4567" - Calls the number directly<br><br>
                    <strong>Weather Commands:</strong><br>
                    • "Hey Leslie, current weather" - Shows today's weather<br>
                    • "Hey Leslie, weather" - Shows today's weather<br>
                    • "Hey Leslie, 7 day forecast" - Shows 7-day forecast<br>
                    • "Hey Leslie, 7 day" - Shows 7-day forecast<br>
                    • "Hey Leslie, hourly" - Shows 24-hour forecast<br>
                    • "Hey Leslie, hourly forecast" - Shows 24-hour forecast<br>
                    • "Hey Leslie, close" - Closes weather displays<br><br>
                    <strong>Recognition Commands:</strong><br>
                    • "Hey Leslie, clear text" - Clears speech recognition text<br>
                    • "Hey Leslie, enhanced mode" - Switches to enhanced recognition<br>
                    • "Hey Leslie, turn off enhanced mode" - Switches to regular recognition<br><br>
                    <strong>Speech Settings Commands:</strong><br>
                    • "Hey Leslie, speak faster" - Increases speech speed<br>
                    • "Hey Leslie, talk slower" - Decreases speech speed<br>
                    • "Hey Leslie, pause more" - Increases pause between words<br>
                    • "Hey Leslie, pause less" - Decreases pause between words<br>
                    • "Hey Leslie, turn off voice command speech" - Disables voice responses<br>
                    • "Hey Leslie, turn on voice command speech" - Enables voice responses<br><br>
                    <strong>Tips for better voice recognition:</strong><br>
                    • Allow microphone permission when prompted<br>
                    • Voice commands work from any page<br>
                    • Speech stays active until you press STOP LISTENING<br>
                    • Complete phrases are spoken back to you<br>
                    • Try Enhanced Mode if standard recognition struggles
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <!-- OpenAI API Key Section -->
                <div class="api-key-section">
                    <div class="settings-title">OpenAI API Key (for Enhanced Recognition)</div>
                    <div class="settings-description">
                        Enter your OpenAI API key to enable Enhanced Recognition mode.
                        Get yours at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
                    </div>
                    <input type="password" class="api-key-input" id="apiKeyInput"
                           placeholder="sk-...">
                    <div style="font-size: 12px; margin-top: 4px; color: #666;">
                        Your API key is stored locally and never shared
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Recognition Mode</div>
                    <div class="settings-description">Choose your preferred speech recognition method</div>
                    <div class="switch">
                        <input type="checkbox" id="autoEnhancedSwitch">
                        <label for="autoEnhancedSwitch">Auto-suggest Enhanced Recognition when needed</label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie repeats your speech back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.5" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to pause between words when speaking</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0" max="2" step="0.5" value="0.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">0.5 seconds</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Enhanced Recognition Mode</div>
                    <div class="settings-description">Use OpenAI Whisper for better accuracy with unclear speech</div>
                    <div class="switch">
                        <input type="checkbox" id="enhancedModeSwitch">
                        <label for="enhancedModeSwitch">Enable Enhanced Mode by default</label>
                    </div>
                    <div class="setting-value" id="enhancedModeLabel">Enhanced Mode: OFF</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Voice Command Speech</div>
                    <div class="settings-description">Whether Leslie should speak responses to voice commands</div>
                    <div class="switch">
                        <input type="checkbox" id="speakVoiceCommandsSwitch" checked>
                        <label for="speakVoiceCommandsSwitch">Enable Voice Command Speech</label>
                    </div>
                    <div class="setting-value" id="speakVoiceCommandsLabel">Voice Command Speech: ON</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ← Back
            </button>
        </div>
    </div>

    <script>
    // --- GLOBALS & DEMO CONTACTS ---
    let recognition = null;
    let voiceCommandRecognition = null;
    let isListening = false;
    let speechSynth = window.speechSynthesis;
    let currentPage = 'home';
    let pageHistory = ['home'];
    let contacts = [];
    let filteredContacts = [];
    let currentPhrase = '';
    let isSpeaking = false;
    let finalTranscript = '';
    let microphonePermissionGranted = false;
    let voiceCommandActive = false;
    let silenceTimer = null;
    let enhancedMode = false;
    let userLocation = null;

    // Settings
    let settings = {
        speechSpeed: 1.0,
        speakVoiceCommands: true,
        autoEnhanced: true,
        apiKey: '',
        pauseBetweenWords: 0.5,
        enhancedMode: false
    };
    let phraseHistory = [];

    // ---- INIT APP ----
    function initApp() {
        loadSettings();
        setupButtonHandlers();
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
            return;
        }
        setupSpeechRecognition();
        initializeContacts();
        setupSwipeDetection();
        setupBackButtonHandling();
        // DO NOT request microphone permission on startup to eliminate pings
        updateEnhancedSectionVisibility();
        updateTextSpeakButton();
        getUserLocation();
    }

    // --- BUTTON HANDLERS ---
    function setupButtonHandlers() {
        document.getElementById('btnStartTalking').onclick = startTalkingFromHome;
        document.getElementById('btnStartTexting').onclick = function() { showPage('textInput'); };
        document.getElementById('btnPhoneCall').onclick = function() { showPage('phone'); };
        document.getElementById('btnCommands').onclick = function() { showPage('commands'); };
        document.getElementById('btnSettings').onclick = function() { showPage('settings'); };

        // Speech Page
        document.getElementById('btnCloseSpeech').onclick = navigateBack;
        document.getElementById('listenButton').onclick = toggleListening;
        document.getElementById('enhancedButton').onclick = startEnhancedRecognition;

        // Phone Page
        document.getElementById('btnClosePhone').onclick = function() { showPage('home'); };
        document.getElementById('btnPhoneHome').onclick = function() { showPage('home'); };

        // Commands Page
        document.getElementById('btnCloseCommands').onclick = navigateBack;

        // Text Input Page
        document.getElementById('btnCloseText').onclick = navigateBack;
        document.getElementById('speakTextBtn').onclick = speakTextInput;
        document.getElementById('btnTextHome').onclick = function() { showPage('home'); };
        document.getElementById('largeTextInputField').oninput = updateTextSpeakButton;

        // Settings Page
        document.getElementById('btnCloseSettings').onclick = navigateBack;
        document.getElementById('btnSettingsHome').onclick = function() { showPage('home'); };
        document.getElementById('apiKeyInput').onchange = function(e) { saveApiKey(e.target.value); };
        document.getElementById('speechSpeedSlider').oninput = function(e) { updateSpeechSpeed(e.target.value); };
        document.getElementById('pauseBetweenWordsSlider').oninput = function(e) { updatePauseBetweenWords(e.target.value); };
        document.getElementById('speakVoiceCommandsSwitch').onchange = function(e) { updateVoiceCommandSetting(e.target.checked); };
        document.getElementById('autoEnhancedSwitch').onchange = function(e) { updateAutoEnhanced(e.target.checked); };
        document.getElementById('enhancedModeSwitch').onchange = function(e) { updateEnhancedMode(e.target.checked); };
    }

    // --- GEOLOCATION ---
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                },
                function(error) {
                    // Use default location if geolocation fails
                    userLocation = { lat: 40.7128, lon: -74.0060 }; // New York
                }
            );
        } else {
            userLocation = { lat: 40.7128, lon: -74.0060 }; // New York
        }
    }

    // --- MICROPHONE PERMISSION ---
    function requestMicrophonePermission() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    microphonePermissionGranted = true;
                    stream.getTracks().forEach(track => track.stop());
                    setTimeout(setupVoiceCommandListener, 500);
                })
                .catch(function(error) {
                    microphonePermissionGranted = false;
                    alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                });
        } else {
            alert('Microphone access not supported in this browser.');
        }
    }

    // COMPLETELY DISABLE ALL SPEECH RECOGNITION EXCEPT ON SPEECH PAGE
    function setupVoiceCommandListener() {
        // DO NOTHING - completely disable to eliminate pings
        console.log('Voice commands completely disabled to eliminate pings');
        return;
    }

    function requestMicrophonePermission() {
        // Skip microphone permission to eliminate pings
        console.log('Microphone permission skipped to eliminate pings');
        microphonePermissionGranted = false;
    }

    function processVoiceCommand(transcript) {
        console.log('Processing voice command:', transcript);
        
        // Time and date commands
        if (transcript.includes('what time is it')) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            speak(`The current time is ${timeString}`);
        } 
        else if (transcript.includes('what\'s the date') || transcript.includes('whats the date')) {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            speak(`Today is ${dateString}`);
        }
        // Navigation commands
        else if (transcript.includes('start talking')) {
            startTalkingFromHome();
            speak('Starting speech recognition');
        }
        else if (transcript.includes('start texting')) {
            showPage('textInput');
            speak('Opening text input page');
        }
        else if (transcript.includes('home')) {
            showPage('home');
            speak('Going to home page');
        }
        else if (transcript.includes('help')) {
            showPage('commands');
            speak('Showing Leslie commands');
        }
        // Phone commands
        else if (transcript.includes('call ')) {
            const callMatch = transcript.match(/call\s+(.+)/);
            if (callMatch) {
                const nameOrNumber = callMatch[1].trim();
                handleCallCommand(nameOrNumber);
            }
        }
        // Leslie Commands
        else if (transcript.includes('commands') && !transcript.includes('close')) {
            showPage('commands');
            speak('Opening Leslie commands');
        }
        else if (transcript.includes('close commands')) {
            showPage('home');
            speak('Closing commands, going home');
        }
        // Weather commands - improved pattern matching
        else if (transcript.includes('current weather') || (transcript.includes('weather') && !transcript.includes('forecast') && !transcript.includes('7') && !transcript.includes('hourly'))) {
            showCurrentWeather();
            speak('Showing current weather');
        }
        else if (transcript.includes('7 day forecast') || transcript.includes('seven day forecast') || transcript.includes('7day forecast') || transcript.includes('sevenday forecast')) {
            showWeeklyWeather();
            speak('Showing 7 day forecast');
        }
        else if (transcript.includes('7 day') || transcript.includes('seven day') || transcript.includes('7day') || transcript.includes('sevenday')) {
            showWeeklyWeather();
            speak('Showing 7 day forecast');
        }
        else if (transcript.includes('hourly forecast') || transcript.includes('hourly weather')) {
            showHourlyWeather();
            speak('Showing hourly forecast');
        }
        else if (transcript.includes('hourly')) {
            showHourlyWeather();
            speak('Showing hourly forecast');
        }
        else if (transcript.includes('close')) {
            hideWeather();
            speak('Closing weather display');
        }
        // Recognition commands
        else if (transcript.includes('clear text')) {
            clearSpeechText();
            speak('Text cleared');
        }
        else if (transcript.includes('enhanced mode') && !transcript.includes('turn off')) {
            enhancedMode = true;
            speak('Enhanced mode enabled');
        }
        else if (transcript.includes('turn off enhanced mode')) {
            enhancedMode = false;
            speak('Enhanced mode disabled');
        }
        // Speech settings commands - SIMPLIFIED AND FIXED
        else if (transcript.includes('speak faster')) {
            console.log('=== SPEAK FASTER COMMAND ===');
            adjustSpeechSpeed(0.1);
            speak(`Speech speed increased to ${settings.speechSpeed.toFixed(1)}`);
        }
        else if (transcript.includes('talk slower') || transcript.includes('speak slower')) {
            console.log('=== SPEAK SLOWER COMMAND ===');
            adjustSpeechSpeed(-0.1);
            speak(`Speech speed decreased to ${settings.speechSpeed.toFixed(1)}`);
        }
        else if (transcript.includes('pause more')) {
            console.log('=== PAUSE MORE COMMAND ===');
            adjustPauseBetweenWords(0.5);
            speak(`Pause increased to ${settings.pauseBetweenWords} seconds`);
        }
        else if (transcript.includes('pause less')) {
            console.log('=== PAUSE LESS COMMAND ===');
            adjustPauseBetweenWords(-0.5);
            speak(`Pause decreased to ${settings.pauseBetweenWords} seconds`);
        }
        else if (transcript.includes('turn off voice command speech')) {
            settings.speakVoiceCommands = false;
            updateVoiceCommandSetting(false);
            speak('Voice command speech turned off');
        }
        else if (transcript.includes('turn on voice command speech')) {
            settings.speakVoiceCommands = true;
            updateVoiceCommandSetting(true);
            speak('Voice command speech turned on');
        }
        else {
            speak('I heard you, but didn\'t understand the command. Say Hey Leslie help for available commands.');
        }
    }

    function handleCallCommand(nameOrNumber) {
        // Check if it's a phone number
        const phoneRegex = /[\d\-\(\)\s]+/;
        if (phoneRegex.test(nameOrNumber) && nameOrNumber.replace(/\D/g, '').length >= 10) {
            const cleanedNumber = nameOrNumber.replace(/\D/g, '');
            window.location.href = `tel:${cleanedNumber}`;
            speak(`Calling ${nameOrNumber}`);
        } else {
            // Search for contact by name
            const contact = contacts.find(c => 
                c.name.toLowerCase().includes(nameOrNumber.toLowerCase())
            );
            if (contact) {
                window.location.href = `tel:${contact.phone.replace(/\D/g, '')}`;
                speak(`Calling ${contact.name}`);
            } else {
                showPage('phone');
                speak(`I couldn't find ${nameOrNumber} in your contacts. Opening phone page.`);
            }
        }
    }

    function adjustSpeechSpeed(change) {
        console.log('Adjusting speech speed by:', change);
        console.log('Current speed:', settings.speechSpeed);
        
        const oldValue = settings.speechSpeed;
        settings.speechSpeed = Math.max(0.5, Math.min(2.0, settings.speechSpeed + change));
        
        console.log('New speed:', settings.speechSpeed);
        
        // Force update the UI slider
        const speedSlider = document.getElementById('speechSpeedSlider');
        if (speedSlider) {
            speedSlider.value = settings.speechSpeed;
            updateSpeechSpeed(settings.speechSpeed);
        }
        
        console.log('Speech speed changed from', oldValue, 'to', settings.speechSpeed);
        saveSettings();
    }

    function adjustPauseBetweenWords(change) {
        console.log('Adjusting pause between words by:', change);
        console.log('Current pause:', settings.pauseBetweenWords);
        
        const oldValue = settings.pauseBetweenWords;
        settings.pauseBetweenWords = Math.max(0, Math.min(5.0, settings.pauseBetweenWords + change));
        
        console.log('New pause:', settings.pauseBetweenWords);
        
        // Force update the UI slider
        const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
        if (pauseSlider) {
            pauseSlider.value = settings.pauseBetweenWords;
            updatePauseBetweenWords(settings.pauseBetweenWords);
        }
        
        console.log('Pause between words changed from', oldValue, 'to', settings.pauseBetweenWords);
        saveSettings();
    }

    function speak(text, useWordPauses = false) {
        if (settings.speakVoiceCommands && text.trim()) {
            speechSynth.cancel();
            
            if (useWordPauses && settings.pauseBetweenWords > 0) {
                // Split text into words for pause control (only for speech recognition)
                const words = text.split(' ');
                let wordIndex = 0;
                
                function speakNextWord() {
                    if (wordIndex < words.length) {
                        const utterance = new SpeechSynthesisUtterance(words[wordIndex]);
                        utterance.rate = settings.speechSpeed;
                        utterance.pitch = 1;
                        utterance.volume = 0.8;
                        
                        utterance.onend = function() {
                            wordIndex++;
                            if (wordIndex < words.length) {
                                setTimeout(speakNextWord, settings.pauseBetweenWords * 1000);
                            }
                        };
                        
                        speechSynth.speak(utterance);
                    }
                }
                
                speakNextWord();
            } else {
                // Speak normally for voice commands
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynth.speak(utterance);
            }
        }
    }

    // --- BACK BUTTON HANDLING ---
    function setupBackButtonHandling() {
        window.addEventListener('popstate', function(event) {
            event.preventDefault();
            navigateBack();
        });
        history.pushState({page: 'home'}, '', '');
    }

    function navigateBack() {
        if (pageHistory.length > 1) {
            pageHistory.pop();
            const previousPage = pageHistory[pageHistory.length - 1];
            showPage(previousPage, false);
        } else {
            showPage('home', false);
        }
    }

    // --- SPEECH RECOGNITION SETUP ---
    function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            isListening = true;
            updateListenButton();
            updateStatus('🎤 Listening... Say something!');
            
            // Start 3-minute silence timer
            silenceTimer = setTimeout(function() {
                if (isListening) {
                    stopListening();
                    updateStatus('Stopped listening due to 3 minutes of silence');
                }
            }, 3 * 60 * 1000); // 3 minutes
            
            // COMPLETELY stop voice command recognition when speech page is active
            if (voiceCommandRecognition && voiceCommandActive) {
                try { 
                    voiceCommandRecognition.stop();
                    voiceCommandRecognition.abort();
                } catch (e) {}
                voiceCommandActive = false;
            }
        };

        recognition.onend = function() {
            console.log('=== RECOGNITION ENDED ===');
            console.log('isListening before end:', isListening);
            
            // CRITICAL: Only change state if we're manually stopping or timing out
            // Do NOT change state just because recognition ended after speaking
            if (isListening) {
                console.log('Recognition ended but we should still be listening - restarting...');
                // Restart recognition to keep listening
                setTimeout(() => {
                    if (isListening) {
                        try {
                            recognition.start();
                            console.log('Recognition restarted to continue listening');
                        } catch (error) {
                            console.log('Error restarting recognition:', error);
                            // Only now change the button state if we can't restart
                            isListening = false;
                            updateListenButton();
                            updateStatus('Recognition stopped - click START TALKING to resume');
                        }
                    }
                }, 100);
            } else {
                // We're intentionally stopping
                updateListenButton();
                updateStatus('Ready to listen - Click "START TALKING" below');
            }
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        };

        recognition.onerror = function(event) {
            isListening = false;
            updateListenButton();
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            
            if (event.error === 'no-speech') {
                updateStatus('No speech detected. Keep talking or click START TALKING again.');
            } else if (event.error === 'audio-capture') {
                updateStatus('Microphone error. Please check permissions and try again.');
            } else if (event.error === 'not-allowed') {
                updateStatus('Microphone permission denied. Please allow microphone access.');
            } else if (event.error === 'network') {
                updateStatus('Network error. Please check your connection.');
            } else {
                updateStatus(`Recognition error (${event.error}). Try again or use Enhanced Recognition.`);
                if (settings.autoEnhanced) {
                    showEnhancedSuggestion();
                }
            }
        };

        recognition.onresult = function(event) {
            // Reset silence timer when speech is detected
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(function() {
                    if (isListening) {
                        stopListening();
                        updateStatus('Stopped listening due to 3 minutes of silence');
                    }
                }, 3 * 60 * 1000);
            }
            
            let interimTranscript = '';
            let finalText = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalText += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }

            if (finalText.trim()) {
                const cleanText = finalText.trim();
                
                // Filter out "Hey Leslie" commands - don't display or speak them
                if (cleanText.toLowerCase().includes('hey leslie') || cleanText.toLowerCase().includes('leslie')) {
                    console.log('Filtered out Leslie command:', cleanText);
                    return; // Don't process Leslie commands on speech page
                }
                
                // Check if this is a duplicate (prevent feedback loop)
                if (phraseHistory.length > 0 && phraseHistory[phraseHistory.length - 1] === cleanText) {
                    console.log('Duplicate phrase filtered out:', cleanText);
                    return;
                }
                
                phraseHistory.push(cleanText);
                if (phraseHistory.length > 20) phraseHistory.shift();
                updateCurrentPhraseDisplay();
                finalTranscript = cleanText;
                updateStatus('✅ Heard: ' + finalTranscript);
                
                // Speak the recognized text with word pauses, but don't stop listening
                if (!isSpeaking) {
                    isSpeaking = true;
                    // Temporarily stop voice command recognition to prevent feedback
                    if (voiceCommandRecognition && voiceCommandActive) {
                        try { voiceCommandRecognition.stop(); } catch (e) {}
                        voiceCommandActive = false;
                    }
                    
                    speak(finalTranscript, true); // Use word pauses for speech recognition
                    
                    setTimeout(() => { 
                        isSpeaking = false;
                        // Restart voice command listener after speaking
                        setTimeout(() => {
                            if (!voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                                setupVoiceCommandListener();
                            }
                        }, 1000);
                    }, (finalTranscript.length * 100) + (settings.pauseBetweenWords * finalTranscript.split(' ').length * 1000));
                }
                // Keep listening - don't change button state
            } else if (interimTranscript.trim()) {
                // Only show interim results if they don't contain Leslie commands
                const cleanInterim = interimTranscript.trim();
                if (!cleanInterim.toLowerCase().includes('hey leslie') && !cleanInterim.toLowerCase().includes('leslie')) {
                    currentPhrase = cleanInterim;
                    updateCurrentPhraseDisplay(true);
                    updateStatus('🔄 Listening: ' + cleanInterim);
                }
            }
        };
    }

    function updateCurrentPhraseDisplay(interimOnly) {
        const currentPhraseEl = document.getElementById('currentPhrase');
        if (currentPhraseEl) {
            let html = '';
            
            // Show phrase history
            if (phraseHistory.length > 0) {
                phraseHistory.forEach((phrase, idx) => {
                    html += `<div class="current-phrase">${phrase}</div>`;
                });
            }
            
            // Show interim results
            if (interimOnly && currentPhrase.trim()) {
                html += `<div class="current-phrase" style="background:#fff8e1; color:#999;">${currentPhrase}</div>`;
            }
            
            if (html) {
                currentPhraseEl.innerHTML = html;
            } else {
                currentPhraseEl.textContent = 'Your speech will appear here...';
            }
            
            // Auto-scroll to bottom
            const speechContent = document.querySelector('.speech-content');
            if (speechContent) {
                speechContent.scrollTop = speechContent.scrollHeight;
            }
        }
    }

    function clearSpeechText() {
        currentPhrase = '';
        finalTranscript = '';
        phraseHistory = [];
        updateCurrentPhraseDisplay();
        updateStatus('Text cleared - Ready to listen');
    }

    // --- CONTACTS ---
    function initializeContacts() {
        contacts = [];
        filteredContacts = [];
        // Auto-load contacts when phone page is visited
        if (currentPage === 'phone') {
            loadRealContacts();
        }
    }

    async function loadRealContacts() {
        const contactsList = document.getElementById('contactsList');
        
        try {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                // Show loading message
                contactsList.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: #666;">
                        <p>Loading your contacts...</p>
                    </div>
                `;
                
                const props = ['name', 'tel'];
                const opts = {multiple: true};
                
                const contactList = await navigator.contacts.select(props, opts);
                
                if (contactList.length > 0) {
                    contacts = contactList.map(contact => ({
                        name: contact.name && contact.name[0] ? contact.name[0] : 'Unknown',
                        phone: contact.tel && contact.tel[0] ? contact.tel[0] : 'No phone'
                    }));
                    contacts.sort((a, b) => a.name.localeCompare(b.name));
                    filteredContacts = [...contacts];
                    displayContactsInApp();
                    return;
                } else {
                    // No contacts selected
                    contacts = [];
                    filteredContacts = [];
                    displayContactsInApp();
                }
            } else {
                // Contacts API not supported
                contacts = [];
                filteredContacts = [];
                displayContactsInApp();
            }
        } catch (error) {
            console.error('Error loading contacts:', error);
            contacts = [];
            filteredContacts = [];
            displayContactsInApp();
        }
    }

    function displayContactsInApp() {
        displayContacts(); // Call the existing display function
    }

    function displayContacts() {
        const contactsList = document.getElementById('contactsList');
        contactsList.innerHTML = '';
        
        if (filteredContacts.length === 0) {
            contactsList.innerHTML = `
                <div style="padding: 16px; text-align: center; color: #666;">
                    <p><strong>📱 Access Your Real Contacts</strong></p>
                    <p>Your contacts are accessed locally on your device only.</p>
                    <p>No contact data is sent to servers or made public.</p>
                    <br>
                    <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        📞 Load Your Contacts
                    </button>
                    <p style="margin-top: 16px; font-size: 12px; color: #999;">
                        If no contacts appear after clicking, your browser may not support the Contacts API.
                    </p>
                </div>
            `;
            return;
        }

        const countDiv = document.createElement('div');
        countDiv.style.padding = '8px';
        countDiv.style.textAlign = 'center';
        countDiv.style.fontWeight = 'bold';
        countDiv.style.color = '#669900';
        countDiv.textContent = `${filteredContacts.length} contacts loaded`;
        contactsList.appendChild(countDiv);

        const contactsToShow = filteredContacts.slice(0, 200);
        contactsToShow.forEach((contact, index) => {
            const contactEl = document.createElement('div');
            contactEl.className = 'contact-item';
            contactEl.innerHTML = `
                <div class="contact-name">${contact.name}</div>
                <div class="contact-phone">${contact.phone}</div>
            `;
            contactEl.onclick = () => callContact(contact);
            contactsList.appendChild(contactEl);
        });

        if (filteredContacts.length > 200) {
            const moreDiv = document.createElement('div');
            moreDiv.style.padding = '16px';
            moreDiv.style.textAlign = 'center';
            moreDiv.style.color = '#666';
            moreDiv.textContent = `... and ${filteredContacts.length - 200} more contacts. Use search to find specific contacts.`;
            contactsList.appendChild(moreDiv);
        }
    }

    function filterContacts(searchTerm) {
        console.log('=== FILTERING CONTACTS ===', searchTerm);
        
        if (!searchTerm.trim()) {
            filteredContacts = [...contacts];
        } else {
            const searchLower = searchTerm.toLowerCase().trim();
            filteredContacts = contacts.filter(contact => {
                const nameLower = contact.name.toLowerCase();
                const phoneNumbers = contact.phone.replace(/[^0-9]/g, '');
                const searchNumbers = searchTerm.replace(/[^0-9]/g, '');
                return nameLower.includes(searchLower) ||
                    nameLower.startsWith(searchLower) ||
                    phoneNumbers.includes(searchNumbers) ||
                    contact.name.toLowerCase().split(' ').some(word => word.startsWith(searchLower));
            });
        }
        
        console.log('Filtered contacts:', filteredContacts.length);
        
        // Use the standard display function to show results on phone page
        displayContacts();
    }

    function callContact(contact) {
        window.location.href = `tel:${contact.phone.replace(/[^0-9]/g, '')}`;
    }

    // --- PAGE NAVIGATION ---
    function showPage(pageId, addToHistory = true) {
        const pages = document.querySelectorAll('.page');
        pages.forEach(page => page.classList.remove('active'));
        
        const targetPage = document.getElementById(pageId + 'Page');
        if (targetPage) {
            targetPage.classList.add('active');
            currentPage = pageId;
            
            if (addToHistory) {
                pageHistory.push(pageId);
                history.pushState({page: pageId}, '', '');
            }
            
            // Stop listening if leaving speech page
            if (pageId !== 'speech' && isListening) {
                stopListening();
            }
            
            // Auto-focus text input and activate speak button
            if (pageId === 'textInput') {
                setTimeout(() => {
                    const textInput = document.getElementById('largeTextInputField');
                    if (textInput) {
                        textInput.focus();
                    }
                    updateTextSpeakButton();
                }, 100);
            }
            
            // Auto-load contacts when visiting phone page - NO VOICE COMMANDS
            if (pageId === 'phone') {
                setTimeout(() => {
                    console.log('Phone page loaded, auto-loading contacts...');
                    loadRealContacts();
                }, 500);
            }
            // NO voice command setup to eliminate pings
        }
    }

    function startTalkingFromHome() {
        showPage('speech');
        setTimeout(() => { 
            // Request microphone permission ONLY when actually starting speech recognition
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        // Now start listening
                        if (!isListening) {
                            startListening();
                        }
                    })
                    .catch(function(error) {
                        microphonePermissionGranted = false;
                        updateStatus('Microphone permission required for speech recognition');
                    });
            }
        }, 500);
    }

    function toggleListening() {
        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    }

    function startListening() {
        if (recognition && !isListening) {
            try { 
                recognition.start(); 
            } catch (error) {
                updateStatus('Error starting recognition. Please try again.');
            }
        }
    }

    function stopListening() {
        console.log('=== MANUALLY STOPPING LISTENING ===');
        if (recognition && isListening) {
            isListening = false; // Set this BEFORE stopping to prevent restart
            recognition.stop();
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
            
            updateStatus('Stopped listening');
            updateListenButton();
            console.log('Listening manually stopped');
        }
    }

    function updateListenButton() {
        const listenButton = document.getElementById('listenButton');
        if (listenButton) {
            if (isListening) {
                listenButton.textContent = 'STOP LISTENING';
                listenButton.className = 'control-btn btn-stop';
            } else {
                listenButton.textContent = 'START TALKING';
                listenButton.className = 'control-btn btn-listen';
            }
        }
    }

    function updateStatus(message) {
        const statusText = document.getElementById('statusText');
        if (statusText) statusText.textContent = message;
    }

    // --- TEXT INPUT ---
    function speakTextInput() {
        const textInput = document.getElementById('largeTextInputField');
        const text = textInput.value.trim();
        if (text) {
            speak(text);
        }
    }

    function updateTextSpeakButton() {
        const textInput = document.getElementById('largeTextInputField');
        const speakBtn = document.getElementById('speakTextBtn');
        if (speakBtn && textInput) {
            // Always show as active/purple when on text input page
            speakBtn.disabled = false;
            speakBtn.style.opacity = '1';
            speakBtn.style.background = '#9933cc';
        }
    }

    // --- WEATHER ---
    async function showCurrentWeather() {
        const weatherDisplay = document.getElementById('weatherDisplay');
        const weatherTitle = document.getElementById('weatherTitle');
        const weatherContent = document.getElementById('weatherContent');
        
        // Set up display immediately at full size to prevent small box
        weatherDisplay.style.width = 'auto';
        weatherDisplay.style.height = 'auto';
        weatherDisplay.style.minWidth = '500px';
        weatherDisplay.style.minHeight = '300px';
        
        weatherTitle.textContent = 'Current Weather';
        weatherContent.innerHTML = `
            <div style="text-align: center; margin: 0 auto; padding: 40px; min-width: 450px; min-height: 200px;">
                <div style="font-size: 20px; color: #0099cc; margin-bottom: 16px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #0099cc; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    Loading weather data...
                </div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        weatherDisplay.classList.remove('hidden');
        
        try {
            let lat, lon;
            if (userLocation) {
                lat = userLocation.lat;
                lon = userLocation.lon;
            } else {
                lat = 40.7128;
                lon = -74.0060;
            }
            
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
            const data = await response.json();
            
            const currentTime = new Date();
            const dateString = currentTime.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const temperature = Math.round(data.current.temperature_2m * 9/5 + 32);
            const humidity = data.current.relative_humidity_2m;
            const windSpeed = Math.round(data.current.wind_speed_10m * 0.621371);
            const conditions = getWeatherDescription(data.current.weather_code);
            
            weatherContent.innerHTML = `
                <div style="min-width: 450px; min-height: 200px; padding: 20px;">
                    <div style="text-align: center; margin: 0 auto 20px auto;">
                        <div style="font-size: 18px; color: #666; margin-bottom: 16px; text-align: center; font-weight: bold;">${dateString}</div>
                        <div style="font-size: 36px; font-weight: bold; color: #0099cc; text-align: center; margin-bottom: 8px;">${temperature}°F</div>
                        <div style="font-size: 22px; font-weight: bold; margin: 12px 0; text-align: center; color: #333;">${conditions}</div>
                    </div>
                    <div style="line-height: 2; font-size: 16px; max-width: 400px; margin: 0 auto;">
                        <div style="text-align: left;">
                            <strong>Humidity:</strong> ${humidity}%<br>
                            <strong>Wind:</strong> ${windSpeed} mph<br>
                            <strong>Time:</strong> ${currentTime.toLocaleTimeString()}<br>
                            <strong>Location:</strong> Current Location<br>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Weather fetch error:', error);
            weatherContent.innerHTML = `
                <div style="text-align: center; margin: 0 auto; padding: 40px; min-width: 450px; min-height: 200px;">
                    <div style="color: #cc0000; font-size: 18px;">Unable to load weather data. Please check your internet connection.</div>
                </div>
            `;
        }
    }

    async function showHourlyWeather() {
        const weatherDisplay = document.getElementById('weatherDisplay');
        const weatherTitle = document.getElementById('weatherTitle');
        const weatherContent = document.getElementById('weatherContent');
        
        weatherTitle.textContent = '24-Hour Forecast';
        weatherContent.innerHTML = 'Loading hourly forecast...';
        weatherDisplay.classList.remove('hidden');
        
        try {
            let lat, lon;
            if (userLocation) {
                lat = userLocation.lat;
                lon = userLocation.lon;
            } else {
                lat = 40.7128;
                lon = -74.0060;
            }
            
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=1`);
            const data = await response.json();
            
            let hourlyData = '<div class="hourly-forecast" style="max-width: 600px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">';
            
            // Show every hour for 24 hours
            for (let i = 0; i < 24; i++) {
                if (i < data.hourly.time.length) {
                    const time = new Date(data.hourly.time[i]);
                    const hour = time.getHours();
                    const temp = Math.round(data.hourly.temperature_2m[i] * 9/5 + 32); // Convert C to F
                    const conditions = getWeatherDescription(data.hourly.weather_code[i]);
                    const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    
                    hourlyData += `
                        <div class="hourly-item">
                            <strong>${displayHour}:00 ${ampm}</strong><br>
                            ${temp}°F<br>
                            <small>${conditions}</small>
                        </div>
                    `;
                }
            }
            hourlyData += '</div>';
            weatherContent.innerHTML = hourlyData;
        } catch (error) {
            console.error('Hourly weather fetch error:', error);
            weatherContent.innerHTML = 'Unable to load hourly forecast. Please check your internet connection.';
        }
    }

    async function showWeeklyWeather() {
        const weatherDisplay = document.getElementById('weatherDisplay');
        const weatherTitle = document.getElementById('weatherTitle');
        const weatherContent = document.getElementById('weatherContent');
        
        weatherTitle.textContent = '7-Day Forecast';
        weatherContent.innerHTML = 'Loading 7-day forecast...';
        weatherDisplay.classList.remove('hidden');
        
        try {
            let lat, lon;
            if (userLocation) {
                lat = userLocation.lat;
                lon = userLocation.lon;
            } else {
                lat = 40.7128;
                lon = -74.0060;
            }
            
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7`);
            const data = await response.json();
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let weeklyData = '<div class="weekly-forecast" style="display: grid; gap: 8px;">';
            
            for (let i = 0; i < 7; i++) {
                if (i < data.daily.time.length) {
                    const date = new Date(data.daily.time[i]);
                    const dayName = days[date.getDay()];
                    const high = Math.round(data.daily.temperature_2m_max[i] * 9/5 + 32); // Convert C to F
                    const low = Math.round(data.daily.temperature_2m_min[i] * 9/5 + 32); // Convert C to F
                    const conditions = getWeatherDescription(data.daily.weather_code[i]);
                    
                    weeklyData += `
                        <div class="weekly-item" style="display: grid; grid-template-columns: 100px 80px 1fr; gap: 12px; align-items: center; padding: 8px;">
                            <div class="day-name" style="font-weight: bold; text-align: left;">${dayName}</div>
                            <div class="day-temps" style="color: #0099cc; font-weight: bold; text-align: center;">${high}°/${low}°</div>
                            <div class="day-condition" style="color: #666; text-align: left;">${conditions}</div>
                        </div>
                    `;
                }
            }
            weeklyData += '</div>';
            weatherContent.innerHTML = weeklyData;
        } catch (error) {
            console.error('Weekly weather fetch error:', error);
            weatherContent.innerHTML = 'Unable to load 7-day forecast. Please check your internet connection.';
        }
    }

    function getWeatherDescription(code) {
        const weatherCodes = {
            0: 'Clear sky',
            1: 'Mainly clear',
            2: 'Partly cloudy',
            3: 'Overcast',
            45: 'Fog',
            48: 'Depositing rime fog',
            51: 'Light drizzle',
            53: 'Moderate drizzle',
            55: 'Dense drizzle',
            61: 'Slight rain',
            63: 'Moderate rain',
            65: 'Heavy rain',
            71: 'Slight snow',
            73: 'Moderate snow',
            75: 'Heavy snow',
            80: 'Slight rain showers',
            81: 'Moderate rain showers',
            82: 'Violent rain showers',
            95: 'Thunderstorm',
            96: 'Thunderstorm with hail',
            99: 'Thunderstorm with heavy hail'
        };
        return weatherCodes[code] || 'Unknown';
    }

    function hideWeather() {
        const weatherDisplay = document.getElementById('weatherDisplay');
        weatherDisplay.classList.add('hidden');
    }

    // --- SWIPE DETECTION ---
    function setupSwipeDetection() {
        const swipeBottom = document.getElementById('swipeBottom');
        const swipeLeft = document.getElementById('swipeLeft');
        const swipeRight = document.getElementById('swipeRight');
        
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        swipeBottom.addEventListener('touchstart', function(e) {
            touchStartY = e.changedTouches[0].screenY;
            e.stopPropagation();
        });

        swipeBottom.addEventListener('touchend', function(e) {
            touchEndY = e.changedTouches[0].screenY;
            const swipeDistance = touchStartY - touchEndY;
            if (swipeDistance > 30) showCurrentWeather();
            e.stopPropagation();
        });

        swipeLeft.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
            e.stopPropagation();
        });

        swipeLeft.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            const swipeDistance = touchEndX - touchStartX;
            if (swipeDistance > 30) showHourlyWeather();
            e.stopPropagation();
        });

        swipeRight.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
            e.stopPropagation();
        });

        swipeRight.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            const swipeDistance = touchStartX - touchEndX;
            if (swipeDistance > 30) showWeeklyWeather();
            e.stopPropagation();
        });
    }

    // --- SETTINGS ---
    function loadSettings() {
        try {
            const savedSettings = localStorage.getItem('leslieSettings');
            if (savedSettings) {
                settings = {...settings, ...JSON.parse(savedSettings)};
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
        updateSettingsUI();
    }

    function saveSettings() {
        try {
            localStorage.setItem('leslieSettings', JSON.stringify(settings));
        } catch (error) {
            console.error('Error saving settings:', error);
        }
    }

    function updateSettingsUI() {
        const speedSlider = document.getElementById('speechSpeedSlider');
        const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
        const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
        const enhancedSwitch = document.getElementById('autoEnhancedSwitch');
        const enhancedModeSwitch = document.getElementById('enhancedModeSwitch');
        const apiKeyInput = document.getElementById('apiKeyInput');

        if (speedSlider) speedSlider.value = settings.speechSpeed;
        if (pauseSlider) pauseSlider.value = settings.pauseBetweenWords;
        if (voiceSwitch) voiceSwitch.checked = settings.speakVoiceCommands;
        if (enhancedSwitch) enhancedSwitch.checked = settings.autoEnhanced;
        if (enhancedModeSwitch) enhancedModeSwitch.checked = settings.enhancedMode;
        if (apiKeyInput) apiKeyInput.value = settings.apiKey;

        updateSpeechSpeed(settings.speechSpeed);
        updatePauseBetweenWords(settings.pauseBetweenWords);
        updateVoiceCommandSetting(settings.speakVoiceCommands);
        updateAutoEnhanced(settings.autoEnhanced);
        updateEnhancedMode(settings.enhancedMode);
    }

    function updateSpeechSpeed(value) {
        settings.speechSpeed = parseFloat(value);
        const label = document.getElementById('speechSpeedValue');
        if (label) {
            if (value == 1.0) {
                label.textContent = 'Normal (1.0x)';
            } else {
                label.textContent = `${value}x`;
            }
        }
        saveSettings();
    }

    function updatePauseBetweenWords(value) {
        settings.pauseBetweenWords = parseFloat(value);
        const label = document.getElementById('pauseBetweenWordsValue');
        if (label) {
            label.textContent = `${value} seconds`;
        }
        saveSettings();
    }

    function updateVoiceCommandSetting(checked) {
        settings.speakVoiceCommands = checked;
        const label = document.getElementById('speakVoiceCommandsLabel');
        if (label) {
            label.textContent = `Voice Command Speech: ${checked ? 'ON' : 'OFF'}`;
        }
        
        const switchElement = document.getElementById('speakVoiceCommandsSwitch');
        if (switchElement) {
            switchElement.checked = checked;
        }
        
        saveSettings();
    }

    function updateAutoEnhanced(checked) {
        settings.autoEnhanced = checked;
        saveSettings();
    }

    function updateEnhancedMode(checked) {
        settings.enhancedMode = checked;
        const label = document.getElementById('enhancedModeLabel');
        if (label) {
            label.textContent = `Enhanced Mode: ${checked ? 'ON' : 'OFF'}`;
        }
        
        const switchElement = document.getElementById('enhancedModeSwitch');
        if (switchElement) {
            switchElement.checked = checked;
        }
        
        saveSettings();
    }

    function saveApiKey(value) {
        settings.apiKey = value;
        saveSettings();
        updateEnhancedSectionVisibility();
    }

    function updateEnhancedSectionVisibility() {
        const enhancedSection = document.getElementById('enhancedSection');
        if (enhancedSection && settings.apiKey) {
            enhancedSection.classList.add('show');
        } else if (enhancedSection) {
            enhancedSection.classList.remove('show');
        }
    }

    // --- ENHANCED RECOGNITION PLACEHOLDER ---
    function startEnhancedRecognition() {
        if (!settings.apiKey) {
            alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
            showPage('settings');
            return;
        }
        alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
    }

    function showEnhancedSuggestion() {
        const enhancedSection = document.getElementById('enhancedSection');
        if (enhancedSection && settings.apiKey) {
            enhancedSection.classList.add('show');
            const enhancedStatus = document.getElementById('enhancedStatus');
            if (enhancedStatus) {
                enhancedStatus.textContent = 'Low confidence detected. Try Enhanced Recognition for better accuracy.';
                enhancedStatus.style.color = '#ff6600';
                enhancedStatus.style.fontWeight = 'bold';
            }
        }
    }

    // --- DOM READY & VISIBILITY ---
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
    });

    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Optional: Stop listeners if needed
        } else {
            if (microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                setTimeout(setupVoiceCommandListener, 1000);
            }
        }
    });
    </script>
</body>
</html>
