<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant - No Ping Version</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #0099cc;
            z-index: 1000;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .icon-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-clear { background-color: #ffaa00; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        .contact-loading-section {
            padding: 20px;
            text-align: center;
            color: #669900;
            border: 2px solid #669900;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 16px;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    üé§ START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    üìù START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    üìû PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    ‚ÑπÔ∏è APP INFO
                </button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Click START TALKING for speech recognition<br>
                    ‚Ä¢ Use Enhanced Recognition if available<br>
                    ‚Ä¢ All microphone access is manual - no background listening<br>
                    ‚Ä¢ Text input allows typing with speech playback
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                
                <div class="status-text" id="statusText">
                    Ready to listen - Click START TALKING to begin!
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                    <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>üìû Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    üîç Search Your Contacts
                </div>
                <input type="text" class="contact-search-input" id="contactSearchInput" placeholder="Type to search contacts...">
            </div>
            
            <div class="contact-loading-section" id="contactLoadingSection">
                <p><strong>üì± GET YOUR REAL CONTACTS</strong></p>
                <p style="color: #333; margin: 10px 0; font-size: 16px;">Currently showing: <span style="color: #cc0000;">Demo Contacts Only</span></p>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Choose how to load YOUR real contacts from your phone:
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button id="loadAllContactsBtn" style="margin: 5px; padding: 16px 24px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        üìû LOAD ALL CONTACTS
                    </button>
                    <button id="loadSelectedContactsBtn" style="margin: 5px; padding: 16px 24px; background: #0099cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        üìã SELECT SPECIFIC CONTACTS
                    </button>
                </div>
                <p style="margin-top: 12px; font-size: 12px; color: #666;">
                    <strong>üìû LOAD ALL:</strong> Opens contact picker with auto-selection attempt<br>
                    <strong>üìã SELECT:</strong> Opens contact picker for manual selection<br>
                    <strong>‚ö†Ô∏è Works on Chrome Android & Safari iOS only</strong>
                </p>
            </div>
            
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    üì± Your contacts will appear here - Tap any contact to call
                </div>
                <div class="contacts-list" id="contactsList"></div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">üè† HOME</button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div style="font-size: 14px; font-weight: bold; color: #9933cc; margin-bottom: 8px;">
                        Type your text and tap speak to have it read aloud:
                    </div>
                    <textarea class="text-input large-text-input" id="largeTextInputField" placeholder="Type what you want to say here..."></textarea>
                    
                    <div class="speak-text-container">
                        <button class="speak-phrase-btn" id="speakTextBtn" disabled>
                            üîä SPEAK
                        </button>
                    </div>
                    
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">üè† HOME</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Info Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>‚ÑπÔ∏è App Information</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div style="padding: 16px; max-height: 70vh; overflow-y: auto; background: white; border-radius: 8px; margin: 8px;">
                <div style="font-size: 16px; line-height: 1.6; color: #333;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0099cc;">
                        <strong>üé§ Leslie Speech Assistant</strong><br>
                        <span style="font-size: 14px; color: #666;">Helping people with speech impairments be better understood</span>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                            <strong style="color: #28a745;">üéØ Main Features</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ <strong>Speech Recognition</strong> - Listens to your speech and displays it clearly<br>
                            ‚Ä¢ <strong>Speech Playback</strong> - Speaks your words back clearly for others to hear<br>
                            ‚Ä¢ <strong>Text Input</strong> - Type messages that can be spoken aloud<br>
                            ‚Ä¢ <strong>Contact Calling</strong> - Easy access to your phone contacts<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #007bff;">
                            <strong style="color: #007bff;">üõ°Ô∏è Privacy & Safety</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ No background listening - microphone only active when you choose<br>
                            ‚Ä¢ No data sent to external servers (except optional OpenAI for enhanced recognition)<br>
                            ‚Ä¢ All processing happens on your device<br>
                            ‚Ä¢ Your contacts and speech data stay private<br>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #6f42c1;">
                            <strong style="color: #6f42c1;">üîß How to Use</strong>
                        </div>
                        <div style="margin-left: 15px; font-size: 15px;">
                            ‚Ä¢ <strong>Speech Recognition:</strong> Click "START TALKING" and speak clearly<br>
                            ‚Ä¢ <strong>Text Input:</strong> Type your message and click "SPEAK" to have it read aloud<br>
                            ‚Ä¢ <strong>Contacts:</strong> Load your real contacts or use the demo ones<br>
                            ‚Ä¢ <strong>Settings:</strong> Adjust speech speed and other preferences<br>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">üí° Tips for Best Results</strong><br>
                        <div style="margin-top: 8px; font-size: 14px; color: #856404;">
                            ‚Ä¢ Speak clearly and at normal volume<br>
                            ‚Ä¢ Use the app in a quiet environment when possible<br>
                            ‚Ä¢ Adjust speech speed in settings if needed<br>
                            ‚Ä¢ Try the text input feature for important messages<br>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 16px; text-align: center;">
                <button class="btn-home" id="btnCommandsHome">üè† HOME</button>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>‚öôÔ∏è Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie speaks your text back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Pause Between Words</div>
                    <div class="settings-description">How long to wait after you stop speaking before processing your complete phrase</div>
                    <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0.5" max="4" step="0.1" value="1.5">
                    <div class="setting-value" id="pauseBetweenWordsValue">1.5 seconds</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">‚Üê Back</button>
        </div>
    </div>

    <script>
        // === GLOBAL STATE MANAGEMENT ===
        let speechRecognition = null;
        let isMainListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let contacts = [];
        let filteredContacts = [];
        let isInitialized = false;
        
        // Recognition control flags
        let shouldKeepListening = false;
        let userStoppedManually = false;
        let sessionTimeoutId = null;
        const SESSION_TIMEOUT = 2 * 60 * 1000; // 2 minutes
        
        // Speech processing control
        let isSpeaking = false;
        let lastSpokenPhrase = '';
        let lastSpokenTime = 0;
        
        // Settings
        let settings = {
            speechSpeed: 1.0,
            pauseBetweenWords: 1.5
        };

        // === COMPLETELY SAFE SPEECH RECOGNITION - NO BACKGROUND ACCESS ===
        function createSpeechRecognition() {
            console.log('üé§ Creating SAFE speech recognition (no background access)...');
            
            // Clean shutdown of any existing recognition
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                    speechRecognition.onstart = null;
                    speechRecognition.onend = null;
                    speechRecognition.onerror = null;
                    speechRecognition.onresult = null;
                } catch (e) {}
                speechRecognition = null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error('‚ùå Speech Recognition not supported');
                updateStatus('‚ùå Speech Recognition not supported');
                return false;
            }
            
            speechRecognition = new SpeechRecognition();
            
            // SAFE settings - no continuous background listening
            speechRecognition.continuous = false; // Change to false to prevent background access
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';
            speechRecognition.maxAlternatives = 1;

            speechRecognition.onstart = function() {
                console.log('üé§ ‚úÖ SAFE recognition started (manual activation only)');
                isMainListening = true;
                updateListenButton();
                updateStatus('üé§ Listening... Speak your phrase!');
                resetSessionTimeout();
            };

            speechRecognition.onend = function() {
                console.log('üé§ Recognition session ended safely');
                isMainListening = false;
                updateListenButton();
                
                // Only restart if user explicitly wants to continue
                if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                    console.log('üîÑ User requested continuation - restarting...');
                    setTimeout(() => {
                        if (shouldKeepListening && !userStoppedManually && currentPage === 'speech') {
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.log('Restart failed - user can manually restart');
                                updateStatus('‚úÖ Session complete - click START TALKING to continue');
                                shouldKeepListening = false;
                            }
                        }
                    }, 500);
                } else {
                    updateStatus('‚úÖ Stopped listening');
                    clearSessionTimeout();
                }
            };

            speechRecognition.onerror = function(event) {
                console.error('üé§ Recognition error:', event.error);
                isMainListening = false;
                updateListenButton();
                
                if (event.error === 'not-allowed') {
                    updateStatus('‚ùå Microphone access denied');
                    shouldKeepListening = false;
                } else if (event.error === 'no-speech') {
                    updateStatus('‚ö†Ô∏è No speech detected - try again');
                } else {
                    updateStatus('‚ö†Ô∏è Recognition error - click START TALKING to try again');
                }
                
                shouldKeepListening = false;
                clearSessionTimeout();
            };

            speechRecognition.onresult = function(event) {
                console.log('üé§ Speech result received');
                
                let finalText = '';
                let interimText = '';
                
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    
                    if (result.isFinal) {
                        finalText += transcript;
                    } else {
                        interimText += transcript;
                    }
                }
                
                // Show interim text
                if (interimText.trim()) {
                    displayInterimPhrase(interimText.trim());
                }
                
                // Process final text
                if (finalText.trim()) {
                    const cleanFinalText = finalText.trim();
                    console.log('üìù Processing phrase:', cleanFinalText);
                    processCompletePhrase(cleanFinalText);
                    
                    // Stop after getting a complete phrase to prevent background listening
                    shouldKeepListening = false;
                    updateStatus('‚úÖ Phrase captured - click START TALKING for next phrase');
                }
                
                resetSessionTimeout();
            };
            
            console.log('‚úÖ SAFE speech recognition configured');
            return true;
        }

        // Display interim results
        function displayInterimPhrase(interimText) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl && interimText.trim()) {
                recognizedTextEl.innerHTML = `
                    <div style="background: #fff8e1; padding: 12px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #ffa000; color: #666; font-style: italic;">
                        üé§ Speaking: "${interimText}"
                    </div>
                `;
                recognizedTextEl.scrollTop = recognizedTextEl.scrollHeight;
            }
        }

        // Process complete phrase
        function processCompletePhrase(phrase) {
            console.log('‚úÖ Processing phrase:', phrase);
            
            // Display the phrase
            displayFinalPhrase(phrase);
            
            // Speak the phrase back with improved method
            setTimeout(() => {
                speakCompletePhraseImproved(phrase);
            }, 500);
        }

        // Display final phrase
        function displayFinalPhrase(phrase) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                recognizedTextEl.innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #28a745; font-weight: bold; font-size: 16px;">
                        ‚úÖ You said: "${phrase}"
                    </div>
                `;
                recognizedTextEl.scrollTop = recognizedTextEl.scrollHeight;
                console.log('‚úÖ Displayed phrase:', phrase);
            }
        }

        // IMPROVED SPEECH SYNTHESIS - GUARANTEED TO SPEAK FULL PHRASE
        function speakCompletePhraseImproved(phrase) {
            // Prevent speaking if already speaking
            if (isSpeaking) {
                console.log('üîä Already speaking, skipping');
                return;
            }
            
            // Prevent duplicate speech
            if (phrase === lastSpokenPhrase && (Date.now() - lastSpokenTime) < 2000) {
                console.log('üîä Duplicate phrase, skipping');
                return;
            }
            
            console.log('üîä IMPROVED: Starting speech for FULL phrase:', phrase);
            console.log('üîä Phrase length:', phrase.length, 'characters');
            
            isSpeaking = true;
            lastSpokenPhrase = phrase;
            lastSpokenTime = Date.now();
            
            // COMPLETE cleanup of speech synthesis
            speechSynth.cancel();
            
            // Wait for cleanup, then speak
            setTimeout(() => {
                // Verify speech synthesis is ready
                if (speechSynth.speaking || speechSynth.pending) {
                    console.log('üîä Speech synthesis still busy, forcing cancel...');
                    speechSynth.cancel();
                    
                    setTimeout(() => {
                        performSpeech(phrase);
                    }, 300);
                } else {
                    performSpeech(phrase);
                }
            }, 200);
        }
        
        function performSpeech(phrase) {
            try {
                // Create utterance with the EXACT phrase
                const utterance = new SpeechSynthesisUtterance();
                
                // Set text using multiple methods to ensure it's set correctly
                utterance.text = phrase;
                Object.defineProperty(utterance, 'text', {
                    value: phrase,
                    writable: false
                });
                
                // Log to verify
                console.log('üîä Utterance created:');
                console.log('üîä - Text:', utterance.text);
                console.log('üîä - Text length:', utterance.text.length);
                
                // Set voice properties
                utterance.lang = 'en-US';
                utterance.rate = Math.max(0.5, Math.min(2.0, settings.speechSpeed));
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Event handlers
                utterance.onstart = function() {
                    console.log('üîä ‚úÖ Speech STARTED - Text being spoken:', utterance.text);
                    updateStatus('üîä Speaking: "' + phrase + '"');
                };
                
                utterance.onend = function() {
                    console.log('üîä ‚úÖ Speech COMPLETED successfully');
                    isSpeaking = false;
                    updateStatus('‚úÖ Phrase spoken - ready for next one');
                    
                    setTimeout(() => {
                        const recognizedTextEl = document.getElementById('recognizedText');
                        if (recognizedTextEl) {
                            recognizedTextEl.innerHTML = '<div style="color: #0099cc; font-style: italic; text-align: center; padding: 20px;">üé§ Ready for your next phrase...</div>';
                        }
                    }, 1500);
                };
                
                utterance.onerror = function(event) {
                    console.error('üîä ‚ùå Speech ERROR:', event.error);
                    console.error('üîä Error details:', event);
                    isSpeaking = false;
                    updateStatus('‚ùå Speech error - phrase captured but not spoken');
                };
                
                utterance.onboundary = function(event) {
                    console.log('üîä Speech boundary:', event.name, 'at position:', event.charIndex, 'of', utterance.text.length);
                };
                
                // Start speaking
                console.log('üîä Starting speech synthesis...');
                speechSynth.speak(utterance);
                
                // Verify it started
                setTimeout(() => {
                    if (!speechSynth.speaking) {
                        console.log('üîä ‚ö†Ô∏è Speech may not have started, checking...');
                        if (speechSynth.paused) {
                            console.log('üîä Speech was paused, resuming...');
                            speechSynth.resume();
                        }
                    } else {
                        console.log('üîä ‚úÖ Speech confirmed active');
                    }
                }, 100);
                
            } catch (error) {
                console.error('üîä ‚ùå CRITICAL speech error:', error);
                isSpeaking = false;
                updateStatus('‚ùå Speech system error');
            }
        }

        function resetSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
            
            sessionTimeoutId = setTimeout(() => {
                if (shouldKeepListening && currentPage === 'speech') {
                    console.log('‚è∞ Session timeout - stopping for safety');
                    stopListening();
                    updateStatus('‚è∞ Session timeout - click START TALKING to continue');
                }
                sessionTimeoutId = null;
            }, SESSION_TIMEOUT);
        }

        function clearSessionTimeout() {
            if (sessionTimeoutId) {
                clearTimeout(sessionTimeoutId);
                sessionTimeoutId = null;
            }
        }

        function toggleListening() {
            if (isMainListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            console.log('üé§ SAFE: Starting manual listening session...');
            
            shouldKeepListening = true;
            userStoppedManually = false;
            isSpeaking = false;
            
            updateStatus('üé§ Preparing recognition...');
            
            const recognitionCreated = createSpeechRecognition();
            
            if (!recognitionCreated) {
                updateStatus('‚ùå Speech recognition not supported');
                shouldKeepListening = false;
                return;
            }
            
            try {
                updateStatus('üé§ Starting listening...');
                speechRecognition.start();
                console.log('‚úÖ SAFE recognition started');
            } catch (error) {
                console.error('‚ùå Failed to start recognition:', error);
                
                if (error.name === 'NotAllowedError') {
                    updateStatus('‚ùå Microphone permission denied');
                } else {
                    updateStatus('‚ùå Failed to start: ' + error.message);
                }
                
                shouldKeepListening = false;
                isMainListening = false;
                updateListenButton();
            }
        }

        function stopListening() {
            console.log('üõë SAFE: Stopping listening...');
            
            shouldKeepListening = false;
            userStoppedManually = true;
            
            clearSessionTimeout();
            
            if (speechRecognition) {
                try {
                    speechRecognition.abort();
                    console.log('‚úÖ Recognition stopped safely');
                } catch (e) {
                    console.log('Recognition already stopped');
                }
            }
            
            isMainListening = false;
            updateListenButton();
            updateStatus('üõë Stopped - click START TALKING to begin again');
        }

        // === RELIABLE TEXT-TO-SPEECH FOR TEXT INPUT ===
        function speakText(text) {
            if (!text || text.trim() === '') {
                console.log('üö´ No text to speak');
                return;
            }
            
            console.log('üîä Speaking text input:', text);
            speakCompletePhraseImproved(text.trim());
        }

        // === UI FUNCTIONS ===
        function showPage(pageId) {
            console.log('üìÑ Showing page:', pageId);
            
            try {
                if (currentPage === 'speech' && pageId !== 'speech') {
                    console.log('üßπ Leaving speech page - stopping recognition...');
                    stopListening();
                }
                
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                
                const targetPage = document.getElementById(pageId + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                    currentPage = pageId;
                    
                    if (pageId === 'speech') {
                        console.log('üìÑ Entering speech page');
                        
                        const recognizedTextEl = document.getElementById('recognizedText');
                        if (recognizedTextEl) {
                            recognizedTextEl.innerHTML = '<div style="color: #0099cc; font-weight: bold; text-align: center; padding: 20px; font-size: 18px;">üé§ Ready for speech recognition<br><br>Click START TALKING when ready</div>';
                        }
                        
                        updateStatus('üé§ Ready - click START TALKING to begin');
                        updateListenButton();
                    }
                    
                    if (pageId === 'phone') {
                        displayContactsOnPhonePage();
                    }
                    
                    if (pageId === 'textInput') {
                        const textField = document.getElementById('largeTextInputField');
                        if (textField) {
                            setTimeout(() => textField.focus(), 100);
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error showing page:', error);
            }
        }

        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isMainListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }

        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) {
                statusText.textContent = message;
                console.log('üìù Status:', message);
            }
        }

        function clearSpeechText() {
            console.log('üóëÔ∏è Clearing speech display...');
            
            speechSynth.cancel();
            isSpeaking = false;
            
            const recognizedTextEl = document.getElementById('recognizedText');
            if (recognizedTextEl) {
                recognizedTextEl.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Ready for speech recognition...</div>';
            }
            
            console.log('‚úÖ Speech display cleared');
        }

        // === EVENT HANDLERS ===
        function setupEventHandlers() {
            try {
                // Main navigation buttons
                const buttons = [
                    {id: 'btnStartTalking', action: () => showPage('speech')},
                    {id: 'btnStartTexting', action: () => showPage('textInput')},
                    {id: 'btnPhoneCall', action: () => showPage('phone')},
                    {id: 'btnCommands', action: () => showPage('commands')},
                    {id: 'btnSettings', action: () => showPage('settings')}
                ];
                
                buttons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element) element.addEventListener('click', btn.action);
                });
                
                // Close buttons
                const closeBtns = [
                    'btnCloseSpeech', 'btnClosePhone', 'btnCloseCommands', 
                    'btnCloseText', 'btnCloseSettings'
                ];
                
                closeBtns.forEach(btnId => {
                    const element = document.getElementById(btnId);
                    if (element) element.addEventListener('click', () => showPage('home'));
                });
                
                // Speech page controls
                const listenButton = document.getElementById('listenButton');
                const clearButton = document.getElementById('clearButton');
                
                if (listenButton) listenButton.addEventListener('click', toggleListening);
                if (clearButton) clearButton.addEventListener('click', clearSpeechText);
                
                // Home buttons
                const homeBtns = [
                    'btnPhoneHome', 'btnTextHome', 'btnSettingsHome', 'btnCommandsHome'
                ];
                
                homeBtns.forEach(btnId => {
                    const element = document.getElementById(btnId);
                    if (element) element.addEventListener('click', () => showPage('home'));
                });
                
                // Text input functionality
                const speakTextBtn = document.getElementById('speakTextBtn');
                const textInputField = document.getElementById('largeTextInputField');
                
                if (speakTextBtn) speakTextBtn.addEventListener('click', speakTextInput);
                if (textInputField) textInputField.addEventListener('input', updateTextSpeakButton);
                
                // Contact functionality
                const contactSearchInput = document.getElementById('contactSearchInput');
                const loadAllBtn = document.getElementById('loadAllContactsBtn');
                const loadSelectedBtn = document.getElementById('loadSelectedContactsBtn');
                
                if (contactSearchInput) contactSearchInput.addEventListener('input', (e) => filterContacts(e.target.value));
                if (loadAllBtn) loadAllBtn.addEventListener('click', loadAllContacts);
                if (loadSelectedBtn) loadSelectedBtn.addEventListener('click', loadSelectedContacts);
                
                // Settings
                const speechSpeedSlider = document.getElementById('speechSpeedSlider');
                const pauseSlider = document.getElementById('pauseBetweenWordsSlider');
                
                if (speechSpeedSlider) speechSpeedSlider.addEventListener('input', (e) => updateSpeechSpeed(e.target.value));
                if (pauseSlider) pauseSlider.addEventListener('input', (e) => updatePauseBetweenWords(e.target.value));
                
                console.log('‚úÖ Event handlers set up successfully');
                
            } catch (error) {
                console.error('‚ùå Error setting up event handlers:', error);
            }
        }

        function speakTextInput() {
            const textField = document.getElementById('largeTextInputField');
            if (textField && textField.value.trim()) {
                speakText(textField.value.trim());
            }
        }

        function updateTextSpeakButton() {
            const speakBtn = document.getElementById('speakTextBtn');
            const textField = document.getElementById('largeTextInputField');
            
            if (speakBtn && textField) {
                if (textField.value.trim()) {
                    speakBtn.disabled = false;
                    speakBtn.style.opacity = '1';
                } else {
                    speakBtn.disabled = true;
                    speakBtn.style.opacity = '0.5';
                }
            }
        }

        // === CONTACTS (UNCHANGED) ===
        function initializeContacts() {
            contacts = [
                { name: 'Emergency Services', phone: '911' },
                { name: 'Demo Contact 1', phone: '(555) 123-4567' },
                { name: 'Demo Contact 2', phone: '(555) 987-6543' },
                { name: 'Demo Contact 3', phone: '(555) 246-8135' }
            ];
            filteredContacts = contacts.slice();
        }

        async function loadAllContacts() {
            const contactsList = document.getElementById('contactsList');
            const loadingSection = document.getElementById('contactLoadingSection');
            
            if (loadingSection) loadingSection.style.display = 'none';
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px; border: 2px solid #669900;">
                        <p><strong>üìû LOADING ALL CONTACTS</strong></p>
                        <p style="margin: 10px 0;">Opening contact picker...</p>
                    </div>
                `;
            }
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList && contactList.length > 0) {
                        const processedContacts = [];
                        contactList.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            const contactName = names[0] || 'Unknown Contact';
                            
                            if (phones.length > 0) {
                                phones.forEach((phone, phoneIndex) => {
                                    processedContacts.push({
                                        name: phones.length > 1 ? `${contactName} (${phoneIndex + 1})` : contactName,
                                        phone: phone
                                    });
                                });
                            } else {
                                processedContacts.push({
                                    name: contactName,
                                    phone: 'No phone number'
                                });
                            }
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        throw new Error('No contacts selected');
                    }
                } else {
                    throw new Error('Contacts API not supported on this device/browser');
                }
            } catch (error) {
                handleContactLoadingError(error, contactsList);
            }
        }

        async function loadSelectedContacts() {
            const contactsList = document.getElementById('contactsList');
            const loadingSection = document.getElementById('contactLoadingSection');
            
            if (loadingSection) loadingSection.style.display = 'none';
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: #0099cc; background: #f0f8ff; border-radius: 8px;">
                        <p><strong>üìã Choose Specific Contacts</strong></p>
                        <p>‚è≥ Opening contact picker...</p>
                    </div>
                `;
            }
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const contactList = await navigator.contacts.select(props, opts);
                    
                    if (contactList.length > 0) {
                        const processedContacts = contactList.map(contact => {
                            const name = (contact.name && contact.name[0]) ? contact.name[0] : 'Unknown';  
                            const phone = (contact.tel && contact.tel[0]) ? contact.tel[0] : 'No phone';
                            return { name, phone };
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) => 
                            index === self.findIndex(c => c.name === contact.name && c.phone === contact.phone)
                        );
                        
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        displayRealContactsOnPhonePage();
                    } else {
                        if (contactsList) {
                            contactsList.innerHTML = `
                                <div style="padding: 20px; text-align: center; color: #ff6600; border: 2px solid #ff6600; border-radius: 8px;">
                                    <p><strong>üì± No Contacts Selected</strong></p>
                                    <p>Demo contacts remain available</p>
                                </div>
                            `;
                        }
                        setTimeout(() => displayContactsOnPhonePage(), 3000);
                    }
                } else {
                    throw new Error('Contacts API not supported on this device/browser');
                }
            } catch (error) {
                handleContactLoadingError(error, contactsList);
            }
        }

        function handleContactLoadingError(error, contactsList) {
            let errorMessage = '';
            if (error.name === 'NotAllowedError') {
                errorMessage = `<p><strong>üì± Permission Denied</strong></p><p>You denied contact access</p>`;
            } else if (error.name === 'AbortError') {
                errorMessage = `<p><strong>üì± Contact Selection Cancelled</strong></p>`;
            } else if (error.message.includes('not supported')) {
                errorMessage = `<p><strong>üì± Contacts API Not Supported</strong></p><p>Requires Chrome Android or Safari iOS</p>`;
            } else {
                errorMessage = `<p><strong>üì± Contact Loading Error</strong></p><p>${error.message || 'Unknown error'}</p>`;
            }
            
            if (contactsList) {
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px;">
                        ${errorMessage}
                        <p style="margin-top: 15px;">Demo contacts will remain available</p>
                    </div>
                `;
            }
            
            setTimeout(() => displayContactsOnPhonePage(), 4000);
        }

        function displayRealContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';

            const successHeader = document.createElement('div');
            successHeader.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: white; background: #28a745; border-radius: 8px; margin-bottom: 8px;';
            successHeader.innerHTML = `‚úÖ SUCCESS: ${filteredContacts.length} REAL contacts loaded!`;
            contactsList.appendChild(successHeader);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.style.backgroundColor = '#e8f5e8';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });

            const footerNote = document.createElement('div');
            footerNote.style.cssText = 'padding: 8px; text-align: center; font-size: 12px; color: #28a745; font-weight: bold; margin-top: 8px;';
            footerNote.textContent = 'üì± These are YOUR real contacts - searchable and callable!';
            contactsList.appendChild(footerNote);
        }

        function displayContactsOnPhonePage() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><p><strong>üì± No contacts found</strong></p></div>';
                return;
            }

            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: #669900; background: #f0f8ff; border-radius: 8px; margin-bottom: 8px;';
            headerDiv.textContent = `üì± ${filteredContacts.length} contacts available - Tap any contact to call`;
            contactsList.appendChild(headerDiv);

            filteredContacts.forEach((contact) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });
        }

        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    return contact.name.toLowerCase().includes(searchLower) ||
                           contact.phone.replace(/[^0-9]/g, '').includes(searchTerm.replace(/[^0-9]/g, ''));
                });
            }
            displayContactsOnPhonePage();
        }

        function callContact(contact) {
            const phoneNumber = contact.phone.replace(/[^0-9]/g, '');
            if (phoneNumber) {
                window.location.href = `tel:${phoneNumber}`;
            }
        }

        // === SETTINGS ===
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) {
                    Object.assign(settings, JSON.parse(savedSettings));
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            updateSettingsUI();
        }

        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        function updateSettingsUI() {
            const speedSlider = document.getElementById('speechSpeedSlider');
            const pauseSlider = document.getElementById('pauseBetweenWordsSlider');

            if (speedSlider) speedSlider.value = settings.speechSpeed;
            if (pauseSlider) pauseSlider.value = settings.pauseBetweenWords;

            updateSpeechSpeed(settings.speechSpeed);
            updatePauseBetweenWords(settings.pauseBetweenWords);
        }

        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            const slider = document.getElementById('speechSpeedSlider');
            
            if (label) {
                const formattedValue = Math.round(parseFloat(value) * 10) / 10;
                label.textContent = formattedValue === 1.0 ? 'Normal (1.0x)' : formattedValue + 'x';
            }
            if (slider) {
                slider.value = value;
            }
            saveSettings();
        }

        function updatePauseBetweenWords(value) {
            settings.pauseBetweenWords = parseFloat(value);
            const label = document.getElementById('pauseBetweenWordsValue');
            const slider = document.getElementById('pauseBetweenWordsSlider');
            
            if (label) {
                const formattedValue = Math.round(parseFloat(value) * 10) / 10;
                label.textContent = formattedValue + ' seconds';
            }
            if (slider) {
                slider.value = value;
            }
            
            saveSettings();
        }

        // === INITIALIZATION ===
        function initApp() {
            console.log('üöÄ Initializing Leslie Speech Assistant (SAFE MODE)...');
            
            if (isInitialized) {
                console.log('‚ö†Ô∏è App already initialized, skipping...');
                return;
            }
            
            try {
                loadSettings();
                setupEventHandlers();
                
                // Check speech recognition support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.error('‚ùå Speech recognition not supported');
                    updateStatus('‚ùå Speech recognition not supported in this browser');
                    
                    const recognizedTextEl = document.getElementById('recognizedText');
                    if (recognizedTextEl) {
                        recognizedTextEl.innerHTML = '<div style="color: #cc0000; font-weight: bold; text-align: center; padding: 20px; font-size: 18px;">‚ùå Speech Recognition Not Supported<br><br>Please use Chrome, Edge, or Safari</div>';
                    }
                    return;
                }
                
                console.log('‚úÖ Speech Recognition supported');
                
                initializeContacts();
                updateTextSpeakButton();
                
                isInitialized = true;
                
                console.log('‚úÖ Leslie Speech Assistant initialized successfully (SAFE MODE)!');
                
            } catch (error) {
                console.error('‚ùå Error during initialization:', error);
                updateStatus('‚ùå Initialization error - please refresh page');
            }
        }

        // === EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing Leslie...');
            try {
                initApp();
            } catch (error) {
                console.error('‚ùå Error during DOMContentLoaded initialization:', error);
            }
        });

        window.addEventListener('load', function() {
            if (!isInitialized) {
                console.log('üîÑ Window loaded - attempting backup initialization...');
                try {
                    initApp();
                } catch (error) {
                    console.error('‚ùå Error during backup initialization:', error);
                }
            }
        });
    </script>
</body>
</html>
