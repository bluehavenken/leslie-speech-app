<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... 100% of your original <head> and CSS ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        /* ... ALL YOUR CSS FROM ORIGINAL ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... ALL YOUR HTML FROM ORIGINAL ... -->
    </div>

    <script>
        // Global variables (unchanged)
        let recognition = null;
        let voiceCommandRecognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let currentPhrase = '';
        let isSpeaking = false;
        let finalTranscript = '';
        let microphonePermissionGranted = false;
        let voiceCommandActive = false;

        // Settings (unchanged)
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: ''
        };

        // --- 100% all your original functions below, only voice command setup is changed ---

        function initApp() {
            // ... Unchanged ...
            loadSettings();
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            setupSpeechRecognition();
            initializeContacts();
            setupSwipeDetection();
            setupBackButtonHandling();
            requestMicrophonePermission();
            updateEnhancedSectionVisibility();
            console.log('Leslie Speech Assistant initialized successfully');
        }

        // --- CHANGED: Voice Command Setup ---
        function requestMicrophonePermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        console.log('Microphone permission granted');
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        // SETUP ONLY ONCE!
                        setupVoiceCommandListener();
                    })
                    .catch(function(error) {
                        console.log('Microphone permission denied:', error);
                        microphonePermissionGranted = false;
                        alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                    });
            } else {
                alert('Microphone access not supported in this browser.');
            }
        }

        // --- CHANGED: Only setup ONCE, never repeatedly ---
        function setupVoiceCommandListener() {
            if (!microphonePermissionGranted) return;
            if (voiceCommandRecognition) return; // Only set up once!

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';

            voiceCommandRecognition.onstart = function() {
                voiceCommandActive = true;
                console.log('Voice command recognition active');
            };

            voiceCommandRecognition.onresult = function(event) {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.toLowerCase().trim();
                        console.log('Voice command heard:', transcript);
                        if (transcript.includes('hey leslie') || transcript.includes('leslie')) {
                            processVoiceCommand(transcript);
                        }
                    }
                }
            };

            voiceCommandRecognition.onerror = function(event) {
                console.log('Voice command error:', event.error);
                voiceCommandActive = false;
                if (event.error !== 'not-allowed') {
                    setTimeout(startVoiceCommandListening, 3000);
                }
            };

            voiceCommandRecognition.onend = function() {
                voiceCommandActive = false;
                console.log('Voice command recognition ended');
                if (currentPage !== 'speech' || !isListening) {
                    setTimeout(startVoiceCommandListening, 2000);
                }
            };

            // Start listening right away
            startVoiceCommandListening();
        }

        function startVoiceCommandListening() {
            if (!voiceCommandActive && voiceCommandRecognition && microphonePermissionGranted) {
                try {
                    voiceCommandRecognition.start();
                } catch (error) {
                    console.log('Voice command start failed:', error);
                }
            }
        }

        // --- EVERYTHING ELSE BELOW IS UNCHANGED (all your original app logic) ---

        function processVoiceCommand(transcript) {
            // ... unchanged ...
            if (transcript.includes('what time is it')) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                speak(`The current time is ${timeString}`);
            } else if (transcript.includes('what\'s the date') || transcript.includes('whats the date')) {
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                speak(`Today is ${dateString}`);
            } else if (transcript.includes('start talking')) {
                startTalkingFromHome();
                speak('Starting speech recognition');
            } else if (transcript.includes('go home')) {
                showPage('home');
                speak('Going to home page');
            } else if (transcript.includes('weather')) {
                showCurrentWeather();
                speak('Showing weather information');
            } else if (transcript.includes('close')) {
                hideWeather();
            } else if (transcript.includes('help')) {
                showPage('commands');
                speak('Showing Leslie commands');
            } else if (transcript.includes('clear text')) {
                clearSpeechText();
                speak('Text cleared');
            } else {
                speak('I heard you, but didn\'t understand the command. Say Hey Leslie help for available commands.');
            }
        }

        function speak(text) {
            if (settings.speakVoiceCommands && text.trim()) {
                speechSynth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynth.speak(utterance);
            }
        }

        // --- EVERYTHING ELSE: KEEP ALL YOUR APP'S JS CODE UNCHANGED BELOW ---
        // All navigation, speech recognition, contacts, weather, UI, etc.
        // (Not repeated here for brevityâ€”just use your original code)

        // --- PAGE VISIBILITY ---
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden');
            } else {
                console.log('Page visible');
                // Only try to restart listening, never setup again!
                if (microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                    setTimeout(startVoiceCommandListening, 1000);
                }
            }
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
        });
    </script>
</body>
</html>
