<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    üé§ START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    üìù START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    üìû PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    üó£Ô∏è LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Click START TALKING for speech recognition<br>
                    ‚Ä¢ Complete phrases will be spoken back to you<br>
                    ‚Ä¢ Click STOP LISTENING to end session<br>
                    ‚Ä¢ Works best with clear speech
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>üìû Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    üîç Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be displayed here -->
                </div>
                <div style="text-align: center; margin: 16px 0;">
                    <button onclick="loadAllContacts()" style="padding: 16px 32px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-right: 10px;">
                        üìû LOAD ALL MY CONTACTS
                    </button>
                    <button onclick="loadSelectedContacts()" style="padding: 16px 32px; background: #0099cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                        üìã SELECT CERTAIN CONTACTS
                    </button>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Works on Chrome Android & Safari iOS with HTTPS
                    </p>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">
                    üè† HOME
                </button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            üîä SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            üè† HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>üó£Ô∏è Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text">
                    <strong>How to Use Leslie:</strong><br><br>
                    <strong>üé§ Speech Recognition:</strong><br>
                    ‚Ä¢ Click "START TALKING" to begin<br>
                    ‚Ä¢ Speak clearly and complete phrases<br>
                    ‚Ä¢ Your speech will appear on screen<br>
                    ‚Ä¢ Leslie will speak back your complete phrase<br>
                    ‚Ä¢ Click "STOP LISTENING" to end<br><br>
                    <strong>üìû Phone Contacts:</strong><br>
                    ‚Ä¢ Click "LOAD ALL MY CONTACTS" to access all contacts<br>
                    ‚Ä¢ Click "SELECT CERTAIN CONTACTS" to choose specific ones<br>
                    ‚Ä¢ Search and tap any contact to call<br>
                    ‚Ä¢ Works with your device's contact list<br><br>
                    <strong>üìù Text Input:</strong><br>
                    ‚Ä¢ Type any message<br>
                    ‚Ä¢ Click "SPEAK TEXT" to hear it spoken<br><br>
                    <strong>Tips:</strong><br>
                    ‚Ä¢ Allow microphone permission when prompted<br>
                    ‚Ä¢ Speak clearly for best results<br>
                    ‚Ä¢ Complete phrases work better than single words
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie speaks back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ‚Üê Back
            </button>
        </div>
    </div>

    <script>
        // Simple working variables - BACK TO ORIGINAL WORKING VERSION
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [
            { name: 'Emergency Services', phone: '911' },
            { name: 'Demo Contact 1', phone: '(555) 123-4567' },
            { name: 'Demo Contact 2', phone: '(555) 987-6543' }
        ];
        let filteredContacts = contacts.slice();
        let isSpeaking = false;
        let phraseHistory = [];
        let finalPhraseSpoken = '';
        let speechSpeed = 1.0;

        // NEW: Variables for continuous listening but SIMPLIFIED
        let continuousListeningEnabled = false;
        let sessionStartTime = null;
        let maxSessionDuration = 3 * 60 * 1000; // 3 minutes in milliseconds
        let sessionTimeout = null;

        // Initialize app
        function initApp() {
            console.log('Initializing Leslie Speech Assistant...');
            setupEventHandlers();
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            
            setupSpeechRecognition();
            displayContacts(); // MAKE SURE CONTACTS SHOW IMMEDIATELY
            console.log('Leslie Speech Assistant initialized successfully!');
        }

        // Set up event handlers
        function setupEventHandlers() {
            document.getElementById('btnStartTalking').addEventListener('click', () => showPage('speech'));
            document.getElementById('btnStartTexting').addEventListener('click', () => showPage('textInput'));
            document.getElementById('btnPhoneCall').addEventListener('click', () => showPage('phone'));
            document.getElementById('btnCommands').addEventListener('click', () => showPage('commands'));
            document.getElementById('btnSettings').addEventListener('click', () => showPage('settings'));
            
            document.getElementById('btnCloseSpeech').addEventListener('click', () => showPage('home'));
            document.getElementById('btnClosePhone').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseCommands').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseText').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseSettings').addEventListener('click', () => showPage('home'));
            
            document.getElementById('listenButton').addEventListener('click', toggleListening);
            document.getElementById('btnPhoneHome').addEventListener('click', () => showPage('home'));
            document.getElementById('speakTextBtn').addEventListener('click', speakTextInput);
            document.getElementById('btnTextHome').addEventListener('click', () => showPage('home'));
            document.getElementById('btnSettingsHome').addEventListener('click', () => showPage('home'));
            
            document.getElementById('speechSpeedSlider').addEventListener('input', (e) => {
                speechSpeed = parseFloat(e.target.value);
                document.getElementById('speechSpeedValue').textContent = speechSpeed == 1.0 ? 'Normal (1.0x)' : speechSpeed + 'x';
            });
        }

        // RESTORED ORIGINAL WORKING SPEECH RECOGNITION - NO CASCADING
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening continuously 
            recognition.interimResults = false; // NO INTERIM - this was causing cascading
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                console.log('Recognition started - continuous mode');
                isListening = true;
                continuousListeningEnabled = true;
                updateListenButton();
                updateStatus('üé§ Listening continuously... Speak complete phrases!');
                
                // Start 3-minute session timer
                sessionStartTime = Date.now();
                sessionTimeout = setTimeout(() => {
                    console.log('Session timeout - stopping after 3 minutes');
                    stopListening();
                    updateStatus('Session ended - 3 minute limit reached. Click to restart.');
                }, maxSessionDuration);
            };

            recognition.onend = function() {
                console.log('Recognition ended');
                
                // Clear session timeout
                if (sessionTimeout) {
                    clearTimeout(sessionTimeout);
                    sessionTimeout = null;
                }
                
                // Only restart if we're still in continuous mode and on speech page
                if (continuousListeningEnabled && currentPage === 'speech') {
                    console.log('Restarting recognition for continuous listening');
                    setTimeout(() => {
                        if (continuousListeningEnabled && currentPage === 'speech' && !isListening) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('Error restarting recognition:', e);
                                stopListening();
                            }
                        }
                    }, 1000);
                } else {
                    isListening = false;
                    updateListenButton();
                    updateStatus('Click "START TALKING" to begin listening');
                }
            };

            recognition.onerror = function(event) {
                console.log('Recognition error:', event.error);
                
                if (event.error === 'no-speech') {
                    // Don't stop for no-speech, just continue
                    console.log('No speech detected - continuing to listen');
                } else {
                    // For other errors, stop and show message
                    stopListening();
                    updateStatus('Error: ' + event.error + ' - Click to try again');
                }
            };

            recognition.onresult = function(event) {
                console.log('Recognition result received');
                
                // Only process FINAL results - NO INTERIM to prevent cascading
                for (let i = 0; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.trim();
                        console.log('FINAL RESULT:', transcript);
                        
                        if (transcript && transcript.length > 1) {
                            // Skip duplicates
                            if (!phraseHistory.includes(transcript) && transcript !== finalPhraseSpoken) {
                                console.log('NEW UNIQUE PHRASE:', transcript);
                                phraseHistory.push(transcript);
                                if (phraseHistory.length > 5) phraseHistory.shift();
                                finalPhraseSpoken = transcript;
                                
                                updateDisplay(transcript, true);
                                updateStatus('‚úÖ Got it: ' + transcript + ' - Still listening...');
                                
                                // Speak the COMPLETE phrase
                                speakPhrase(transcript);
                            } else {
                                console.log('DUPLICATE PHRASE IGNORED:', transcript);
                            }
                        }
                        break; // Process only first final result
                    }
                }
            };
        }

        // RESTORED ORIGINAL WORKING SPEECH FUNCTION
        function speakPhrase(text) {
            console.log('SPEAKING FUNCTION CALLED WITH:', text);
            
            if (isSpeaking) {
                console.log('Already speaking, skipping');
                return;
            }
            
            // Cancel any existing speech first
            speechSynth.cancel();
            
            // Wait for speech synth to be ready
            setTimeout(() => {
                console.log('Starting speech synthesis for:', text);
                isSpeaking = true;
                
                const utterance = new SpeechSynthesisUtterance();
                utterance.text = text;
                utterance.lang = 'en-US';
                utterance.rate = speechSpeed;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onstart = function() {
                    console.log('SPEECH STARTED:', this.text);
                };
                
                utterance.onend = function() {
                    console.log('SPEECH COMPLETED:', this.text);
                    isSpeaking = false;
                };
                
                utterance.onerror = function(event) {
                    console.error('SPEECH ERROR:', event.error);
                    isSpeaking = false;
                };
                
                speechSynth.speak(utterance);
                
            }, 500);
        }

        // RESTORED ORIGINAL DISPLAY - NO CASCADING
        function updateDisplay(text, isFinal) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (!recognizedTextEl) return;
            
            let html = '';
            
            // Show recent final phrases ONLY
            if (phraseHistory.length > 0) {
                phraseHistory.forEach((phrase, index) => {
                    const isLatest = index === phraseHistory.length - 1;
                    html += '<div class="final-phrase">' + (isLatest ? '‚úÖ ' : '‚Ä¢ ') + phrase + '</div>';
                });
            }
            
            if (html) {
                recognizedTextEl.innerHTML = html;
            } else {
                recognizedTextEl.innerHTML = '<div style="color: #666; font-style: italic;">Say something and it will appear here...</div>';
            }
        }

        // Toggle listening
        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // Start listening
        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.log('Error starting recognition:', error);
                    updateStatus('Error starting recognition. Please try again.');
                }
            }
        }

        // IMPROVED: Stop listening properly
        function stopListening() {
            console.log('Stopping continuous listening');
            continuousListeningEnabled = false;
            
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
            
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                }
            }
            
            isListening = false;
            updateListenButton();
            updateStatus('Stopped listening. Click "START TALKING" to restart.');
        }

        // Update listen button
        function updateListenButton() {
            const btn = document.getElementById('listenButton');
            if (btn) {
                if (isListening) {
                    btn.textContent = 'STOP LISTENING';
                    btn.className = 'control-btn btn-stop';
                } else {
                    btn.textContent = 'START TALKING';
                    btn.className = 'control-btn btn-listen';
                }
            }
        }

        // Update status
        function updateStatus(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) statusEl.textContent = message;
        }

        // Speak text input
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                speakPhrase(text);
            }
        }

        // SIMPLIFIED: Load ALL contacts automatically
        async function loadAllContacts() {
            const contactsList = document.getElementById('contactsList');
            
            contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px;"><p><strong>üì± Loading ALL your contacts...</strong></p><p>This will load all your contacts automatically</p><p>Please allow permission when prompted</p></div>';
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    console.log('Requesting ALL contacts from device...');
                    
                    const properties = ['name', 'tel', 'email'];
                    const options = { multiple: true };
                    
                    const allContacts = await navigator.contacts.select(properties, options);
                    console.log('Retrieved', allContacts.length, 'contacts from device');
                    
                    if (allContacts && allContacts.length > 0) {
                        const processedContacts = [];
                        
                        allContacts.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            const emails = contact.email || [];
                            
                            const contactName = names[0] || 'Unknown Contact';
                            
                            // Add phone numbers
                            if (phones.length > 0) {
                                phones.forEach(phone => {
                                    processedContacts.push({
                                        name: contactName,
                                        phone: phone,
                                        type: 'phone'
                                    });
                                });
                            }
                            
                            // Add emails
                            if (emails.length > 0) {
                                emails.forEach(email => {
                                    processedContacts.push({
                                        name: contactName + ' (Email)',
                                        phone: email,
                                        type: 'email'
                                    });
                                });
                            }
                            
                            // Add contact even without phone/email
                            if (phones.length === 0 && emails.length === 0) {
                                processedContacts.push({
                                    name: contactName,
                                    phone: 'No contact info',
                                    type: 'other'
                                });
                            }
                        });
                        
                        // Remove duplicates
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        // Replace contacts array
                        contacts = [
                            { name: 'Emergency Services', phone: '911', type: 'emergency' },
                            ...uniqueContacts.sort((a, b) => a.name.localeCompare(b.name))
                        ];
                        filteredContacts = contacts.slice();
                        
                        console.log('SUCCESS: Loaded', contacts.length, 'contacts');
                        displayContacts();
                        
                    } else {
                        throw new Error('No contacts were returned');
                    }
                    
                } else {
                    throw new Error('Contacts API not supported');
                }
                
            } catch (error) {
                console.error('Contact loading error:', error);
                
                let errorMsg = 'Error loading contacts: ' + error.message;
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'üö´ Permission denied. Please refresh and allow contact access.';
                } else if (error.name === 'AbortError') {
                    errorMsg = 'üì± Contact loading cancelled. Try again to load contacts.';
                }
                
                contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px;"><p><strong>‚ùå ${errorMsg}</strong></p><p>Demo contacts shown below:</p></div>`;
                
                setTimeout(() => {
                    displayContacts();
                }, 3000);
            }
        }

        // Load selected contacts
        async function loadSelectedContacts() {
            const contactsList = document.getElementById('contactsList');
            
            contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #0099cc; background: #f0f8ff; border-radius: 8px;"><p><strong>üìã Select Specific Contacts</strong></p><p>Choose individual contacts from the picker</p><p>Select as many as you want</p></div>';
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const properties = ['name', 'tel', 'email'];
                    const options = { multiple: true };
                    
                    const selectedContacts = await navigator.contacts.select(properties, options);
                    
                    if (selectedContacts && selectedContacts.length > 0) {
                        // Same processing as loadAllContacts but with selected contacts
                        const processedContacts = [];
                        
                        selectedContacts.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            const emails = contact.email || [];
                            
                            const contactName = names[0] || 'Unknown Contact';
                            
                            if (phones.length > 0) {
                                phones.forEach(phone => {
                                    processedContacts.push({
                                        name: contactName,
                                        phone: phone,
                                        type: 'phone'
                                    });
                                });
                            }
                            
                            if (emails.length > 0) {
                                emails.forEach(email => {
                                    processedContacts.push({
                                        name: contactName + ' (Email)',
                                        phone: email,
                                        type: 'email'
                                    });
                                });
                            }
                        });
                        
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        contacts = [
                            { name: 'Emergency Services', phone: '911', type: 'emergency' },
                            ...uniqueContacts.sort((a, b) => a.name.localeCompare(b.name))
                        ];
                        filteredContacts = contacts.slice();
                        
                        displayContacts();
                        
                    } else {
                        throw new Error('No contacts selected');
                    }
                    
                } else {
                    throw new Error('Contacts API not supported');
                }
                
            } catch (error) {
                console.error('Contact selection error:', error);
                
                let errorMsg = 'Error selecting contacts: ' + error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'üì± Contact selection cancelled.';
                }
                
                contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #ff8800; border: 2px solid #ff8800; border-radius: 8px;"><p><strong>‚ö†Ô∏è ${errorMsg}</strong></p><p>Demo contacts shown below:</p></div>`;
                
                setTimeout(() => {
                    displayContacts();
                }, 3000);
            }
        }

        // FIXED: Display contacts - ALWAYS SHOW CONTACTS
        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            contactsList.innerHTML = ''; // Clear first
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;"><p>No contacts to display</p></div>';
                return;
            }
            
            filteredContacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                
                // Style based on type
                if (contact.name === 'Emergency Services' || contact.type === 'emergency') {
                    contactEl.style.backgroundColor = '#ffe6e6';
                    contactEl.style.borderLeft = '4px solid #cc0000';
                } else if (contact.type === 'email') {
                    contactEl.style.backgroundColor = '#f0f8ff';
                    contactEl.style.borderLeft = '4px solid #0066cc';
                } else if (contact.name.includes('Demo')) {
                    contactEl.style.backgroundColor = '#f8f8f8';
                    contactEl.style.borderLeft = '4px solid #999';
                } else {
                    contactEl.style.backgroundColor = '#e8f5e8';
                    contactEl.style.borderLeft = '4px solid #669900';
                }
                
                const typeIcon = contact.type === 'emergency' ? 'üö®' : 
                               contact.type === 'email' ? 'üìß' : 'üìû';
                
                contactEl.innerHTML = `
                    <div class="contact-name">${typeIcon} ${contact.name}</div>
                    <div class="contact-phone">${contact.phone}</div>
                `;
                
                contactEl.addEventListener('click', () => callContact(contact));
                contactsList.appendChild(contactEl);
            });
        }

        // Filter contacts
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const search = searchTerm.toLowerCase();
                filteredContacts = contacts.filter(contact => 
                    contact.name.toLowerCase().includes(search) ||
                    contact.phone.toLowerCase().includes(search)
                );
            }
            displayContacts();
        }

        // Call contact
        function callContact(contact) {
            console.log('Calling:', contact.name, contact.phone);
            
            if (contact.type === 'email') {
                window.location.href = 'mailto:' + contact.phone;
            } else {
                const cleanPhone = contact.phone.replace(/[^0-9]/g, '');
                window.location.href = 'tel:' + cleanPhone;
            }
        }

        // Show page
        function showPage(pageId) {
            // Stop listening when leaving speech page
            if (currentPage === 'speech' && pageId !== 'speech') {
                stopListening();
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (pageId === 'phone') {
                    displayContacts(); // ALWAYS show contacts when entering phone page
                } else if (pageId === 'speech') {
                    // Reset speech page
                    updateStatus('Ready to listen - Click "START TALKING" below');
                    phraseHistory = [];
                    finalPhraseSpoken = '';
                    updateDisplay('', true);
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
