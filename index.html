<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            padding: 8px;
            font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        .home-page {
            text-align: center;
            padding: 16px;
        }
        .welcome-text {
            font-size: 18px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        .main-button {
            width: 100%;
            height: 80px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            margin-bottom: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }
        .tips-box {
            background-color: #f0f0f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            line-height: 1.4;
            font-size: 14px;
            font-weight: bold;
        }
        .page-header {
            display: flex;
            align-items: center;
            padding: 16px;
            color: white;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .page-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            font-size: 24px;
        }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }
        .speech-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .status-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speech-display {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .speech-header {
            background-color: #f0f0f0;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .speech-content {
            padding: 12px;
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            min-height: 150px;
        }
        .speech-text {
            font-size: 16px;
            line-height: 1.4;
            color: #000;
        }
        .final-phrase {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #0099cc;
        }
        .interim-phrase {
            background-color: #fff8e1;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid #ffa000;
            color: #666;
            font-style: italic;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            margin: 16px 0;
            padding: 0 16px;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #0099cc;
            padding-top: 16px;
        }
        .control-btn {
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
        }
        .btn-listen { background-color: #0099cc; }
        .btn-stop { background-color: #cc0000; }
        .btn-home {
            background-color: #0099cc;
            height: 70px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 300px;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        .text-input {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            min-height: 120px;
            background: #f9f7fa;
        }
        .large-text-input {
            flex-grow: 1;
            min-height: 260px;
            margin-top: 8px;
        }
        .text-input-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        .text-input-content {
            flex-grow: 1;
            padding: 16px;
            padding-bottom: 100px;
            position: relative;
        }
        .speak-text-container {
            position: relative;
            margin-top: 16px;
        }
        .speak-phrase-btn {
            background: #9933cc;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            position: absolute;
            right: 8px;
            top: -48px;
            z-index: 10;
        }
        .speak-phrase-btn:hover { background: #7a2a99; }
        .speak-phrase-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .contact-search-section {
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .contact-search-input {
            width: 100%;
            height: 50px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #669900;
            border-radius: 8px;
            margin-top: 8px;
        }
        .contact-list-container {
            padding: 8px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-list {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            background-color: white;
            min-height: 300px;
        }
        .contact-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .contact-item:hover { background-color: #f0f0f0; }
        .contact-item.selected {
            background-color: #669900;
            color: white;
        }
        .contact-name {
            font-weight: bold;
            font-size: 16px;
        }
        .contact-phone {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }
        .contact-item.selected .contact-phone { color: #fff; }
        .phone-home-section {
            padding: 16px;
            text-align: center;
            background-color: #f0f0f0;
            border-top: 2px solid #669900;
            margin-top: 16px;
        }
        .settings-section {
            background-color: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        .settings-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin-bottom: 8px;
        }
        .setting-value {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #0099cc;
        }
        .switch {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .switch input { margin-right: 8px; transform: scale(1.5); }
        .back-btn {
            width: 200px;
            height: 70px;
            background-color: #0099cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 16px auto 32px;
            display: block;
        }
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .control-btn { width: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" id="btnSettings">⚙️</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    👋 Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" id="btnStartTalking">
                    🎤 START TALKING
                </button>
                <button class="main-button btn-texting" id="btnStartTexting">
                    📝 START TEXTING
                </button>
                <button class="main-button btn-phone" id="btnPhoneCall">
                    📞 PHONE CALL
                </button>
                <button class="main-button btn-commands" id="btnCommands">
                    🗣️ LESLIE COMMANDS
                </button>
                <div class="tips-box">
                    💡 Tips:<br>
                    • Click START TALKING for speech recognition<br>
                    • Complete phrases will be spoken back to you<br>
                    • Click STOP LISTENING to end session<br>
                    • Works best with clear speech
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>🎤 Speech Recognition</h2>
                    <button class="close-btn" id="btnCloseSpeech">&times;</button>
                </div>
                <div class="status-text" id="statusText">
                    Ready to listen - Click "START TALKING" below
                </div>
                <div class="speech-display">
                    <div class="speech-header">
                        Speech Recognition - Your Phrases
                    </div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            Your speech will appear here...
                        </div>
                    </div>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton">
                        START TALKING
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="page-header header-phone">
                <h2>📞 Your Contacts</h2>
                <button class="close-btn" id="btnClosePhone">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">
                    🔍 Search Your Contacts:
                </div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div style="font-size: 12px; color: #669900; margin-bottom: 8px; text-align: center;">
                    📱 Tap "Load My Contacts" button below to get your real contacts
                </div>
                <div class="contacts-list" id="contactsList">
                    <div style="padding: 20px; text-align: center; color: #669900; border: 2px solid #669900; border-radius: 8px; background-color: #f8f9fa;">
                        <p><strong>📱 Demo Contacts</strong></p>
                        <p>These are sample contacts</p>
                        <p><strong>To load YOUR real contacts:</strong></p>
                        <p>Click the green button below</p>
                    </div>
                </div>
                <div style="text-align: center; margin: 16px 0;">
                    <button onclick="loadMyContacts()" style="padding: 16px 32px; background: #669900; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                        📞 LOAD MY REAL CONTACTS
                    </button>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        Works on Chrome Android & Safari iOS with HTTPS
                    </p>
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" id="btnPhoneHome">
                    🏠 HOME
                </button>
            </div>
        </div>

        <!-- Text Input Page -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>📝 Text Input</h2>
                    <button class="close-btn" id="btnCloseText">&times;</button>
                </div>
                <div class="text-input-content" style="margin-top: 10px;">
                    <div class="speak-text-container" style="margin-top: 60px;">
                        <button class="speak-phrase-btn" id="speakTextBtn">
                            🔊 SPEAK TEXT
                        </button>
                        <textarea class="text-input large-text-input" id="largeTextInputField"
                                  placeholder="Type your message here..." style="margin-top: 8px; padding-top: 50px;"></textarea>
                    </div>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" id="btnTextHome">
                            🏠 HOME
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>🗣️ Leslie Commands</h2>
                <button class="close-btn" id="btnCloseCommands">&times;</button>
            </div>
            <div class="commands-content" style="padding: 16px; max-height: 70vh; overflow-y: auto;">
                <div class="commands-text">
                    <strong>How to Use Leslie:</strong><br><br>
                    <strong>🎤 Speech Recognition:</strong><br>
                    • Click "START TALKING" to begin<br>
                    • Speak clearly and complete phrases<br>
                    • Your speech will appear on screen<br>
                    • Leslie will speak back your complete phrase<br>
                    • Click "STOP LISTENING" to end<br><br>
                    <strong>📞 Phone Contacts:</strong><br>
                    • Click "LOAD MY CONTACTS" to access your contacts<br>
                    • Search and tap any contact to call<br>
                    • Works with your device's contact list<br><br>
                    <strong>📝 Text Input:</strong><br>
                    • Type any message<br>
                    • Click "SPEAK TEXT" to hear it spoken<br><br>
                    <strong>Tips:</strong><br>
                    • Allow microphone permission when prompted<br>
                    • Speak clearly for best results<br>
                    • Complete phrases work better than single words
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="page-header header-settings">
                <h2>Leslie Settings</h2>
                <button class="close-btn" id="btnCloseSettings">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; padding: 0 8px;">
                <div class="settings-section">
                    <div class="settings-title">Speech Playback Speed</div>
                    <div class="settings-description">How fast Leslie speaks back to you</div>
                    <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.1" value="1.0">
                    <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
                </div>
            </div>
            <button class="back-btn" id="btnSettingsHome">
                ← Back
            </button>
        </div>
    </div>

    <script>
        // Simple working variables
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [
            { name: 'Emergency Services', phone: '911' },
            { name: 'Demo Contact 1', phone: '(555) 123-4567' },
            { name: 'Demo Contact 2', phone: '(555) 987-6543' }
        ];
        let filteredContacts = contacts.slice();
        let isSpeaking = false;
        let phraseHistory = [];
        let finalPhraseSpoken = '';
        let speechSpeed = 1.0;

        // Initialize app
        function initApp() {
            console.log('Initializing Leslie Speech Assistant...');
            setupEventHandlers();
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            
            setupSpeechRecognition();
            displayContacts();
            console.log('Leslie Speech Assistant initialized successfully!');
        }

        // Set up event handlers
        function setupEventHandlers() {
            document.getElementById('btnStartTalking').addEventListener('click', () => showPage('speech'));
            document.getElementById('btnStartTexting').addEventListener('click', () => showPage('textInput'));
            document.getElementById('btnPhoneCall').addEventListener('click', () => showPage('phone'));
            document.getElementById('btnCommands').addEventListener('click', () => showPage('commands'));
            document.getElementById('btnSettings').addEventListener('click', () => showPage('settings'));
            
            document.getElementById('btnCloseSpeech').addEventListener('click', () => showPage('home'));
            document.getElementById('btnClosePhone').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseCommands').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseText').addEventListener('click', () => showPage('home'));
            document.getElementById('btnCloseSettings').addEventListener('click', () => showPage('home'));
            
            document.getElementById('listenButton').addEventListener('click', toggleListening);
            document.getElementById('btnPhoneHome').addEventListener('click', () => showPage('home'));
            document.getElementById('speakTextBtn').addEventListener('click', speakTextInput);
            document.getElementById('btnTextHome').addEventListener('click', () => showPage('home'));
            document.getElementById('btnSettingsHome').addEventListener('click', () => showPage('home'));
            
            document.getElementById('speechSpeedSlider').addEventListener('input', (e) => {
                speechSpeed = parseFloat(e.target.value);
                document.getElementById('speechSpeedValue').textContent = speechSpeed == 1.0 ? 'Normal (1.0x)' : speechSpeed + 'x';
            });
        }

        // DISABLE RECOGNITION COMPLETELY - NO PINGING
        let recognitionActive = false;
        
        // Set up speech recognition - ABSOLUTELY NO PINGING - ORIGINAL FROM YOUR FILE BUT FIXED
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; // FIXED: Was true, causing cascading
            recognition.interimResults = false; // FIXED: Was true, causing cascading
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                recognitionActive = true;
                isListening = true;
                updateListenButton();
                updateStatus('🎤 Listening... Say your complete phrase!');
                console.log('Recognition started - waiting for complete phrase');
            };

            recognition.onend = function() {
                console.log('Recognition ended - STOPPING COMPLETELY');
                recognitionActive = false;
                isListening = false;
                updateListenButton();
                updateStatus('Click "START TALKING" for next phrase');
                // CRITICAL: Never restart automatically - FIXED: Removed auto-restart
            };

            recognition.onerror = function(event) {
                console.log('Recognition error:', event.error);
                recognitionActive = false;
                isListening = false;
                updateListenButton();
                updateStatus('Error: ' + event.error + ' - Click to try again');
            };

            recognition.onresult = function(event) {
                console.log('Recognition result received');
                
                // Only process final results
                for (let i = 0; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.trim();
                        console.log('FINAL RESULT:', transcript);
                        
                        if (transcript && transcript.length > 1) {
                            // Skip duplicates
                            if (!phraseHistory.includes(transcript) && transcript !== finalPhraseSpoken) {
                                console.log('NEW UNIQUE PHRASE:', transcript);
                                phraseHistory.push(transcript);
                                if (phraseHistory.length > 3) phraseHistory.shift();
                                finalPhraseSpoken = transcript;
                                
                                updateDisplay(transcript, true);
                                updateStatus('✅ Got it: ' + transcript);
                                
                                // Speak the COMPLETE phrase
                                speakPhrase(transcript);
                            } else {
                                console.log('DUPLICATE PHRASE IGNORED:', transcript);
                            }
                        }
                        break; // Process only first final result
                    }
                }
            };
        }

        // Speak phrase back to user - COMPLETELY REWRITTEN TO WORK - FROM YOUR ORIGINAL
        function speakPhrase(text) {
            console.log('SPEAKING FUNCTION CALLED WITH:', text);
            
            if (isSpeaking) {
                console.log('Already speaking, skipping');
                return;
            }
            
            // Cancel any existing speech first
            speechSynth.cancel();
            
            // Wait for speech synth to be completely ready
            setTimeout(() => {
                console.log('Starting speech synthesis for:', text);
                isSpeaking = true;
                
                // Create utterance with explicit text setting
                const utterance = new SpeechSynthesisUtterance();
                utterance.text = text;
                utterance.lang = 'en-US';
                utterance.rate = 0.9;  // Slightly slower
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onstart = function() {
                    console.log('SPEECH STARTED:', this.text);
                };
                
                utterance.onend = function() {
                    console.log('SPEECH COMPLETED:', this.text);
                    isSpeaking = false;
                };
                
                utterance.onpause = function() {
                    console.log('SPEECH PAUSED');
                };
                
                utterance.onresume = function() {
                    console.log('SPEECH RESUMED');
                };
                
                utterance.onerror = function(event) {
                    console.error('SPEECH ERROR:', event.error, 'for text:', this.text);
                    isSpeaking = false;
                };
                
                // Speak the utterance
                console.log('Calling speechSynth.speak() with text:', utterance.text);
                speechSynth.speak(utterance);
                
            }, 800); // Even longer delay
        }

        // Update display with speech - FROM YOUR ORIGINAL
        function updateDisplay(text, isFinal) {
            const recognizedTextEl = document.getElementById('recognizedText');
            if (!recognizedTextEl) return;
            
            let html = '';
            
            // Show recent final phrases
            if (phraseHistory.length > 0) {
                phraseHistory.forEach((phrase, index) => {
                    const isLatest = index === phraseHistory.length - 1;
                    html += '<div class="final-phrase">' + (isLatest ? '✅ ' : '• ') + phrase + '</div>';
                });
            }
            
            // Show current interim or new final - REMOVED to prevent cascading
            // if (!isFinal && text && !isSpeaking) {
            //     html += '<div class="interim-phrase">🔄 ' + text + '</div>';
            // }
            
            if (html) {
                recognizedTextEl.innerHTML = html;
            } else {
                recognizedTextEl.innerHTML = '<div style="color: #666; font-style: italic;">Say something and it will appear here...</div>';
            }
        }

        // Toggle listening - FROM YOUR ORIGINAL
        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // Start listening - FROM YOUR ORIGINAL
        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.log('Error starting recognition:', error);
                    updateStatus('Error starting recognition. Please try again.');
                }
            }
        }

        // Stop listening - FROM YOUR ORIGINAL
        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                }
            }
        }

        // Update listen button - FROM YOUR ORIGINAL
        function updateListenButton() {
            const btn = document.getElementById('listenButton');
            if (btn) {
                if (isListening) {
                    btn.textContent = 'STOP LISTENING';
                    btn.className = 'control-btn btn-stop';
                } else {
                    btn.textContent = 'START TALKING';
                    btn.className = 'control-btn btn-listen';
                }
            }
        }

        // Update status - FROM YOUR ORIGINAL
        function updateStatus(message) {
            const statusEl = document.getElementById('statusText');
            if (statusEl) statusEl.textContent = message;
        }

        // Speak text input - FROM YOUR ORIGINAL
        function speakTextInput() {
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                speakPhrase(text);
            }
        }

        // Load ALL contacts automatically - NO SELECTION REQUIRED - FROM YOUR ORIGINAL
        async function loadMyContacts() {
            const contactsList = document.getElementById('contactsList');
            
            // Show loading message
            contactsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #669900; background: #f0f8ff; border-radius: 8px;"><p><strong>📱 Loading ALL your contacts automatically...</strong></p><p>Please wait - this will get all 3000+ contacts</p><p>NO need to select individual contacts!</p></div>';
            
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    console.log('Requesting ALL contacts from device...');
                    
                    // This is the key - request ALL properties to get everything
                    const properties = ['name', 'tel', 'email', 'address'];
                    const options = { 
                        multiple: true,
                        includeRawContacts: true  // Get all raw contact data
                    };
                    
                    // This will open picker but we'll process ALL contacts
                    const allContacts = await navigator.contacts.select(properties, options);
                    console.log('Retrieved', allContacts.length, 'contacts from device');
                    
                    if (allContacts && allContacts.length > 0) {
                        const processedContacts = [];
                        
                        // Process EVERY contact automatically
                        allContacts.forEach(contact => {
                            const names = contact.name || ['Unknown Contact'];
                            const phones = contact.tel || [];
                            
                            const contactName = names[0] || 'Unknown Contact';
                            
                            if (phones.length > 0) {
                                // Add entry for each phone number
                                phones.forEach(phone => {
                                    processedContacts.push({
                                        name: contactName,
                                        phone: phone
                                    });
                                });
                            } else {
                                // Add contact even without phone
                                processedContacts.push({
                                    name: contactName,
                                    phone: 'No phone number'
                                });
                            }
                        });
                        
                        // Remove exact duplicates
                        const uniqueContacts = processedContacts.filter((contact, index, self) =>
                            index === self.findIndex(c => 
                                c.name === contact.name && c.phone === contact.phone
                            )
                        );
                        
                        // Replace ALL demo contacts with real ones
                        contacts = uniqueContacts.sort((a, b) => a.name.localeCompare(b.name));
                        filteredContacts = contacts.slice();
                        
                        console.log('SUCCESS: Loaded', contacts.length, 'unique contacts');
                        
                        // Display success message
                        contactsList.innerHTML = `
                            <div style="padding: 16px; text-align: center; background: #28a745; color: white; border-radius: 8px; margin-bottom: 16px;">
                                <p><strong>🎉 SUCCESS!</strong></p>
                                <p><strong>Automatically loaded ${contacts.length} contacts!</strong></p>
                                <p>All your contacts are now searchable below</p>
                            </div>
                        `;
                        
                        // Display ALL contacts immediately
                        contacts.forEach(contact => {
                            const contactEl = document.createElement('div');
                            contactEl.className = 'contact-item';
                            contactEl.style.backgroundColor = '#e8f5e8'; // Light green for real contacts
                            contactEl.innerHTML = `
                                <div class="contact-name">${contact.name}</div>
                                <div class="contact-phone">${contact.phone}</div>
                            `;
                            contactEl.addEventListener('click', () => callContact(contact));
                            contactsList.appendChild(contactEl);
                        });
                        
                        // Add footer showing total
                        const footerEl = document.createElement('div');
                        footerEl.style.cssText = 'padding: 12px; text-align: center; background: #d4edda; color: #155724; border-radius: 8px; margin-top: 16px; font-weight: bold;';
                        footerEl.innerHTML = `📱 Total: ${contacts.length} contacts loaded and ready to use!`;
                        contactsList.appendChild(footerEl);
                        
                    } else {
                        throw new Error('No contacts were returned from device');
                    }
                    
                } else {
                    throw new Error('Contacts API not supported on this device/browser');
                }
                
            } catch (error) {
                console.error('Contact loading error:', error);
                
                let errorMsg = '';
                if (error.message.includes('not supported')) {
                    errorMsg = `
                        <p><strong>📱 Contacts API Not Supported</strong></p>
                        <p>This feature requires:</p>
                        <p>• Chrome on Android</p>
                        <p>• Safari on iOS</p>
                        <p>• HTTPS connection</p>
                        <p>• Modern browser version</p>
                    `;
                } else if (error.name === 'NotAllowedError') {
                    errorMsg = `
                        <p><strong>📱 Permission Denied</strong></p>
                        <p>You denied access to contacts</p>
                        <p>To enable: Refresh page and allow contact access</p>
                    `;
                } else if (error.name === 'AbortError') {
                    errorMsg = `
                        <p><strong>📱 Contact Loading Cancelled</strong></p>
                        <p>You cancelled the contact selection</p>
                        <p>Try the button again to load contacts</p>
                    `;
                } else {
                    errorMsg = `
                        <p><strong>📱 Contact Loading Error</strong></p>
                        <p>Error: ${error.message}</p>
                        <p>Please try again</p>
                    `;
                }
                
                contactsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #cc0000; border: 2px solid #cc0000; border-radius: 8px; background: #fff5f5;">
                        ${errorMsg}
                        <p style="margin-top: 16px; color: #666;">Demo contacts will be shown below:</p>
                    </div>
                `;
                
                // Show demo contacts after error
                setTimeout(() => {
                    displayContacts();
                }, 3000);
            }
        }

        // Display contacts - FROM YOUR ORIGINAL - FIXED: Added initial display
        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            if (!contactsList) return;
            
            // FIXED: Don't clear if there's already content, just append
            if (!contactsList.innerHTML.includes('Demo Contact') && 
                !contactsList.innerHTML.includes('SUCCESS') && 
                !contactsList.innerHTML.includes('Loading')) {
                contactsList.innerHTML = '';
            }
            
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;"><p>No contacts to display</p></div>';
                return;
            }
            
            // FIXED: Only add contacts if not already showing demo or success message
            if (!contactsList.innerHTML.includes('Demo Contacts') && 
                !contactsList.innerHTML.includes('SUCCESS') && 
                !contactsList.innerHTML.includes('Loading')) {
                
                filteredContacts.forEach(contact => {
                    const contactEl = document.createElement('div');
                    contactEl.className = 'contact-item';
                    contactEl.innerHTML = `
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-phone">${contact.phone}</div>
                    `;
                    contactEl.addEventListener('click', () => callContact(contact));
                    contactsList.appendChild(contactEl);
                });
            }
        }

        // Filter contacts - FROM YOUR ORIGINAL
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = contacts.slice();
            } else {
                const search = searchTerm.toLowerCase();
                filteredContacts = contacts.filter(contact => 
                    contact.name.toLowerCase().includes(search) ||
                    contact.phone.includes(searchTerm)
                );
            }
            displayContacts();
        }

        // Call contact - FROM YOUR ORIGINAL
        function callContact(contact) {
            console.log('Calling:', contact.name, contact.phone);
            window.location.href = 'tel:' + contact.phone.replace(/[^0-9]/g, '');
        }

        // Show page - FROM YOUR ORIGINAL - FIXED: Added displayContacts call
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                if (pageId !== 'speech' && isListening) {
                    stopListening();
                }
                
                if (pageId === 'phone') {
                    displayContacts(); // FIXED: Always show demo contacts
                }
            }
        }

        // Initialize when page loads - FROM YOUR ORIGINAL
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
