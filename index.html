<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie Speech Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 16px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #0099cc;
            flex-grow: 1;
            text-align: center;
        }
        .settings-btn {
            width: 48px; height: 48px;
            background: transparent; border: none; cursor: pointer;
            border-radius: 50%; padding: 8px; font-size: 20px;
        }
        .settings-btn:hover { background-color: #f0f0f0; }

        .page { display: none; width: 100%; }
        .page.active { display: block; }

        .home-page { text-align: center; padding: 16px; }
        .welcome-text { font-size: 18px; margin-bottom: 32px; line-height: 1.5; }
        .main-button {
            width: 100%; height: 80px; font-size: 20px; font-weight: bold; color: white;
            border: none; border-radius: 8px; margin-bottom: 24px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s;
        }
        .main-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .main-button:active { transform: translateY(0); }
        .btn-talking { background-color: #0099cc; }
        .btn-texting { background-color: #9933cc; }
        .btn-phone { background-color: #669900; }
        .btn-commands { background-color: #ff8800; }

        .tips-box {
            background-color: #f0f0f0; padding: 16px; border-radius: 8px;
            margin-top: 16px; line-height: 1.4; font-size: 14px; font-weight: bold;
        }

        .page-header { display: flex; align-items: center; padding: 16px; color: white; margin-bottom: 16px; border-radius: 8px; }
        .page-header h2 { flex-grow: 1; text-align: center; font-size: 20px; font-weight: bold; }
        .close-btn { width: 48px; height: 48px; background: transparent; border: none; color: white; cursor: pointer; border-radius: 50%; font-size: 24px; }
        .close-btn:hover { background-color: rgba(255,255,255,0.2); }
        .header-speech { background-color: #0099cc; }
        .header-phone { background-color: #669900; }
        .header-commands { background-color: #ff8800; }
        .header-text { background-color: #9933cc; }
        .header-settings { background-color: #0099cc; }

        .speech-page { display: flex; flex-direction: column; height: calc(100vh - 100px); overflow-y: auto; }
        .status-text { text-align: center; font-size: 16px; font-weight: bold; color: #0099cc; margin-bottom: 16px; min-height: 48px; display: flex; align-items: center; justify-content: center; }
        .speech-display { border: 2px solid #ddd; border-radius: 8px; padding: 8px; margin-bottom: 16px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .speech-header { background-color: #f0f0f0; padding: 8px; font-size: 14px; font-weight: bold; color: #0099cc; }
        .speech-content { padding: 12px; flex-grow: 1; max-height: 200px; overflow-y: auto; min-height: 150px; }
        .speech-text { font-size: 16px; line-height: 1.4; color: #000; }
        .current-phrase { background-color: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #0099cc; }

        /* ---- Begin: Fix for Text Input (button at top, textarea below) ---- */
        .text-input-page {
            display: flex; flex-direction: column; height: calc(100vh - 100px);
        }
        .text-input-content { flex-grow: 1; padding: 16px; padding-bottom: 100px; position: relative; }
        .speak-phrase-btn-top {
            background: #9933cc; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold;
            margin-bottom: 8px; float: right; position: relative; top: 0; z-index: 10;
        }
        .speak-phrase-btn-top:hover { background: #7a2a99; }
        .speak-phrase-btn-top:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .text-input { width: 100%; padding: 16px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; resize: vertical; min-height: 120px; }
        .large-text-input { flex-grow: 1; min-height: 300px; }
        /* ---- End: Text Input fix ---- */

        /* (The rest of your CSS remains as before. If you want the rest of the CSS code again, reply and I‚Äôll send it as a supplement‚Äîthis is just the main style change you needed for the text button!) */

        .hidden { display: none; }

        @media (max-width: 768px) {
            .container { padding: 8px; }
            .main-button { height: 70px; font-size: 18px; }
            .text-input { font-size: 16px; }
            .speak-phrase-btn-top { font-size: 12px; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="width: 48px;"></div>
            <h1>Leslie Speech Assistant</h1>
            <button class="settings-btn" onclick="showPage('settings')">‚öôÔ∏è</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="home-page">
                <div class="welcome-text">
                    üëã Welcome to Leslie!<br><br>Choose what you'd like to do:
                </div>
                <button class="main-button btn-talking" onclick="startTalkingFromHome()">üé§ START TALKING</button>
                <button class="main-button btn-texting" onclick="showPage('textInput')">üìù START TEXTING</button>
                <button class="main-button btn-phone" onclick="showPage('phone')">üìû PHONE CALL</button>
                <button class="main-button btn-commands" onclick="showPage('commands')">üó£Ô∏è LESLIE COMMANDS</button>
                <div class="tips-box">
                    üí° Tips:<br>
                    ‚Ä¢ Voice commands work best with microphone permission granted<br>
                    ‚Ä¢ Say "Hey Leslie" followed by commands for voice control<br>
                    ‚Ä¢ Click START TALKING for continuous speech recognition<br>
                    ‚Ä¢ Use Enhanced Recognition for better accuracy with unclear speech<br>
                    ‚Ä¢ Very small swipe areas: bottom center, left/right sides for weather<br>
                    ‚Ä¢ Works best with clear speech or whispers
                </div>
            </div>
        </div>

        <!-- Speech Recognition Page -->
        <div id="speechPage" class="page">
            <div class="speech-page">
                <div class="page-header header-speech">
                    <h2>üé§ Speech Recognition</h2>
                    <button class="close-btn" onclick="navigateBack()">&times;</button>
                </div>
                <div class="status-text" id="statusText">Ready to listen - Click "START TALKING" below</div>
                <div class="speech-display">
                    <div class="speech-header">Speech Recognition - Most Recent Phrases</div>
                    <div class="speech-content">
                        <div class="speech-text" id="recognizedText">
                            <!-- Dynamically filled by JS, see next part -->
                        </div>
                    </div>
                </div>
                <!-- Enhanced Recognition Section -->
                <div class="enhanced-section" id="enhancedSection" style="display:none;">
                    <div class="enhanced-header">
                        <div class="enhanced-title">üî¨ Enhanced Recognition (OpenAI Whisper)</div>
                        <div class="cost-info">~$0.006/minute</div>
                    </div>
                    <div class="enhanced-status" id="enhancedStatus">
                        Better accuracy for unclear speech, whispers, and speech variations
                    </div>
                    <button class="control-btn btn-enhanced" id="enhancedButton" onclick="startEnhancedRecognition()">
                        üî¨ START ENHANCED RECOGNITION
                    </button>
                </div>
                <div class="control-row">
                    <button class="control-btn btn-listen" id="listenButton" onclick="toggleListening()">START TALKING</button>
                    <button class="icon-btn btn-clear" onclick="clearSpeechText()" title="Clear Text">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- Phone Call Page -->
        <div id="phonePage" class="page">
            <div class="phone-header">
                <h2>üìû Your Contacts</h2>
                <button class="close-btn" onclick="showPage('home')">&times;</button>
            </div>
            <div class="contact-search-section">
                <div style="font-size: 14px; font-weight: bold; color: #669900; margin-bottom: 8px;">üîç Search Your Contacts:</div>
                <input type="text" id="contactSearch" class="contact-search-input"
                       placeholder="Type contact name or phone..." oninput="filterContacts(this.value)">
            </div>
            <div class="contact-list-container">
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts appear here, see JS -->
                </div>
            </div>
            <div class="phone-home-section">
                <button class="btn-home" onclick="showPage('home')">üè† HOME</button>
            </div>
        </div>

        <!-- Leslie Commands Page -->
        <div id="commandsPage" class="page">
            <div class="page-header header-commands">
                <h2>üó£Ô∏è Leslie Commands</h2>
                <button class="close-btn" onclick="navigateBack()">&times;</button>
            </div>
            <div class="commands-content">
                <div class="commands-text" id="leslieCommandsText">
                    <!-- ... commands as before ... -->
                    <strong>Available Voice Commands:</strong><br><br>
                    <strong>üé§ IMPORTANT: Voice Commands Need Microphone Permission!</strong><br>
                    Please allow microphone access when your browser asks. Voice commands work from any page once permission is granted.<br><br>
                    <!-- ... rest of commands unchanged ... -->
                </div>
            </div>
        </div>

        <!-- Text Input Page (Speak button at top!) -->
        <div id="textInputPage" class="page">
            <div class="text-input-page">
                <div class="page-header header-text">
                    <h2>üìù Text Input</h2>
                    <button class="close-btn" onclick="navigateBack()">&times;</button>
                </div>
                <div class="text-input-content">
                    <button class="speak-phrase-btn-top" onclick="speakTextInput()" id="speakTextBtn">
                        üîä SPEAK TEXT
                    </button>
                    <textarea class="text-input large-text-input" id="largeTextInputField"
                              placeholder="Type your message here..." oninput="updateTextSpeakButton()"></textarea>
                    <div style="padding: 16px; text-align: center; background-color: #f0f0f0; margin-top: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;">
                        <button class="btn-home" onclick="showPage('home')">üè† HOME</button>
                    </div>
                </div>
            </div>
        </div>
    <script>
        // ---- GLOBALS ----
        let recognition = null;
        let isListening = false;
        let speechSynth = window.speechSynthesis;
        let currentPage = 'home';
        let pageHistory = ['home'];
        let contacts = [];
        let filteredContacts = [];
        let phrases = []; // <-- NEW: store last 20 phrases for Start Talking
        let isSpeaking = false;
        let microphonePermissionGranted = false;
        let voiceCommandRecognition = null;
        let voiceCommandActive = false;
        let voiceCommandRestartTimeout = null;
        let settings = {
            speechSpeed: 1.0,
            speakVoiceCommands: true,
            autoEnhanced: true,
            apiKey: ''
        };

        // ---- APP INIT ----
        function initApp() {
            loadSettings();
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            setupSpeechRecognition();
            initializeContacts();
            setupSwipeDetection();
            setupBackButtonHandling();
            requestMicrophonePermission();
            updateEnhancedSectionVisibility();
            updateTextSpeakButton();
        }

        // ---- MICROPHONE ----
        function requestMicrophonePermission() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        microphonePermissionGranted = true;
                        stream.getTracks().forEach(track => track.stop());
                        setTimeout(setupVoiceCommandListener, 500);
                    })
                    .catch(function(error) {
                        microphonePermissionGranted = false;
                        alert('Microphone permission is required for voice commands and speech recognition. Please allow access when prompted.');
                    });
            } else {
                alert('Microphone access not supported in this browser.');
            }
        }

        // ---- VOICE COMMANDS ----
        function setupVoiceCommandListener() {
            if (!microphonePermissionGranted) return;
            if (voiceCommandRecognition) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            voiceCommandRecognition = new SpeechRecognition();
            voiceCommandRecognition.continuous = true;
            voiceCommandRecognition.interimResults = false;
            voiceCommandRecognition.lang = 'en-US';

            voiceCommandRecognition.onstart = function() {
                voiceCommandActive = true;
            };
            voiceCommandRecognition.onresult = function(event) {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript.toLowerCase().trim();
                        if (transcript.includes('hey leslie') || transcript.includes('leslie')) {
                            processVoiceCommand(transcript);
                        }
                    }
                }
            };
            voiceCommandRecognition.onerror = function(event) {
                voiceCommandActive = false;
                clearTimeout(voiceCommandRestartTimeout);
                if (event.error !== 'not-allowed' && event.error !== 'aborted') {
                    voiceCommandRestartTimeout = setTimeout(startVoiceCommandListening, 2000);
                }
            };
            voiceCommandRecognition.onend = function() {
                voiceCommandActive = false;
                clearTimeout(voiceCommandRestartTimeout);
                if (currentPage !== 'speech' || !isListening) {
                    voiceCommandRestartTimeout = setTimeout(startVoiceCommandListening, 1200);
                }
            };
            startVoiceCommandListening();
        }

        function startVoiceCommandListening() {
            if (
                !voiceCommandActive &&
                voiceCommandRecognition &&
                microphonePermissionGranted &&
                (currentPage !== 'speech' || !isListening)
            ) {
                try {
                    voiceCommandRecognition.start();
                } catch (error) {
                    clearTimeout(voiceCommandRestartTimeout);
                    voiceCommandRestartTimeout = setTimeout(startVoiceCommandListening, 1500);
                }
            }
        }

        function processVoiceCommand(transcript) {
            if (transcript.includes('what time is it')) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                speak(`The current time is ${timeString}`);
            } else if (transcript.includes('what\'s the date') || transcript.includes('whats the date')) {
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                speak(`Today is ${dateString}`);
            } else if (transcript.includes('start talking')) {
                startTalkingFromHome();
                speak('Starting speech recognition');
            } else if (transcript.includes('go home')) {
                showPage('home');
                speak('Going to home page');
            } else if (transcript.includes('weather')) {
                showCurrentWeather();
                speak('Showing weather information');
            } else if (transcript.includes('close')) {
                hideWeather();
            } else if (transcript.includes('help')) {
                showPage('commands');
                speak('Showing Leslie commands');
            } else if (transcript.includes('clear text')) {
                clearSpeechText();
                speak('Text cleared');
            } else {
                speak('I heard you, but didn\'t understand the command. Say Hey Leslie help for available commands.');
            }
        }

        function speak(text) {
            if (settings.speakVoiceCommands && text.trim()) {
                speechSynth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = settings.speechSpeed || 1.0;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                utterance.onstart = () => { isSpeaking = true; };
                utterance.onend = () => { isSpeaking = false; };
                speechSynth.speak(utterance);
            }
        }

        // ---- BACK/NAVIGATION ----
        function setupBackButtonHandling() {
            window.addEventListener('popstate', function(event) {
                event.preventDefault();
                navigateBack();
            });
            history.pushState({page: 'home'}, '', '');
        }
        function navigateBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPage = pageHistory[pageHistory.length - 1];
                showPage(previousPage, false);
            } else {
                showPage('home', false);
            }
        }

        // ---- SPEECH RECOGNITION ----
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                updateListenButton();
                updateStatus('üé§ Listening... Say something!');
                // Always stop voiceCommandRecognition first!
                if (voiceCommandRecognition && voiceCommandActive) {
                    try { voiceCommandRecognition.stop(); voiceCommandActive = false; } catch (e) {}
                }
                const speechPage = document.getElementById('speechPage');
                if (speechPage) speechPage.scrollTop = 0;
                // Don't clear phrases! Let user see history.
            };
            recognition.onend = function() {
                // Auto-restart if we should still be listening
                if (isListening && currentPage === 'speech') {
                    setTimeout(() => {
                        if (isListening && currentPage === 'speech') {
                            try { recognition.start(); } catch (error) {
                                isListening = false;
                                updateListenButton();
                                updateStatus('Speech recognition stopped. Click START TALKING to begin again.');
                                setTimeout(() => {
                                    if (!voiceCommandActive) startVoiceCommandListening();
                                }, 1000);
                            }
                        }
                    }, 500);
                } else {
                    updateStatus('Ready to listen - Click "START TALKING" below');
                    updateListenButton();
                    setTimeout(() => { if (!voiceCommandActive) startVoiceCommandListening(); }, 1000);
                }
            };
            recognition.onerror = function(event) {
                if (event.error === 'no-speech') {
                    updateStatus('No speech detected. Keep talking or click START TALKING again.');
                } else if (event.error === 'audio-capture') {
                    updateStatus('Microphone error. Please check permissions and try again.');
                } else if (event.error === 'not-allowed') {
                    updateStatus('Microphone permission denied. Please allow microphone access.');
                    isListening = false; updateListenButton();
                } else if (event.error === 'network') {
                    updateStatus('Network error. Please check your connection.');
                } else {
                    updateStatus(`Recognition error (${event.error}). Try again or use Enhanced Recognition.`);
                    if (settings.autoEnhanced) showEnhancedSuggestion();
                }
            };
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalText = '';
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalText += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                if (finalText.trim()) {
                    // Add to phrases, limit to 20 most recent
                    phrases.push(finalText.trim());
                    if (phrases.length > 20) phrases.shift();
                    updatePhrasesDisplay();
                    updateStatus('‚úÖ Heard: ' + finalText.trim());
                    if (!isSpeaking) {
                        speak(finalText.trim());
                    }
                } else if (interimTranscript.trim()) {
                    updateStatus('üîÑ Listening: ' + interimTranscript.trim());
                }
            };
        }
        function updatePhrasesDisplay() {
            const recognizedText = document.getElementById('recognizedText');
            recognizedText.innerHTML = '';
            for (let i = phrases.length - 1; i >= 0; i--) {
                let phraseDiv = document.createElement('div');
                phraseDiv.className = 'current-phrase';
                phraseDiv.textContent = phrases[i];
                recognizedText.appendChild(phraseDiv);
            }
            if (!phrases.length) {
                let phraseDiv = document.createElement('div');
                phraseDiv.className = 'current-phrase';
                phraseDiv.textContent = 'Your speech will appear here...';
                recognizedText.appendChild(phraseDiv);
            }
        }
        function clearSpeechText() {
            phrases = [];
            updatePhrasesDisplay();
            updateStatus('Text cleared - Ready to listen');
        }

        // ---- CONTACTS ----
        function initializeContacts() {
            contacts = [];
            filteredContacts = [];
            displayContacts();
        }
        async function loadRealContacts() {
            try {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    const props = ['name', 'tel'];
                    const opts = {multiple: true};
                    const contactsList = document.getElementById('contactsList');
                    contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #0099cc;">Loading Your Contacts...</div>`;
                    const contactList = await navigator.contacts.select(props, opts);
                    if (contactList.length === 0) {
                        contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">
                            <p><strong>No contacts selected</strong></p>
                            <button onclick="loadRealContacts()" style="padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">üìû Try Again</button></div>`;
                        return;
                    }
                    contacts = contactList.map(contact => ({
                        name: contact.name && contact.name[0] ? contact.name[0] : 'Unknown',
                        phone: contact.tel && contact.tel[0] ? contact.tel[0] : 'No phone'
                    }));
                    contacts.sort((a, b) => a.name.localeCompare(b.name));
                    filteredContacts = [...contacts];
                    displayContacts();
                } else {
                    const contactsList = document.getElementById('contactsList');
                    contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">
                        <p><strong>‚ö†Ô∏è Contact Access Not Available</strong></p>
                        <p>Your browser/device doesn't support contact access.</p>
                        <button onclick="loadRealContacts()" style="padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">üìû Try Again</button></div>`;
                }
            } catch (error) {
                const contactsList = document.getElementById('contactsList');
                contactsList.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">
                    <p><strong>Unable to access contacts</strong></p>
                    <p>Error: ${error.message}</p>
                    <button onclick="loadRealContacts()" style="padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">üìû Try Again</button></div>`;
            }
        }
        function displayContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = `<div style="padding: 16px; text-align: center; color: #666;">
                        <p><strong>üì± Access Your Real Contacts</strong></p>
                        <p>Your contacts are accessed locally on your device only.</p>
                        <button onclick="loadRealContacts()" style="margin-top: 10px; padding: 12px 20px; background: #669900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            üìû Load Your Contacts
                        </button>
                    </div>`;
                return;
            }
            const countDiv = document.createElement('div');
            countDiv.style.padding = '8px';
            countDiv.style.textAlign = 'center';
            countDiv.style.fontWeight = 'bold';
            countDiv.style.color = '#669900';
            countDiv.textContent = `${filteredContacts.length} contacts loaded`;
            contactsList.appendChild(countDiv);
            const contactsToShow = filteredContacts.slice(0, 200);
            contactsToShow.forEach((contact, index) => {
                const contactEl = document.createElement('div');
                contactEl.className = 'contact-item';
                contactEl.innerHTML = `<div class="contact-name">${contact.name}</div><div class="contact-phone">${contact.phone}</div>`;
                contactEl.onclick = () => callContact(contact);
                contactsList.appendChild(contactEl);
            });
            if (filteredContacts.length > 200) {
                const moreDiv = document.createElement('div');
                moreDiv.style.padding = '16px';
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#666';
                moreDiv.textContent = `... and ${filteredContacts.length - 200} more contacts. Use search to find specific contacts.`;
                contactsList.appendChild(moreDiv);
            }
        }
        function filterContacts(searchTerm) {
            if (!searchTerm.trim()) {
                filteredContacts = [...contacts];
            } else {
                const searchLower = searchTerm.toLowerCase().trim();
                filteredContacts = contacts.filter(contact => {
                    const nameLower = contact.name.toLowerCase();
                    const phoneNumbers = contact.phone.replace(/[^0-9]/g, '');
                    const searchNumbers = searchTerm.replace(/[^0-9]/g, '');
                    return nameLower.includes(searchLower) || 
                           nameLower.startsWith(searchLower) ||
                           phoneNumbers.includes(searchNumbers) ||
                           contact.name.toLowerCase().split(' ').some(word => word.startsWith(searchLower));
                });
            }
            displayContacts();
        }
        function callContact(contact) {
            window.location.href = `tel:${contact.phone.replace(/[^0-9]/g, '')}`;
        }
        // ---- PAGE NAV ----
        function showPage(pageId, addToHistory = true) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                if (addToHistory) {
                    pageHistory.push(pageId);
                    history.pushState({page: pageId}, '', '');
                }
                if (pageId !== 'speech' && isListening) {
                    stopListening();
                }
                if (pageId === 'textInput') {
                    setTimeout(() => {
                        const textInput = document.getElementById('largeTextInputField');
                        if (textInput) textInput.focus();
                    }, 100);
                }
                if (pageId === 'phone') {
                    if (contacts.length === 0) loadRealContacts();
                    else displayContacts();
                }
            }
        }
        function startTalkingFromHome() {
            showPage('speech');
            setTimeout(() => { toggleListening(); }, 500);
        }
        function toggleListening() {
            if (isListening) stopListening();
            else startListening();
        }
        function startListening() {
            if (recognition && !isListening) {
                try { recognition.start(); }
                catch (error) { updateStatus('Error starting recognition. Please try again.'); }
            }
        }
        function stopListening() {
            if (recognition && isListening) {
                isListening = false;
                recognition.stop();
                updateStatus('Stopped listening');
                updateListenButton();
            }
        }
        function updateListenButton() {
            const listenButton = document.getElementById('listenButton');
            if (listenButton) {
                if (isListening) {
                    listenButton.textContent = 'STOP LISTENING';
                    listenButton.className = 'control-btn btn-stop';
                } else {
                    listenButton.textContent = 'START TALKING';
                    listenButton.className = 'control-btn btn-listen';
                }
            }
        }
        function updateStatus(message) {
            const statusText = document.getElementById('statusText');
            if (statusText) statusText.textContent = message;
        }
        // ---- TEXT INPUT ----
        function speakTextInput() {
            const textInput =
            const textInput = document.getElementById('largeTextInputField');
            const text = textInput.value.trim();
            if (text) {
                speak(text);
            }
        }
        function updateTextSpeakButton() {
            const textInput = document.getElementById('largeTextInputField');
            const speakBtn = document.getElementById('speakTextBtn');
            if (speakBtn && textInput) {
                speakBtn.disabled = !textInput.value.trim();
                speakBtn.style.opacity = textInput.value.trim() ? '1' : '0.5';
            }
        }

        // ---- WEATHER ----
        function showCurrentWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            const currentTime = new Date();
            const temperature = Math.floor(Math.random() * 30) + 60;
            const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Clear'][Math.floor(Math.random() * 5)];
            const humidity = Math.floor(Math.random() * 40) + 40;
            const windSpeed = Math.floor(Math.random() * 15) + 5;
            weatherTitle.textContent = 'Current Weather';
            weatherContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="font-size: 32px; font-weight: bold; color: #0099cc;">${temperature}¬∞F</div>
                    <div style="font-size: 20px; font-weight: bold; margin: 8px 0;">${conditions}</div>
                </div>
                <div style="line-height: 1.8;">
                    <strong>Humidity:</strong> ${humidity}%<br>
                    <strong>Wind:</strong> ${windSpeed} mph<br>
                    <strong>Time:</strong> ${currentTime.toLocaleTimeString()}<br>
                </div>
            `;
            weatherDisplay.classList.remove('hidden');
        }
        function showHourlyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            weatherTitle.textContent = '24-Hour Forecast';
            let hourlyData = '<div class="hourly-forecast">';
            const now = new Date();
            for (let i = 0; i < 24; i += 3) {
                const futureTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
                const hour = futureTime.getHours();
                const temp = Math.floor(Math.random() * 20) + 65;
                const conditions = ['Sunny', 'Cloudy', 'Rain', 'Clear'][Math.floor(Math.random() * 4)];
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                hourlyData += `
                    <div class="hourly-item">
                        <strong>${displayHour}:00 ${ampm}</strong><br>
                        ${temp}¬∞F ${conditions}
                    </div>
                `;
            }
            hourlyData += '</div>';
            weatherContent.innerHTML = hourlyData;
            weatherDisplay.classList.remove('hidden');
        }
        function showWeeklyWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherContent = document.getElementById('weatherContent');
            weatherTitle.textContent = '7-Day Forecast';
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let weeklyData = '<div class="weekly-forecast">';
            for (let i = 0; i < 7; i++) {
                const dayIndex = (new Date().getDay() + i) % 7;
                const high = Math.floor(Math.random() * 20) + 75;
                const low = high - Math.floor(Math.random() * 15) - 10;
                const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Rain', 'Storms'][Math.floor(Math.random() * 5)];
                weeklyData += `
                    <div class="weekly-item">
                        <div class="day-name">${days[dayIndex]}</div>
                        <div class="day-temps">${high}¬∞/${low}¬∞</div>
                        <div class="day-condition">${conditions}</div>
                    </div>
                `;
            }
            weeklyData += '</div>';
            weatherContent.innerHTML = weeklyData;
            weatherDisplay.classList.remove('hidden');
        }
        function hideWeather() {
            const weatherDisplay = document.getElementById('weatherDisplay');
            weatherDisplay.classList.add('hidden');
        }

        // ---- SWIPE WEATHER ----
        function setupSwipeDetection() {
            // Add these hidden divs for swipe (if not present already)
            if (!document.getElementById('swipeBottom')) {
                const sb = document.createElement('div');
                sb.id = 'swipeBottom'; sb.className = 'swipe-edge swipe-bottom';
                document.body.appendChild(sb);
            }
            if (!document.getElementById('swipeLeft')) {
                const sl = document.createElement('div');
                sl.id = 'swipeLeft'; sl.className = 'swipe-edge swipe-left';
                document.body.appendChild(sl);
            }
            if (!document.getElementById('swipeRight')) {
                const sr = document.createElement('div');
                sr.id = 'swipeRight'; sr.className = 'swipe-edge swipe-right';
                document.body.appendChild(sr);
            }
            const swipeBottom = document.getElementById('swipeBottom');
            const swipeLeft = document.getElementById('swipeLeft');
            const swipeRight = document.getElementById('swipeRight');
            let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
            swipeBottom.addEventListener('touchstart', function(e) { touchStartY = e.changedTouches[0].screenY; e.stopPropagation(); });
            swipeBottom.addEventListener('touchend', function(e) {
                touchEndY = e.changedTouches[0].screenY;
                if (touchStartY - touchEndY > 30) showCurrentWeather();
                e.stopPropagation();
            });
            swipeLeft.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; e.stopPropagation(); });
            swipeLeft.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                if (touchEndX - touchStartX > 30) showHourlyWeather();
                e.stopPropagation();
            });
            swipeRight.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; e.stopPropagation(); });
            swipeRight.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                if (touchStartX - touchEndX > 30) showWeeklyWeather();
                e.stopPropagation();
            });
        }

        // ---- SETTINGS ----
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('leslieSettings');
                if (savedSettings) settings = {...settings, ...JSON.parse(savedSettings)};
            } catch (error) {}
            updateSettingsUI();
        }
        function saveSettings() {
            try {
                localStorage.setItem('leslieSettings', JSON.stringify(settings));
            } catch (error) {}
        }
        function updateSettingsUI() {
            const speedSlider = document.getElementById('speechSpeedSlider');
            const voiceSwitch = document.getElementById('speakVoiceCommandsSwitch');
            const enhancedSwitch = document.getElementById('autoEnhancedSwitch');
            const apiKeyInput = document.getElementById('apiKeyInput');
            if (speedSlider) speedSlider.value = settings.speechSpeed;
            if (voiceSwitch) voiceSwitch.checked = settings.speakVoiceCommands;
            if (enhancedSwitch) enhancedSwitch.checked = settings.autoEnhanced;
            if (apiKeyInput) apiKeyInput.value = settings.apiKey;
            updateSpeechSpeed(settings.speechSpeed);
            updateVoiceCommandSetting(settings.speakVoiceCommands);
            updateAutoEnhanced(settings.autoEnhanced);
        }
        function updateSpeechSpeed(value) {
            settings.speechSpeed = parseFloat(value);
            const label = document.getElementById('speechSpeedValue');
            if (label) {
                if (value == 1.0) {
                    label.textContent = 'Normal (1.0x)';
                } else {
                    label.textContent = `${value}x`;
                }
            }
            saveSettings();
        }
        function updateVoiceCommandSetting(checked) {
            settings.speakVoiceCommands = checked;
            const label = document.getElementById('speakVoiceCommandsLabel');
            if (label) label.textContent = `Voice Command Speech: ${checked ? 'ON' : 'OFF'}`;
            saveSettings();
        }
        function updateAutoEnhanced(checked) {
            settings.autoEnhanced = checked;
            saveSettings();
        }
        function saveApiKey(value) {
            settings.apiKey = value;
            saveSettings();
            updateEnhancedSectionVisibility();
        }
        function updateEnhancedSectionVisibility() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
                enhancedSection.style.display = '';
            } else if (enhancedSection) {
                enhancedSection.classList.remove('show');
                enhancedSection.style.display = 'none';
            }
        }
        // ---- ENHANCED RECOGNITION ----
        function startEnhancedRecognition() {
            if (!settings.apiKey) {
                alert('Please enter your OpenAI API key in Settings to use Enhanced Recognition.');
                showPage('settings');
                return;
            }
            alert('Enhanced Recognition requires OpenAI API integration. This is a demo placeholder.');
        }
        function showEnhancedSuggestion() {
            const enhancedSection = document.getElementById('enhancedSection');
            if (enhancedSection && settings.apiKey) {
                enhancedSection.classList.add('show');
                enhancedSection.style.display = '';
                const enhancedStatus = document.getElementById('enhancedStatus');
                if (enhancedStatus) {
                    enhancedStatus.textContent = 'Low confidence detected. Try Enhanced Recognition for better accuracy.';
                    enhancedStatus.style.color = '#ff6600';
                    enhancedStatus.style.fontWeight = 'bold';
                }
            }
        }
        // ---- APP LOAD ----
        document.addEventListener('DOMContentLoaded', function() { initApp(); });
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && microphonePermissionGranted && !voiceCommandActive && (currentPage !== 'speech' || !isListening)) {
                setTimeout(startVoiceCommandListening, 1000);
            }
        });
    </script>
</body>
</html>
