<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leslie Speech Assistant</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #ffffff; color: #000000; overflow-x: hidden; touch-action: pan-y; }
    .container { max-width: 100vw; min-height: 100vh; padding: 16px; position: relative; }

    .header { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 16px; }
    .header h1 { font-size: 24px; font-weight: bold; color: #0099cc; flex-grow: 1; text-align: center; }
    .settings-btn { width: 48px; height: 48px; background: transparent; border: none; cursor: pointer; border-radius: 50%; padding: 8px; font-size: 20px; }
    .settings-btn:hover { background-color: #f0f0f0; }

    .page { display: none; width: 100%; }
    .page.active { display: block; }

    .home-page { text-align: center; padding: 16px; }
    .welcome-text { font-size: 18px; margin-bottom: 32px; line-height: 1.5; }
    .main-button {
      width: 100%; height: 80px; font-size: 20px; font-weight: bold; color: white; border: none; border-radius: 8px;
      margin-bottom: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s;
    }
    .main-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
    .main-button:active { transform: translateY(0); }
    .btn-talking { background-color: #0099cc; }
    .btn-texting { background-color: #9933cc; }
    .btn-phone   { background-color: #669900; }
    .btn-commands{ background-color: #ff8800; }

    .tips-box { background-color: #f0f0f0; padding: 16px; border-radius: 8px; margin-top: 16px; line-height: 1.4; font-size: 14px; font-weight: bold; }

    .page-header { display: flex; align-items: center; padding: 16px; color: white; margin-bottom: 16px; border-radius: 8px; }
    .page-header h2 { flex-grow: 1; text-align: center; font-size: 20px; font-weight: bold; }
    .close-btn { width: 48px; height: 48px; background: transparent; border: none; color: white; cursor: pointer; border-radius: 50%; font-size: 24px; }
    .close-btn:hover { background-color: rgba(255,255,255,0.2); }
    .header-speech   { background-color: #0099cc; }
    .header-phone    { background-color: #669900; }
    .header-commands { background-color: #ff8800; }
    .header-text     { background-color: #9933cc; }
    .header-settings { background-color: #0099cc; }

    .speech-page { display: flex; flex-direction: column; height: calc(100vh - 100px); overflow-y: auto; padding-bottom: 100px; }
    .status-text { text-align: center; font-size: 16px; font-weight: bold; color: #0099cc; margin-bottom: 16px; min-height: 48px; display: flex; align-items: center; justify-content: center; }

    .speech-display { border: 2px solid #ddd; border-radius: 8px; padding: 8px; margin-bottom: 16px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
    .speech-header { background-color: #f0f0f0; padding: 8px; font-size: 14px; font-weight: bold; color: #0099cc; }
    .speech-content { padding: 12px; flex-grow: 1; max-height: 200px; overflow-y: auto; min-height: 150px; }
    .speech-text { font-size: 16px; line-height: 1.4; color: #000; }

    .final-phrase  { background-color: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #0099cc; }
    .interim-phrase{ background-color: #fff8e1; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #ffa000; color: #666; font-style: italic; }

    .control-row {
      display: flex; justify-content: center; gap: 8px; align-items: center; margin: 16px 0; padding: 16px;
      position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #0099cc; z-index: 1000;
      box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
    }
    .control-btn { height: 70px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; width: 300px; max-width: 80%; }
    .icon-btn { width: 70px; height: 70px; border: none; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
    .btn-listen { background-color: #0099cc; }
    .btn-stop   { background-color: #cc0000; }
    .btn-clear  { background-color: #ffaa00; }
    .btn-home   {
      background-color: #0099cc; height: 70px; font-size: 18px; font-weight: bold; color: white; border: none;
      border-radius: 8px; cursor: pointer; width: 300px; max-width: 80%; margin: 0 auto; display: block;
    }

    .contact-search-section { padding: 12px; background-color: #f0f0f0; border-radius: 8px; margin-bottom: 16px; }
    .contact-list-container { padding: 8px; flex-grow: 1; max-height: 400px; overflow-y: auto; }
    .contacts-list { border: 2px solid #ddd; border-radius: 8px; padding: 8px; background-color: white; min-height: 300px; }
    .contact-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    .contact-item:hover { background-color: #f0f0f0; }
    .contact-name { font-weight: bold; font-size: 16px; }
    .contact-phone { color: #666; font-size: 14px; margin-top: 2px; }
    .phone-home-section { padding: 16px; text-align: center; background-color: #f0f0f0; border-top: 2px solid #669900; margin-top: 16px; }

    .settings-section { background-color: #f9f9f9; border: 2px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .settings-title { font-size: 16px; font-weight: bold; color: #000; margin-bottom: 8px; }
    .settings-description { font-size: 12px; color: #666; margin-bottom: 12px; }
    .slider { width: 100%; height: 8px; border-radius: 4px; background: #ddd; outline: none; margin-bottom: 8px; }
    .setting-value { text-align: center; font-size: 14px; font-weight: bold; color: #0099cc; }

    .weather-display {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border: 3px solid #0099cc; border-radius: 12px; padding: 20px; z-index: 1000;
      width: 90vw; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .weather-display.hidden { display: none; }

    @media (max-width: 768px) {
      .container { padding: 8px; }
      .main-button { height: 70px; font-size: 18px; }
      .control-btn { width: 250px; }
      .weather-display { padding: 16px; width: 95vw; max-width: 450px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="width:48px;"></div>
      <h1>Leslie Speech Assistant</h1>
      <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="page active">
      <div class="home-page">
        <div class="welcome-text">üëã Welcome to Leslie!<br><br>Choose what you'd like to do:</div>
        <button class="main-button btn-talking" id="btnStartTalking">üé§ START TALKING</button>
        <button class="main-button btn-texting"  id="btnStartTexting">üìù START TEXTING</button>
        <button class="main-button btn-phone"    id="btnPhoneCall">üìû PHONE CALL</button>
        <button class="main-button btn-commands" id="btnCommands">üó£Ô∏è LESLIE COMMANDS</button>

        <div class="tips-box">
          üí° Tips:<br>
          ‚Ä¢ Tap START TALKING to begin/stop listening<br>
          ‚Ä¢ ‚ÄúFinal phrase‚Äù will be spoken back to you at the speed in Settings<br>
          ‚Ä¢ Weather & Contacts work on tap; nothing auto-starts the mic
        </div>
      </div>
    </div>

    <!-- Speech Recognition Page -->
    <div id="speechPage" class="page">
      <div class="speech-page">
        <div class="page-header header-speech">
          <h2>üé§ Speech Recognition</h2>
          <button class="close-btn" id="btnCloseSpeech">&times;</button>
        </div>

        <div class="status-text" id="statusText">Tap START TALKING to begin listening.</div>

        <div class="speech-display">
          <div class="speech-header">Speech Recognition - Your Phrases</div>
          <div class="speech-content">
            <div class="speech-text" id="recognizedText">
              <div style="color:#666;font-style:italic;text-align:center;padding:20px;">Waiting to start‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="control-row">
          <button class="control-btn btn-listen" id="listenButton">START TALKING</button>
          <button class="icon-btn btn-clear" id="clearButton" title="Clear Text">üóëÔ∏è</button>
        </div>
      </div>
    </div>

    <!-- Phone Call Page -->
    <div id="phonePage" class="page">
      <div class="page-header header-phone">
        <h2>üìû Your Contacts</h2>
        <button class="close-btn" id="btnClosePhone">&times;</button>
      </div>

      <div class="contact-search-section">
        <div style="font-size:14px;font-weight:bold;color:#669900;margin-bottom:8px;">üö´ Search Disabled to Prevent Phone Pinging</div>
        <div style="padding:12px;background:#f0f0f0;border-radius:8px;color:#666;font-style:italic;">
          Contact search disabled to prevent microphone access
        </div>
      </div>

      <div class="contact-loading-section" id="contactLoadingSection" style="padding: 20px; text-align:center; color:#669900; border:2px solid #669900; border-radius:8px; background-color:#f8f9fa; margin-bottom:16px;">
        <p><strong>üì± GET YOUR REAL CONTACTS</strong></p>
        <p style="color:#333;margin:10px 0;font-size:16px;">Currently showing: <span style="color:#cc0000;">Demo Contacts Only</span></p>
        <p style="color:#666;font-size:14px;margin-bottom:15px;">Choose how to load YOUR real contacts from your phone:</p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button onclick="loadAllContacts()" style="margin:5px;padding:16px 24px;background:#669900;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;">üìû LOAD ALL CONTACTS</button>
          <button onclick="loadSelectedContacts()" style="margin:5px;padding:16px 24px;background:#0099cc;color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;">üìã SELECT SPECIFIC CONTACTS</button>
        </div>
        <p style="margin-top:12px;font-size:12px;color:#666;">
          <strong>üìû LOAD ALL:</strong> Opens contact picker with auto-selection attempt<br>
          <strong>üìã SELECT:</strong> Opens contact picker for manual selection<br>
          <strong>‚ö†Ô∏è Works on Chrome Android & Safari iOS only</strong>
        </p>
      </div>

      <div class="contact-list-container">
        <div style="font-size:12px;color:#669900;margin-bottom:8px;text-align:center;">üì± Your contacts will appear here - Tap any contact to call</div>
        <div class="contacts-list" id="contactsList"></div>
      </div>

      <div class="phone-home-section">
        <button class="btn-home" id="btnPhoneHome">üè† HOME</button>
      </div>
    </div>

    <!-- Text Input Page (kept but disabled to avoid mic ping) -->
    <div id="textInputPage" class="page">
      <div class="page-header header-text">
        <h2>üìù Text Input</h2>
        <button class="close-btn" id="btnCloseText">&times;</button>
      </div>
      <div class="text-input-content" style="margin-top:10px;">
        <div style="padding:40px;background:#f0f0f0;border-radius:8px;color:#666;font-style:italic;text-align:center;margin:20px 0;">
          üö´ Text Input Disabled to Prevent Phone Pinging
        </div>
        <div style="padding:16px;text-align:center;background-color:#f0f0f0;margin-top:8px;position:fixed;bottom:0;left:0;right:0;z-index:999;">
          <button class="btn-home" id="btnTextHome">üè† HOME</button>
        </div>
      </div>
    </div>

    <!-- Leslie Commands Page -->
    <div id="commandsPage" class="page">
      <div class="page-header header-commands">
        <h2>üó£Ô∏è Leslie Commands</h2>
        <button class="close-btn" id="btnCloseCommands">&times;</button>
      </div>
      <div style="padding:16px; max-height:70vh; overflow-y:auto; background:white; border-radius:8px; margin:8px;">
        <div style="font-size:16px; line-height:1.6; color:#333;">
          <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px; border-left:4px solid #0099cc;">
            <strong>üé§ Available Voice Commands</strong><br>
            <span style="font-size:14px; color:#666;">(Voice command engine is disabled in this build to prevent pinging; navigation still works via buttons.)</span>
          </div>
          <div style="margin-bottom:25px;">
            <div style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:10px; border-left:3px solid #28a745;">
              <strong style="color:#28a745;">üß≠ Navigation Commands</strong>
            </div>
            <div style="margin-left:15px; font-size:15px;">
              ‚Ä¢ "Hey Leslie, <strong>home</strong>" ‚Äî Return to home<br>
              ‚Ä¢ "Hey Leslie, <strong>start talking</strong>" ‚Äî Speech page<br>
              ‚Ä¢ "Hey Leslie, <strong>start texting</strong>" ‚Äî Text page<br>
              ‚Ä¢ "Hey Leslie, <strong>phone</strong>" ‚Äî Phone page<br>
              ‚Ä¢ "Hey Leslie, <strong>settings</strong>" ‚Äî Settings page<br>
              ‚Ä¢ "Hey Leslie, <strong>help</strong>" ‚Äî Show commands
            </div>
          </div>
          <div style="margin-bottom:25px;">
            <div style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:10px; border-left:3px solid #007bff;">
              <strong style="color:#007bff;">üå§Ô∏è Weather Commands</strong>
            </div>
            <div style="margin-left:15px; font-size:15px;">
              ‚Ä¢ "Hey Leslie, <strong>weather</strong>" ‚Äî Current weather<br>
              ‚Ä¢ "Hey Leslie, <strong>hourly</strong>" ‚Äî 24-hour forecast<br>
              ‚Ä¢ "Hey Leslie, <strong>weekly</strong>" ‚Äî 7-day forecast<br>
              ‚Ä¢ "Hey Leslie, <strong>close</strong>" ‚Äî Close weather
            </div>
          </div>
        </div>
      </div>
      <div style="padding:16px; text-align:center;">
        <button class="btn-home" id="btnCommandsHome">üè† HOME</button>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="page">
      <div class="page-header header-settings">
        <h2>‚öôÔ∏è Leslie Settings</h2>
        <button class="close-btn" id="btnCloseSettings">&times;</button>
      </div>
      <div style="max-height:500px; overflow-y:auto; padding:0 8px;">
        <div class="settings-section">
          <div class="settings-title">Speech Playback Speed</div>
          <div class="settings-description">How fast Leslie repeats your speech back to you</div>
          <input type="range" class="slider" id="speechSpeedSlider" min="0.5" max="2" step="0.2" value="1.0">
          <div class="setting-value" id="speechSpeedValue">Normal (1.0x)</div>
        </div>

        <div class="settings-section">
          <div class="settings-title">Pause Between Words</div>
          <div class="settings-description">How long to wait after you stop speaking before processing your complete phrase</div>
          <input type="range" class="slider" id="pauseBetweenWordsSlider" min="0.5" max="4" step="0.1" value="1.5">
          <div class="setting-value" id="pauseBetweenWordsValue">1.5 seconds</div>
        </div>
      </div>

      <button class="btn-home" id="btnSettingsHome">‚Üê Back</button>
    </div>
  </div>

  <!-- Weather modal -->
  <div id="weatherDisplay" class="weather-display hidden" aria-hidden="true">
    <div id="weatherTitle" class="weather-title" style="font-size:20px; font-weight:bold; color:#0099cc; text-align:center; margin-bottom:16px;">Weather</div>
    <div id="weatherContent" class="weather-content" style="margin-bottom:16px; line-height:1.6; text-align:center;"></div>
    <div class="weather-controls" style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
      <button class="weather-btn" onclick="showCurrentWeather()" style="padding:8px 16px; background:#0099cc; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold;">Current</button>
      <button class="weather-btn" onclick="showHourlyWeather()"  style="padding:8px 16px; background:#0099cc; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold;">Hourly</button>
      <button class="weather-btn" onclick="showWeeklyWeather()"  style="padding:8px 16px; background:#0099cc; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold;">Weekly</button>
      <button class="weather-btn" onclick="hideWeather()"        style="padding:8px 16px; background:#0099cc; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold;">Close</button>
    </div>
  </div>

  <script>
    // ===============================
    // GLOBAL STATE / SETTINGS
    // ===============================
    let speechRecognition = null;
    let isMainListening = false;
    let shouldKeepListening = false;
    let userStoppedManually = false;

    const speechSynth = window.speechSynthesis;

    // TTS prime so mobile Safari/Chrome will speak after first user tap
    let ttsPrimed = false;
    function primeTTSOnce() {
      if (ttsPrimed) return;
      try {
        const u = new SpeechSynthesisUtterance('.');
        u.volume = 0; u.rate = 1; u.pitch = 1; u.lang = 'en-US';
        u.onend = () => { ttsPrimed = true; };
        speechSynth.cancel();
        speechSynth.speak(u);
      } catch (e) { console.log('TTS prime error:', e); }
    }

    let isSpeaking = false;
    let currentSpeechUtterance = null;
    let lastSpokenPhrase = '';
    let lastSpokenTime = 0;

    let currentPage = 'home';
    let contacts = [];
    let filteredContacts = [];
    let userLocation = { lat: 38.8117, lon: -90.8529 }; // default without geolocation

    const SESSION_TIMEOUT = 2 * 60 * 1000; // 2 minutes
    let sessionTimeoutId = null;

    const settings = {
      speechSpeed: 1.0,
      pauseBetweenWords: 1.5
    };

    // ===============================
    // UI HELPERS
    // ===============================
    function updateStatus(message) {
      const el = document.getElementById('statusText');
      if (el) el.textContent = message;
      console.log('STATUS:', message);
    }

    function updateListenButton() {
      const listenButton = document.getElementById('listenButton');
      if (!listenButton) return;
      if (isMainListening || shouldKeepListening) {
        listenButton.textContent = 'STOP LISTENING';
        listenButton.className = 'control-btn btn-stop';
      } else {
        listenButton.textContent = 'START TALKING';
        listenButton.className = 'control-btn btn-listen';
      }
    }

    function resetSessionTimeout() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(() => {
        if (shouldKeepListening && currentPage === 'speech') {
          stopListening();
          updateStatus('‚è∞ Session timeout (2 minutes) ‚Äî tap START TALKING to continue');
        }
      }, SESSION_TIMEOUT);
    }

    function clearSessionTimeout() {
      if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
      sessionTimeoutId = null;
    }

    // ===============================
    // SPEAK (final phrase playback)
    // ===============================
    function speakCompletePhrase(text) {
      if (!text || !text.trim()) return;

      // prevent duplicates within 5 seconds
      if (text === lastSpokenPhrase && (Date.now() - lastSpokenTime) < 5000) return;

      if (isSpeaking) return;

      isSpeaking = true;
      lastSpokenPhrase = text;
      lastSpokenTime = Date.now();

      speechSynth.cancel();

      setTimeout(() => {
        try {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'en-US';
          u.rate = Number(settings.speechSpeed) || 1.0;
          u.pitch = 1.0;
          u.volume = 1.0;

          u.onstart = () => updateStatus(`üîä Speaking: "${text}"`);
          u.onend = () => {
            isSpeaking = false;
            currentSpeechUtterance = null;
            updateStatus('üé§ Ready for your next phrase');
            const rt = document.getElementById('recognizedText');
            if (rt && shouldKeepListening) {
              setTimeout(() => {
                rt.innerHTML = '<div style="color:#0099cc;font-style:italic;text-align:center;padding:20px;">üé§ Ready‚Ä¶</div>';
              }, 300);
            }
          };
          u.onerror = () => {
            isSpeaking = false;
            currentSpeechUtterance = null;
            updateStatus('‚ö†Ô∏è Speech error ‚Äî ready');
          };

          currentSpeechUtterance = u;

          if (speechSynth.speaking) {
            speechSynth.cancel();
            setTimeout(() => speechSynth.speak(u), 150);
          } else {
            speechSynth.speak(u);
          }
        } catch (e) {
          isSpeaking = false;
          currentSpeechUtterance = null;
          updateStatus('‚ö†Ô∏è Could not speak ‚Äî ready');
        }
      }, 180);
    }

    function displayInterimPhrase(interimText) {
      const el = document.getElementById('recognizedText');
      if (!el) return;
      el.innerHTML = `<div class="interim-phrase">üé§ Speaking: "${interimText}"</div>`;
      el.scrollTop = el.scrollHeight;
    }

    function displayFinalPhrase(phrase) {
      const el = document.getElementById('recognizedText');
      if (!el) return;
      el.innerHTML = `<div class="final-phrase">‚úÖ You said: "${phrase}"</div>`;
      el.scrollTop = el.scrollHeight;
    }

    // ===============================
    // SPEECH RECOGNITION
    // ===============================
    function createSpeechRecognition() {
      if (speechRecognition) {
        try { speechRecognition.abort(); } catch (_) {}
        speechRecognition = null;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        updateStatus('‚ùå Speech Recognition not supported');
        return false;
      }

      const rec = new SR();
      rec.continuous = true;
      rec.interimResults = true;
      rec.lang = 'en-US';
      rec.maxAlternatives = 1;

      let lastResultIndex = 0;

      rec.onstart = () => {
        isMainListening = true;
        updateListenButton();
        updateStatus('üé§ Listening‚Ä¶ Speak your complete phrases');
        resetSessionTimeout();
      };

      rec.onend = () => {
        isMainListening = false;
        updateListenButton();
        if (shouldKeepListening && currentPage === 'speech' && !userStoppedManually) {
          setTimeout(() => { try { rec.start(); } catch (_) {} }, 250);
        } else {
          clearSessionTimeout();
          updateStatus('‚úÖ Stopped listening');
        }
      };

      rec.onerror = (e) => {
        console.log('Recognition error:', e.error);
        isMainListening = false;
        updateListenButton();

        if (e.error === 'not-allowed') {
          shouldKeepListening = false;
          updateStatus('‚ùå Microphone access denied');
        } else if (e.error === 'no-speech') {
          resetSessionTimeout();
        } else {
          if (shouldKeepListening && currentPage === 'speech' && !userStoppedManually) {
            setTimeout(() => { try { rec.start(); } catch (_) {} }, 600);
          }
        }
      };

      rec.onresult = (event) => {
        // Ignore recognition while TTS is speaking (prevents loop/‚Äúping‚Äù)
        if (isSpeaking) return;

        let interim = '';
        let finalText = '';

        for (let i = lastResultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          const transcript = result[0].transcript;
          if (result.isFinal) {
            finalText += transcript;
            lastResultIndex = i + 1;
          } else {
            interim += transcript;
          }
        }

        if (interim.trim()) displayInterimPhrase(interim.trim());

        if (finalText.trim()) {
          const phrase = finalText.trim();
          displayFinalPhrase(phrase);
          setTimeout(() => speakCompletePhrase(phrase), 200);
        }

        resetSessionTimeout();
      };

      speechRecognition = rec;
      return true;
    }

    function startListening() {
      if (shouldKeepListening) return;
      primeTTSOnce(); // make sure mobile will speak

      shouldKeepListening = true;
      userStoppedManually = false;

      if (!createSpeechRecognition()) {
        shouldKeepListening = false;
        return;
      }
      try {
        speechRecognition.start();
      } catch (e) {
        updateStatus('‚ùå Failed to start: ' + (e.message || e.name));
        shouldKeepListening = false;
        isMainListening = false;
        updateListenButton();
      }
      updateListenButton();
    }

    function stopListening() {
      shouldKeepListening = false;
      userStoppedManually = true;
      clearSessionTimeout();
      speechSynth.cancel();
      isSpeaking = false;
      currentSpeechUtterance = null;
      if (speechRecognition) {
        try { speechRecognition.abort(); } catch (_) {}
      }
      isMainListening = false;
      updateListenButton();
      updateStatus('üõë Stopped ‚Äî tap START TALKING to begin again');
    }

    function toggleListening() {
      if (isMainListening || shouldKeepListening) stopListening();
      else startListening();
    }

    // ===============================
    // NAVIGATION / PAGES
    // ===============================
    function showPage(pageId) {
      // Leaving speech page? Stop mic to avoid background ping
      if (currentPage === 'speech' && pageId !== 'speech') {
        stopListening();
      }

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById(pageId + 'Page');
      if (target) target.classList.add('active');
      currentPage = pageId;

      if (pageId === 'speech') {
        const rt = document.getElementById('recognizedText');
        if (rt) {
          rt.innerHTML = '<div style="color:#0099cc;font-weight:bold;text-align:center;padding:20px;font-size:18px;">Tap START TALKING to begin</div>';
        }
        updateStatus('Tap START TALKING to begin listening');
        updateListenButton();
      }

      if (pageId === 'phone') {
        displayContactsOnPhonePage();
      }
    }

    // ===============================
    // CONTACTS
    // ===============================
    function initializeContacts() {
      contacts = [
        { name: 'Emergency Services', phone: '911' },
        { name: 'Demo Contact 1', phone: '(555) 123-4567' },
        { name: 'Demo Contact 2', phone: '(555) 987-6543' },
        { name: 'Demo Contact 3', phone: '(555) 246-8135' }
      ];
      filteredContacts = contacts.slice();
    }

    async function loadAllContacts() {
      const contactsList = document.getElementById('contactsList');
      const loadingSection = document.getElementById('contactLoadingSection');
      if (loadingSection) loadingSection.style.display = 'none';
      if (contactsList) {
        contactsList.innerHTML = `
          <div style="padding:20px; text-align:center; color:#669900; background:#f0f8ff; border-radius:8px; border:2px solid #669900;">
            <p><strong>üìû LOADING ALL CONTACTS</strong></p>
            <p style="margin:10px 0;">Opening contact picker...</p>
          </div>`;
      }

      try {
        if ('contacts' in navigator && 'ContactsManager' in window) {
          const props = ['name', 'tel'];
          const opts = { multiple: true };
          const picked = await navigator.contacts.select(props, opts);

          if (picked && picked.length) {
            const out = [];
            picked.forEach(c => {
              const names = c.name || ['Unknown Contact'];
              const phones = c.tel || [];
              const base = names[0] || 'Unknown Contact';
              if (phones.length) {
                phones.forEach((p, i) => out.push({ name: (phones.length > 1 ? `${base} (${i+1})` : base), phone: p }));
              } else {
                out.push({ name: base, phone: 'No phone number' });
              }
            });
            const unique = out.filter((c, i, self) => i === self.findIndex(t => t.name === c.name && t.phone === c.phone));
            contacts = unique.sort((a, b) => a.name.localeCompare(b.name));
            filteredContacts = contacts.slice();
            displayRealContactsOnPhonePage();
          } else {
            throw new Error('No contacts selected');
          }
        } else {
          throw new Error('Contacts API not supported on this device/browser');
        }
      } catch (e) {
        handleContactLoadingError(e, contactsList);
      }
    }

    async function loadSelectedContacts() {
      const contactsList = document.getElementById('contactsList');
      const loadingSection = document.getElementById('contactLoadingSection');
      if (loadingSection) loadingSection.style.display = 'none';
      if (contactsList) {
        contactsList.innerHTML = `
          <div style="padding:16px; text-align:center; color:#0099cc; background:#f0f8ff; border-radius:8px;">
            <p><strong>üìã Choose Specific Contacts</strong></p>
            <p>‚è≥ Opening contact picker...</p>
          </div>`;
      }

      try {
        if ('contacts' in navigator && 'ContactsManager' in window) {
          const props = ['name', 'tel'];
          const opts = { multiple: true };
          const picked = await navigator.contacts.select(props, opts);

          if (picked.length) {
            const out = picked.map(c => ({
              name: (c.name && c.name[0]) ? c.name[0] : 'Unknown',
              phone: (c.tel && c.tel[0]) ? c.tel[0] : 'No phone'
            }));
            const unique = out.filter((c, i, self) => i === self.findIndex(t => t.name === c.name && t.phone === c.phone));
            contacts = unique.sort((a, b) => a.name.localeCompare(b.name));
            filteredContacts = contacts.slice();
            displayRealContactsOnPhonePage();
          } else {
            if (contactsList) {
              contactsList.innerHTML = `
                <div style="padding:20px; text-align:center; color:#ff6600; border:2px solid #ff6600; border-radius:8px;">
                  <p><strong>üì± No Contacts Selected</strong></p>
                  <p>Demo contacts remain available</p>
                </div>`;
            }
            setTimeout(() => displayContactsOnPhonePage(), 2000);
          }
        } else {
          throw new Error('Contacts API not supported on this device/browser');
        }
      } catch (e) {
        handleContactLoadingError(e, contactsList);
      }
    }

    function handleContactLoadingError(error, contactsList) {
      let message = '';
      if (error.name === 'NotAllowedError') {
        message = '<p><strong>üì± Permission Denied</strong></p><p>You denied contact access</p>';
      } else if (error.name === 'AbortError') {
        message = '<p><strong>üì± Contact Selection Cancelled</strong></p>';
      } else if ((error.message || '').includes('not supported')) {
        message = '<p><strong>üì± Contacts API Not Supported</strong></p><p>Requires Chrome Android or Safari iOS</p>';
      } else {
        message = `<p><strong>üì± Contact Loading Error</strong></p><p>${error.message || 'Unknown error'}</p>`;
      }

      if (contactsList) {
        contactsList.innerHTML = `
          <div style="padding:20px; text-align:center; color:#cc0000; border:2px solid #cc0000; border-radius:8px;">
            ${message}
            <p style="margin-top:15px;">Demo contacts will remain available</p>
          </div>`;
      }
      setTimeout(() => displayContactsOnPhonePage(), 2000);
    }

    function displayRealContactsOnPhonePage() {
      const list = document.getElementById('contactsList');
      if (!list) return;

      list.innerHTML = '';
      const ok = document.createElement('div');
      ok.style.cssText = 'padding:12px;text-align:center;font-weight:bold;color:white;background:#28a745;border-radius:8px;margin-bottom:8px;';
      ok.innerHTML = `‚úÖ SUCCESS: ${filteredContacts.length} REAL contacts loaded!`;
      list.appendChild(ok);

      filteredContacts.forEach(c => {
        const el = document.createElement('div');
        el.className = 'contact-item';
        el.style.backgroundColor = '#e8f5e8';
        el.innerHTML = `<div class="contact-name">${c.name}</div><div class="contact-phone">${c.phone}</div>`;
        el.addEventListener('click', () => callContact(c));
        list.appendChild(el);
      });

      const note = document.createElement('div');
      note.style.cssText = 'padding:8px;text-align:center;font-size:12px;color:#28a745;font-weight:bold;margin-top:8px;';
      note.textContent = 'üì± These are YOUR real contacts - tap to call';
      list.appendChild(note);
    }

    function displayContactsOnPhonePage() {
      const list = document.getElementById('contactsList');
      if (!list) return;

      list.innerHTML = '';
      if (!filteredContacts.length) {
        list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><p><strong>üì± No contacts found</strong></p></div>';
        return;
      }

      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'padding:12px;text-align:center;font-weight:bold;color:#669900;background:#f0f8ff;border-radius:8px;margin-bottom:8px;';
      headerDiv.textContent = `üì± ${filteredContacts.length} contacts available - tap to call`;
      list.appendChild(headerDiv);

      filteredContacts.forEach(c => {
        const el = document.createElement('div');
        el.className = 'contact-item';
        el.innerHTML = `<div class="contact-name">${c.name}</div><div class="contact-phone">${c.phone}</div>`;
        el.addEventListener('click', () => callContact(c));
        list.appendChild(el);
      });
    }

    function callContact(contact) {
      const phone = String(contact.phone || '').replace(/[^0-9]/g, '');
      if (phone) window.location.href = `tel:${phone}`;
    }

    // ===============================
    // WEATHER (no mic / no geolocation prompt)
    // ===============================
    function getWeatherDescription(code) {
      const m = {
        0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',
        45:'Fog',48:'Depositing rime fog',
        51:'Light drizzle',53:'Moderate drizzle',55:'Dense drizzle',
        61:'Slight rain',63:'Moderate rain',65:'Heavy rain',
        71:'Slight snow',73:'Moderate snow',75:'Heavy snow',
        80:'Slight rain showers',81:'Moderate rain showers',82:'Violent rain showers',
        95:'Thunderstorm',96:'Thunderstorm with hail',99:'Thunderstorm with heavy hail'
      };
      return m[code] || 'Unknown';
    }

    function showWeatherDisplay(title, content) {
      const weatherDisplay = document.getElementById('weatherDisplay');
      const weatherTitle = document.getElementById('weatherTitle');
      const weatherContent = document.getElementById('weatherContent');

      if (weatherTitle) weatherTitle.textContent = title;
      if (weatherContent) weatherContent.innerHTML = `<div style="text-align:center;padding:20px;">${content}</div>`;
      if (weatherDisplay) weatherDisplay.classList.remove('hidden');
    }

    function hideWeather() {
      const weatherDisplay = document.getElementById('weatherDisplay');
      if (weatherDisplay) weatherDisplay.classList.add('hidden');
    }

    async function showCurrentWeather() {
      showWeatherDisplay('Current Weather', 'Loading‚Ä¶');
      try {
        const { lat, lon } = userLocation;
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
        const data = await r.json();

        const f = Math.round(data.current.temperature_2m * 9/5 + 32);
        const hum = data.current.relative_humidity_2m;
        const wind = Math.round(data.current.wind_speed_10m * 0.621371);
        const cond = getWeatherDescription(data.current.weather_code);

        const html = `
          <div style="text-align:center;padding:10px;">
            <div style="font-size:28px;font-weight:bold;color:#0099cc;margin-bottom:8px;">${f}¬∞F</div>
            <div style="font-size:18px;font-weight:bold;margin-bottom:16px;">${cond}</div>
            <div style="font-size:14px;line-height:1.6;">
              <div><strong>Humidity:</strong> ${hum}%</div>
              <div><strong>Wind:</strong> ${wind} mph</div>
            </div>
          </div>`;
        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = html;
      } catch {
        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = '<div style="text-align:center;padding:20px;">Unable to load weather data.</div>';
      }
    }

    async function showHourlyWeather() {
      showWeatherDisplay('Next 24 Hours', 'Loading‚Ä¶');
      try {
        const { lat, lon } = userLocation;
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=2`);
        const data = await r.json();

        const now = new Date();
        const curHour = now.getHours();
        let startIndex = 0;
        for (let i = 0; i < data.hourly.time.length; i++) {
          const t = new Date(data.hourly.time[i]);
          if (t.getHours() === curHour && t.getDate() === now.getDate()) { startIndex = i; break; }
        }

        let out = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:4px;padding:10px;max-height:400px;overflow-y:auto;">';
        for (let i = startIndex; i < Math.min(startIndex + 24, data.hourly.time.length); i++) {
          const t = new Date(data.hourly.time[i]);
          const hr = t.getHours();
          const temp = Math.round(data.hourly.temperature_2m[i] * 9/5 + 32);
          const cond = getWeatherDescription(data.hourly.weather_code[i]);
          const label = i === startIndex ? 'NOW' : (((hr % 12) || 12) + (hr >= 12 ? 'PM' : 'AM'));
          const bg = i === startIndex ? '#0099cc' : '#f0f8ff';
          const fg = i === startIndex ? '#fff' : '#000';

          out += `
            <div class="hourly-item" style="background:${bg};color:${fg};padding:6px;text-align:center;font-size:10px;border-radius:4px;">
              <div style="font-weight:bold;font-size:11px;">${label}</div>
              <div style="font-size:12px;font-weight:bold;margin:2px 0;">${temp}¬∞</div>
              <div style="font-size:9px;opacity:.9;line-height:1.1;">${cond}</div>
            </div>`;
        }
        out += '</div>';

        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = out;
      } catch {
        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = '<div style="text-align:center;padding:20px;">Unable to load 24-hour forecast.</div>';
      }
    }

    async function showWeeklyWeather() {
      showWeatherDisplay('7-Day Forecast', 'Loading‚Ä¶');
      try {
        const { lat, lon } = userLocation;
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=7`);
        const data = await r.json();

        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        let out = '<div style="display:grid;gap:6px;padding:10px;">';
        for (let i = 0; i < Math.min(7, data.daily.time.length); i++) {
          const d = new Date(data.daily.time[i]);
          const hi = Math.round(data.daily.temperature_2m_max[i]*9/5+32);
          const lo = Math.round(data.daily.temperature_2m_min[i]*9/5+32);
          const cond = getWeatherDescription(data.daily.weather_code[i]);

          out += `
            <div class="weekly-item" style="display:grid;grid-template-columns:80px 60px 1fr;gap:8px;align-items:center;font-size:14px;background:#f0f8ff;padding:8px;border-radius:6px;">
              <div class="day-name" style="font-weight:bold;">${days[d.getDay()]}</div>
              <div class="day-temps" style="color:#0099cc;font-weight:bold;">${hi}¬∞/${lo}¬∞</div>
              <div class="day-condition" style="color:#666;">${cond}</div>
            </div>`;
        }
        out += '</div>';

        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = out;
      } catch {
        const el = document.getElementById('weatherContent');
        if (el) el.innerHTML = '<div style="text-align:center;padding:20px;">Unable to load 7-day forecast.</div>';
      }
    }

    // ===============================
    // SETTINGS
    // ===============================
    function loadSettings() {
      try {
        const s = localStorage.getItem('leslieSettings');
        if (s) Object.assign(settings, JSON.parse(s));
      } catch {}
      updateSettingsUI();
    }

    function saveSettings() {
      try { localStorage.setItem('leslieSettings', JSON.stringify(settings)); } catch {}
    }

    function updateSettingsUI() {
      const sp = document.getElementById('speechSpeedSlider');
      const spv = document.getElementById('speechSpeedValue');
      const pa = document.getElementById('pauseBetweenWordsSlider');
      const pav = document.getElementById('pauseBetweenWordsValue');

      if (sp)  sp.value = settings.speechSpeed;
      if (spv) spv.textContent = (settings.speechSpeed === 1 ? 'Normal (1.0x)' : Number(settings.speechSpeed).toFixed(1) + 'x');

      if (pa)  pa.value = settings.pauseBetweenWords;
      if (pav) pav.textContent = Number(settings.pauseBetweenWords).toFixed(1) + ' seconds';
    }

    function updateSpeechSpeed(v) {
      settings.speechSpeed = parseFloat(v) || 1.0;
      updateSettingsUI();
      saveSettings();
    }

    function updatePauseBetweenWords(v) {
      settings.pauseBetweenWords = parseFloat(v) || 1.5;
      updateSettingsUI();
      saveSettings();
    }

    // ===============================
    // MISC CLEANUPS (from your original intent)
    // ===============================
    function removeVoiceCommandElements() {
      const voiceStatus = document.getElementById('voiceCommandStatus');
      if (voiceStatus) {
        voiceStatus.remove();
        console.log('üö´ Voice command status element REMOVED');
      }
    }

    // ===============================
    // EVENTS & INIT
    // ===============================
    function setupEventHandlers() {
      const byId = (x) => document.getElementById(x);

      const btnStartTalking = byId('btnStartTalking');
      const btnStartTexting = byId('btnStartTexting');
      const btnPhoneCall    = byId('btnPhoneCall');
      const btnCommands     = byId('btnCommands');
      const btnSettings     = byId('btnSettings');

      if (btnStartTalking) btnStartTalking.addEventListener('click', () => showPage('speech'));
      if (btnStartTexting) btnStartTexting.addEventListener('click', () => showPage('textInput'));
      if (btnPhoneCall)    btnPhoneCall.addEventListener('click',    () => showPage('phone'));
      if (btnCommands)     btnCommands.addEventListener('click',     () => showPage('commands'));
      if (btnSettings)     btnSettings.addEventListener('click',     () => showPage('settings'));

      const closes = [
        ['btnCloseSpeech', 'home'],
        ['btnClosePhone', 'home'],
        ['btnCloseCommands', 'home'],
        ['btnCloseText', 'home'],
        ['btnCloseSettings', 'home']
      ];
      closes.forEach(([id, to]) => {
        const el = byId(id);
        if (el) el.addEventListener('click', () => showPage(to));
      });

      const listenButton = byId('listenButton');
      const clearButton  = byId('clearButton');

      if (listenButton) listenButton.addEventListener('click', () => { primeTTSOnce(); toggleListening(); });
      if (clearButton) {
        clearButton.addEventListener('click', () => {
          speechSynth.cancel();
          isSpeaking = false;
          currentSpeechUtterance = null;
          const rt = byId('recognizedText');
          if (rt) rt.innerHTML = shouldKeepListening
            ? '<div style="color:#0099cc;font-style:italic;text-align:center;padding:20px;">üé§ Ready‚Ä¶</div>'
            : '<div style="color:#666;font-style:italic;text-align:center;padding:20px;">Waiting to start‚Ä¶</div>';
        });
      }

      const homeBtns = ['btnPhoneHome', 'btnTextHome', 'btnSettingsHome', 'btnCommandsHome'];
      homeBtns.forEach(id => {
        const el = byId(id);
        if (el) el.addEventListener('click', () => showPage('home'));
      });

      const speed = byId('speechSpeedSlider');
      const pause = byId('pauseBetweenWordsSlider');
      if (speed) speed.addEventListener('input', e => updateSpeechSpeed(e.target.value));
      if (pause) pause.addEventListener('input', e => updatePauseBetweenWords(e.target.value));
    }

    function initApp() {
      loadSettings();
      setupEventHandlers();
      initializeContacts();

      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        updateStatus('‚ùå Speech recognition not supported in this browser');
        const rt = document.getElementById('recognizedText');
        if (rt) {
          rt.innerHTML = '<div style="color:#cc0000;font-weight:bold;text-align:center;padding:20px;font-size:18px;">‚ùå Speech Recognition Not Supported<br><br>Please use Chrome, Edge, or Safari</div>';
        }
      } else {
        updateStatus('Tap START TALKING to begin listening');
      }

      // Remove any voice command status element you had
      removeVoiceCommandElements();

      updateListenButton();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
